#!/usr/bin/env python3
"""
Penetration Testing Report Generator
Generates comprehensive penetration testing reports.
"""

import json
import sys
from datetime import datetime
from typing import List, Dict

class ReportGenerator:
    def __init__(self, client_name: str, project_name: str):
        self.client_name = client_name
        self.project_name = project_name
        self.vulnerabilities = []
        self.executive_summary = ""
        self.methodology = ""
        self.scope = ""
    
    def add_vulnerability(self, title: str, severity: str, description: str,
                         impact: str, recommendation: str, cvss_score: float = None,
                         affected_systems: List[str] = None, poc: str = None) -> Dict:
        """Add vulnerability to report"""
        vuln = {
            'title': title,
            'severity': severity,
            'description': description,
            'impact': impact,
            'recommendation': recommendation,
            'cvss_score': cvss_score,
            'affected_systems': affected_systems or [],
            'poc': poc,
            'id': len(self.vulnerabilities) + 1
        }
        self.vulnerabilities.append(vuln)
        return vuln
    
    def set_executive_summary(self, summary: str):
        """Set executive summary"""
        self.executive_summary = summary
    
    def set_methodology(self, methodology: str):
        """Set testing methodology"""
        self.methodology = methodology
    
    def set_scope(self, scope: str):
        """Set testing scope"""
        self.scope = scope
    
    def calculate_risk_summary(self) -> Dict:
        """Calculate risk summary statistics"""
        critical = [v for v in self.vulnerabilities if v['severity'] == 'Critical']
        high = [v for v in self.vulnerabilities if v['severity'] == 'High']
        medium = [v for v in self.vulnerabilities if v['severity'] == 'Medium']
        low = [v for v in self.vulnerabilities if v['severity'] == 'Low']
        
        return {
            'total': len(self.vulnerabilities),
            'critical': len(critical),
            'high': len(high),
            'medium': len(medium),
            'low': len(low)
        }
    
    def generate_executive_summary(self) -> str:
        """Generate executive summary section"""
        risk_summary = self.calculate_risk_summary()
        
        summary = f"## Executive Summary\n\n"
        summary += f"{self.executive_summary or 'This report presents the findings from the penetration test conducted on ' + self.client_name + ' systems.'}\n\n"
        summary += f"### Risk Overview\n\n"
        summary += f"During the assessment, **{risk_summary['total']} vulnerabilities** were identified:\n\n"
        summary += f"- **Critical**: {risk_summary['critical']}\n"
        summary += f"- **High**: {risk_summary['high']}\n"
        summary += f"- **Medium**: {risk_summary['medium']}\n"
        summary += f"- **Low**: {risk_summary['low']}\n\n"
        
        if risk_summary['critical'] > 0 or risk_summary['high'] > 0:
            summary += f"**Immediate Action Required**: {risk_summary['critical'] + risk_summary['high']} high-severity vulnerabilities require immediate attention.\n\n"
        
        return summary
    
    def generate_vulnerability_section(self) -> str:
        """Generate vulnerability findings section"""
        section = "## Technical Findings\n\n"
        
        # Sort by severity
        severity_order = {'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3, 'Informational': 4}
        sorted_vulns = sorted(self.vulnerabilities, key=lambda x: severity_order.get(x['severity'], 99))
        
        for vuln in sorted_vulns:
            section += f"### {vuln['id']}. {vuln['title']}\n\n"
            section += f"**Severity**: {vuln['severity']}\n\n"
            
            if vuln['cvss_score']:
                section += f"**CVSS Score**: {vuln['cvss_score']}\n\n"
            
            section += f"**Description**:\n\n{vuln['description']}\n\n"
            section += f"**Impact**:\n\n{vuln['impact']}\n\n"
            
            if vuln['affected_systems']:
                section += f"**Affected Systems**:\n"
                for system in vuln['affected_systems']:
                    section += f"- {system}\n"
                section += "\n"
            
            if vuln['poc']:
                section += f"**Proof of Concept**:\n\n```\n{vuln['poc']}\n```\n\n"
            
            section += f"**Recommendation**:\n\n{vuln['recommendation']}\n\n"
            section += "---\n\n"
        
        return section
    
    def generate_report(self) -> str:
        """Generate complete penetration testing report"""
        report = f"# Penetration Testing Report\n\n"
        report += f"**Client**: {self.client_name}\n"
        report += f"**Project**: {self.project_name}\n"
        report += f"**Date**: {datetime.now().strftime('%Y-%m-%d')}\n"
        report += f"**Report Version**: 1.0\n\n"
        report += "---\n\n"
        
        # Table of Contents
        report += "## Table of Contents\n\n"
        report += "1. [Executive Summary](#executive-summary)\n"
        report += "2. [Scope](#scope)\n"
        report += "3. [Methodology](#methodology)\n"
        report += "4. [Technical Findings](#technical-findings)\n"
        report += "5. [Risk Assessment](#risk-assessment)\n"
        report += "6. [Recommendations](#recommendations)\n"
        report += "7. [Conclusion](#conclusion)\n\n"
        report += "---\n\n"
        
        # Executive Summary
        report += self.generate_executive_summary()
        
        # Scope
        report += "## Scope\n\n"
        report += f"{self.scope or 'Testing scope to be defined.'}\n\n"
        report += "---\n\n"
        
        # Methodology
        report += "## Methodology\n\n"
        report += f"{self.methodology or 'PTES (Penetration Testing Execution Standard) methodology was followed.'}\n\n"
        report += "---\n\n"
        
        # Technical Findings
        report += self.generate_vulnerability_section()
        
        # Risk Assessment
        report += "## Risk Assessment\n\n"
        risk_summary = self.calculate_risk_summary()
        report += f"### Risk Distribution\n\n"
        report += f"- **Critical Risk**: {risk_summary['critical']} findings\n"
        report += f"- **High Risk**: {risk_summary['high']} findings\n"
        report += f"- **Medium Risk**: {risk_summary['medium']} findings\n"
        report += f"- **Low Risk**: {risk_summary['low']} findings\n\n"
        report += "---\n\n"
        
        # Recommendations
        report += "## Recommendations\n\n"
        report += "### Immediate Actions\n\n"
        critical_high = [v for v in self.vulnerabilities if v['severity'] in ['Critical', 'High']]
        if critical_high:
            for vuln in critical_high[:5]:  # Top 5
                report += f"- **{vuln['title']}**: {vuln['recommendation']}\n"
        else:
            report += "- No immediate actions required.\n"
        report += "\n---\n\n"
        
        # Conclusion
        report += "## Conclusion\n\n"
        report += f"This penetration test identified {risk_summary['total']} security vulnerabilities "
        report += f"across the tested systems. It is recommended that all identified issues be addressed "
        report += f"according to their severity and business impact.\n\n"
        
        report += "---\n\n"
        report += f"**Report Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
        
        return report
    
    def save_report(self, filename: str = None):
        """Save report to file"""
        if not filename:
            filename = f"pentest_report_{self.client_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.md"
        
        report = self.generate_report()
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(report)
        
        print(f"[+] Report saved to {filename}")
        return filename

def main():
    if len(sys.argv) < 3:
        print("Usage: python report_generator.py <client_name> <project_name>")
        print("Example: python report_generator.py 'Acme Corp' 'Web Application Assessment'")
        sys.exit(1)
    
    client_name = sys.argv[1]
    project_name = sys.argv[2]
    
    generator = ReportGenerator(client_name, project_name)
    
    # Set metadata
    generator.set_scope("Web application and network infrastructure")
    generator.set_methodology("PTES - Penetration Testing Execution Standard")
    generator.set_executive_summary(
        f"This report presents the findings from the penetration test conducted on {client_name} systems. "
        "The assessment identified several security vulnerabilities that require attention."
    )
    
    # Example vulnerabilities
    generator.add_vulnerability(
        title="SQL Injection in Login Form",
        severity="Critical",
        description="SQL injection vulnerability allows authentication bypass",
        impact="Attackers can bypass authentication and gain unauthorized access",
        recommendation="Use parameterized queries and input validation",
        cvss_score=9.8,
        affected_systems=["Web Application - Login Page"],
        poc="' OR '1'='1"
    )
    
    generator.add_vulnerability(
        title="Missing Security Headers",
        severity="Medium",
        description="X-Frame-Options and CSP headers not configured",
        impact="Application vulnerable to clickjacking attacks",
        recommendation="Implement security headers (X-Frame-Options, CSP, etc.)",
        cvss_score=3.1,
        affected_systems=["Web Application"]
    )
    
    # Generate and save report
    filename = generator.save_report()
    print(f"\n[+] Report generated successfully!")
    print(f"[+] Total vulnerabilities: {len(generator.vulnerabilities)}")

if __name__ == '__main__':
    main()

