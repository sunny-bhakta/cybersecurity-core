/**
 * Penetration Testing Report Generator
 * Generates comprehensive penetration testing reports.
 */

const fs = require('fs');

class ReportGenerator {
    constructor(clientName, projectName) {
        this.clientName = clientName;
        this.projectName = projectName;
        this.vulnerabilities = [];
        this.executiveSummary = '';
        this.methodology = '';
        this.scope = '';
    }

    addVulnerability(title, severity, description, impact, recommendation, cvssScore = null, affectedSystems = null, poc = null) {
        const vuln = {
            title: title,
            severity: severity,
            description: description,
            impact: impact,
            recommendation: recommendation,
            cvss_score: cvssScore,
            affected_systems: affectedSystems || [],
            poc: poc,
            id: this.vulnerabilities.length + 1
        };
        this.vulnerabilities.push(vuln);
        return vuln;
    }

    setExecutiveSummary(summary) {
        this.executiveSummary = summary;
    }

    setMethodology(methodology) {
        this.methodology = methodology;
    }

    setScope(scope) {
        this.scope = scope;
    }

    calculateRiskSummary() {
        const critical = this.vulnerabilities.filter(v => v.severity === 'Critical');
        const high = this.vulnerabilities.filter(v => v.severity === 'High');
        const medium = this.vulnerabilities.filter(v => v.severity === 'Medium');
        const low = this.vulnerabilities.filter(v => v.severity === 'Low');

        return {
            total: this.vulnerabilities.length,
            critical: critical.length,
            high: high.length,
            medium: medium.length,
            low: low.length
        };
    }

    generateExecutiveSummary() {
        const riskSummary = this.calculateRiskSummary();
        let summary = `## Executive Summary\n\n`;
        summary += `${this.executiveSummary || `This report presents the findings from the penetration test conducted on ${this.clientName} systems.`}\n\n`;
        summary += `### Risk Overview\n\n`;
        summary += `During the assessment, **${riskSummary.total} vulnerabilities** were identified:\n\n`;
        summary += `- **Critical**: ${riskSummary.critical}\n`;
        summary += `- **High**: ${riskSummary.high}\n`;
        summary += `- **Medium**: ${riskSummary.medium}\n`;
        summary += `- **Low**: ${riskSummary.low}\n\n`;

        if (riskSummary.critical > 0 || riskSummary.high > 0) {
            summary += `**Immediate Action Required**: ${riskSummary.critical + riskSummary.high} high-severity vulnerabilities require immediate attention.\n\n`;
        }

        return summary;
    }

    generateVulnerabilitySection() {
        let section = `## Technical Findings\n\n`;

        const severityOrder = { 'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3, 'Informational': 4 };
        const sortedVulns = this.vulnerabilities.sort((a, b) => {
            return (severityOrder[a.severity] || 99) - (severityOrder[b.severity] || 99);
        });

        sortedVulns.forEach(vuln => {
            section += `### ${vuln.id}. ${vuln.title}\n\n`;
            section += `**Severity**: ${vuln.severity}\n\n`;

            if (vuln.cvss_score) {
                section += `**CVSS Score**: ${vuln.cvss_score}\n\n`;
            }

            section += `**Description**:\n\n${vuln.description}\n\n`;
            section += `**Impact**:\n\n${vuln.impact}\n\n`;

            if (vuln.affected_systems && vuln.affected_systems.length > 0) {
                section += `**Affected Systems**:\n`;
                vuln.affected_systems.forEach(system => {
                    section += `- ${system}\n`;
                });
                section += `\n`;
            }

            if (vuln.poc) {
                section += `**Proof of Concept**:\n\n\`\`\`\n${vuln.poc}\n\`\`\`\n\n`;
            }

            section += `**Recommendation**:\n\n${vuln.recommendation}\n\n`;
            section += `---\n\n`;
        });

        return section;
    }

    generateReport() {
        const date = new Date().toISOString().split('T')[0];
        let report = `# Penetration Testing Report\n\n`;
        report += `**Client**: ${this.clientName}\n`;
        report += `**Project**: ${this.projectName}\n`;
        report += `**Date**: ${date}\n`;
        report += `**Report Version**: 1.0\n\n`;
        report += `---\n\n`;

        report += `## Table of Contents\n\n`;
        report += `1. [Executive Summary](#executive-summary)\n`;
        report += `2. [Scope](#scope)\n`;
        report += `3. [Methodology](#methodology)\n`;
        report += `4. [Technical Findings](#technical-findings)\n`;
        report += `5. [Risk Assessment](#risk-assessment)\n`;
        report += `6. [Recommendations](#recommendations)\n`;
        report += `7. [Conclusion](#conclusion)\n\n`;
        report += `---\n\n`;

        report += this.generateExecutiveSummary();

        report += `## Scope\n\n`;
        report += `${this.scope || 'Testing scope to be defined.'}\n\n`;
        report += `---\n\n`;

        report += `## Methodology\n\n`;
        report += `${this.methodology || 'PTES (Penetration Testing Execution Standard) methodology was followed.'}\n\n`;
        report += `---\n\n`;

        report += this.generateVulnerabilitySection();

        const riskSummary = this.calculateRiskSummary();
        report += `## Risk Assessment\n\n`;
        report += `### Risk Distribution\n\n`;
        report += `- **Critical Risk**: ${riskSummary.critical} findings\n`;
        report += `- **High Risk**: ${riskSummary.high} findings\n`;
        report += `- **Medium Risk**: ${riskSummary.medium} findings\n`;
        report += `- **Low Risk**: ${riskSummary.low} findings\n\n`;
        report += `---\n\n`;

        report += `## Recommendations\n\n`;
        report += `### Immediate Actions\n\n`;
        const criticalHigh = this.vulnerabilities.filter(v => ['Critical', 'High'].includes(v.severity));
        if (criticalHigh.length > 0) {
            criticalHigh.slice(0, 5).forEach(vuln => {
                report += `- **${vuln.title}**: ${vuln.recommendation}\n`;
            });
        } else {
            report += `- No immediate actions required.\n`;
        }
        report += `\n---\n\n`;

        report += `## Conclusion\n\n`;
        report += `This penetration test identified ${riskSummary.total} security vulnerabilities `;
        report += `across the tested systems. It is recommended that all identified issues be addressed `;
        report += `according to their severity and business impact.\n\n`;

        report += `---\n\n`;
        report += `**Report Generated**: ${new Date().toISOString()}\n`;

        return report;
    }

    saveReport(filename = null) {
        if (!filename) {
            const clientSlug = this.clientName.replace(/ /g, '_');
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            filename = `pentest_report_${clientSlug}_${date}.md`;
        }

        const report = this.generateReport();
        fs.writeFileSync(filename, report, 'utf8');

        console.log(`[+] Report saved to ${filename}`);
        return filename;
    }
}

function main() {
    const args = process.argv.slice(2);
    if (args.length < 2) {
        console.log('Usage: node report_generator.js <client_name> <project_name>');
        console.log('Example: node report_generator.js "Acme Corp" "Web Application Assessment"');
        process.exit(1);
    }

    const clientName = args[0];
    const projectName = args[1];

    const generator = new ReportGenerator(clientName, projectName);

    generator.setScope('Web application and network infrastructure');
    generator.setMethodology('PTES - Penetration Testing Execution Standard');
    generator.setExecutiveSummary(
        `This report presents the findings from the penetration test conducted on ${clientName} systems. ` +
        'The assessment identified several security vulnerabilities that require attention.'
    );

    generator.addVulnerability(
        'SQL Injection in Login Form',
        'Critical',
        'SQL injection vulnerability allows authentication bypass',
        'Attackers can bypass authentication and gain unauthorized access',
        'Use parameterized queries and input validation',
        9.8,
        ['Web Application - Login Page'],
        "' OR '1'='1"
    );

    generator.addVulnerability(
        'Missing Security Headers',
        'Medium',
        'X-Frame-Options and CSP headers not configured',
        'Application vulnerable to clickjacking attacks',
        'Implement security headers (X-Frame-Options, CSP, etc.)',
        3.1,
        ['Web Application']
    );

    const filename = generator.saveReport();
    console.log(`\n[+] Report generated successfully!`);
    console.log(`[+] Total vulnerabilities: ${generator.vulnerabilities.length}`);
}

if (require.main === module) {
    main();
}

module.exports = ReportGenerator;

