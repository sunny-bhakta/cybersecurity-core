#!/usr/bin/env node
/**
 * PKI Analyzer
 * Analyzes Public Key Infrastructure (PKI) configurations and certificates.
 */

const tls = require('tls');
const fs = require('fs');

class PKIAnalyzer {
    constructor(hostname, port = 443) {
        this.hostname = hostname;
        this.port = port;
    }

    getCertificate() {
        return new Promise((resolve, reject) => {
            console.log(`[*] Getting certificate for ${this.hostname}:${this.port}...`);
            
            const socket = tls.connect(this.port, this.hostname, {
                rejectUnauthorized: false
            }, () => {
                const cert = socket.getPeerCertificate(true);
                socket.end();
                
                resolve({
                    subject: cert.subject,
                    issuer: cert.issuer,
                    validFrom: cert.valid_from,
                    validTo: cert.valid_to,
                    serialNumber: cert.serialNumber,
                    subjectAltName: cert.subjectaltname
                });
            });
            
            socket.on('error', (err) => {
                console.log(`[-] Error: ${err.message}`);
                resolve({});
            });
        });
    }

    analyzeCertificate(cert) {
        console.log('[*] Analyzing certificate...');
        
        const issues = [];
        
        if (!cert || Object.keys(cert).length === 0) {
            issues.push('Could not retrieve certificate');
            return issues;
        }
        
        // Check expiration
        if (cert.validTo) {
            const validTo = new Date(cert.validTo);
            const now = new Date();
            
            if (validTo < now) {
                issues.push('Certificate has expired');
            } else {
                const daysUntilExpiry = Math.floor((validTo - now) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry < 30) {
                    issues.push(`Certificate expires in ${daysUntilExpiry} days`);
                }
            }
        }
        
        return issues;
    }

    async generateReport() {
        let report = `# PKI Analysis Report for ${this.hostname}:${this.port}\n\n`;
        
        const cert = await this.getCertificate();
        
        if (cert && Object.keys(cert).length > 0) {
            report += `## Certificate Information\n\n`;
            report += `**Subject**: ${cert.subject?.CN || 'N/A'}\n\n`;
            report += `**Issuer**: ${cert.issuer?.CN || 'N/A'}\n\n`;
            report += `**Valid From**: ${cert.validFrom || 'N/A'}\n\n`;
            report += `**Valid To**: ${cert.validTo || 'N/A'}\n\n`;
            report += `**Serial Number**: ${cert.serialNumber || 'N/A'}\n\n`;
            
            const issues = this.analyzeCertificate(cert);
            if (issues.length > 0) {
                report += `## Issues Found\n\n`;
                issues.forEach(issue => {
                    report += `- ⚠️ ${issue}\n`;
                });
                report += `\n`;
            }
        } else {
            report += `[-] Could not retrieve certificate.\n\n`;
        }
        
        report += `## PKI Best Practices\n\n`;
        report += `1. Use strong encryption algorithms\n`;
        report += `2. Keep certificates up to date\n`;
        report += `3. Use proper certificate chain\n`;
        report += `4. Implement certificate pinning\n`;
        report += `5. Monitor certificate expiration\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node pki_analyzer.js <hostname> [port]');
        console.log('Example: node pki_analyzer.js example.com 443');
        process.exit(1);
    }
    
    const hostname = process.argv[2];
    const port = parseInt(process.argv[3]) || 443;
    
    const analyzer = new PKIAnalyzer(hostname, port);
    const report = await analyzer.generateReport();
    
    const filename = `pki_analysis_${hostname.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] PKI analysis complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = PKIAnalyzer;

