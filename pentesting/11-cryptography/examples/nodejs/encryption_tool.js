/**
 * Encryption Tool
 * Demonstrates encryption and decryption using various algorithms.
 */

const crypto = require('crypto');

class EncryptionTool {
    constructor() {
        this.algorithm = 'aes-256-cbc';
    }

    generateKeyFromPassword(password, salt = 'salt_12345678') {
        return crypto.pbkdf2Sync(password, salt, 100000, 32, 'sha256');
    }

    encryptAES(plaintext, password) {
        const key = this.generateKeyFromPassword(password);
        const iv = crypto.randomBytes(16);
        const cipher = crypto.createCipheriv(this.algorithm, key, iv);
        
        let encrypted = cipher.update(plaintext, 'utf8', 'hex');
        encrypted += cipher.final('hex');
        
        return {
            encrypted: encrypted,
            iv: iv.toString('hex'),
            algorithm: 'AES-256-CBC',
            salt: Buffer.from('salt_12345678').toString('base64')
        };
    }

    decryptAES(encryptedData, password, ivHex, salt = null) {
        try {
            const saltBytes = salt ? Buffer.from(salt, 'base64') : Buffer.from('salt_12345678');
            const key = this.generateKeyFromPassword(password, saltBytes.toString());
            const iv = Buffer.from(ivHex, 'hex');
            const decipher = crypto.createDecipheriv(this.algorithm, key, iv);
            
            let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
            decrypted += decipher.final('utf8');
            
            return decrypted;
        } catch (error) {
            console.log(`[-] Decryption failed: ${error.message}`);
            return null;
        }
    }

    hashText(text, algorithm = 'sha256') {
        const algorithms = ['md5', 'sha1', 'sha256', 'sha512'];
        if (!algorithms.includes(algorithm)) {
            throw new Error(`Unsupported algorithm: ${algorithm}`);
        }
        return crypto.createHash(algorithm).update(text).digest('hex');
    }

    verifyHash(text, hashValue, algorithm = 'sha256') {
        const computedHash = this.hashText(text, algorithm);
        return computedHash === hashValue;
    }
}

function main() {
    const args = process.argv.slice(2);
    if (args.length < 1) {
        console.log('Usage:');
        console.log('  node encryption_tool.js encrypt <text> <password>');
        console.log('  node encryption_tool.js decrypt <encrypted> <iv> <password> [salt]');
        console.log('  node encryption_tool.js hash <text> [algorithm]');
        console.log('  node encryption_tool.js verify <text> <hash> [algorithm]');
        process.exit(1);
    }
    
    const tool = new EncryptionTool();
    const action = args[0];
    
    if (action === 'encrypt') {
        if (args.length < 3) {
            console.log('Usage: node encryption_tool.js encrypt <text> <password>');
            process.exit(1);
        }
        const text = args[1];
        const password = args[2];
        const result = tool.encryptAES(text, password);
        console.log(`[+] Encrypted: ${result.encrypted}`);
        console.log(`[+] IV: ${result.iv}`);
        console.log(`[+] Algorithm: ${result.algorithm}`);
        console.log(`[+] Salt: ${result.salt}`);
    } else if (action === 'decrypt') {
        if (args.length < 4) {
            console.log('Usage: node encryption_tool.js decrypt <encrypted> <iv> <password> [salt]');
            process.exit(1);
        }
        const encrypted = args[1];
        const iv = args[2];
        const password = args[3];
        const salt = args[4] || null;
        const decrypted = tool.decryptAES(encrypted, password, iv, salt);
        if (decrypted) {
            console.log(`[+] Decrypted: ${decrypted}`);
        }
    } else if (action === 'hash') {
        if (args.length < 2) {
            console.log('Usage: node encryption_tool.js hash <text> [algorithm]');
            process.exit(1);
        }
        const text = args[1];
        const algorithm = args[2] || 'sha256';
        const hashValue = tool.hashText(text, algorithm);
        console.log(`[+] Hash (${algorithm}): ${hashValue}`);
    } else if (action === 'verify') {
        if (args.length < 3) {
            console.log('Usage: node encryption_tool.js verify <text> <hash> [algorithm]');
            process.exit(1);
        }
        const text = args[1];
        const hashValue = args[2];
        const algorithm = args[3] || 'sha256';
        const isValid = tool.verifyHash(text, hashValue, algorithm);
        if (isValid) {
            console.log('[+] Hash verification: SUCCESS');
        } else {
            console.log('[-] Hash verification: FAILED');
        }
    }
}

if (require.main === module) {
    main();
}

module.exports = EncryptionTool;

