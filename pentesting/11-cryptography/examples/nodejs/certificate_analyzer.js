#!/usr/bin/env node
/**
 * Certificate Analyzer
 * Analyzes SSL/TLS certificates for security issues.
 */

const tls = require('tls');
const fs = require('fs');

class CertificateAnalyzer {
    constructor(hostname, port = 443) {
        this.hostname = hostname;
        this.port = port;
        this.cert = null;
        this.issues = [];
    }

    getCertificate() {
        return new Promise((resolve) => {
            console.log(`[*] Retrieving certificate from ${this.hostname}:${this.port}...`);
            
            const socket = tls.connect(this.port, this.hostname, {
                rejectUnauthorized: false
            }, () => {
                this.cert = socket.getPeerCertificate(true);
                socket.destroy();
                resolve(this.cert);
            });
            
            socket.on('error', (err) => {
                console.log(`[-] Error: ${err.message}`);
                resolve(null);
            });
        });
    }

    checkExpiration() {
        if (!this.cert) {
            return {};
        }
        
        const validTo = new Date(this.cert.valid_to);
        const now = new Date();
        const daysUntilExpiry = Math.floor((validTo - now) / (1000 * 60 * 60 * 24));
        
        const result = {
            expires: validTo,
            daysRemaining: daysUntilExpiry,
            isExpired: daysUntilExpiry < 0,
            isExpiringSoon: 0 <= daysUntilExpiry && daysUntilExpiry <= 30
        };
        
        if (result.isExpired) {
            this.issues.push('Certificate has expired!');
        } else if (result.isExpiringSoon) {
            this.issues.push(`Certificate expires in ${daysUntilExpiry} days!`);
        }
        
        return result;
    }

    async generateReport() {
        await this.getCertificate();
        
        let report = `# Certificate Analysis Report for ${this.hostname}:${this.port}\n\n`;
        
        if (!this.cert) {
            report += `[-] Could not retrieve certificate.\n\n`;
            return report;
        }
        
        report += `## Certificate Information\n\n`;
        report += `**Subject**: ${JSON.stringify(this.cert.subject)}\n\n`;
        report += `**Issuer**: ${JSON.stringify(this.cert.issuer)}\n\n`;
        report += `**Serial Number**: ${this.cert.serialNumber}\n\n`;
        
        const expiration = this.checkExpiration();
        report += `## Expiration Status\n\n`;
        report += `**Valid From**: ${this.cert.valid_from}\n\n`;
        report += `**Valid Until**: ${this.cert.valid_to}\n\n`;
        report += `**Days Remaining**: ${expiration.daysRemaining}\n\n`;
        
        if (this.issues.length > 0) {
            report += `## Issues Found\n\n`;
            this.issues.forEach(issue => {
                report += `⚠️ ${issue}\n`;
            });
            report += `\n`;
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Monitor certificate expiration\n`;
        report += `2. Renew certificates before expiration\n`;
        report += `3. Use strong key sizes (2048+ bits)\n`;
        report += `4. Use trusted certificate authorities\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node certificate_analyzer.js <hostname> [port]');
        console.log('Example: node certificate_analyzer.js example.com');
        process.exit(1);
    }
    
    const hostname = process.argv[2];
    const port = parseInt(process.argv[3]) || 443;
    
    const analyzer = new CertificateAnalyzer(hostname, port);
    const report = await analyzer.generateReport();
    
    const filename = `certificate_analysis_${hostname.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Certificate analysis complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only analyze certificates you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = CertificateAnalyzer;

