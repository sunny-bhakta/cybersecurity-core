#!/usr/bin/env node
/**
 * SSL/TLS Scanner
 * Scans SSL/TLS configurations for security issues.
 */

const tls = require('tls');
const fs = require('fs');

class SSLTLSScanner {
    constructor(host, port = 443) {
        this.host = host;
        this.port = port;
        this.findings = [];
    }

    scanSSL() {
        return new Promise((resolve) => {
            console.log(`[*] Scanning SSL/TLS on ${this.host}:${this.port}...`);
            
            const info = {
                version: null,
                cipher: null,
                certificate: null,
                vulnerabilities: []
            };
            
            const socket = tls.connect(this.port, this.host, {
                rejectUnauthorized: false
            }, () => {
                info.version = socket.getProtocol();
                info.cipher = socket.getCipher();
                
                const cert = socket.getPeerCertificate(true);
                if (cert) {
                    info.certificate = {
                        subject: cert.subject,
                        issuer: cert.issuer,
                        validFrom: cert.valid_from,
                        validTo: cert.valid_to
                    };
                }
                
                // Check for vulnerabilities
                if (info.version && info.version.includes('SSL')) {
                    info.vulnerabilities.push('Using deprecated SSL protocol');
                }
                
                if (info.cipher && info.cipher.name && info.cipher.name.includes('RC4')) {
                    info.vulnerabilities.push('Using weak RC4 cipher');
                }
                
                socket.destroy();
                resolve(info);
            });
            
            socket.on('error', (err) => {
                console.log(`[-] Error scanning SSL: ${err.message}`);
                resolve(info);
            });
        });
    }

    async generateReport() {
        const info = await this.scanSSL();
        
        let report = `# SSL/TLS Scan Report for ${this.host}:${this.port}\n\n`;
        
        report += `## SSL/TLS Information\n\n`;
        report += `**Protocol Version**: ${info.version || 'Not detected'}\n\n`;
        report += `**Cipher Suite**: ${info.cipher ? JSON.stringify(info.cipher) : 'Not detected'}\n\n`;
        
        if (info.certificate) {
            report += `## Certificate Information\n\n`;
            report += `**Subject**: ${JSON.stringify(info.certificate.subject)}\n\n`;
            report += `**Issuer**: ${JSON.stringify(info.certificate.issuer)}\n\n`;
            report += `**Valid From**: ${info.certificate.validFrom}\n\n`;
            report += `**Valid Until**: ${info.certificate.validTo}\n\n`;
        }
        
        if (info.vulnerabilities.length > 0) {
            report += `## Vulnerabilities Found\n\n`;
            info.vulnerabilities.forEach(vuln => {
                report += `⚠️ ${vuln}\n`;
            });
            report += `\n`;
        } else {
            report += `✅ No obvious SSL/TLS vulnerabilities detected.\n\n`;
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Use TLS 1.2 or higher\n`;
        report += `2. Disable weak ciphers\n`;
        report += `3. Use strong certificate algorithms\n`;
        report += `4. Keep certificates up to date\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node ssl_tls_scanner.js <host> [port]');
        console.log('Example: node ssl_tls_scanner.js example.com');
        process.exit(1);
    }
    
    const host = process.argv[2];
    const port = parseInt(process.argv[3]) || 443;
    
    const scanner = new SSLTLSScanner(host, port);
    const report = await scanner.generateReport();
    
    const filename = `ssl_tls_scan_${host.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] SSL/TLS scanning complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only scan systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = SSLTLSScanner;

