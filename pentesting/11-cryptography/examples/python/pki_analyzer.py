#!/usr/bin/env python3
"""
PKI Analyzer
Analyzes Public Key Infrastructure (PKI) configurations and certificates.
"""

import sys
import ssl
import socket
from typing import Dict, List

class PKIAnalyzer:
    def __init__(self, hostname: str, port: int = 443):
        self.hostname = hostname
        self.port = port
    
    def get_certificate(self) -> Dict:
        """Get SSL/TLS certificate"""
        print(f"[*] Getting certificate for {self.hostname}:{self.port}...")
        
        try:
            context = ssl.create_default_context()
            with socket.create_connection((self.hostname, self.port), timeout=10) as sock:
                with context.wrap_socket(sock, server_hostname=self.hostname) as ssock:
                    cert = ssock.getpeercert()
                    
                    return {
                        'subject': dict(x[0] for x in cert['subject']),
                        'issuer': dict(x[0] for x in cert['issuer']),
                        'version': cert.get('version', 'N/A'),
                        'serialNumber': cert.get('serialNumber', 'N/A'),
                        'notBefore': cert.get('notBefore', 'N/A'),
                        'notAfter': cert.get('notAfter', 'N/A'),
                        'subjectAltName': cert.get('subjectAltName', [])
                    }
        except Exception as e:
            print(f"[-] Error: {e}")
            return {}
    
    def analyze_certificate(self, cert: Dict) -> List[str]:
        """Analyze certificate for issues"""
        print("[*] Analyzing certificate...")
        
        issues = []
        
        if not cert:
            issues.append("Could not retrieve certificate")
            return issues
        
        # Check expiration
        from datetime import datetime
        if 'notAfter' in cert and cert['notAfter']:
            try:
                not_after = datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
                if not_after < datetime.now():
                    issues.append("Certificate has expired")
                elif (not_after - datetime.now()).days < 30:
                    issues.append("Certificate expires soon")
            except:
                pass
        
        # Check subject alternative names
        if 'subjectAltName' in cert:
            if not cert['subjectAltName']:
                issues.append("No subject alternative names")
        
        return issues
    
    def check_certificate_chain(self) -> List[Dict]:
        """Check certificate chain"""
        print("[*] Checking certificate chain...")
        
        chain = []
        
        # In real implementation, would retrieve full chain
        cert = self.get_certificate()
        if cert:
            chain.append(cert)
        
        return chain
    
    def generate_report(self) -> str:
        """Generate PKI analysis report"""
        report = f"# PKI Analysis Report for {self.hostname}:{self.port}\n\n"
        
        cert = self.get_certificate()
        
        if cert:
            report += "## Certificate Information\n\n"
            report += f"**Subject**: {cert.get('subject', {}).get('commonName', 'N/A')}\n\n"
            report += f"**Issuer**: {cert.get('issuer', {}).get('commonName', 'N/A')}\n\n"
            report += f"**Valid From**: {cert.get('notBefore', 'N/A')}\n\n"
            report += f"**Valid To**: {cert.get('notAfter', 'N/A')}\n\n"
            report += f"**Serial Number**: {cert.get('serialNumber', 'N/A')}\n\n"
            
            issues = self.analyze_certificate(cert)
            if issues:
                report += "## Issues Found\n\n"
                for issue in issues:
                    report += f"- ⚠️ {issue}\n"
                report += "\n"
        else:
            report += "[-] Could not retrieve certificate.\n\n"
        
        report += "## PKI Best Practices\n\n"
        report += "1. Use strong encryption algorithms\n"
        report += "2. Keep certificates up to date\n"
        report += "3. Use proper certificate chain\n"
        report += "4. Implement certificate pinning\n"
        report += "5. Monitor certificate expiration\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python pki_analyzer.py <hostname> [port]")
        print("Example: python pki_analyzer.py example.com 443")
        sys.exit(1)
    
    hostname = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 443
    
    analyzer = PKIAnalyzer(hostname, port)
    report = analyzer.generate_report()
    
    filename = f"pki_analysis_{hostname.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] PKI analysis complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

