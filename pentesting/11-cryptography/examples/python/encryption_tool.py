#!/usr/bin/env python3
"""
Encryption Tool
Demonstrates encryption and decryption using various algorithms.
"""

import hashlib
import base64
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from typing import Optional

class EncryptionTool:
    def __init__(self):
        pass
    
    def generate_key_from_password(self, password: str, salt: bytes = None) -> bytes:
        """Generate encryption key from password using PBKDF2"""
        if salt is None:
            salt = b'salt_12345678'  # In production, use random salt
        
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=salt,
            iterations=100000,
        )
        key = base64.urlsafe_b64encode(kdf.derive(password.encode()))
        return key
    
    def encrypt_aes(self, plaintext: str, password: str) -> dict:
        """Encrypt text using AES (Fernet)"""
        key = self.generate_key_from_password(password)
        fernet = Fernet(key)
        
        encrypted = fernet.encrypt(plaintext.encode())
        
        return {
            'encrypted': base64.b64encode(encrypted).decode(),
            'algorithm': 'AES-256',
            'salt': base64.b64encode(b'salt_12345678').decode()
        }
    
    def decrypt_aes(self, encrypted_data: str, password: str, salt: str = None) -> Optional[str]:
        """Decrypt text using AES (Fernet)"""
        try:
            if salt:
                salt_bytes = base64.b64decode(salt)
            else:
                salt_bytes = b'salt_12345678'
            
            key = self.generate_key_from_password(password, salt_bytes)
            fernet = Fernet(key)
            
            encrypted_bytes = base64.b64decode(encrypted_data)
            decrypted = fernet.decrypt(encrypted_bytes)
            
            return decrypted.decode()
        except Exception as e:
            print(f"[-] Decryption failed: {e}")
            return None
    
    def hash_text(self, text: str, algorithm: str = 'sha256') -> str:
        """Hash text using specified algorithm"""
        algorithms = {
            'md5': hashlib.md5,
            'sha1': hashlib.sha1,
            'sha256': hashlib.sha256,
            'sha512': hashlib.sha512
        }
        
        if algorithm not in algorithms:
            raise ValueError(f"Unsupported algorithm: {algorithm}")
        
        hash_func = algorithms[algorithm]
        return hash_func(text.encode()).hexdigest()
    
    def verify_hash(self, text: str, hash_value: str, algorithm: str = 'sha256') -> bool:
        """Verify text against hash"""
        computed_hash = self.hash_text(text, algorithm)
        return computed_hash == hash_value

def main():
    import sys
    
    tool = EncryptionTool()
    
    if len(sys.argv) < 2:
        print("Usage:")
        print("  python encryption_tool.py encrypt <text> <password>")
        print("  python encryption_tool.py decrypt <encrypted> <password> [salt]")
        print("  python encryption_tool.py hash <text> [algorithm]")
        print("  python encryption_tool.py verify <text> <hash> [algorithm]")
        sys.exit(1)
    
    action = sys.argv[1]
    
    if action == 'encrypt':
        if len(sys.argv) < 4:
            print("Usage: python encryption_tool.py encrypt <text> <password>")
            sys.exit(1)
        text = sys.argv[2]
        password = sys.argv[3]
        result = tool.encrypt_aes(text, password)
        print(f"[+] Encrypted: {result['encrypted']}")
        print(f"[+] Algorithm: {result['algorithm']}")
        print(f"[+] Salt: {result['salt']}")
    
    elif action == 'decrypt':
        if len(sys.argv) < 4:
            print("Usage: python encryption_tool.py decrypt <encrypted> <password> [salt]")
            sys.exit(1)
        encrypted = sys.argv[2]
        password = sys.argv[3]
        salt = sys.argv[4] if len(sys.argv) > 4 else None
        decrypted = tool.decrypt_aes(encrypted, password, salt)
        if decrypted:
            print(f"[+] Decrypted: {decrypted}")
    
    elif action == 'hash':
        if len(sys.argv) < 3:
            print("Usage: python encryption_tool.py hash <text> [algorithm]")
            sys.exit(1)
        text = sys.argv[2]
        algorithm = sys.argv[3] if len(sys.argv) > 3 else 'sha256'
        hash_value = tool.hash_text(text, algorithm)
        print(f"[+] Hash ({algorithm}): {hash_value}")
    
    elif action == 'verify':
        if len(sys.argv) < 4:
            print("Usage: python encryption_tool.py verify <text> <hash> [algorithm]")
            sys.exit(1)
        text = sys.argv[2]
        hash_value = sys.argv[3]
        algorithm = sys.argv[4] if len(sys.argv) > 4 else 'sha256'
        is_valid = tool.verify_hash(text, hash_value, algorithm)
        if is_valid:
            print("[+] Hash verification: SUCCESS")
        else:
            print("[-] Hash verification: FAILED")

if __name__ == '__main__':
    main()

