#!/usr/bin/env python3
"""
Certificate Analyzer
Analyzes SSL/TLS certificates for security issues.
"""

import sys
import socket
import ssl
from datetime import datetime
from typing import Dict

class CertificateAnalyzer:
    def __init__(self, hostname: str, port: int = 443):
        self.hostname = hostname
        self.port = port
        self.cert = None
        self.issues = []
    
    def get_certificate(self) -> Dict:
        """Retrieve SSL/TLS certificate"""
        print(f"[*] Retrieving certificate from {self.hostname}:{self.port}...")
        
        try:
            context = ssl.create_default_context()
            with socket.create_connection((self.hostname, self.port), timeout=10) as sock:
                with context.wrap_socket(sock, server_hostname=self.hostname) as ssock:
                    self.cert = ssock.getpeercert()
                    return self.cert
        except Exception as e:
            print(f"[-] Error: {e}")
            return None
    
    def check_expiration(self) -> Dict:
        """Check certificate expiration"""
        if not self.cert:
            return {}
        
        not_after = datetime.strptime(self.cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
        days_until_expiry = (not_after - datetime.now()).days
        
        result = {
            'expires': not_after,
            'days_remaining': days_until_expiry,
            'is_expired': days_until_expiry < 0,
            'is_expiring_soon': 0 <= days_until_expiry <= 30
        }
        
        if result['is_expired']:
            self.issues.append("Certificate has expired!")
        elif result['is_expiring_soon']:
            self.issues.append(f"Certificate expires in {days_until_expiry} days!")
        
        return result
    
    def check_signature_algorithm(self) -> Dict:
        """Check certificate signature algorithm"""
        if not self.cert:
            return {}
        
        # Check for weak algorithms
        weak_algorithms = ['MD5', 'SHA1']
        
        # Note: signature algorithm info may not be directly in cert dict
        # In real implementation, would parse certificate more thoroughly
        
        return {
            'algorithm': 'Unknown',
            'is_weak': False
        }
    
    def check_key_size(self) -> Dict:
        """Check certificate key size"""
        if not self.cert:
            return {}
        
        # Key size information typically requires parsing certificate
        # This is a simplified example
        
        return {
            'key_size': 'Unknown',
            'is_weak': False
        }
    
    def check_san(self) -> Dict:
        """Check Subject Alternative Names"""
        if not self.cert:
            return {}
        
        san = []
        if 'subjectAltName' in self.cert:
            san = self.cert['subjectAltName']
        
        return {
            'san': san,
            'has_san': len(san) > 0
        }
    
    def generate_report(self) -> str:
        """Generate certificate analysis report"""
        cert = self.get_certificate()
        
        report = f"# Certificate Analysis Report for {self.hostname}:{self.port}\n\n"
        
        if not cert:
            report += "[-] Could not retrieve certificate.\n"
            return report
        
        report += "## Certificate Information\n\n"
        
        # Subject
        subject = dict(x[0] for x in cert.get('subject', []))
        report += "### Subject\n\n"
        for key, value in subject.items():
            report += f"**{key}**: {value}\n"
        report += "\n"
        
        # Issuer
        issuer = dict(x[0] for x in cert.get('issuer', []))
        report += "### Issuer\n\n"
        for key, value in issuer.items():
            report += f"**{key}**: {value}\n"
        report += "\n"
        
        # Validity
        report += "### Validity\n\n"
        report += f"**Not Before**: {cert.get('notBefore', 'Unknown')}\n\n"
        report += f"**Not After**: {cert.get('notAfter', 'Unknown')}\n\n"
        
        # Expiration check
        expiry = self.check_expiration()
        if expiry:
            report += f"**Days Until Expiry**: {expiry.get('days_remaining', 'Unknown')}\n\n"
            if expiry.get('is_expired'):
                report += "⚠️ **WARNING**: Certificate has expired!\n\n"
            elif expiry.get('is_expiring_soon'):
                report += "⚠️ **WARNING**: Certificate expires soon!\n\n"
        
        # SAN
        san_info = self.check_san()
        if san_info.get('has_san'):
            report += "### Subject Alternative Names\n\n"
            for name_type, name_value in san_info.get('san', []):
                report += f"- {name_type}: {name_value}\n"
            report += "\n"
        
        # Issues
        if self.issues:
            report += "## Security Issues Found\n\n"
            for issue in self.issues:
                report += f"⚠️ {issue}\n"
            report += "\n"
        
        report += "## Recommendations\n\n"
        report += "1. Ensure certificate is not expired\n"
        report += "2. Use strong signature algorithms (SHA-256 or better)\n"
        report += "3. Use adequate key sizes (2048-bit RSA minimum)\n"
        report += "4. Include all hostnames in SAN\n"
        report += "5. Renew certificates before expiration\n"
        report += "6. Use certificate pinning where appropriate\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python certificate_analyzer.py <hostname> [port]")
        print("Example: python certificate_analyzer.py example.com")
        print("Example: python certificate_analyzer.py example.com 443")
        sys.exit(1)
    
    hostname = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 443
    
    analyzer = CertificateAnalyzer(hostname, port)
    
    report = analyzer.generate_report()
    
    filename = f"certificate_analysis_{hostname.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Certificate analysis complete")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()

