#!/usr/bin/env python3
"""
GCP Security Scanner
Scans Google Cloud Platform resources for security misconfigurations.
"""

import sys
import json
from typing import Dict, List

class GCPSecurityScanner:
    def __init__(self, project_id: str = None):
        self.project_id = project_id
        self.findings = []
    
    def check_storage_bucket_security(self, bucket: Dict) -> List[Dict]:
        """Check GCP Storage Bucket security"""
        print("[*] Checking Storage Bucket security...")
        
        findings = []
        
        # Check for public access
        iam_policy = bucket.get('iamConfiguration', {}).get('publicAccessPrevention', 'inherited')
        if iam_policy == 'enforced':
            # Check bucket policy
            if bucket.get('iamConfiguration', {}).get('uniformBucketLevelAccess', {}).get('enabled', False):
                # Check IAM bindings
                bindings = bucket.get('iam', {}).get('bindings', [])
                for binding in bindings:
                    if 'allUsers' in binding.get('members', []) or 'allAuthenticatedUsers' in binding.get('members', []):
                        findings.append({
                            'severity': 'High',
                            'issue': 'Public Bucket Access',
                            'description': 'Bucket is publicly accessible',
                            'resource': bucket.get('name', 'Unknown')
                        })
        
        # Check for versioning
        if not bucket.get('versioning', {}).get('enabled', False):
            findings.append({
                'severity': 'Medium',
                'issue': 'Versioning Not Enabled',
                'description': 'Bucket versioning is not enabled',
                'resource': bucket.get('name', 'Unknown')
            })
        
        return findings
    
    def check_compute_instance_security(self, instance: Dict) -> List[Dict]:
        """Check GCP Compute Instance security"""
        print("[*] Checking Compute Instance security...")
        
        findings = []
        
        # Check for public IP
        network_interfaces = instance.get('networkInterfaces', [])
        for ni in network_interfaces:
            access_configs = ni.get('accessConfigs', [])
            if access_configs:
                findings.append({
                    'severity': 'Medium',
                    'issue': 'Public IP Assigned',
                    'description': 'Instance has public IP address',
                    'resource': instance.get('name', 'Unknown')
                })
        
        # Check for service account
        service_account = instance.get('serviceAccounts', [])
        if service_account:
            email = service_account[0].get('email', '')
            if 'default' in email or 'compute@developer' in email:
                findings.append({
                    'severity': 'Medium',
                    'issue': 'Default Service Account',
                    'description': 'Instance uses default service account',
                    'resource': instance.get('name', 'Unknown')
                })
        
        return findings
    
    def check_sql_instance_security(self, sql_instance: Dict) -> List[Dict]:
        """Check GCP SQL Instance security"""
        print("[*] Checking SQL Instance security...")
        
        findings = []
        
        # Check for public IP
        ip_addresses = sql_instance.get('ipAddresses', [])
        for ip in ip_addresses:
            if ip.get('type') == 'PRIMARY' and ip.get('ipAddress'):
                findings.append({
                    'severity': 'High',
                    'issue': 'Public IP Enabled',
                    'description': 'SQL instance has public IP address',
                    'resource': sql_instance.get('name', 'Unknown')
                })
        
        # Check for SSL requirement
        if not sql_instance.get('settings', {}).get('ipConfiguration', {}).get('requireSsl', False):
            findings.append({
                'severity': 'High',
                'issue': 'SSL Not Required',
                'description': 'SQL instance does not require SSL',
                'resource': sql_instance.get('name', 'Unknown')
            })
        
        return findings
    
    def check_iam_policy(self, policy: Dict) -> List[Dict]:
        """Check GCP IAM Policy"""
        print("[*] Checking IAM Policy...")
        
        findings = []
        
        bindings = policy.get('bindings', [])
        for binding in bindings:
            role = binding.get('role', '')
            members = binding.get('members', [])
            
            # Check for overly permissive roles
            if 'roles/owner' in role or 'roles/editor' in role:
                findings.append({
                    'severity': 'High',
                    'issue': f'Overly Permissive Role: {role}',
                    'description': f'Role {role} grants excessive permissions',
                    'resource': 'IAM Policy'
                })
            
            # Check for public access
            if 'allUsers' in members or 'allAuthenticatedUsers' in members:
                findings.append({
                    'severity': 'Critical',
                    'issue': 'Public Access Granted',
                    'description': f'Public access granted with role: {role}',
                    'resource': 'IAM Policy'
                })
        
        return findings
    
    def scan_resources(self, resources: Dict) -> Dict:
        """Scan GCP resources for security issues"""
        print("[*] Scanning GCP resources...")
        
        # Scan storage buckets
        buckets = resources.get('buckets', [])
        for bucket in buckets:
            self.findings.extend(self.check_storage_bucket_security(bucket))
        
        # Scan compute instances
        instances = resources.get('instances', [])
        for instance in instances:
            self.findings.extend(self.check_compute_instance_security(instance))
        
        # Scan SQL instances
        sql_instances = resources.get('sql_instances', [])
        for sql_instance in sql_instances:
            self.findings.extend(self.check_sql_instance_security(sql_instance))
        
        # Scan IAM policy
        if 'iam_policy' in resources:
            self.findings.extend(self.check_iam_policy(resources['iam_policy']))
        
        return {
            'findings': self.findings,
            'resources_scanned': len(buckets) + len(instances) + len(sql_instances)
        }
    
    def generate_report(self) -> str:
        """Generate GCP security scan report"""
        report = "# GCP Security Scan Report\n\n"
        
        if self.project_id:
            report += f"**Project ID**: {self.project_id}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'resource' in finding:
                    report += f"**Resource**: {finding['resource']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## Best Practices\n\n"
        report += "1. Use private IPs where possible\n"
        report += "2. Enable VPC Flow Logs\n"
        report += "3. Implement least privilege IAM\n"
        report += "4. Enable Cloud Security Command Center\n"
        report += "5. Use organization policies\n"
        report += "6. Enable audit logging\n"
        report += "7. Use service account keys securely\n\n"
        
        return report

def main():
    project_id = sys.argv[1] if len(sys.argv) > 1 else None
    
    scanner = GCPSecurityScanner(project_id)
    
    # In real implementation, would fetch resources from GCP API
    print("[!] Note: Real implementation requires GCP SDK")
    print("[!] Use: google-cloud-resource-manager or gcloud CLI")
    
    resources = {}  # Placeholder
    scanner.scan_resources(resources)
    
    report = scanner.generate_report()
    
    filename = "gcp_security_scan.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] GCP security scan complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

