#!/usr/bin/env python3
"""
Secret Scanner
Scans code repositories and files for exposed secrets and credentials.
"""

import sys
import os
import re
from typing import List, Dict

class SecretScanner:
    def __init__(self, target_path: str):
        self.target_path = target_path
        self.findings = []
        self.patterns = {
            'AWS_ACCESS_KEY': r'AKIA[0-9A-Z]{16}',
            'AWS_SECRET_KEY': r'aws_secret_access_key\s*=\s*["\']?([A-Za-z0-9/+=]{40})["\']?',
            'API_KEY': r'api[_-]?key\s*[:=]\s*["\']?([A-Za-z0-9]{20,})["\']?',
            'PRIVATE_KEY': r'-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----',
            'PASSWORD': r'password\s*[:=]\s*["\']?([^"\'\s]{8,})["\']?',
            'TOKEN': r'token\s*[:=]\s*["\']?([A-Za-z0-9]{20,})["\']?',
            'SECRET': r'secret\s*[:=]\s*["\']?([A-Za-z0-9]{20,})["\']?',
            'DATABASE_URL': r'(postgres|mysql|mongodb)://[^\s"\']+',
            'GITHUB_TOKEN': r'ghp_[A-Za-z0-9]{36}',
            'SLACK_TOKEN': r'xox[baprs]-[0-9a-zA-Z-]{10,}',
            'STRIPE_KEY': r'sk_live_[0-9a-zA-Z]{24,}',
        }
    
    def scan_file(self, file_path: str) -> List[Dict]:
        """Scan a single file for secrets"""
        findings = []
        
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
                lines = content.split('\n')
                
                for line_num, line in enumerate(lines, 1):
                    for secret_type, pattern in self.patterns.items():
                        matches = re.finditer(pattern, line, re.IGNORECASE)
                        for match in matches:
                            # Mask the secret in output
                            secret_value = match.group(0)
                            if len(secret_value) > 20:
                                masked = secret_value[:10] + '...' + secret_value[-5:]
                            else:
                                masked = '***'
                            
                            findings.append({
                                'severity': 'High',
                                'type': secret_type,
                                'file': file_path,
                                'line': line_num,
                                'match': masked,
                                'description': f'Potential {secret_type} found'
                            })
        except Exception as e:
            print(f"[-] Error scanning {file_path}: {e}")
        
        return findings
    
    def scan_directory(self, directory: str) -> List[Dict]:
        """Scan directory recursively for secrets"""
        print(f"[*] Scanning directory: {directory}...")
        
        findings = []
        excluded_dirs = {'.git', 'node_modules', '.venv', 'venv', '__pycache__', '.pytest_cache'}
        excluded_extensions = {'.pyc', '.pyo', '.pyd', '.so', '.dll', '.exe', '.jpg', '.png', '.gif'}
        
        for root, dirs, files in os.walk(directory):
            # Exclude certain directories
            dirs[:] = [d for d in dirs if d not in excluded_dirs]
            
            for file in files:
                file_path = os.path.join(root, file)
                
                # Skip excluded file types
                if any(file.endswith(ext) for ext in excluded_extensions):
                    continue
                
                file_findings = self.scan_file(file_path)
                findings.extend(file_findings)
        
        return findings
    
    def scan(self) -> Dict:
        """Perform secret scan"""
        if os.path.isfile(self.target_path):
            self.findings = self.scan_file(self.target_path)
        elif os.path.isdir(self.target_path):
            self.findings = self.scan_directory(self.target_path)
        else:
            print(f"[-] Path not found: {self.target_path}")
            return {}
        
        return {
            'findings': self.findings,
            'total_secrets': len(self.findings)
        }
    
    def generate_report(self) -> str:
        """Generate secret scan report"""
        report = f"# Secret Scanner Report\n\n"
        report += f"**Target**: {self.target_path}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"**Total Secrets Found**: {len(self.findings)}\n\n"
            
            # Group by type
            by_type = {}
            for finding in self.findings:
                secret_type = finding['type']
                if secret_type not in by_type:
                    by_type[secret_type] = []
                by_type[secret_type].append(finding)
            
            report += "## Findings by Type\n\n"
            for secret_type, findings in by_type.items():
                report += f"### {secret_type}: {len(findings)} found\n\n"
            
            report += "## Detailed Findings\n\n"
            for i, finding in enumerate(self.findings[:50], 1):  # Limit to 50
                report += f"### {i}. {finding['type']}\n\n"
                report += f"**File**: `{finding['file']}`\n\n"
                report += f"**Line**: {finding['line']}\n\n"
                report += f"**Match**: `{finding['match']}`\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                report += "---\n\n"
            
            if len(self.findings) > 50:
                report += f"\n*... and {len(self.findings) - 50} more findings*\n\n"
        else:
            report += "âœ… No secrets found.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Remove secrets from code immediately\n"
        report += "2. Rotate all exposed credentials\n"
        report += "3. Use environment variables or secret managers\n"
        report += "4. Add secrets to .gitignore\n"
        report += "5. Use pre-commit hooks to prevent commits\n"
        report += "6. Enable secret scanning in CI/CD\n"
        report += "7. Review git history for exposed secrets\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python secret_scanner.py <file_or_directory>")
        print("Example: python secret_scanner.py /path/to/repo")
        print("Example: python secret_scanner.py config.json")
        sys.exit(1)
    
    target_path = sys.argv[1]
    
    scanner = SecretScanner(target_path)
    scanner.scan()
    
    report = scanner.generate_report()
    
    filename = "secret_scan_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Secret scan complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] Found {len(scanner.findings)} potential secrets")
    print("[!] WARNING: Review findings and rotate any exposed credentials!")

if __name__ == "__main__":
    main()

