#!/usr/bin/env python3
"""
S3 Bucket Scanner
Scans for publicly accessible S3 buckets and checks for misconfigurations.
"""

import boto3
import requests
from botocore.exceptions import ClientError, NoCredentialsError
from typing import List, Dict, Optional

class S3BucketScanner:
    def __init__(self):
        self.public_buckets = []
        self.vulnerable_buckets = []
    
    def check_bucket_exists(self, bucket_name: str) -> bool:
        """Check if S3 bucket exists"""
        try:
            # Try to access bucket via HTTP
            url = f"http://{bucket_name}.s3.amazonaws.com"
            response = requests.get(url, timeout=5)
            return response.status_code != 404
        except:
            try:
                # Try HTTPS
                url = f"https://{bucket_name}.s3.amazonaws.com"
                response = requests.get(url, timeout=5)
                return response.status_code != 404
            except:
                return False
    
    def check_bucket_public(self, bucket_name: str) -> Dict:
        """Check if bucket is publicly accessible"""
        result = {
            'bucket': bucket_name,
            'public': False,
            'listable': False,
            'readable': False,
            'writable': False,
            'details': {}
        }
        
        # Test public read access
        try:
            url = f"https://{bucket_name}.s3.amazonaws.com"
            response = requests.get(url, timeout=5)
            
            if response.status_code == 200:
                result['public'] = True
                result['listable'] = True
                result['details']['list_response'] = response.text[:500]
        except:
            pass
        
        # Test if we can list objects
        try:
            url = f"https://{bucket_name}.s3.amazonaws.com/?list-type=2"
            response = requests.get(url, timeout=5)
            
            if response.status_code == 200:
                result['listable'] = True
                result['details']['object_list'] = response.text[:1000]
        except:
            pass
        
        # Test write access (dangerous - use carefully)
        # This is just a check, not actual writing
        try:
            url = f"https://{bucket_name}.s3.amazonaws.com/test-write-check.txt"
            response = requests.put(url, data="test", timeout=5)
            
            if response.status_code in [200, 204]:
                result['writable'] = True
                # Clean up test file
                requests.delete(url, timeout=5)
        except:
            pass
        
        if result['public'] or result['listable'] or result['readable']:
            self.public_buckets.append(result)
            if result['writable']:
                self.vulnerable_buckets.append(result)
        
        return result
    
    def enumerate_bucket_contents(self, bucket_name: str) -> List[str]:
        """Attempt to enumerate bucket contents"""
        objects = []
        
        try:
            # Try listing via HTTP
            url = f"https://{bucket_name}.s3.amazonaws.com/?list-type=2"
            response = requests.get(url, timeout=10)
            
            if response.status_code == 200:
                # Parse XML response (simplified)
                import xml.etree.ElementTree as ET
                root = ET.fromstring(response.text)
                
                for content in root.findall('.//{http://s3.amazonaws.com/doc/2006-03-01/}Contents'):
                    key = content.find('{http://s3.amazonaws.com/doc/2006-03-01/}Key')
                    if key is not None:
                        objects.append(key.text)
        except Exception as e:
            print(f"[-] Error enumerating bucket: {e}")
        
        return objects
    
    def check_bucket_via_aws_cli(self, bucket_name: str) -> Optional[Dict]:
        """Check bucket using AWS CLI (requires credentials)"""
        try:
            s3_client = boto3.client('s3')
            
            # Get bucket ACL
            acl = s3_client.get_bucket_acl(Bucket=bucket_name)
            
            # Get bucket policy
            try:
                policy = s3_client.get_bucket_policy(Bucket=bucket_name)
            except ClientError:
                policy = None
            
            # Get bucket versioning
            try:
                versioning = s3_client.get_bucket_versioning(Bucket=bucket_name)
            except ClientError:
                versioning = None
            
            return {
                'acl': acl,
                'policy': policy,
                'versioning': versioning
            }
        except NoCredentialsError:
            print("[-] AWS credentials not configured")
            return None
        except ClientError as e:
            print(f"[-] Error accessing bucket via AWS CLI: {e}")
            return None
    
    def scan_bucket(self, bucket_name: str, use_aws_cli: bool = False) -> Dict:
        """Perform comprehensive bucket scan"""
        print(f"[*] Scanning bucket: {bucket_name}")
        
        result = {
            'bucket': bucket_name,
            'exists': False,
            'public_check': None,
            'aws_cli_check': None,
            'objects': []
        }
        
        # Check if bucket exists
        result['exists'] = self.check_bucket_exists(bucket_name)
        if not result['exists']:
            print(f"[-] Bucket does not exist or is not accessible")
            return result
        
        print(f"[+] Bucket exists")
        
        # Check public access
        result['public_check'] = self.check_bucket_public(bucket_name)
        
        # Use AWS CLI if credentials available
        if use_aws_cli:
            result['aws_cli_check'] = self.check_bucket_via_aws_cli(bucket_name)
        
        # Enumerate objects if bucket is listable
        if result['public_check']['listable']:
            print(f"[*] Enumerating bucket contents...")
            result['objects'] = self.enumerate_bucket_contents(bucket_name)
            print(f"[+] Found {len(result['objects'])} objects")
        
        return result
    
    def generate_report(self) -> str:
        """Generate scan report"""
        report = "# S3 Bucket Security Scan Report\n\n"
        report += "## Summary\n\n"
        report += f"Public Buckets Found: {len(self.public_buckets)}\n"
        report += f"Writable Buckets: {len(self.vulnerable_buckets)}\n\n"
        
        report += "## Public Buckets\n\n"
        for bucket in self.public_buckets:
            report += f"### {bucket['bucket']}\n\n"
            report += f"- **Public**: {bucket['public']}\n"
            report += f"- **Listable**: {bucket['listable']}\n"
            report += f"- **Readable**: {bucket['readable']}\n"
            report += f"- **Writable**: {bucket['writable']}\n\n"
        
        if self.vulnerable_buckets:
            report += "## ⚠️ CRITICAL: Writable Buckets\n\n"
            for bucket in self.vulnerable_buckets:
                report += f"- **{bucket['bucket']}**: Publicly writable!\n"
        
        return report

def main():
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: python s3_bucket_scanner.py <bucket_name> [bucket_name2] ...")
        print("Example: python s3_bucket_scanner.py my-bucket test-bucket")
        sys.exit(1)
    
    scanner = S3BucketScanner()
    
    bucket_names = sys.argv[1:]
    
    print(f"[*] Scanning {len(bucket_names)} bucket(s)\n")
    
    for bucket_name in bucket_names:
        result = scanner.scan_bucket(bucket_name)
        print()
    
    # Generate report
    report = scanner.generate_report()
    with open('s3_scan_report.md', 'w') as f:
        f.write(report)
    
    print(f"[+] Report saved to s3_scan_report.md")
    print(f"[!] WARNING: Only test buckets you own or have permission to test!")

if __name__ == '__main__':
    main()

