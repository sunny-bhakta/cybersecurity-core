#!/usr/bin/env python3
"""
Cloud API Security Tester
Tests cloud APIs for security vulnerabilities and misconfigurations.
"""

import sys
import requests
import json
from typing import Dict, List

class CloudAPISecurityTester:
    def __init__(self, api_endpoint: str):
        self.api_endpoint = api_endpoint
        self.findings = []
    
    def test_authentication(self) -> List[Dict]:
        """Test API authentication"""
        print("[*] Testing API authentication...")
        
        findings = []
        
        # Test without authentication
        try:
            response = requests.get(self.api_endpoint, timeout=10)
            if response.status_code == 200:
                findings.append({
                    'severity': 'Critical',
                    'issue': 'No Authentication Required',
                    'description': 'API endpoint is accessible without authentication',
                    'endpoint': self.api_endpoint
                })
        except:
            pass
        
        # Test with invalid credentials
        try:
            response = requests.get(
                self.api_endpoint,
                auth=('invalid', 'invalid'),
                timeout=10
            )
            if response.status_code == 200:
                findings.append({
                    'severity': 'High',
                    'issue': 'Weak Authentication',
                    'description': 'API accepts invalid credentials',
                    'endpoint': self.api_endpoint
                })
        except:
            pass
        
        return findings
    
    def test_authorization(self, token: str = None) -> List[Dict]:
        """Test API authorization"""
        print("[*] Testing API authorization...")
        
        findings = []
        
        # Test unauthorized access
        headers = {}
        if token:
            headers['Authorization'] = f'Bearer {token}'
        
        try:
            # Try accessing admin endpoints
            admin_endpoints = ['/admin', '/api/admin', '/management', '/api/v1/admin']
            for endpoint in admin_endpoints:
                url = self.api_endpoint.rstrip('/') + endpoint
                response = requests.get(url, headers=headers, timeout=10)
                if response.status_code == 200:
                    findings.append({
                        'severity': 'High',
                        'issue': 'Unauthorized Access',
                        'description': f'Unauthorized access to {endpoint}',
                        'endpoint': url
                    })
        except:
            pass
        
        return findings
    
    def test_rate_limiting(self) -> List[Dict]:
        """Test API rate limiting"""
        print("[*] Testing API rate limiting...")
        
        findings = []
        
        # Send multiple rapid requests
        try:
            for i in range(100):
                response = requests.get(self.api_endpoint, timeout=5)
                if response.status_code == 429:
                    break
            else:
                findings.append({
                    'severity': 'Medium',
                    'issue': 'No Rate Limiting',
                    'description': 'API does not implement rate limiting',
                    'endpoint': self.api_endpoint
                })
        except:
            pass
        
        return findings
    
    def test_input_validation(self) -> List[Dict]:
        """Test API input validation"""
        print("[*] Testing API input validation...")
        
        findings = []
        
        # Test SQL injection
        sql_payloads = ["' OR '1'='1", "'; DROP TABLE users--", "1' UNION SELECT NULL--"]
        for payload in sql_payloads:
            try:
                response = requests.get(
                    self.api_endpoint,
                    params={'id': payload},
                    timeout=10
                )
                if 'error' in response.text.lower() or 'sql' in response.text.lower():
                    findings.append({
                        'severity': 'High',
                        'issue': 'SQL Injection Vulnerability',
                        'description': f'Potential SQL injection with payload: {payload}',
                        'endpoint': self.api_endpoint
                    })
            except:
                pass
        
        # Test XSS
        xss_payloads = ['<script>alert(1)</script>', '"><img src=x onerror=alert(1)>']
        for payload in xss_payloads:
            try:
                response = requests.get(
                    self.api_endpoint,
                    params={'q': payload},
                    timeout=10
                )
                if payload in response.text:
                    findings.append({
                        'severity': 'Medium',
                        'issue': 'XSS Vulnerability',
                        'description': f'Potential XSS with payload: {payload}',
                        'endpoint': self.api_endpoint
                    })
            except:
                pass
        
        return findings
    
    def test_cors_configuration(self) -> List[Dict]:
        """Test CORS configuration"""
        print("[*] Testing CORS configuration...")
        
        findings = []
        
        try:
            response = requests.options(
                self.api_endpoint,
                headers={'Origin': 'https://evil.com'},
                timeout=10
            )
            
            cors_headers = {
                'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials'),
            }
            
            if cors_headers['Access-Control-Allow-Origin'] == '*':
                findings.append({
                    'severity': 'High',
                    'issue': 'Permissive CORS',
                    'description': 'CORS allows all origins (*)',
                    'endpoint': self.api_endpoint
                })
        except:
            pass
        
        return findings
    
    def test_all(self) -> Dict:
        """Run all security tests"""
        print(f"[*] Testing API: {self.api_endpoint}\n")
        
        self.findings.extend(self.test_authentication())
        self.findings.extend(self.test_authorization())
        self.findings.extend(self.test_rate_limiting())
        self.findings.extend(self.test_input_validation())
        self.findings.extend(self.test_cors_configuration())
        
        return {
            'endpoint': self.api_endpoint,
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate API security test report"""
        report = f"# Cloud API Security Test Report\n\n"
        report += f"**API Endpoint**: {self.api_endpoint}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'endpoint' in finding:
                    report += f"**Endpoint**: {finding['endpoint']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## Best Practices\n\n"
        report += "1. Implement strong authentication\n"
        report += "2. Use proper authorization checks\n"
        report += "3. Implement rate limiting\n"
        report += "4. Validate and sanitize all inputs\n"
        report += "5. Configure CORS properly\n"
        report += "6. Use HTTPS only\n"
        report += "7. Implement API versioning\n"
        report += "8. Enable logging and monitoring\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python cloud_api_security_tester.py <api_endpoint>")
        print("Example: python cloud_api_security_tester.py https://api.example.com/v1/users")
        sys.exit(1)
    
    api_endpoint = sys.argv[1]
    
    tester = CloudAPISecurityTester(api_endpoint)
    tester.test_all()
    
    report = tester.generate_report()
    
    filename = "cloud_api_security_test.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] API security testing complete")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only test APIs you own or have permission to test!")

if __name__ == "__main__":
    main()

