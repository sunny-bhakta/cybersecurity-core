#!/usr/bin/env python3
"""
Azure Security Scanner
Scans Azure resources for security misconfigurations and vulnerabilities.
"""

import sys
import json
from typing import Dict, List

class AzureSecurityScanner:
    def __init__(self, subscription_id: str = None):
        self.subscription_id = subscription_id
        self.findings = []
    
    def check_storage_account_security(self, storage_account: Dict) -> List[Dict]:
        """Check Azure Storage Account security"""
        print("[*] Checking Storage Account security...")
        
        findings = []
        
        # Check for public access
        if storage_account.get('properties', {}).get('allowBlobPublicAccess', True):
            findings.append({
                'severity': 'High',
                'issue': 'Public Blob Access Enabled',
                'description': 'Storage account allows public blob access',
                'resource': storage_account.get('name', 'Unknown')
            })
        
        # Check for HTTPS only
        if not storage_account.get('properties', {}).get('supportsHttpsTrafficOnly', True):
            findings.append({
                'severity': 'High',
                'issue': 'HTTPS Only Not Enforced',
                'description': 'Storage account allows HTTP traffic',
                'resource': storage_account.get('name', 'Unknown')
            })
        
        return findings
    
    def check_sql_database_security(self, sql_server: Dict) -> List[Dict]:
        """Check Azure SQL Database security"""
        print("[*] Checking SQL Database security...")
        
        findings = []
        
        # Check for public network access
        if sql_server.get('properties', {}).get('publicNetworkAccess') == 'Enabled':
            findings.append({
                'severity': 'High',
                'issue': 'Public Network Access Enabled',
                'description': 'SQL server allows public network access',
                'resource': sql_server.get('name', 'Unknown')
            })
        
        # Check for TLS version
        tls_version = sql_server.get('properties', {}).get('minimalTlsVersion')
        if not tls_version or tls_version < '1.2':
            findings.append({
                'severity': 'Medium',
                'issue': 'Weak TLS Version',
                'description': f'SQL server uses weak TLS version: {tls_version}',
                'resource': sql_server.get('name', 'Unknown')
            })
        
        return findings
    
    def check_key_vault_security(self, key_vault: Dict) -> List[Dict]:
        """Check Azure Key Vault security"""
        print("[*] Checking Key Vault security...")
        
        findings = []
        
        # Check for public network access
        network_acls = key_vault.get('properties', {}).get('networkAcls', {})
        if network_acls.get('defaultAction') == 'Allow':
            findings.append({
                'severity': 'High',
                'issue': 'Public Network Access Allowed',
                'description': 'Key Vault allows access from all networks',
                'resource': key_vault.get('name', 'Unknown')
            })
        
        # Check for soft delete
        if not key_vault.get('properties', {}).get('enableSoftDelete', False):
            findings.append({
                'severity': 'Medium',
                'issue': 'Soft Delete Not Enabled',
                'description': 'Key Vault does not have soft delete enabled',
                'resource': key_vault.get('name', 'Unknown')
            })
        
        return findings
    
    def check_virtual_machine_security(self, vm: Dict) -> List[Dict]:
        """Check Azure Virtual Machine security"""
        print("[*] Checking Virtual Machine security...")
        
        findings = []
        
        # Check for public IP
        network_profile = vm.get('properties', {}).get('networkProfile', {})
        if network_profile:
            # In real implementation, would check for public IPs
            pass
        
        # Check for encryption
        storage_profile = vm.get('properties', {}).get('storageProfile', {})
        os_disk = storage_profile.get('osDisk', {})
        if not os_disk.get('encryptionSettings'):
            findings.append({
                'severity': 'Medium',
                'issue': 'Disk Encryption Not Enabled',
                'description': 'VM disk encryption is not enabled',
                'resource': vm.get('name', 'Unknown')
            })
        
        return findings
    
    def scan_resources(self, resources: List[Dict]) -> Dict:
        """Scan Azure resources for security issues"""
        print("[*] Scanning Azure resources...")
        
        for resource in resources:
            resource_type = resource.get('type', '').lower()
            
            if 'storageaccount' in resource_type:
                self.findings.extend(self.check_storage_account_security(resource))
            elif 'sql' in resource_type:
                self.findings.extend(self.check_sql_database_security(resource))
            elif 'keyvault' in resource_type:
                self.findings.extend(self.check_key_vault_security(resource))
            elif 'virtualmachine' in resource_type:
                self.findings.extend(self.check_virtual_machine_security(resource))
        
        return {
            'findings': self.findings,
            'resources_scanned': len(resources)
        }
    
    def generate_report(self) -> str:
        """Generate Azure security scan report"""
        report = "# Azure Security Scan Report\n\n"
        
        if self.subscription_id:
            report += f"**Subscription ID**: {self.subscription_id}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'resource' in finding:
                    report += f"**Resource**: {finding['resource']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## Best Practices\n\n"
        report += "1. Enable network security groups\n"
        report += "2. Use private endpoints where possible\n"
        report += "3. Enable encryption at rest\n"
        report += "4. Implement least privilege access\n"
        report += "5. Enable Azure Security Center\n"
        report += "6. Use Azure Policy for compliance\n"
        report += "7. Enable diagnostic logging\n\n"
        
        return report

def main():
    subscription_id = sys.argv[1] if len(sys.argv) > 1 else None
    
    scanner = AzureSecurityScanner(subscription_id)
    
    # In real implementation, would fetch resources from Azure API
    print("[!] Note: Real implementation requires Azure SDK")
    print("[!] Use: azure-cli or azure-mgmt-resource library")
    
    resources = []  # Placeholder
    scanner.scan_resources(resources)
    
    report = scanner.generate_report()
    
    filename = "azure_security_scan.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Azure security scan complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

