#!/usr/bin/env python3
"""
AWS IAM Policy Analyzer
Analyzes AWS IAM policies for security misconfigurations and vulnerabilities.
"""

import sys
import json
import re
from typing import Dict, List

class AWSIAMPolicyAnalyzer:
    def __init__(self, policy_file: str = None):
        self.policy_file = policy_file
        self.findings = []
    
    def load_policy(self, policy_content: str) -> Dict:
        """Load and parse IAM policy"""
        try:
            if isinstance(policy_content, str):
                policy = json.loads(policy_content)
            else:
                policy = policy_content
            return policy
        except json.JSONDecodeError as e:
            print(f"[-] Error parsing policy JSON: {e}")
            return {}
    
    def analyze_policy(self, policy: Dict) -> List[Dict]:
        """Analyze IAM policy for security issues"""
        print("[*] Analyzing IAM policy...")
        
        findings = []
        
        if not policy:
            return findings
        
        statements = policy.get('Statement', [])
        if not isinstance(statements, list):
            statements = [statements]
        
        for i, statement in enumerate(statements):
            # Check for overly permissive actions
            actions = statement.get('Action', [])
            if not isinstance(actions, list):
                actions = [actions]
            
            if '*' in actions or 's3:*' in actions or 'ec2:*' in actions:
                findings.append({
                    'severity': 'High',
                    'issue': f'Overly Permissive Actions (Statement {i+1})',
                    'description': f'Policy allows wildcard or overly broad actions: {actions}',
                    'statement': i+1
                })
            
            # Check for wildcard resources
            resources = statement.get('Resource', [])
            if not isinstance(resources, list):
                resources = [resources]
            
            if '*' in resources:
                findings.append({
                    'severity': 'Critical',
                    'issue': f'Wildcard Resource (Statement {i+1})',
                    'description': 'Policy allows access to all resources (*)',
                    'statement': i+1
                })
            
            # Check for missing conditions
            if 'Condition' not in statement:
                if '*' in actions or '*' in resources:
                    findings.append({
                        'severity': 'Medium',
                        'issue': f'Missing Conditions (Statement {i+1})',
                        'description': 'Policy lacks conditions to restrict access',
                        'statement': i+1
                    })
            
            # Check for Allow + NotAction (dangerous combination)
            if statement.get('Effect') == 'Allow' and 'NotAction' in statement:
                findings.append({
                    'severity': 'High',
                    'issue': f'Allow with NotAction (Statement {i+1})',
                    'description': 'Allow with NotAction can be overly permissive',
                    'statement': i+1
                })
        
        return findings
    
    def check_principle_of_least_privilege(self, policy: Dict) -> List[Dict]:
        """Check if policy follows principle of least privilege"""
        print("[*] Checking principle of least privilege...")
        
        findings = []
        statements = policy.get('Statement', [])
        if not isinstance(statements, list):
            statements = [statements]
        
        for i, statement in enumerate(statements):
            actions = statement.get('Action', [])
            if not isinstance(actions, list):
                actions = [actions]
            
            # Check for admin-level actions
            admin_actions = ['*', 'iam:*', 'cloudformation:*', 'lambda:*']
            if any(action in admin_actions for action in actions):
                findings.append({
                    'severity': 'High',
                    'issue': f'Admin-Level Permissions (Statement {i+1})',
                    'description': 'Policy grants administrative permissions',
                    'statement': i+1
                })
        
        return findings
    
    def analyze_all(self, policy_content: str) -> Dict:
        """Perform complete policy analysis"""
        policy = self.load_policy(policy_content)
        
        if not policy:
            return {}
        
        self.findings.extend(self.analyze_policy(policy))
        self.findings.extend(self.check_principle_of_least_privilege(policy))
        
        return {
            'policy': policy,
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate IAM policy analysis report"""
        report = "# AWS IAM Policy Analysis Report\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'statement' in finding:
                    report += f"**Statement**: {finding['statement']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## Best Practices\n\n"
        report += "1. Follow principle of least privilege\n"
        report += "2. Avoid wildcard resources (*)\n"
        report += "3. Use specific actions instead of wildcards\n"
        report += "4. Implement conditions to restrict access\n"
        report += "5. Regularly review and audit policies\n"
        report += "6. Use IAM Access Analyzer\n"
        report += "7. Enable CloudTrail for audit logging\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python aws_iam_policy_analyzer.py <policy_file>")
        print("Example: python aws_iam_policy_analyzer.py policy.json")
        print("\nOr provide policy JSON as stdin:")
        print("cat policy.json | python aws_iam_policy_analyzer.py -")
        sys.exit(1)
    
    policy_file = sys.argv[1]
    
    if policy_file == '-':
        policy_content = sys.stdin.read()
    else:
        try:
            with open(policy_file, 'r') as f:
                policy_content = f.read()
        except FileNotFoundError:
            print(f"[-] Policy file not found: {policy_file}")
            sys.exit(1)
    
    analyzer = AWSIAMPolicyAnalyzer(policy_file)
    analyzer.analyze_all(policy_content)
    
    report = analyzer.generate_report()
    
    filename = "aws_iam_policy_analysis.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] IAM policy analysis complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

