#!/usr/bin/env node
/**
 * Azure Security Scanner
 * Scans Azure resources for security misconfigurations and vulnerabilities.
 */

const fs = require('fs');

class AzureSecurityScanner {
    constructor(subscriptionId = null) {
        this.subscriptionId = subscriptionId;
        this.findings = [];
    }

    checkStorageAccountSecurity(storageAccount) {
        console.log('[*] Checking Storage Account security...');
        
        const findings = [];
        
        if (storageAccount.properties?.allowBlobPublicAccess === true) {
            findings.push({
                severity: 'High',
                issue: 'Public Blob Access Enabled',
                description: 'Storage account allows public blob access',
                resource: storageAccount.name || 'Unknown'
            });
        }
        
        if (storageAccount.properties?.supportsHttpsTrafficOnly !== true) {
            findings.push({
                severity: 'High',
                issue: 'HTTPS Only Not Enforced',
                description: 'Storage account allows HTTP traffic',
                resource: storageAccount.name || 'Unknown'
            });
        }
        
        return findings;
    }

    checkSqlDatabaseSecurity(sqlServer) {
        console.log('[*] Checking SQL Database security...');
        
        const findings = [];
        
        if (sqlServer.properties?.publicNetworkAccess === 'Enabled') {
            findings.push({
                severity: 'High',
                issue: 'Public Network Access Enabled',
                description: 'SQL server allows public network access',
                resource: sqlServer.name || 'Unknown'
            });
        }
        
        const tlsVersion = sqlServer.properties?.minimalTlsVersion;
        if (!tlsVersion || tlsVersion < '1.2') {
            findings.push({
                severity: 'Medium',
                issue: 'Weak TLS Version',
                description: `SQL server uses weak TLS version: ${tlsVersion || 'default'}`,
                resource: sqlServer.name || 'Unknown'
            });
        }
        
        return findings;
    }

    checkKeyVaultSecurity(keyVault) {
        console.log('[*] Checking Key Vault security...');
        
        const findings = [];
        
        const networkAcls = keyVault.properties?.networkAcls || {};
        if (networkAcls.defaultAction === 'Allow') {
            findings.push({
                severity: 'High',
                issue: 'Public Network Access Allowed',
                description: 'Key Vault allows access from all networks',
                resource: keyVault.name || 'Unknown'
            });
        }
        
        if (keyVault.properties?.enableSoftDelete !== true) {
            findings.push({
                severity: 'Medium',
                issue: 'Soft Delete Not Enabled',
                description: 'Key Vault does not have soft delete enabled',
                resource: keyVault.name || 'Unknown'
            });
        }
        
        return findings;
    }

    scanResources(resources) {
        console.log('[*] Scanning Azure resources...');
        
        resources.forEach(resource => {
            const resourceType = (resource.type || '').toLowerCase();
            
            if (resourceType.includes('storageaccount')) {
                this.findings.push(...this.checkStorageAccountSecurity(resource));
            } else if (resourceType.includes('sql')) {
                this.findings.push(...this.checkSqlDatabaseSecurity(resource));
            } else if (resourceType.includes('keyvault')) {
                this.findings.push(...this.checkKeyVaultSecurity(resource));
            }
        });
        
        return {
            findings: this.findings,
            resourcesScanned: resources.length
        };
    }

    generateReport() {
        let report = `# Azure Security Scan Report\n\n`;
        
        if (this.subscriptionId) {
            report += `**Subscription ID**: ${this.subscriptionId}\n\n`;
        }
        
        if (this.findings.length > 0) {
            report += `## Summary\n\n`;
            report += `Total Findings: ${this.findings.length}\n\n`;
            
            const critical = this.findings.filter(f => f.severity === 'Critical');
            const high = this.findings.filter(f => f.severity === 'High');
            const medium = this.findings.filter(f => f.severity === 'Medium');
            
            report += `- **Critical**: ${critical.length}\n`;
            report += `- **High**: ${high.length}\n`;
            report += `- **Medium**: ${medium.length}\n\n`;
            
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                if (finding.resource) {
                    report += `**Resource**: ${finding.resource}\n\n`;
                }
                report += `---\n\n`;
            });
        } else {
            report += `âœ… No security issues found.\n\n`;
        }
        
        report += `## Best Practices\n\n`;
        report += `1. Enable network security groups\n`;
        report += `2. Use private endpoints where possible\n`;
        report += `3. Enable encryption at rest\n`;
        report += `4. Implement least privilege access\n`;
        report += `5. Enable Azure Security Center\n`;
        report += `6. Use Azure Policy for compliance\n`;
        report += `7. Enable diagnostic logging\n\n`;
        
        return report;
    }
}

function main() {
    const subscriptionId = process.argv[2] || null;
    
    const scanner = new AzureSecurityScanner(subscriptionId);
    
    console.log('[!] Note: Real implementation requires Azure SDK');
    console.log('[!] Use: @azure/arm-resources or azure-cli');
    
    const resources = []; // Placeholder
    scanner.scanResources(resources);
    
    const report = scanner.generateReport();
    
    const filename = 'azure_security_scan.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Azure security scan complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main();
}

module.exports = AzureSecurityScanner;

