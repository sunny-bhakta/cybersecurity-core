#!/usr/bin/env node
/**
 * Cloud Metadata Service Tester
 * Tests cloud metadata services for security vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class CloudMetadataServiceTester {
    constructor() {
        this.findings = [];
        this.metadataEndpoints = {
            aws: 'http://169.254.169.254/latest/meta-data/',
            azure: 'http://169.254.169.254/metadata/instance?api-version=2021-02-01',
            gcp: 'http://metadata.google.internal/computeMetadata/v1/',
            digitalocean: 'http://169.254.169.254/metadata/v1/'
        };
    }

    makeRequest(url, headers = {}) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            const req = protocol.get(url, { headers, timeout: 5000 }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: data, headers: res.headers });
                });
            });
            
            req.on('error', (err) => {
                reject(err);
            });
            
            req.on('timeout', () => {
                req.destroy();
                reject(new Error('Request timeout'));
            });
        });
    }

    async testAWSMetadata() {
        console.log('[*] Testing AWS metadata service...');
        
        try {
            const response = await this.makeRequest(this.metadataEndpoints.aws);
            if (response.statusCode === 200) {
                this.findings.push({
                    severity: 'High',
                    issue: 'AWS Metadata Service Accessible',
                    description: 'AWS metadata service is accessible without authentication',
                    endpoint: this.metadataEndpoints.aws,
                    response: response.text.substring(0, 200)
                });
            }
        } catch (err) {
            // Metadata service not accessible (expected in most cases)
        }
    }

    async testAzureMetadata() {
        console.log('[*] Testing Azure metadata service...');
        
        try {
            const headers = { 'Metadata': 'true' };
            const response = await this.makeRequest(this.metadataEndpoints.azure, headers);
            if (response.statusCode === 200) {
                this.findings.push({
                    severity: 'High',
                    issue: 'Azure Metadata Service Accessible',
                    description: 'Azure metadata service is accessible',
                    endpoint: this.metadataEndpoints.azure,
                    response: response.text.substring(0, 200)
                });
            }
        } catch (err) {
            // Metadata service not accessible
        }
    }

    async testGCPMetadata() {
        console.log('[*] Testing GCP metadata service...');
        
        try {
            const headers = { 'Metadata-Flavor': 'Google' };
            const response = await this.makeRequest(this.metadataEndpoints.gcp, headers);
            if (response.statusCode === 200) {
                this.findings.push({
                    severity: 'High',
                    issue: 'GCP Metadata Service Accessible',
                    description: 'GCP metadata service is accessible',
                    endpoint: this.metadataEndpoints.gcp,
                    response: response.text.substring(0, 200)
                });
            }
        } catch (err) {
            // Metadata service not accessible
        }
    }

    async testSSRFVulnerability(targetUrl) {
        console.log('[*] Testing SSRF vulnerability...');
        
        // In real implementation, would test if target can access metadata service
        console.log('[!] Note: Real implementation requires SSRF testing');
    }

    async testAll() {
        console.log('[*] Testing cloud metadata services...\n');
        
        await this.testAWSMetadata();
        await this.testAzureMetadata();
        await this.testGCPMetadata();
        
        return {
            findings: this.findings
        };
    }

    generateReport() {
        let report = `# Cloud Metadata Service Test Report\n\n`;
        
        if (this.findings.length > 0) {
            report += `## Summary\n\n`;
            report += `Total Findings: ${this.findings.length}\n\n`;
            
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                report += `**Endpoint**: ${finding.endpoint}\n\n`;
                if (finding.response) {
                    report += `**Response**: ${finding.response}\n\n`;
                }
                report += `---\n\n`;
            });
        } else {
            report += `âœ… Metadata services not accessible (expected behavior).\n\n`;
        }
        
        report += `## Security Risks\n\n`;
        report += `1. **Credential Exposure**: Metadata services may contain credentials\n`;
        report += `2. **SSRF Attacks**: Vulnerable applications can access metadata\n`;
        report += `3. **Instance Metadata**: Can reveal sensitive instance information\n\n`;
        
        report += `## Prevention\n\n`;
        report += `1. Use IMDSv2 (AWS) with session tokens\n`;
        report += `2. Restrict metadata service access\n`;
        report += `3. Use network policies to block metadata access\n`;
        report += `4. Implement SSRF protection\n`;
        report += `5. Use service accounts instead of instance metadata\n`;
        report += `6. Enable metadata service authentication\n\n`;
        
        return report;
    }
}

async function main() {
    const tester = new CloudMetadataServiceTester();
    await tester.testAll();
    
    const report = tester.generateReport();
    
    const filename = 'cloud_metadata_service_test.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Cloud metadata service testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test on systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = CloudMetadataServiceTester;

