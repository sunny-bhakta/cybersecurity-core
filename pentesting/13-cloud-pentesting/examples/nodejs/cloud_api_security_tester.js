#!/usr/bin/env node
/**
 * Cloud API Security Tester
 * Tests cloud APIs for security vulnerabilities and misconfigurations.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class CloudAPISecurityTester {
    constructor(apiEndpoint) {
        this.apiEndpoint = apiEndpoint;
        this.findings = [];
    }

    makeRequest(url, options = {}) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            protocol.get(url, { ...options, timeout: 10000 }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, headers: res.headers, text: data });
                });
            }).on('error', (err) => {
                reject(err);
            });
        });
    }

    async testAuthentication() {
        console.log('[*] Testing API authentication...');
        
        const findings = [];
        
        try {
            const response = await this.makeRequest(this.apiEndpoint);
            if (response.statusCode === 200) {
                findings.push({
                    severity: 'Critical',
                    issue: 'No Authentication Required',
                    description: 'API endpoint is accessible without authentication',
                    endpoint: this.apiEndpoint
                });
            }
        } catch (err) {
            // Ignore errors
        }
        
        return findings;
    }

    async testAuthorization(token = null) {
        console.log('[*] Testing API authorization...');
        
        const findings = [];
        
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const adminEndpoints = ['/admin', '/api/admin', '/management', '/api/v1/admin'];
        for (const endpoint of adminEndpoints) {
            try {
                const url = this.apiEndpoint.replace(/\/$/, '') + endpoint;
                const response = await this.makeRequest(url, { headers });
                if (response.statusCode === 200) {
                    findings.push({
                        severity: 'High',
                        issue: 'Unauthorized Access',
                        description: `Unauthorized access to ${endpoint}`,
                        endpoint: url
                    });
                }
            } catch (err) {
                // Ignore errors
            }
        }
        
        return findings;
    }

    async testRateLimiting() {
        console.log('[*] Testing API rate limiting...');
        
        const findings = [];
        
        try {
            let rateLimited = false;
            for (let i = 0; i < 100; i++) {
                const response = await this.makeRequest(this.apiEndpoint);
                if (response.statusCode === 429) {
                    rateLimited = true;
                    break;
                }
            }
            
            if (!rateLimited) {
                findings.push({
                    severity: 'Medium',
                    issue: 'No Rate Limiting',
                    description: 'API does not implement rate limiting',
                    endpoint: this.apiEndpoint
                });
            }
        } catch (err) {
            // Ignore errors
        }
        
        return findings;
    }

    async testInputValidation() {
        console.log('[*] Testing API input validation...');
        
        const findings = [];
        
        const sqlPayloads = ["' OR '1'='1", "'; DROP TABLE users--", "1' UNION SELECT NULL--"];
        for (const payload of sqlPayloads) {
            try {
                const url = new URL(this.apiEndpoint);
                url.searchParams.set('id', payload);
                const response = await this.makeRequest(url.toString());
                const text = response.text.toLowerCase();
                if (text.includes('error') || text.includes('sql')) {
                    findings.push({
                        severity: 'High',
                        issue: 'SQL Injection Vulnerability',
                        description: `Potential SQL injection with payload: ${payload}`,
                        endpoint: this.apiEndpoint
                    });
                }
            } catch (err) {
                // Ignore errors
            }
        }
        
        return findings;
    }

    async testCorsConfiguration() {
        console.log('[*] Testing CORS configuration...');
        
        const findings = [];
        
        try {
            const url = new URL(this.apiEndpoint);
            const options = {
                method: 'OPTIONS',
                headers: { 'Origin': 'https://evil.com' }
            };
            
            const response = await this.makeRequest(this.apiEndpoint, options);
            const corsOrigin = response.headers['access-control-allow-origin'];
            
            if (corsOrigin === '*') {
                findings.push({
                    severity: 'High',
                    issue: 'Permissive CORS',
                    description: 'CORS allows all origins (*)',
                    endpoint: this.apiEndpoint
                });
            }
        } catch (err) {
            // Ignore errors
        }
        
        return findings;
    }

    async testAll() {
        console.log(`[*] Testing API: ${this.apiEndpoint}\n`);
        
        this.findings.push(...await this.testAuthentication());
        this.findings.push(...await this.testAuthorization());
        this.findings.push(...await this.testRateLimiting());
        this.findings.push(...await this.testInputValidation());
        this.findings.push(...await this.testCorsConfiguration());
        
        return {
            endpoint: this.apiEndpoint,
            findings: this.findings
        };
    }

    generateReport() {
        let report = `# Cloud API Security Test Report\n\n`;
        report += `**API Endpoint**: ${this.apiEndpoint}\n\n`;
        
        if (this.findings.length > 0) {
            report += `## Summary\n\n`;
            report += `Total Findings: ${this.findings.length}\n\n`;
            
            const critical = this.findings.filter(f => f.severity === 'Critical');
            const high = this.findings.filter(f => f.severity === 'High');
            const medium = this.findings.filter(f => f.severity === 'Medium');
            
            report += `- **Critical**: ${critical.length}\n`;
            report += `- **High**: ${high.length}\n`;
            report += `- **Medium**: ${medium.length}\n\n`;
            
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                if (finding.endpoint) {
                    report += `**Endpoint**: ${finding.endpoint}\n\n`;
                }
                report += `---\n\n`;
            });
        } else {
            report += `âœ… No security issues found.\n\n`;
        }
        
        report += `## Best Practices\n\n`;
        report += `1. Implement strong authentication\n`;
        report += `2. Use proper authorization checks\n`;
        report += `3. Implement rate limiting\n`;
        report += `4. Validate and sanitize all inputs\n`;
        report += `5. Configure CORS properly\n`;
        report += `6. Use HTTPS only\n`;
        report += `7. Implement API versioning\n`;
        report += `8. Enable logging and monitoring\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node cloud_api_security_tester.js <api_endpoint>');
        console.log('Example: node cloud_api_security_tester.js https://api.example.com/v1/users');
        process.exit(1);
    }
    
    const apiEndpoint = process.argv[2];
    
    const tester = new CloudAPISecurityTester(apiEndpoint);
    await tester.testAll();
    
    const report = tester.generateReport();
    
    const filename = 'cloud_api_security_test.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] API security testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test APIs you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = CloudAPISecurityTester;

