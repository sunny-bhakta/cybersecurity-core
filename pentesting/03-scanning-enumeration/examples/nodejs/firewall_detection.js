#!/usr/bin/env node
/**
 * Firewall Detection Tool
 * Detects and analyzes firewall configurations.
 */

const net = require('net');
const fs = require('fs');

class FirewallDetection {
    constructor(target) {
        this.target = target;
        this.findings = [];
    }

    checkPortFiltering(ports) {
        return Promise.all(ports.map(port => {
            return new Promise((resolve) => {
                const sock = new net.Socket();
                sock.setTimeout(3000);
                
                sock.on('connect', () => {
                    sock.destroy();
                    resolve({ port, status: 'open' });
                });
                
                sock.on('timeout', () => {
                    sock.destroy();
                    resolve({ port, status: 'filtered' });
                });
                
                sock.on('error', () => {
                    resolve({ port, status: 'closed' });
                });
                
                sock.connect(port, this.target);
            });
        })).then(results => {
            const categorized = {
                open: [],
                filtered: [],
                closed: []
            };
            
            results.forEach(result => {
                categorized[result.status].push(result.port);
            });
            
            return categorized;
        });
    }

    detectFirewallByTiming(port = 80) {
        return new Promise((resolve) => {
            console.log(`[*] Detecting firewall by timing analysis on port ${port}...`);
            
            const startTime = Date.now();
            const sock = new net.Socket();
            sock.setTimeout(5000);
            
            sock.on('connect', () => {
                const elapsed = Date.now() - startTime;
                sock.destroy();
                resolve(elapsed > 2500); // Likely filtered if timeout
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve(true); // Timeout suggests filtering
            });
            
            sock.on('error', () => {
                resolve(false);
            });
            
            sock.connect(port, this.target);
        });
    }

    detectFirewallType(portResults) {
        console.log('[*] Attempting to identify firewall type...');
        
        if (portResults.filtered.length > portResults.open.length) {
            return 'Stateful Firewall (likely)';
        }
        
        return 'Unknown';
    }

    async generateReport() {
        const commonPorts = [21, 22, 23, 25, 53, 80, 110, 143, 443, 3306, 3389];
        const portResults = await this.checkPortFiltering(commonPorts);
        
        let report = `# Firewall Detection Report for ${this.target}\n\n`;
        
        report += `## Port Status\n\n`;
        report += `**Open Ports**: ${portResults.open.length}\n`;
        if (portResults.open.length > 0) {
            report += `- ${portResults.open.join(', ')}\n`;
        }
        report += `\n`;
        
        report += `**Filtered Ports**: ${portResults.filtered.length}\n`;
        if (portResults.filtered.length > 0) {
            report += `- ${portResults.filtered.join(', ')}\n`;
        }
        report += `\n`;
        
        report += `**Closed Ports**: ${portResults.closed.length}\n\n`;
        
        const hasFirewall = await this.detectFirewallByTiming();
        if (hasFirewall || portResults.filtered.length > 0) {
            report += `## Firewall Detection\n\n`;
            report += `⚠️ **Firewall Detected**: Ports appear to be filtered\n\n`;
            
            const firewallType = this.detectFirewallType(portResults);
            report += `**Firewall Type**: ${firewallType}\n\n`;
        } else {
            report += `## Firewall Detection\n\n`;
            report += `[-] No obvious firewall detected.\n\n`;
        }
        
        report += `## Firewall Detection Methods\n\n`;
        report += `1. **Port Filtering**: Check if ports are filtered\n`;
        report += `2. **Timing Analysis**: Analyze response times\n`;
        report += `3. **Fragmentation Testing**: Test fragmented packet handling\n`;
        report += `4. **Banner Grabbing**: Analyze error messages\n`;
        report += `5. **Traceroute**: Identify network path and firewalls\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Use multiple detection methods\n`;
        report += `2. Consider using Nmap's firewall detection features\n`;
        report += `3. Test from different network locations\n`;
        report += `4. Analyze response patterns carefully\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node firewall_detection.js <target_ip>');
        console.log('Example: node firewall_detection.js 192.168.1.100');
        process.exit(1);
    }
    
    const target = process.argv[2];
    const detector = new FirewallDetection(target);
    const report = await detector.generateReport();
    
    const filename = `firewall_detection_${target.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`\n[+] Firewall detection complete for ${target}`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only scan systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = FirewallDetection;

