#!/usr/bin/env node
/**
 * SMTP Enumeration Tool
 * Enumerates SMTP services for user enumeration and relay testing.
 */

const net = require('net');
const fs = require('fs');

class SMTPEnumeration {
    constructor(target, port = 25) {
        this.target = target;
        this.port = port;
        this.findings = [];
    }

    checkSmtpPort() {
        return new Promise((resolve) => {
            const sock = new net.Socket();
            sock.setTimeout(3000);
            
            sock.on('connect', () => {
                sock.destroy();
                resolve(true);
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve(false);
            });
            
            sock.on('error', () => {
                resolve(false);
            });
            
            sock.connect(this.port, this.target);
        });
    }

    getBanner() {
        return new Promise((resolve) => {
            const sock = new net.Socket();
            sock.setTimeout(5000);
            
            sock.on('connect', () => {
                let banner = '';
                sock.on('data', (data) => {
                    banner += data.toString('utf8');
                    sock.destroy();
                    resolve(banner.trim());
                });
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve(null);
            });
            
            sock.on('error', () => {
                resolve(null);
            });
            
            sock.connect(this.port, this.target);
        });
    }

    async enumerateUsers(usernames) {
        console.log(`[*] Enumerating users on ${this.target}...`);
        const validUsers = [];
        
        try {
            const sock = new net.Socket();
            sock.setTimeout(5000);
            
            await new Promise((resolve, reject) => {
                sock.on('connect', () => {
                    let data = '';
                    sock.on('data', (chunk) => {
                        data += chunk.toString('utf8');
                        if (data.includes('220')) {
                            // Banner received, start testing
                            for (const username of usernames.slice(0, 10)) {
                                sock.write(`VRFY ${username}\r\n`);
                                sock.once('data', (response) => {
                                    const resp = response.toString('utf8');
                                    if (resp.includes('250') || resp.includes('252')) {
                                        console.log(`[+] Valid user found: ${username}`);
                                        validUsers.push(username);
                                    }
                                });
                            }
                            setTimeout(() => {
                                sock.destroy();
                                resolve();
                            }, 1000);
                        }
                    });
                });
                
                sock.on('error', reject);
                sock.connect(this.port, this.target);
            });
        } catch (err) {
            console.log(`[-] Error: ${err.message}`);
        }
        
        return validUsers;
    }

    async testRelay() {
        console.log(`[*] Testing SMTP relay on ${this.target}...`);
        // In real implementation, would test relay
        return false;
    }

    async generateReport() {
        const portOpen = await this.checkSmtpPort();
        
        let report = `# SMTP Enumeration Report for ${this.target}:${this.port}\n\n`;
        
        if (!portOpen) {
            report += `[-] SMTP port (${this.port}) is not accessible.\n`;
            return report;
        }
        
        report += `[+] SMTP port (${this.port}) is open.\n\n`;
        
        const banner = await this.getBanner();
        if (banner) {
            report += `## SMTP Banner\n\n`;
            report += `\`\`\`\n${banner}\n\`\`\`\n\n`;
        }
        
        const commonUsers = ['admin', 'administrator', 'root', 'user', 'test'];
        const validUsers = await this.enumerateUsers(commonUsers);
        
        if (validUsers.length > 0) {
            report += `## Valid Users Found\n\n`;
            validUsers.forEach(user => {
                report += `- ${user}\n`;
            });
            report += `\n`;
        }
        
        const openRelay = await this.testRelay();
        if (openRelay) {
            report += `⚠️ **CRITICAL**: Open relay detected!\n\n`;
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Disable VRFY and EXPN commands\n`;
        report += `2. Configure relay restrictions\n`;
        report += `3. Use authentication for relaying\n`;
        report += `4. Implement rate limiting\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node smtp_enumeration.js <target_ip> [port]');
        console.log('Example: node smtp_enumeration.js 192.168.1.100');
        process.exit(1);
    }
    
    const target = process.argv[2];
    const port = parseInt(process.argv[3]) || 25;
    
    const enum = new SMTPEnumeration(target, port);
    const report = await enum.generateReport();
    
    const filename = `smtp_enum_${target.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] SMTP enumeration complete for ${target}:${port}`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only enumerate systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = SMTPEnumeration;

