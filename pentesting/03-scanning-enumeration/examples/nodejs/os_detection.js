#!/usr/bin/env node
/**
 * OS Detection Tool
 * Detects operating system of target hosts.
 */

const net = require('net');
const { exec } = require('child_process');
const { promisify } = require('util');
const fs = require('fs');
const execAsync = promisify(exec);

class OSDetection {
    constructor(target) {
        this.target = target;
        this.osInfo = {};
    }

    detectByBanner(port = 22) {
        return new Promise((resolve) => {
            console.log(`[*] Attempting OS detection via banner on port ${port}...`);
            
            const sock = new net.Socket();
            sock.setTimeout(5000);
            
            sock.on('connect', () => {
                let banner = '';
                sock.on('data', (data) => {
                    banner += data.toString('utf8');
                    sock.destroy();
                    
                    const bannerLower = banner.toLowerCase();
                    let detected = 'Unknown';
                    
                    if (bannerLower.includes('linux')) {
                        detected = 'Linux';
                    } else if (bannerLower.includes('windows') || bannerLower.includes('microsoft')) {
                        detected = 'Windows';
                    } else if (bannerLower.includes('unix')) {
                        detected = 'Unix';
                    } else if (bannerLower.includes('freebsd')) {
                        detected = 'FreeBSD';
                    } else if (bannerLower.includes('openbsd')) {
                        detected = 'OpenBSD';
                    }
                    
                    resolve(detected);
                });
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve('Unknown');
            });
            
            sock.on('error', () => {
                resolve('Unknown');
            });
            
            sock.connect(port, this.target);
        });
    }

    async detectByTtl() {
        console.log('[*] Attempting OS detection via TTL...');
        
        try {
            const { stdout } = await execAsync(`ping -c 1 ${this.target}`, { timeout: 5000 });
            const output = stdout.toLowerCase();
            
            if (output.includes('ttl=64') || output.includes('ttl=63')) {
                return 'Linux/Unix';
            } else if (output.includes('ttl=128') || output.includes('ttl=127')) {
                return 'Windows';
            } else if (output.includes('ttl=255') || output.includes('ttl=254')) {
                return 'Cisco/Network Device';
            }
        } catch (err) {
            // Ignore errors
        }
        
        return 'Unknown';
    }

    detectByTcpFingerprint() {
        console.log('[*] Attempting OS detection via TCP fingerprinting...');
        console.log('[!] Note: Real TCP fingerprinting requires specialized tools like Nmap');
        return 'Unknown';
    }

    async detectAll() {
        console.log(`[*] Starting OS detection for ${this.target}\n`);
        
        const results = {
            banner: await this.detectByBanner(),
            ttl: await this.detectByTtl(),
            tcpFingerprint: this.detectByTcpFingerprint(),
            detectedOs: 'Unknown'
        };
        
        // Determine most likely OS
        const osVotes = {};
        for (const [method, osName] of Object.entries(results)) {
            if (method !== 'detectedOs' && osName !== 'Unknown') {
                osVotes[osName] = (osVotes[osName] || 0) + 1;
            }
        }
        
        if (Object.keys(osVotes).length > 0) {
            results.detectedOs = Object.keys(osVotes).reduce((a, b) => 
                osVotes[a] > osVotes[b] ? a : b
            );
        }
        
        return results;
    }

    async generateReport() {
        const results = await this.detectAll();
        
        let report = `# OS Detection Report for ${this.target}\n\n`;
        
        report += `## Detection Results\n\n`;
        report += `**Banner Detection**: ${results.banner}\n\n`;
        report += `**TTL Detection**: ${results.ttl}\n\n`;
        report += `**TCP Fingerprint**: ${results.tcpFingerprint}\n\n`;
        
        if (results.detectedOs !== 'Unknown') {
            report += `## Detected OS\n\n`;
            report += `**Most Likely OS**: ${results.detectedOs}\n\n`;
        } else {
            report += `## Detection Status\n\n`;
            report += `[-] Could not reliably detect OS.\n\n`;
        }
        
        report += `## OS Detection Methods\n\n`;
        report += `1. **Banner Grabbing**: Analyze service banners\n`;
        report += `2. **TTL Analysis**: Analyze TTL values from ping\n`;
        report += `3. **TCP Fingerprinting**: Analyze TCP/IP stack behavior\n`;
        report += `4. **Port Scanning**: Identify open ports (OS-specific)\n`;
        report += `5. **Nmap OS Detection**: Use Nmap's -O flag\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Use multiple detection methods for accuracy\n`;
        report += `2. Consider using specialized tools like Nmap\n`;
        report += `3. Be aware that OS detection can be evaded\n`;
        report += `4. Use results to guide vulnerability assessment\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node os_detection.js <target_ip>');
        console.log('Example: node os_detection.js 192.168.1.100');
        process.exit(1);
    }
    
    const target = process.argv[2];
    const detector = new OSDetection(target);
    const report = await detector.generateReport();
    
    const filename = `os_detection_${target.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`\n[+] OS detection complete for ${target}`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only scan systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = OSDetection;

