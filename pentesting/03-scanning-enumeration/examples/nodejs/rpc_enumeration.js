#!/usr/bin/env node
/**
 * RPC Enumeration Tool
 * Enumerates RPC (Remote Procedure Call) services.
 */

const net = require('net');
const fs = require('fs');

class RPCEnumeration {
    constructor(target, port = 111) {
        this.target = target;
        this.port = port;
        this.findings = [];
    }

    checkRpcPort() {
        return new Promise((resolve) => {
            const sock = new net.Socket();
            sock.setTimeout(3000);
            
            sock.on('connect', () => {
                sock.destroy();
                resolve(true);
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve(false);
            });
            
            sock.on('error', () => {
                resolve(false);
            });
            
            sock.connect(this.port, this.target);
        });
    }

    enumerateRpcServices() {
        console.log(`[*] Enumerating RPC services on ${this.target}...`);
        
        const commonServices = [
            { name: 'portmapper', program: 100000, version: 2 },
            { name: 'nfs', program: 100003, version: 3 },
            { name: 'mountd', program: 100005, version: 3 },
            { name: 'yppasswdd', program: 100009, version: 1 },
            { name: 'ypbind', program: 100007, version: 2 },
            { name: 'ypxfrd', program: 100069, version: 1 },
            { name: 'rquotad', program: 100011, version: 1 },
            { name: 'rstatd', program: 100001, version: 3 },
            { name: 'rusersd', program: 100002, version: 2 },
            { name: 'sprayd', program: 100012, version: 1 }
        ];
        
        console.log('[!] Note: Real RPC enumeration requires rpcinfo or rpcbind protocol');
        console.log('[!] Use tools like rpcinfo -p for actual enumeration');
        
        return commonServices;
    }

    async generateReport() {
        const portOpen = await this.checkRpcPort();
        
        let report = `# RPC Enumeration Report for ${this.target}:${this.port}\n\n`;
        
        if (!portOpen) {
            report += `[-] RPC port (${this.port}) is not accessible.\n`;
            return report;
        }
        
        report += `[+] RPC port (${this.port}) is open.\n\n`;
        
        const services = this.enumerateRpcServices();
        if (services.length > 0) {
            report += `## RPC Services Found\n\n`;
            report += `| Service | Program ID | Version |\n`;
            report += `|---------|------------|--------|\n`;
            services.forEach(service => {
                report += `| ${service.name} | ${service.program} | ${service.version} |\n`;
            });
            report += `\n`;
        }
        
        report += `## Common RPC Security Issues\n\n`;
        report += `1. **Exposed RPC Services**: Services accessible without authentication\n`;
        report += `2. **Information Disclosure**: RPC reveals system information\n`;
        report += `3. **Version Vulnerabilities**: Outdated RPC implementations\n`;
        report += `4. **Unnecessary Services**: Running unused RPC services\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Disable unnecessary RPC services\n`;
        report += `2. Use firewall rules to restrict RPC access\n`;
        report += `3. Keep RPC implementations updated\n`;
        report += `4. Use RPC over secure channels when possible\n`;
        report += `5. Monitor RPC service access\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node rpc_enumeration.js <target_ip> [port]');
        console.log('Example: node rpc_enumeration.js 192.168.1.100');
        process.exit(1);
    }
    
    const target = process.argv[2];
    const port = parseInt(process.argv[3]) || 111;
    
    const enum = new RPCEnumeration(target, port);
    const report = await enum.generateReport();
    
    const filename = `rpc_enum_${target.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] RPC enumeration complete for ${target}:${port}`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only enumerate systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = RPCEnumeration;

