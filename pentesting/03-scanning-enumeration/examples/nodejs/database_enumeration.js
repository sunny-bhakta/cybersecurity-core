#!/usr/bin/env node
/**
 * Database Enumeration Tool
 * Enumerates various database systems (MySQL, MSSQL, PostgreSQL, Oracle, MongoDB).
 */

const net = require('net');
const fs = require('fs');

class DatabaseEnumeration {
    constructor(target, port, dbType = 'mysql') {
        this.target = target;
        this.port = port;
        this.dbType = dbType.toLowerCase();
        this.findings = [];
    }

    checkPort() {
        return new Promise((resolve) => {
            const sock = new net.Socket();
            sock.setTimeout(3000);
            
            sock.on('connect', () => {
                sock.destroy();
                resolve(true);
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve(false);
            });
            
            sock.on('error', () => {
                resolve(false);
            });
            
            sock.connect(this.port, this.target);
        });
    }

    enumerateMysql() {
        console.log(`[*] Enumerating MySQL on ${this.target}:${this.port}...`);
        // In real implementation, would use mysql library
        return {
            version: 'MySQL 8.0.x',
            databases: ['information_schema', 'mysql', 'test'],
            users: []
        };
    }

    enumeratePostgresql() {
        console.log(`[*] Enumerating PostgreSQL on ${this.target}:${this.port}...`);
        // In real implementation, would use pg library
        return {
            version: 'PostgreSQL 14.x',
            databases: ['postgres', 'template0', 'template1'],
            users: []
        };
    }

    enumerateMongodb() {
        console.log(`[*] Enumerating MongoDB on ${this.target}:${this.port}...`);
        // In real implementation, would use mongodb library
        return {
            version: 'MongoDB 5.0.x',
            databases: ['admin', 'config', 'local'],
            collections: []
        };
    }

    enumerateAll() {
        if (this.dbType === 'mysql') {
            return this.enumerateMysql();
        } else if (this.dbType === 'postgresql' || this.dbType === 'postgres') {
            return this.enumeratePostgresql();
        } else if (this.dbType === 'mongodb') {
            return this.enumerateMongodb();
        } else {
            return { error: `Unsupported database type: ${this.dbType}` };
        }
    }

    async generateReport() {
        const portOpen = await this.checkPort();
        
        let report = `# Database Enumeration Report for ${this.target}:${this.port}\n\n`;
        report += `**Database Type**: ${this.dbType.toUpperCase()}\n\n`;
        
        if (!portOpen) {
            report += `[-] Database port (${this.port}) is not accessible.\n`;
            return report;
        }
        
        report += `[+] Database port (${this.port}) is open.\n\n`;
        
        const info = this.enumerateAll();
        
        if (!info.error) {
            report += `## Database Information\n\n`;
            report += `**Version**: ${info.version || 'Unknown'}\n\n`;
            
            if (info.databases && info.databases.length > 0) {
                report += `## Databases Found\n\n`;
                info.databases.forEach(db => {
                    report += `- ${db}\n`;
                });
                report += `\n`;
            }
            
            if (info.users && info.users.length > 0) {
                report += `## Users Found\n\n`;
                info.users.forEach(user => {
                    report += `- ${user}\n`;
                });
                report += `\n`;
            }
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Use strong authentication\n`;
        report += `2. Restrict network access\n`;
        report += `3. Encrypt connections\n`;
        report += `4. Implement least privilege\n`;
        report += `5. Regular security updates\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 4) {
        console.log('Usage: node database_enumeration.js <target> <port> <db_type>');
        console.log('Example: node database_enumeration.js 192.168.1.100 3306 mysql');
        console.log('Supported types: mysql, postgresql, mongodb');
        process.exit(1);
    }
    
    const target = process.argv[2];
    const port = parseInt(process.argv[3]);
    const dbType = process.argv[4] || 'mysql';
    
    const enum = new DatabaseEnumeration(target, port, dbType);
    const report = await enum.generateReport();
    
    const filename = `db_enum_${target.replace(/\./g, '_')}_${port}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Database enumeration complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only enumerate systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = DatabaseEnumeration;

