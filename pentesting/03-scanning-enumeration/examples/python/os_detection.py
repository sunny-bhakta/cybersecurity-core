#!/usr/bin/env python3
"""
OS Detection Tool
Detects operating system of target hosts.
"""

import sys
import socket
from typing import Dict

class OSDetection:
    def __init__(self, target: str):
        self.target = target
        self.os_info = {}
    
    def detect_by_banner(self, port: int = 22) -> str:
        """Detect OS by service banner"""
        print(f"[*] Attempting OS detection via banner on port {port}...")
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, port))
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            
            # Analyze banner for OS indicators
            banner_lower = banner.lower()
            
            if 'linux' in banner_lower:
                return 'Linux'
            elif 'windows' in banner_lower or 'microsoft' in banner_lower:
                return 'Windows'
            elif 'unix' in banner_lower:
                return 'Unix'
            elif 'freebsd' in banner_lower:
                return 'FreeBSD'
            elif 'openbsd' in banner_lower:
                return 'OpenBSD'
            
            return 'Unknown'
        except:
            return 'Unknown'
    
    def detect_by_ttl(self) -> str:
        """Detect OS by TTL (Time To Live) value"""
        print(f"[*] Attempting OS detection via TTL...")
        
        try:
            import subprocess
            # Use ping to get TTL
            result = subprocess.run(
                ['ping', '-c', '1', self.target],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            # Parse TTL from ping output
            # TTL values: Linux/Unix ~64, Windows ~128, Cisco ~255
            output = result.stdout.lower()
            
            if 'ttl=' in output:
                # Extract TTL value (simplified)
                if 'ttl=64' in output or 'ttl=63' in output:
                    return 'Linux/Unix'
                elif 'ttl=128' in output or 'ttl=127' in output:
                    return 'Windows'
                elif 'ttl=255' in output or 'ttl=254' in output:
                    return 'Cisco/Network Device'
            
            return 'Unknown'
        except:
            return 'Unknown'
    
    def detect_by_tcp_fingerprint(self) -> str:
        """Detect OS by TCP fingerprinting"""
        print(f"[*] Attempting OS detection via TCP fingerprinting...")
        
        # In real implementation, would analyze:
        # - TCP window size
        # - TCP options
        # - Initial sequence number patterns
        # - TCP flags behavior
        
        print("[!] Note: Real TCP fingerprinting requires specialized tools like Nmap")
        return 'Unknown'
    
    def detect_all(self) -> Dict:
        """Perform all OS detection methods"""
        print(f"[*] Starting OS detection for {self.target}\n")
        
        results = {
            'banner': self.detect_by_banner(),
            'ttl': self.detect_by_ttl(),
            'tcp_fingerprint': self.detect_by_tcp_fingerprint(),
            'detected_os': 'Unknown'
        }
        
        # Determine most likely OS
        os_votes = {}
        for method, os_name in results.items():
            if os_name != 'Unknown':
                os_votes[os_name] = os_votes.get(os_name, 0) + 1
        
        if os_votes:
            results['detected_os'] = max(os_votes, key=os_votes.get)
        
        return results
    
    def generate_report(self) -> str:
        """Generate OS detection report"""
        results = self.detect_all()
        
        report = f"# OS Detection Report for {self.target}\n\n"
        
        report += "## Detection Results\n\n"
        report += f"**Banner Detection**: {results['banner']}\n\n"
        report += f"**TTL Detection**: {results['ttl']}\n\n"
        report += f"**TCP Fingerprint**: {results['tcp_fingerprint']}\n\n"
        
        if results['detected_os'] != 'Unknown':
            report += f"## Detected OS\n\n"
            report += f"**Most Likely OS**: {results['detected_os']}\n\n"
        else:
            report += "## Detection Status\n\n"
            report += "[-] Could not reliably detect OS.\n\n"
        
        report += "## OS Detection Methods\n\n"
        report += "1. **Banner Grabbing**: Analyze service banners\n"
        report += "2. **TTL Analysis**: Analyze TTL values from ping\n"
        report += "3. **TCP Fingerprinting**: Analyze TCP/IP stack behavior\n"
        report += "4. **Port Scanning**: Identify open ports (OS-specific)\n"
        report += "5. **Nmap OS Detection**: Use Nmap's -O flag\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use multiple detection methods for accuracy\n"
        report += "2. Consider using specialized tools like Nmap\n"
        report += "3. Be aware that OS detection can be evaded\n"
        report += "4. Use results to guide vulnerability assessment\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python os_detection.py <target_ip>")
        print("Example: python os_detection.py 192.168.1.100")
        sys.exit(1)
    
    target = sys.argv[1]
    
    detector = OSDetection(target)
    report = detector.generate_report()
    
    filename = f"os_detection_{target.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"\n[+] OS detection complete for {target}")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only scan systems you own or have permission to test!")

if __name__ == "__main__":
    main()

