#!/usr/bin/env python3
"""
IDS/IPS Evasion Tool
Demonstrates techniques for evading Intrusion Detection/Prevention Systems.
"""

import sys
import socket
import time
from typing import List, Dict

class IDSIPSEvasion:
    def __init__(self, target: str, port: int):
        self.target = target
        self.port = port
        self.techniques = []
    
    def fragmentation_evasion(self, data: bytes) -> List[bytes]:
        """Fragment packets to evade IDS/IPS"""
        print("[*] Using fragmentation evasion...")
        
        # Split data into fragments
        fragment_size = 8
        fragments = []
        
        for i in range(0, len(data), fragment_size):
            fragments.append(data[i:i+fragment_size])
        
        self.techniques.append("Fragmentation")
        return fragments
    
    def timing_evasion(self, delay: float = 2.0):
        """Use timing to evade IDS/IPS"""
        print(f"[*] Using timing evasion (delay: {delay}s)...")
        
        time.sleep(delay)
        self.techniques.append(f"Timing (delay: {delay}s)")
    
    def encoding_evasion(self, data: str) -> str:
        """Use encoding to evade signature detection"""
        print("[*] Using encoding evasion...")
        
        # URL encoding
        encoded = data.replace(' ', '%20').replace('/', '%2F')
        
        self.techniques.append("URL Encoding")
        return encoded
    
    def case_variation(self, data: str) -> str:
        """Use case variation to evade signatures"""
        print("[*] Using case variation evasion...")
        
        # Mix case
        varied = ''.join(c.upper() if i % 2 == 0 else c.lower() 
                        for i, c in enumerate(data))
        
        self.techniques.append("Case Variation")
        return varied
    
    def null_byte_injection(self, data: str) -> str:
        """Inject null bytes to evade detection"""
        print("[*] Using null byte injection...")
        
        # Insert null bytes
        modified = data.replace(' ', '\x00')
        
        self.techniques.append("Null Byte Injection")
        return modified
    
    def test_evasion(self, payload: str):
        """Test various evasion techniques"""
        print(f"[*] Testing IDS/IPS evasion techniques on {self.target}:{self.port}...")
        
        # Apply multiple evasion techniques
        encoded = self.encoding_evasion(payload)
        varied = self.case_variation(encoded)
        
        # Fragment if needed
        fragments = self.fragmentation_evasion(varied.encode())
        
        # Use timing
        self.timing_evasion(1.5)
        
        return {
            'original': payload,
            'evaded': varied,
            'fragments': len(fragments),
            'techniques': self.techniques
        }
    
    def generate_report(self) -> str:
        """Generate IDS/IPS evasion report"""
        report = f"# IDS/IPS Evasion Report for {self.target}:{self.port}\n\n"
        
        report += "⚠️ **WARNING**: This tool is for authorized security testing only!\n\n"
        
        report += "## Evasion Techniques Demonstrated\n\n"
        
        techniques = [
            "1. **Fragmentation**: Split packets to evade signature detection",
            "2. **Timing**: Use delays to avoid rate-based detection",
            "3. **Encoding**: Use various encodings (URL, Unicode, etc.)",
            "4. **Case Variation**: Mix upper/lower case to evade signatures",
            "5. **Null Byte Injection**: Insert null bytes in payloads",
            "6. **Protocol Tunneling**: Tunnel traffic through allowed protocols",
            "7. **Traffic Normalization**: Normalize traffic to bypass filters",
            "8. **Polymorphic Shellcode**: Use polymorphic techniques"
        ]
        
        for technique in techniques:
            report += f"{technique}\n"
        report += "\n"
        
        if self.techniques:
            report += "## Techniques Used\n\n"
            for technique in self.techniques:
                report += f"- {technique}\n"
            report += "\n"
        
        report += "## Detection Methods\n\n"
        report += "1. **Deep Packet Inspection**: Analyze packet contents\n"
        report += "2. **Behavioral Analysis**: Monitor for unusual patterns\n"
        report += "3. **Anomaly Detection**: Detect deviations from normal traffic\n"
        report += "4. **Multi-layered Defense**: Use multiple detection methods\n"
        report += "5. **Regular Updates**: Keep signatures and rules updated\n\n"
        
        report += "## Legal and Ethical Considerations\n\n"
        report += "⚠️ **WARNING**: IDS/IPS evasion techniques should only be used:\n"
        report += "- On systems you own\n"
        report += "- With explicit written authorization\n"
        report += "- In controlled testing environments\n"
        report += "- Following responsible disclosure practices\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python ids_ips_evasion.py <target> <port>")
        print("Example: python ids_ips_evasion.py 192.168.1.100 80")
        print("\n⚠️ WARNING: Only use for authorized security testing!")
        sys.exit(1)
    
    target = sys.argv[1]
    port = int(sys.argv[2])
    
    evader = IDSIPSEvasion(target, port)
    
    # Test with sample payload
    test_payload = "GET /index.html HTTP/1.1"
    evader.test_evasion(test_payload)
    
    report = evader.generate_report()
    
    filename = f"ids_ips_evasion_{target.replace('.', '_')}_{port}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"\n[+] IDS/IPS evasion testing complete")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only test systems you own or have permission to test!")

if __name__ == "__main__":
    main()

