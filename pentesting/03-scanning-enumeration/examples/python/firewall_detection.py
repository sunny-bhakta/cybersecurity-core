#!/usr/bin/env python3
"""
Firewall Detection Tool
Detects and analyzes firewall configurations.
"""

import sys
import socket
import time
from typing import List, Dict

class FirewallDetection:
    def __init__(self, target: str):
        self.target = target
        self.findings = []
    
    def check_port_filtering(self, ports: List[int]) -> Dict:
        """Check if ports are filtered by firewall"""
        print(f"[*] Checking port filtering on {self.target}...")
        
        results = {
            'open': [],
            'filtered': [],
            'closed': []
        }
        
        for port in ports:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(3)
                result = sock.connect_ex((self.target, port))
                sock.close()
                
                if result == 0:
                    results['open'].append(port)
                else:
                    # Check if filtered (timeout) or closed (immediate rejection)
                    results['filtered'].append(port)
            except socket.timeout:
                results['filtered'].append(port)
            except:
                results['closed'].append(port)
        
        return results
    
    def detect_firewall_by_timing(self, port: int = 80) -> bool:
        """Detect firewall by response timing"""
        print(f"[*] Detecting firewall by timing analysis on port {port}...")
        
        try:
            start_time = time.time()
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            result = sock.connect_ex((self.target, port))
            elapsed = time.time() - start_time
            sock.close()
            
            # Filtered ports typically timeout, closed ports respond quickly
            if elapsed > 2.5:
                return True  # Likely filtered by firewall
        except:
            pass
        
        return False
    
    def test_fragmentation(self) -> bool:
        """Test if firewall handles fragmented packets"""
        print(f"[*] Testing firewall fragmentation handling...")
        
        # In real implementation, would send fragmented packets
        # This is a simplified example
        print("[!] Note: Real fragmentation testing requires packet crafting")
        return False
    
    def detect_firewall_type(self) -> str:
        """Attempt to identify firewall type"""
        print(f"[*] Attempting to identify firewall type...")
        
        # Common indicators:
        # - Response patterns
        # - Error messages
        # - Port behavior
        
        firewall_type = "Unknown"
        
        # Check common firewall ports
        common_ports = [80, 443, 22, 21, 25]
        port_results = self.check_port_filtering(common_ports)
        
        if len(port_results['filtered']) > len(port_results['open']):
            firewall_type = "Stateful Firewall (likely)"
        
        return firewall_type
    
    def generate_report(self) -> str:
        """Generate firewall detection report"""
        report = f"# Firewall Detection Report for {self.target}\n\n"
        
        # Test common ports
        common_ports = [21, 22, 23, 25, 53, 80, 110, 143, 443, 3306, 3389]
        port_results = self.check_port_filtering(common_ports)
        
        report += "## Port Status\n\n"
        report += f"**Open Ports**: {len(port_results['open'])}\n"
        if port_results['open']:
            report += f"- {', '.join(map(str, port_results['open']))}\n"
        report += "\n"
        
        report += f"**Filtered Ports**: {len(port_results['filtered'])}\n"
        if port_results['filtered']:
            report += f"- {', '.join(map(str, port_results['filtered']))}\n"
        report += "\n"
        
        report += f"**Closed Ports**: {len(port_results['closed'])}\n\n"
        
        # Firewall detection
        has_firewall = self.detect_firewall_by_timing()
        if has_firewall or len(port_results['filtered']) > 0:
            report += "## Firewall Detection\n\n"
            report += "⚠️ **Firewall Detected**: Ports appear to be filtered\n\n"
            
            firewall_type = self.detect_firewall_type()
            report += f"**Firewall Type**: {firewall_type}\n\n"
        else:
            report += "## Firewall Detection\n\n"
            report += "[-] No obvious firewall detected.\n\n"
        
        report += "## Firewall Detection Methods\n\n"
        report += "1. **Port Filtering**: Check if ports are filtered\n"
        report += "2. **Timing Analysis**: Analyze response times\n"
        report += "3. **Fragmentation Testing**: Test fragmented packet handling\n"
        report += "4. **Banner Grabbing**: Analyze error messages\n"
        report += "5. **Traceroute**: Identify network path and firewalls\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use multiple detection methods\n"
        report += "2. Consider using Nmap's firewall detection features\n"
        report += "3. Test from different network locations\n"
        report += "4. Analyze response patterns carefully\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python firewall_detection.py <target_ip>")
        print("Example: python firewall_detection.py 192.168.1.100")
        sys.exit(1)
    
    target = sys.argv[1]
    
    detector = FirewallDetection(target)
    report = detector.generate_report()
    
    filename = f"firewall_detection_{target.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"\n[+] Firewall detection complete for {target}")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only scan systems you own or have permission to test!")

if __name__ == "__main__":
    main()

