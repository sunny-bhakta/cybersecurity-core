#!/usr/bin/env python3
"""
SMTP Enumeration Tool
Enumerates SMTP services for user enumeration and relay testing.
"""

import sys
import socket
from typing import List, Dict

class SMTPEnumeration:
    def __init__(self, target: str, port: int = 25):
        self.target = target
        self.port = port
        self.findings = []
    
    def check_smtp_port(self) -> bool:
        """Check if SMTP port is open"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((self.target, self.port))
            sock.close()
            return result == 0
        except:
            return False
    
    def get_banner(self) -> str:
        """Get SMTP banner"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, self.port))
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            return banner
        except:
            return None
    
    def enumerate_users(self, usernames: List[str]) -> List[str]:
        """Enumerate SMTP users using VRFY/EXPN"""
        print(f"[*] Enumerating users on {self.target}...")
        valid_users = []
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, self.port))
            sock.recv(1024)  # Receive banner
            
            for username in usernames[:10]:  # Limit to first 10
                # Try VRFY command
                sock.send(f"VRFY {username}\r\n".encode())
                response = sock.recv(1024).decode('utf-8', errors='ignore')
                
                if '250' in response or '252' in response:
                    print(f"[+] Valid user found: {username}")
                    valid_users.append(username)
            
            sock.close()
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return valid_users
    
    def test_relay(self) -> bool:
        """Test for open relay"""
        print(f"[*] Testing SMTP relay on {self.target}...")
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, self.port))
            sock.recv(1024)
            
            # Try to relay
            sock.send(b"MAIL FROM: test@external.com\r\n")
            response1 = sock.recv(1024).decode()
            
            sock.send(b"RCPT TO: test@external.com\r\n")
            response2 = sock.recv(1024).decode()
            
            sock.close()
            
            if '250' in response1 and '250' in response2:
                print("[+] Open relay detected!")
                return True
        except:
            pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate SMTP enumeration report"""
        report = f"# SMTP Enumeration Report for {self.target}:{self.port}\n\n"
        
        if not self.check_smtp_port():
            report += f"[-] SMTP port ({self.port}) is not accessible.\n"
            return report
        
        report += f"[+] SMTP port ({self.port}) is open.\n\n"
        
        banner = self.get_banner()
        if banner:
            report += f"## SMTP Banner\n\n```\n{banner}\n```\n\n"
        
        # Test common usernames
        common_users = ['admin', 'administrator', 'root', 'user', 'test']
        valid_users = self.enumerate_users(common_users)
        
        if valid_users:
            report += "## Valid Users Found\n\n"
            for user in valid_users:
                report += f"- {user}\n"
            report += "\n"
        
        open_relay = self.test_relay()
        if open_relay:
            report += "⚠️ **CRITICAL**: Open relay detected!\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Disable VRFY and EXPN commands\n"
        report += "2. Configure relay restrictions\n"
        report += "3. Use authentication for relaying\n"
        report += "4. Implement rate limiting\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python smtp_enumeration.py <target_ip> [port]")
        print("Example: python smtp_enumeration.py 192.168.1.100")
        sys.exit(1)
    
    target = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 25
    
    enum = SMTPEnumeration(target, port)
    
    report = enum.generate_report()
    
    filename = f"smtp_enum_{target.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] SMTP enumeration complete for {target}:{port}")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only enumerate systems you own or have permission to test!")

if __name__ == '__main__':
    main()


