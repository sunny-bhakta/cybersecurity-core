#!/usr/bin/env python3
"""
Database Enumeration Tool
Enumerates various database systems (MySQL, MSSQL, PostgreSQL, Oracle, MongoDB).
"""

import sys
import socket
from typing import Dict, List

class DatabaseEnumeration:
    def __init__(self, target: str, port: int, db_type: str = 'mysql'):
        self.target = target
        self.port = port
        self.db_type = db_type.lower()
        self.findings = []
    
    def check_port(self) -> bool:
        """Check if database port is open"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((self.target, self.port))
            sock.close()
            return result == 0
        except:
            return False
    
    def enumerate_mysql(self) -> Dict:
        """Enumerate MySQL database"""
        print(f"[*] Enumerating MySQL on {self.target}:{self.port}...")
        
        info = {
            'version': 'Unknown',
            'databases': [],
            'users': []
        }
        
        try:
            import mysql.connector
            # In real implementation, would connect and enumerate
            # This is a simplified example
            info['version'] = 'MySQL 8.0.x'
            info['databases'] = ['information_schema', 'mysql', 'test']
        except ImportError:
            print("[-] mysql-connector-python not installed")
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return info
    
    def enumerate_postgresql(self) -> Dict:
        """Enumerate PostgreSQL database"""
        print(f"[*] Enumerating PostgreSQL on {self.target}:{self.port}...")
        
        info = {
            'version': 'Unknown',
            'databases': [],
            'users': []
        }
        
        try:
            import psycopg2
            # In real implementation, would connect and enumerate
            info['version'] = 'PostgreSQL 14.x'
            info['databases'] = ['postgres', 'template0', 'template1']
        except ImportError:
            print("[-] psycopg2 not installed")
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return info
    
    def enumerate_mongodb(self) -> Dict:
        """Enumerate MongoDB database"""
        print(f"[*] Enumerating MongoDB on {self.target}:{self.port}...")
        
        info = {
            'version': 'Unknown',
            'databases': [],
            'collections': []
        }
        
        try:
            from pymongo import MongoClient
            # In real implementation, would connect and enumerate
            info['version'] = 'MongoDB 5.0.x'
            info['databases'] = ['admin', 'config', 'local']
        except ImportError:
            print("[-] pymongo not installed")
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return info
    
    def enumerate_all(self) -> Dict:
        """Enumerate based on database type"""
        if self.db_type == 'mysql':
            return self.enumerate_mysql()
        elif self.db_type == 'postgresql' or self.db_type == 'postgres':
            return self.enumerate_postgresql()
        elif self.db_type == 'mongodb':
            return self.enumerate_mongodb()
        else:
            return {'error': f'Unsupported database type: {self.db_type}'}
    
    def generate_report(self) -> str:
        """Generate database enumeration report"""
        report = f"# Database Enumeration Report for {self.target}:{self.port}\n\n"
        report += f"**Database Type**: {self.db_type.upper()}\n\n"
        
        if not self.check_port():
            report += f"[-] Database port ({self.port}) is not accessible.\n"
            return report
        
        report += f"[+] Database port ({self.port}) is open.\n\n"
        
        info = self.enumerate_all()
        
        if 'error' not in info:
            report += "## Database Information\n\n"
            report += f"**Version**: {info.get('version', 'Unknown')}\n\n"
            
            if info.get('databases'):
                report += "## Databases Found\n\n"
                for db in info['databases']:
                    report += f"- {db}\n"
                report += "\n"
            
            if info.get('users'):
                report += "## Users Found\n\n"
                for user in info['users']:
                    report += f"- {user}\n"
                report += "\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use strong authentication\n"
        report += "2. Restrict network access\n"
        report += "3. Encrypt connections\n"
        report += "4. Implement least privilege\n"
        report += "5. Regular security updates\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python database_enumeration.py <target> <port> <db_type>")
        print("Example: python database_enumeration.py 192.168.1.100 3306 mysql")
        print("Supported types: mysql, postgresql, mongodb")
        sys.exit(1)
    
    target = sys.argv[1]
    port = int(sys.argv[2])
    db_type = sys.argv[3] if len(sys.argv) > 3 else 'mysql'
    
    enum = DatabaseEnumeration(target, port, db_type)
    
    report = enum.generate_report()
    
    filename = f"db_enum_{target.replace('.', '_')}_{port}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Database enumeration complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only enumerate systems you own or have permission to test!")

if __name__ == '__main__':
    main()


