#!/usr/bin/env python3
"""
FTP Enumeration Tool
Enumerates FTP services for anonymous access and directory listings.
"""

import sys
import socket
import ftplib
from typing import List, Dict

class FTPEnumeration:
    def __init__(self, target: str, port: int = 21):
        self.target = target
        self.port = port
        self.findings = []
    
    def check_ftp_port(self) -> bool:
        """Check if FTP port is open"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((self.target, self.port))
            sock.close()
            return result == 0
        except:
            return False
    
    def test_anonymous_login(self) -> bool:
        """Test for anonymous FTP access"""
        print(f"[*] Testing anonymous login on {self.target}...")
        try:
            ftp = ftplib.FTP()
            ftp.connect(self.target, self.port, timeout=10)
            ftp.login('anonymous', 'anonymous@')
            
            # Try to list directory
            files = ftp.nlst()
            ftp.quit()
            
            print(f"[+] Anonymous login successful! Found {len(files)} items")
            return True
        except:
            print("[-] Anonymous login failed")
            return False
    
    def enumerate_directory(self, username: str = None, password: str = None) -> List[str]:
        """Enumerate FTP directory"""
        print(f"[*] Enumerating FTP directory...")
        files = []
        
        try:
            ftp = ftplib.FTP()
            ftp.connect(self.target, self.port, timeout=10)
            
            if username and password:
                ftp.login(username, password)
            else:
                ftp.login('anonymous', 'anonymous@')
            
            files = ftp.nlst()
            ftp.quit()
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return files
    
    def get_banner(self) -> str:
        """Get FTP banner"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            sock.connect((self.target, self.port))
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            return banner
        except:
            return "Not available"
    
    def generate_report(self) -> str:
        """Generate FTP enumeration report"""
        report = f"# FTP Enumeration Report for {self.target}:{self.port}\n\n"
        
        if not self.check_ftp_port():
            report += f"[-] FTP port ({self.port}) is not accessible.\n"
            return report
        
        report += f"[+] FTP port ({self.port}) is open.\n\n"
        
        banner = self.get_banner()
        report += f"## FTP Banner\n\n```\n{banner}\n```\n\n"
        
        anonymous = self.test_anonymous_login()
        if anonymous:
            report += "⚠️ **WARNING**: Anonymous FTP access is enabled!\n\n"
            files = self.enumerate_directory()
            if files:
                report += f"## Files/Directories Found ({len(files)})\n\n"
                for file in files[:20]:  # Limit to first 20
                    report += f"- {file}\n"
                if len(files) > 20:
                    report += f"\n... and {len(files) - 20} more\n"
                report += "\n"
        
        report += "## Recommendations\n\n"
        report += "1. Disable anonymous FTP access\n"
        report += "2. Use SFTP instead of FTP\n"
        report += "3. Implement strong authentication\n"
        report += "4. Restrict directory access\n"
        report += "5. Use encrypted connections (FTPS)\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python ftp_enumeration.py <target_ip> [port]")
        print("Example: python ftp_enumeration.py 192.168.1.100")
        sys.exit(1)
    
    target = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 21
    
    enum = FTPEnumeration(target, port)
    
    report = enum.generate_report()
    
    filename = f"ftp_enum_{target.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] FTP enumeration complete for {target}:{port}")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only enumerate systems you own or have permission to test!")

if __name__ == '__main__':
    main()

