#!/usr/bin/env node
/**
 * Patch Management Checker
 * Checks for missing patches and updates on systems.
 */

const { exec } = require('child_process');
const { promisify } = require('util');
const fs = require('fs');
const os = require('os');
const execAsync = promisify(exec);

class PatchManagementChecker {
    constructor(target = null) {
        this.target = target;
        this.missingPatches = [];
    }

    async checkWindowsUpdates() {
        console.log('[*] Checking Windows updates...');
        
        const patches = [];
        
        try {
            const { stdout } = await execAsync('wmic qfe list brief', { timeout: 30000 });
            const lines = stdout.split('\n');
            
            for (const line of lines.slice(1)) {
                if (line.trim()) {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length >= 2) {
                        patches.push({
                            kb: parts[0],
                            description: parts.slice(1).join(' ')
                        });
                    }
                }
            }
        } catch (err) {
            console.log('[-] Could not check Windows updates');
        }
        
        return patches;
    }

    async checkLinuxUpdates() {
        console.log('[*] Checking Linux package updates...');
        
        const patches = [];
        
        try {
            const { stdout } = await execAsync('apt list --upgradable', { timeout: 30000 });
            const lines = stdout.split('\n');
            
            for (const line of lines.slice(1)) {
                if (line.trim() && line.includes('/')) {
                    const parts = line.split('/');
                    const versionParts = parts[1] ? parts[1].split(/\s+/) : [];
                    patches.push({
                        package: parts[0],
                        current: versionParts[0] || 'N/A',
                        available: versionParts[1] || 'N/A'
                    });
                }
            }
        } catch (err) {
            console.log('[-] Could not check Linux updates');
        }
        
        return patches;
    }

    async checkSystem() {
        console.log('[*] Checking system for missing patches...');
        
        const system = os.platform();
        let patches = [];
        
        if (system === 'win32') {
            patches = await this.checkWindowsUpdates();
        } else if (system === 'linux') {
            patches = await this.checkLinuxUpdates();
        } else {
            console.log(`[-] Unsupported system: ${system}`);
        }
        
        return {
            system,
            patches,
            count: patches.length
        };
    }

    async generateReport() {
        const results = await this.checkSystem();
        
        let report = `# Patch Management Check Report\n\n`;
        report += `**System**: ${results.system}\n\n`;
        report += `**Updates Available**: ${results.count}\n\n`;
        
        if (results.patches.length > 0) {
            report += `## Available Updates\n\n`;
            
            if (results.system === 'win32') {
                report += `| KB Number | Description |\n`;
                report += `|-----------|-------------|\n`;
                results.patches.slice(0, 20).forEach(patch => {
                    report += `| ${patch.kb || 'N/A'} | ${(patch.description || 'N/A').substring(0, 50)}... |\n`;
                });
            } else {
                report += `| Package | Current | Available |\n`;
                report += `|---------|---------|-----------|\n`;
                results.patches.slice(0, 20).forEach(patch => {
                    report += `| ${patch.package || 'N/A'} | ${patch.current || 'N/A'} | ${patch.available || 'N/A'} |\n`;
                });
            }
            report += `\n`;
        } else {
            report += `âœ… System appears to be up to date.\n\n`;
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Install security updates promptly\n`;
        report += `2. Enable automatic updates when possible\n`;
        report += `3. Test updates in staging before production\n`;
        report += `4. Maintain an update schedule\n`;
        report += `5. Monitor for critical security patches\n\n`;
        
        return report;
    }
}

async function main() {
    const target = process.argv[2] || null;
    
    const checker = new PatchManagementChecker(target);
    const report = await checker.generateReport();
    
    const filename = 'patch_management_check.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Patch management check complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = PatchManagementChecker;

