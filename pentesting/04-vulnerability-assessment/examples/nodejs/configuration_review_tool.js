#!/usr/bin/env node
/**
 * Configuration Review Tool
 * Reviews system and application configurations for security issues.
 */

const fs = require('fs');
const os = require('os');

class ConfigurationReviewTool {
    constructor(configPath = null) {
        this.configPath = configPath;
        this.findings = [];
    }

    checkFilePermissions(filePath) {
        console.log(`[*] Checking permissions for: ${filePath}...`);
        
        const findings = {
            file: filePath,
            issues: []
        };
        
        try {
            if (!fs.existsSync(filePath)) {
                findings.issues.push('File does not exist');
                return findings;
            }
            
            const stats = fs.statSync(filePath);
            const mode = stats.mode;
            
            // Check if world-readable (others have read permission)
            if (mode & parseInt('004', 8)) {
                findings.issues.push('World-readable file');
            }
            
            // Check if world-writable (others have write permission)
            if (mode & parseInt('002', 8)) {
                findings.issues.push('World-writable file (CRITICAL)');
            }
        } catch (err) {
            findings.issues.push(`Error checking file: ${err.message}`);
        }
        
        return findings;
    }

    checkCommonConfigFiles() {
        console.log('[*] Checking common configuration files...');
        
        const commonConfigs = [
            '/etc/passwd',
            '/etc/shadow',
            '/etc/ssh/sshd_config',
            '/etc/apache2/apache2.conf',
            '/etc/nginx/nginx.conf',
            '.env',
            'config.json',
            'settings.py'
        ];
        
        const findings = [];
        for (const config of commonConfigs) {
            if (fs.existsSync(config)) {
                const finding = this.checkFilePermissions(config);
                if (finding.issues.length > 0) {
                    findings.push(finding);
                }
            }
        }
        
        return findings;
    }

    checkEnvVariables() {
        console.log('[*] Checking environment variables...');
        
        const sensitiveVars = [];
        const sensitivePatterns = ['PASSWORD', 'SECRET', 'KEY', 'TOKEN', 'API_KEY'];
        
        for (const [key, value] of Object.entries(process.env)) {
            for (const pattern of sensitivePatterns) {
                if (key.toUpperCase().includes(pattern)) {
                    sensitiveVars.push(key);
                    break;
                }
            }
        }
        
        return sensitiveVars;
    }

    reviewJsonConfig(configFile) {
        console.log(`[*] Reviewing JSON config: ${configFile}...`);
        
        const issues = [];
        
        try {
            const content = fs.readFileSync(configFile, 'utf8');
            const config = JSON.parse(content);
            const configStr = JSON.stringify(config).toLowerCase();
            
            if (configStr.includes('password') && !configStr.includes('encrypted')) {
                issues.push('Plaintext password found in config');
            }
            
            if (config.debug === true) {
                issues.push('Debug mode enabled in production');
            }
            
            if (config.ssl && config.ssl.verify === false) {
                issues.push('SSL verification disabled');
            }
        } catch (err) {
            issues.push(`Could not parse configuration file: ${err.message}`);
        }
        
        return issues;
    }

    generateReport() {
        let report = `# Configuration Review Report\n\n`;
        
        const configFindings = this.checkCommonConfigFiles();
        if (configFindings.length > 0) {
            report += `## Configuration File Issues\n\n`;
            configFindings.forEach(finding => {
                report += `### ${finding.file}\n\n`;
                finding.issues.forEach(issue => {
                    report += `- ⚠️ ${issue}\n`;
                });
                report += `\n`;
            });
        }
        
        const envVars = this.checkEnvVariables();
        if (envVars.length > 0) {
            report += `## Sensitive Environment Variables\n\n`;
            report += `⚠️ **WARNING**: Sensitive environment variables detected:\n\n`;
            envVars.forEach(v => {
                report += `- ${v}\n`;
            });
            report += `\n`;
        }
        
        report += `## Common Configuration Issues\n\n`;
        report += `1. **Weak Passwords**: Default or weak passwords\n`;
        report += `2. **Exposed Secrets**: Secrets in configuration files\n`;
        report += `3. **Debug Mode**: Debug enabled in production\n`;
        report += `4. **Insecure Protocols**: Use of insecure protocols\n`;
        report += `5. **Excessive Permissions**: Overly permissive file permissions\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Use environment variables for secrets\n`;
        report += `2. Restrict file permissions\n`;
        report += `3. Disable debug mode in production\n`;
        report += `4. Use secure protocols (HTTPS, SSH)\n`;
        report += `5. Regularly review configurations\n\n`;
        
        return report;
    }
}

function main() {
    const configPath = process.argv[2] || null;
    
    const reviewer = new ConfigurationReviewTool(configPath);
    const report = reviewer.generateReport();
    
    const filename = 'configuration_review.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Configuration review complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main();
}

module.exports = ConfigurationReviewTool;

