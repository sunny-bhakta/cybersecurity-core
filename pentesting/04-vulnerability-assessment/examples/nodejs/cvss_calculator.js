#!/usr/bin/env node
/**
 * CVSS Calculator
 * Calculates CVSS (Common Vulnerability Scoring System) scores.
 */

const fs = require('fs');

class CVSSCalculator {
    constructor() {
        this.baseMetrics = {
            AV: 'N', // Attack Vector
            AC: 'L', // Attack Complexity
            PR: 'N', // Privileges Required
            UI: 'N', // User Interaction
            S: 'U',  // Scope
            C: 'H',  // Confidentiality
            I: 'H',  // Integrity
            A: 'H'   // Availability
        };
    }

    calculateBaseScore(metrics = null) {
        if (metrics) {
            Object.assign(this.baseMetrics, metrics);
        }
        
        const m = this.baseMetrics;
        
        // Impact Sub-Score
        const impact = 1 - ((1 - this.confidentialityValue(m.C)) *
                           (1 - this.integrityValue(m.I)) *
                           (1 - this.availabilityValue(m.A)));
        
        let impactScore;
        if (m.S === 'U') {
            impactScore = 6.42 * impact;
        } else {
            impactScore = 7.52 * (impact - 0.029) - 3.25 * Math.pow(impact - 0.02, 15);
        }
        
        // Exploitability Sub-Score
        const exploitability = 8.22 * this.attackVectorValue(m.AV) *
                              this.attackComplexityValue(m.AC) *
                              this.privilegesRequiredValue(m.PR, m.S) *
                              this.userInteractionValue(m.UI);
        
        let baseScore;
        if (impactScore <= 0) {
            baseScore = 0.0;
        } else if (m.S === 'U') {
            baseScore = Math.min(impactScore + exploitability, 10.0);
        } else {
            baseScore = Math.min(1.08 * (impactScore + exploitability), 10.0);
        }
        
        return Math.round(baseScore * 10) / 10;
    }

    attackVectorValue(av) {
        const values = { N: 0.85, A: 0.62, L: 0.55, P: 0.2 };
        return values[av] || 0.85;
    }

    attackComplexityValue(ac) {
        const values = { L: 0.77, H: 0.44 };
        return values[ac] || 0.77;
    }

    privilegesRequiredValue(pr, scope) {
        if (scope === 'U') {
            const values = { N: 0.85, L: 0.62, H: 0.27 };
            return values[pr] || 0.85;
        } else {
            const values = { N: 0.85, L: 0.68, H: 0.50 };
            return values[pr] || 0.85;
        }
    }

    userInteractionValue(ui) {
        const values = { N: 0.85, R: 0.62 };
        return values[ui] || 0.85;
    }

    confidentialityValue(c) {
        const values = { N: 0.0, L: 0.22, H: 0.56 };
        return values[c] || 0.0;
    }

    integrityValue(i) {
        const values = { N: 0.0, L: 0.22, H: 0.56 };
        return values[i] || 0.0;
    }

    availabilityValue(a) {
        const values = { N: 0.0, L: 0.22, H: 0.56 };
        return values[a] || 0.0;
    }

    getSeverity(score) {
        if (score >= 9.0) return 'Critical';
        if (score >= 7.0) return 'High';
        if (score >= 4.0) return 'Medium';
        if (score > 0.0) return 'Low';
        return 'None';
    }

    generateReport(metrics = null) {
        const score = this.calculateBaseScore(metrics);
        const severity = this.getSeverity(score);
        
        if (metrics) {
            Object.assign(this.baseMetrics, metrics);
        }
        
        let report = `# CVSS Base Score Calculation\n\n`;
        report += `## Base Metrics\n\n`;
        report += `| Metric | Value | Description |\n`;
        report += `|--------|-------|-------------|\n`;
        report += `| **Attack Vector (AV)** | ${this.baseMetrics.AV} | ${this.avDescription(this.baseMetrics.AV)} |\n`;
        report += `| **Attack Complexity (AC)** | ${this.baseMetrics.AC} | ${this.acDescription(this.baseMetrics.AC)} |\n`;
        report += `| **Privileges Required (PR)** | ${this.baseMetrics.PR} | ${this.prDescription(this.baseMetrics.PR)} |\n`;
        report += `| **User Interaction (UI)** | ${this.baseMetrics.UI} | ${this.uiDescription(this.baseMetrics.UI)} |\n`;
        report += `| **Scope (S)** | ${this.baseMetrics.S} | ${this.sDescription(this.baseMetrics.S)} |\n`;
        report += `| **Confidentiality (C)** | ${this.baseMetrics.C} | ${this.cDescription(this.baseMetrics.C)} |\n`;
        report += `| **Integrity (I)** | ${this.baseMetrics.I} | ${this.iDescription(this.baseMetrics.I)} |\n`;
        report += `| **Availability (A)** | ${this.baseMetrics.A} | ${this.aDescription(this.baseMetrics.A)} |\n\n`;
        
        report += `## Score\n\n`;
        report += `**CVSS Base Score**: ${score}\n\n`;
        report += `**Severity**: ${severity}\n\n`;
        
        report += `## CVSS Vector String\n\n`;
        const vector = `CVSS:3.1/AV:${this.baseMetrics.AV}/AC:${this.baseMetrics.AC}/PR:${this.baseMetrics.PR}/UI:${this.baseMetrics.UI}/S:${this.baseMetrics.S}/C:${this.baseMetrics.C}/I:${this.baseMetrics.I}/A:${this.baseMetrics.A}`;
        report += `\`${vector}\`\n\n`;
        
        return report;
    }

    avDescription(av) {
        const desc = { N: 'Network', A: 'Adjacent', L: 'Local', P: 'Physical' };
        return desc[av] || 'Network';
    }

    acDescription(ac) {
        const desc = { L: 'Low', H: 'High' };
        return desc[ac] || 'Low';
    }

    prDescription(pr) {
        const desc = { N: 'None', L: 'Low', H: 'High' };
        return desc[pr] || 'None';
    }

    uiDescription(ui) {
        const desc = { N: 'None', R: 'Required' };
        return desc[ui] || 'None';
    }

    sDescription(s) {
        const desc = { U: 'Unchanged', C: 'Changed' };
        return desc[s] || 'Unchanged';
    }

    cDescription(c) {
        const desc = { N: 'None', L: 'Low', H: 'High' };
        return desc[c] || 'None';
    }

    iDescription(i) {
        const desc = { N: 'None', L: 'Low', H: 'High' };
        return desc[i] || 'None';
    }

    aDescription(a) {
        const desc = { N: 'None', L: 'Low', H: 'High' };
        return desc[a] || 'None';
    }
}

function main() {
    console.log('CVSS Calculator');
    console.log('='.repeat(50));
    
    const calculator = new CVSSCalculator();
    
    const metrics = {
        AV: 'N',
        AC: 'L',
        PR: 'N',
        UI: 'N',
        S: 'U',
        C: 'H',
        I: 'H',
        A: 'H'
    };
    
    const report = calculator.generateReport(metrics);
    
    const filename = 'cvss_calculation.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] CVSS calculation complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main();
}

module.exports = CVSSCalculator;

