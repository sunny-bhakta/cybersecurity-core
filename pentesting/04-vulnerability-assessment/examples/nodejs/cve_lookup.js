#!/usr/bin/env node
/**
 * CVE Lookup Tool
 * Looks up CVE information from vulnerability databases.
 */

const https = require('https');
const fs = require('fs');

class CVELookup {
    constructor() {
        this.apiUrls = {
            nvd: 'services.nvd.nist.gov',
            cveMitre: 'cve.mitre.org'
        };
    }

    makeRequest(hostname, path) {
        return new Promise((resolve, reject) => {
            https.get({
                hostname: hostname,
                path: path,
                timeout: 10000
            }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    try {
                        resolve(JSON.parse(data));
                    } catch (e) {
                        resolve(data);
                    }
                });
            }).on('error', (err) => {
                reject(err);
            });
        });
    }

    async lookupCVE(cveId) {
        console.log(`[*] Looking up CVE: ${cveId}...`);
        
        const info = {
            id: cveId,
            description: '',
            severity: '',
            cvssScore: '',
            published: '',
            references: []
        };
        
        try {
            const path = `/rest/json/cves/2.0?cveId=${cveId}`;
            const data = await this.makeRequest(this.apiUrls.nvd, path);
            
            if (data.vulnerabilities && data.vulnerabilities.length > 0) {
                const vuln = data.vulnerabilities[0].cve;
                info.description = vuln.descriptions?.[0]?.value || '';
                info.published = vuln.published || '';
                
                if (vuln.metrics) {
                    const metrics = vuln.metrics;
                    if (metrics.cvssMetricV31) {
                        const cvss = metrics.cvssMetricV31[0];
                        info.cvssScore = cvss.cvssData.baseScore;
                        info.severity = cvss.cvssData.baseSeverity;
                    }
                }
            }
        } catch (err) {
            console.log(`[-] Error: ${err.message}`);
        }
        
        return info;
    }

    generateReport(cveId, info) {
        let report = `# CVE Lookup Report: ${cveId}\n\n`;
        
        if (info.description) {
            report += `## Description\n\n`;
            report += `${info.description}\n\n`;
        }
        
        if (info.severity) {
            report += `## Severity Information\n\n`;
            report += `**Severity**: ${info.severity}\n\n`;
            report += `**CVSS Score**: ${info.cvssScore}\n\n`;
        }
        
        if (info.published) {
            report += `**Published**: ${info.published}\n\n`;
        }
        
        report += `## References\n\n`;
        report += `- NVD: https://nvd.nist.gov/vuln/detail/${cveId}\n`;
        report += `- MITRE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cveId}\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node cve_lookup.js <CVE-ID>');
        console.log('Example: node cve_lookup.js CVE-2021-44228');
        process.exit(1);
    }
    
    const cveId = process.argv[2];
    const lookup = new CVELookup();
    
    const info = await lookup.lookupCVE(cveId);
    const report = lookup.generateReport(cveId, info);
    
    const filename = `cve_${cveId.replace(/-/g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] CVE lookup complete for ${cveId}`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = CVELookup;

