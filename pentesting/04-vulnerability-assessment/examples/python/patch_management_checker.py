#!/usr/bin/env python3
"""
Patch Management Checker
Checks for missing patches and updates on systems.
"""

import sys
import subprocess
import platform
from typing import List, Dict

class PatchManagementChecker:
    def __init__(self, target: str = None):
        self.target = target
        self.missing_patches = []
    
    def check_windows_updates(self) -> List[Dict]:
        """Check Windows updates"""
        print("[*] Checking Windows updates...")
        
        patches = []
        
        try:
            # Use wmic to check updates
            result = subprocess.run(
                ['wmic', 'qfe', 'list', 'brief'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                lines = result.stdout.split('\n')
                for line in lines[1:]:  # Skip header
                    if line.strip():
                        parts = line.split()
                        if len(parts) >= 2:
                            patches.append({
                                'kb': parts[0],
                                'description': ' '.join(parts[1:])
                            })
        except:
            print("[-] Could not check Windows updates")
        
        return patches
    
    def check_linux_updates(self) -> List[Dict]:
        """Check Linux package updates"""
        print("[*] Checking Linux package updates...")
        
        patches = []
        
        try:
            # Check for available updates
            result = subprocess.run(
                ['apt', 'list', '--upgradable'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                lines = result.stdout.split('\n')
                for line in lines[1:]:  # Skip header
                    if line.strip() and '/' in line:
                        parts = line.split('/')
                        patches.append({
                            'package': parts[0],
                            'current': parts[1].split()[0] if len(parts) > 1 else 'N/A',
                            'available': parts[1].split()[1] if len(parts) > 1 and len(parts[1].split()) > 1 else 'N/A'
                        })
        except:
            print("[-] Could not check Linux updates")
        
        return patches
    
    def check_system(self) -> Dict:
        """Check current system for updates"""
        print("[*] Checking system for missing patches...")
        
        system = platform.system()
        patches = []
        
        if system == 'Windows':
            patches = self.check_windows_updates()
        elif system == 'Linux':
            patches = self.check_linux_updates()
        else:
            print(f"[-] Unsupported system: {system}")
        
        return {
            'system': system,
            'patches': patches,
            'count': len(patches)
        }
    
    def generate_report(self) -> str:
        """Generate patch management report"""
        results = self.check_system()
        
        report = "# Patch Management Check Report\n\n"
        report += f"**System**: {results['system']}\n\n"
        report += f"**Updates Available**: {results['count']}\n\n"
        
        if results['patches']:
            report += "## Available Updates\n\n"
            
            if results['system'] == 'Windows':
                report += "| KB Number | Description |\n"
                report += "|-----------|-------------|\n"
                for patch in results['patches'][:20]:
                    report += f"| {patch.get('kb', 'N/A')} | {patch.get('description', 'N/A')[:50]}... |\n"
            else:
                report += "| Package | Current | Available |\n"
                report += "|---------|---------|-----------|\n"
                for patch in results['patches'][:20]:
                    report += f"| {patch.get('package', 'N/A')} | {patch.get('current', 'N/A')} | {patch.get('available', 'N/A')} |\n"
            report += "\n"
        else:
            report += "âœ… System appears to be up to date.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Install security updates promptly\n"
        report += "2. Enable automatic updates when possible\n"
        report += "3. Test updates in staging before production\n"
        report += "4. Maintain an update schedule\n"
        report += "5. Monitor for critical security patches\n\n"
        
        return report

def main():
    target = sys.argv[1] if len(sys.argv) > 1 else None
    
    checker = PatchManagementChecker(target)
    report = checker.generate_report()
    
    filename = "patch_management_check.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Patch management check complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

