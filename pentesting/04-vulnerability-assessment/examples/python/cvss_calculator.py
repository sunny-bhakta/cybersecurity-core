#!/usr/bin/env python3
"""
CVSS Calculator
Calculates CVSS (Common Vulnerability Scoring System) scores.
"""

import sys
from typing import Dict

class CVSSCalculator:
    def __init__(self):
        self.base_metrics = {
            'AV': 'N',  # Attack Vector: N(etwork), A(djacent), L(ocal), P(hysical)
            'AC': 'L',  # Attack Complexity: L(ow), H(igh)
            'PR': 'N',  # Privileges Required: N(one), L(ow), H(igh)
            'UI': 'N',  # User Interaction: N(one), R(equired)
            'S': 'U',   # Scope: U(nchanged), C(hanged)
            'C': 'H',   # Confidentiality: N(one), L(ow), H(igh)
            'I': 'H',   # Integrity: N(one), L(ow), H(igh)
            'A': 'H'    # Availability: N(one), L(ow), H(igh)
        }
    
    def calculate_base_score(self, metrics: Dict[str, str] = None) -> float:
        """Calculate CVSS Base Score"""
        if metrics:
            self.base_metrics.update(metrics)
        
        m = self.base_metrics
        
        # Impact Sub-Score (ISC)
        impact = 1 - ((1 - self._confidentiality_value(m['C'])) *
                     (1 - self._integrity_value(m['I'])) *
                     (1 - self._availability_value(m['A'])))
        
        if m['S'] == 'U':
            impact = 6.42 * impact
        else:  # Scope Changed
            impact = 7.52 * (impact - 0.029) - 3.25 * ((impact - 0.02) ** 15)
        
        # Exploitability Sub-Score
        exploitability = 8.22 * self._attack_vector_value(m['AV']) * \
                        self._attack_complexity_value(m['AC']) * \
                        self._privileges_required_value(m['PR'], m['S']) * \
                        self._user_interaction_value(m['UI'])
        
        if impact <= 0:
            base_score = 0.0
        elif m['S'] == 'U':
            base_score = min(impact + exploitability, 10.0)
        else:
            base_score = min(1.08 * (impact + exploitability), 10.0)
        
        return round(base_score, 1)
    
    def _attack_vector_value(self, av: str) -> float:
        values = {'N': 0.85, 'A': 0.62, 'L': 0.55, 'P': 0.2}
        return values.get(av, 0.85)
    
    def _attack_complexity_value(self, ac: str) -> float:
        values = {'L': 0.77, 'H': 0.44}
        return values.get(ac, 0.77)
    
    def _privileges_required_value(self, pr: str, scope: str) -> float:
        if scope == 'U':
            values = {'N': 0.85, 'L': 0.62, 'H': 0.27}
        else:
            values = {'N': 0.85, 'L': 0.68, 'H': 0.50}
        return values.get(pr, 0.85)
    
    def _user_interaction_value(self, ui: str) -> float:
        values = {'N': 0.85, 'R': 0.62}
        return values.get(ui, 0.85)
    
    def _confidentiality_value(self, c: str) -> float:
        values = {'N': 0.0, 'L': 0.22, 'H': 0.56}
        return values.get(c, 0.0)
    
    def _integrity_value(self, i: str) -> float:
        values = {'N': 0.0, 'L': 0.22, 'H': 0.56}
        return values.get(i, 0.0)
    
    def _availability_value(self, a: str) -> float:
        values = {'N': 0.0, 'L': 0.22, 'H': 0.56}
        return values.get(a, 0.0)
    
    def get_severity(self, score: float) -> str:
        """Get severity rating from score"""
        if score >= 9.0:
            return "Critical"
        elif score >= 7.0:
            return "High"
        elif score >= 4.0:
            return "Medium"
        elif score > 0.0:
            return "Low"
        else:
            return "None"
    
    def generate_report(self, metrics: Dict[str, str] = None) -> str:
        """Generate CVSS calculation report"""
        score = self.calculate_base_score(metrics)
        severity = self.get_severity(score)
        
        if metrics:
            self.base_metrics.update(metrics)
        
        report = "# CVSS Base Score Calculation\n\n"
        report += "## Base Metrics\n\n"
        report += "| Metric | Value | Description |\n"
        report += "|--------|-------|-------------|\n"
        report += f"| **Attack Vector (AV)** | {self.base_metrics['AV']} | {self._av_description(self.base_metrics['AV'])} |\n"
        report += f"| **Attack Complexity (AC)** | {self.base_metrics['AC']} | {self._ac_description(self.base_metrics['AC'])} |\n"
        report += f"| **Privileges Required (PR)** | {self.base_metrics['PR']} | {self._pr_description(self.base_metrics['PR'])} |\n"
        report += f"| **User Interaction (UI)** | {self.base_metrics['UI']} | {self._ui_description(self.base_metrics['UI'])} |\n"
        report += f"| **Scope (S)** | {self.base_metrics['S']} | {self._s_description(self.base_metrics['S'])} |\n"
        report += f"| **Confidentiality (C)** | {self.base_metrics['C']} | {self._c_description(self.base_metrics['C'])} |\n"
        report += f"| **Integrity (I)** | {self.base_metrics['I']} | {self._i_description(self.base_metrics['I'])} |\n"
        report += f"| **Availability (A)** | {self.base_metrics['A']} | {self._a_description(self.base_metrics['A'])} |\n\n"
        
        report += "## Score\n\n"
        report += f"**CVSS Base Score**: {score}\n\n"
        report += f"**Severity**: {severity}\n\n"
        
        report += "## CVSS Vector String\n\n"
        vector = f"CVSS:3.1/AV:{self.base_metrics['AV']}/AC:{self.base_metrics['AC']}/PR:{self.base_metrics['PR']}/UI:{self.base_metrics['UI']}/S:{self.base_metrics['S']}/C:{self.base_metrics['C']}/I:{self.base_metrics['I']}/A:{self.base_metrics['A']}"
        report += f"`{vector}`\n\n"
        
        return report
    
    def _av_description(self, av: str) -> str:
        desc = {'N': 'Network', 'A': 'Adjacent', 'L': 'Local', 'P': 'Physical'}
        return desc.get(av, 'Network')
    
    def _ac_description(self, ac: str) -> str:
        desc = {'L': 'Low', 'H': 'High'}
        return desc.get(ac, 'Low')
    
    def _pr_description(self, pr: str) -> str:
        desc = {'N': 'None', 'L': 'Low', 'H': 'High'}
        return desc.get(pr, 'None')
    
    def _ui_description(self, ui: str) -> str:
        desc = {'N': 'None', 'R': 'Required'}
        return desc.get(ui, 'None')
    
    def _s_description(self, s: str) -> str:
        desc = {'U': 'Unchanged', 'C': 'Changed'}
        return desc.get(s, 'Unchanged')
    
    def _c_description(self, c: str) -> str:
        desc = {'N': 'None', 'L': 'Low', 'H': 'High'}
        return desc.get(c, 'None')
    
    def _i_description(self, i: str) -> str:
        desc = {'N': 'None', 'L': 'Low', 'H': 'High'}
        return desc.get(i, 'None')
    
    def _a_description(self, a: str) -> str:
        desc = {'N': 'None', 'L': 'Low', 'H': 'High'}
        return desc.get(a, 'None')

def main():
    print("CVSS Calculator")
    print("=" * 50)
    
    calculator = CVSSCalculator()
    
    # Example: High severity vulnerability
    metrics = {
        'AV': 'N',  # Network
        'AC': 'L',  # Low complexity
        'PR': 'N',  # No privileges
        'UI': 'N',  # No user interaction
        'S': 'U',   # Unchanged scope
        'C': 'H',   # High confidentiality impact
        'I': 'H',   # High integrity impact
        'A': 'H'    # High availability impact
    }
    
    report = calculator.generate_report(metrics)
    
    filename = "cvss_calculation.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] CVSS calculation complete")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()

