#!/usr/bin/env python3
"""
Vulnerability Scanner
Scans for common vulnerabilities and misconfigurations.
"""

import requests
import re
from typing import List, Dict
from urllib.parse import urljoin

class VulnerabilityScanner:
    def __init__(self, target_url: str):
        self.target_url = target_url
        self.session = requests.Session()
        self.vulnerabilities = []
    
    def check_security_headers(self) -> List[Dict]:
        """Check for missing security headers"""
        print("[*] Checking security headers...")
        vulnerabilities = []
        
        required_headers = {
            'X-Frame-Options': 'Prevents clickjacking',
            'X-Content-Type-Options': 'Prevents MIME sniffing',
            'X-XSS-Protection': 'XSS protection',
            'Strict-Transport-Security': 'HSTS enforcement',
            'Content-Security-Policy': 'CSP protection'
        }
        
        try:
            response = self.session.get(self.target_url, timeout=10)
            headers = response.headers
            
            for header, description in required_headers.items():
                if header not in headers:
                    vuln = {
                        'type': 'Missing Security Header',
                        'severity': 'Medium',
                        'header': header,
                        'description': description,
                        'recommendation': f'Add {header} header'
                    }
                    vulnerabilities.append(vuln)
                    print(f"[-] Missing header: {header}")
        except Exception as e:
            print(f"[-] Error checking headers: {e}")
        
        return vulnerabilities
    
    def check_exposed_files(self) -> List[Dict]:
        """Check for exposed sensitive files"""
        print("[*] Checking for exposed files...")
        vulnerabilities = []
        
        sensitive_files = [
            '.env',
            '.git/config',
            'backup.sql',
            'config.php',
            'wp-config.php',
            'web.config',
            'robots.txt',
            '.htaccess',
            'phpinfo.php',
            'info.php'
        ]
        
        for file_path in sensitive_files:
            try:
                url = urljoin(self.target_url, file_path)
                response = self.session.get(url, timeout=5)
                
                if response.status_code == 200:
                    # Check if it's actually the file (not 404 page)
                    if len(response.text) > 50:
                        vuln = {
                            'type': 'Exposed File',
                            'severity': 'High',
                            'file': file_path,
                            'url': url,
                            'description': f'Exposed file found: {file_path}',
                            'recommendation': 'Remove or restrict access to sensitive files'
                        }
                        vulnerabilities.append(vuln)
                        print(f"[+] Exposed file found: {file_path}")
            except:
                pass
        
        return vulnerabilities
    
    def check_server_info_disclosure(self) -> List[Dict]:
        """Check for server information disclosure"""
        print("[*] Checking for information disclosure...")
        vulnerabilities = []
        
        try:
            response = self.session.get(self.target_url, timeout=10)
            headers = response.headers
            
            # Check Server header
            if 'Server' in headers:
                server_info = headers['Server']
                vuln = {
                    'type': 'Information Disclosure',
                    'severity': 'Low',
                    'header': 'Server',
                    'value': server_info,
                    'description': f'Server information disclosed: {server_info}',
                    'recommendation': 'Remove or obfuscate Server header'
                }
                vulnerabilities.append(vuln)
                print(f"[+] Server information disclosed: {server_info}")
            
            # Check X-Powered-By header
            if 'X-Powered-By' in headers:
                powered_by = headers['X-Powered-By']
                vuln = {
                    'type': 'Information Disclosure',
                    'severity': 'Low',
                    'header': 'X-Powered-By',
                    'value': powered_by,
                    'description': f'Technology stack disclosed: {powered_by}',
                    'recommendation': 'Remove X-Powered-By header'
                }
                vulnerabilities.append(vuln)
                print(f"[+] Technology stack disclosed: {powered_by}")
        except Exception as e:
            print(f"[-] Error checking information disclosure: {e}")
        
        return vulnerabilities
    
    def check_http_methods(self) -> List[Dict]:
        """Check for dangerous HTTP methods"""
        print("[*] Checking HTTP methods...")
        vulnerabilities = []
        
        dangerous_methods = ['PUT', 'DELETE', 'TRACE', 'CONNECT', 'PATCH']
        
        try:
            response = self.session.options(self.target_url, timeout=10)
            if 'Allow' in response.headers:
                allowed_methods = response.headers['Allow'].split(', ')
                
                for method in dangerous_methods:
                    if method in allowed_methods:
                        vuln = {
                            'type': 'Dangerous HTTP Method',
                            'severity': 'Medium',
                            'method': method,
                            'description': f'Dangerous HTTP method enabled: {method}',
                            'recommendation': f'Disable {method} method if not needed'
                        }
                        vulnerabilities.append(vuln)
                        print(f"[-] Dangerous method enabled: {method}")
        except Exception as e:
            print(f"[-] Error checking HTTP methods: {e}")
        
        return vulnerabilities
    
    def scan_all(self) -> List[Dict]:
        """Run all vulnerability checks"""
        print(f"[*] Starting vulnerability scan on {self.target_url}\n")
        
        self.vulnerabilities.extend(self.check_security_headers())
        self.vulnerabilities.extend(self.check_exposed_files())
        self.vulnerabilities.extend(self.check_server_info_disclosure())
        self.vulnerabilities.extend(self.check_http_methods())
        
        return self.vulnerabilities
    
    def generate_report(self) -> str:
        """Generate vulnerability report"""
        report = f"# Vulnerability Assessment Report\n\n"
        report += f"**Target**: {self.target_url}\n\n"
        report += f"## Summary\n\n"
        report += f"Total Vulnerabilities Found: {len(self.vulnerabilities)}\n\n"
        
        # Group by severity
        critical = [v for v in self.vulnerabilities if v['severity'] == 'Critical']
        high = [v for v in self.vulnerabilities if v['severity'] == 'High']
        medium = [v for v in self.vulnerabilities if v['severity'] == 'Medium']
        low = [v for v in self.vulnerabilities if v['severity'] == 'Low']
        
        report += f"- **Critical**: {len(critical)}\n"
        report += f"- **High**: {len(high)}\n"
        report += f"- **Medium**: {len(medium)}\n"
        report += f"- **Low**: {len(low)}\n\n"
        
        report += "## Vulnerabilities\n\n"
        for i, vuln in enumerate(self.vulnerabilities, 1):
            report += f"### {i}. {vuln['type']}\n\n"
            report += f"**Severity**: {vuln['severity']}\n\n"
            report += f"**Description**: {vuln['description']}\n\n"
            report += f"**Recommendation**: {vuln['recommendation']}\n\n"
            if 'url' in vuln:
                report += f"**URL**: {vuln['url']}\n\n"
            report += "---\n\n"
        
        return report

def main():
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: python vulnerability_scanner.py <target_url>")
        print("Example: python vulnerability_scanner.py http://example.com")
        sys.exit(1)
    
    target_url = sys.argv[1]
    scanner = VulnerabilityScanner(target_url)
    
    vulnerabilities = scanner.scan_all()
    
    # Generate report
    report = scanner.generate_report()
    with open('vulnerability_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Scan complete. Found {len(vulnerabilities)} vulnerabilities")
    print(f"[+] Report saved to vulnerability_report.md")
    print(f"[!] WARNING: Only test on systems you own or have permission to test!")

if __name__ == '__main__':
    main()

