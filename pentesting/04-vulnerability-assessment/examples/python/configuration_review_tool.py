#!/usr/bin/env python3
"""
Configuration Review Tool
Reviews system and application configurations for security issues.
"""

import sys
import os
import json
from typing import List, Dict

class ConfigurationReviewTool:
    def __init__(self, config_path: str = None):
        self.config_path = config_path
        self.findings = []
    
    def check_file_permissions(self, file_path: str) -> Dict:
        """Check file permissions"""
        print(f"[*] Checking permissions for: {file_path}...")
        
        findings = {
            'file': file_path,
            'issues': []
        }
        
        if not os.path.exists(file_path):
            findings['issues'].append("File does not exist")
            return findings
        
        # Check if world-readable
        if os.stat(file_path).st_mode & 0o004:
            findings['issues'].append("World-readable file")
        
        # Check if world-writable
        if os.stat(file_path).st_mode & 0o002:
            findings['issues'].append("World-writable file (CRITICAL)")
        
        return findings
    
    def check_common_config_files(self) -> List[Dict]:
        """Check common configuration files"""
        print("[*] Checking common configuration files...")
        
        common_configs = [
            '/etc/passwd',
            '/etc/shadow',
            '/etc/ssh/sshd_config',
            '/etc/apache2/apache2.conf',
            '/etc/nginx/nginx.conf',
            '.env',
            'config.json',
            'settings.py'
        ]
        
        findings = []
        for config in common_configs:
            if os.path.exists(config):
                finding = self.check_file_permissions(config)
                if finding['issues']:
                    findings.append(finding)
        
        return findings
    
    def check_env_variables(self) -> List[str]:
        """Check for sensitive environment variables"""
        print("[*] Checking environment variables...")
        
        sensitive_vars = []
        sensitive_patterns = ['PASSWORD', 'SECRET', 'KEY', 'TOKEN', 'API_KEY']
        
        for key, value in os.environ.items():
            for pattern in sensitive_patterns:
                if pattern in key.upper():
                    sensitive_vars.append(key)
                    break
        
        return sensitive_vars
    
    def review_json_config(self, config_file: str) -> List[str]:
        """Review JSON configuration file"""
        print(f"[*] Reviewing JSON config: {config_file}...")
        
        issues = []
        
        try:
            with open(config_file, 'r') as f:
                config = json.load(f)
            
            # Check for common issues
            if 'password' in str(config).lower() and 'encrypted' not in str(config).lower():
                issues.append("Plaintext password found in config")
            
            if 'debug' in config and config.get('debug') == True:
                issues.append("Debug mode enabled in production")
            
            if 'ssl' in str(config).lower() and 'verify' in str(config).lower():
                if config.get('ssl', {}).get('verify') == False:
                    issues.append("SSL verification disabled")
        except:
            issues.append("Could not parse configuration file")
        
        return issues
    
    def generate_report(self) -> str:
        """Generate configuration review report"""
        report = "# Configuration Review Report\n\n"
        
        # Check common config files
        config_findings = self.check_common_config_files()
        if config_findings:
            report += "## Configuration File Issues\n\n"
            for finding in config_findings:
                report += f"### {finding['file']}\n\n"
                for issue in finding['issues']:
                    report += f"- ⚠️ {issue}\n"
                report += "\n"
        
        # Check environment variables
        env_vars = self.check_env_variables()
        if env_vars:
            report += "## Sensitive Environment Variables\n\n"
            report += "⚠️ **WARNING**: Sensitive environment variables detected:\n\n"
            for var in env_vars:
                report += f"- {var}\n"
            report += "\n"
        
        report += "## Common Configuration Issues\n\n"
        report += "1. **Weak Passwords**: Default or weak passwords\n"
        report += "2. **Exposed Secrets**: Secrets in configuration files\n"
        report += "3. **Debug Mode**: Debug enabled in production\n"
        report += "4. **Insecure Protocols**: Use of insecure protocols\n"
        report += "5. **Excessive Permissions**: Overly permissive file permissions\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use environment variables for secrets\n"
        report += "2. Restrict file permissions\n"
        report += "3. Disable debug mode in production\n"
        report += "4. Use secure protocols (HTTPS, SSH)\n"
        report += "5. Regularly review configurations\n\n"
        
        return report

def main():
    config_path = sys.argv[1] if len(sys.argv) > 1 else None
    
    reviewer = ConfigurationReviewTool(config_path)
    report = reviewer.generate_report()
    
    filename = "configuration_review.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Configuration review complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

