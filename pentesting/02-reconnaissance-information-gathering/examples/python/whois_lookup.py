#!/usr/bin/env python3
"""
WHOIS Lookup Tool
Performs WHOIS queries to gather domain registration information.
"""

import sys
import socket
import subprocess
from typing import Dict, Optional

class WhoisLookup:
    def __init__(self):
        self.whois_servers = {
            'com': 'whois.verisign-grs.com',
            'net': 'whois.verisign-grs.com',
            'org': 'whois.pir.org',
            'edu': 'whois.educause.edu',
            'gov': 'whois.nic.gov',
            'uk': 'whois.nic.uk',
            'de': 'whois.denic.de',
            'fr': 'whois.afnic.fr',
            'jp': 'whois.jprs.jp',
            'au': 'whois.aunic.net'
        }
    
    def get_tld(self, domain: str) -> str:
        """Extract TLD from domain"""
        parts = domain.split('.')
        if len(parts) >= 2:
            return parts[-1].lower()
        return 'com'
    
    def query_whois(self, domain: str) -> Optional[str]:
        """Query WHOIS information"""
        try:
            # Try using whois command if available
            result = subprocess.run(
                ['whois', domain],
                capture_output=True,
                text=True,
                timeout=30
            )
            if result.returncode == 0:
                return result.stdout
        except FileNotFoundError:
            pass
        except Exception as e:
            print(f"[-] Error querying WHOIS: {e}")
        
        # Fallback: Try direct socket connection
        try:
            tld = self.get_tld(domain)
            server = self.whois_servers.get(tld, 'whois.iana.org')
            
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(10)
            sock.connect((server, 43))
            sock.send(f"{domain}\r\n".encode())
            
            response = b""
            while True:
                data = sock.recv(4096)
                if not data:
                    break
                response += data
            
            sock.close()
            return response.decode('utf-8', errors='ignore')
        except Exception as e:
            print(f"[-] Error connecting to WHOIS server: {e}")
            return None
    
    def parse_whois(self, whois_data: str) -> Dict:
        """Parse WHOIS data into structured format"""
        info = {
            'domain': '',
            'registrar': '',
            'creation_date': '',
            'expiration_date': '',
            'updated_date': '',
            'name_servers': [],
            'status': [],
            'registrant': {},
            'admin_contact': {},
            'tech_contact': {}
        }
        
        if not whois_data:
            return info
        
        lines = whois_data.split('\n')
        current_section = None
        
        for line in lines:
            line = line.strip()
            if not line or line.startswith('%') or line.startswith('#'):
                continue
            
            # Domain name
            if 'Domain Name:' in line or 'domain:' in line.lower():
                info['domain'] = line.split(':', 1)[-1].strip().upper()
            
            # Registrar
            if 'Registrar:' in line or 'registrar:' in line.lower():
                info['registrar'] = line.split(':', 1)[-1].strip()
            
            # Dates
            if 'Creation Date:' in line or 'created:' in line.lower():
                info['creation_date'] = line.split(':', 1)[-1].strip()
            if 'Expiration Date:' in line or 'expires:' in line.lower():
                info['expiration_date'] = line.split(':', 1)[-1].strip()
            if 'Updated Date:' in line or 'modified:' in line.lower():
                info['updated_date'] = line.split(':', 1)[-1].strip()
            
            # Name servers
            if 'Name Server:' in line or 'nserver:' in line.lower():
                ns = line.split(':', 1)[-1].strip().lower()
                if ns and ns not in info['name_servers']:
                    info['name_servers'].append(ns)
            
            # Status
            if 'Status:' in line or 'domain status:' in line.lower():
                status = line.split(':', 1)[-1].strip()
                if status and status not in info['status']:
                    info['status'].append(status)
        
        return info
    
    def generate_report(self, domain: str) -> str:
        """Generate WHOIS lookup report"""
        print(f"[*] Querying WHOIS for {domain}...")
        whois_data = self.query_whois(domain)
        
        if not whois_data:
            return f"# WHOIS Lookup Report for {domain}\n\n[-] Failed to retrieve WHOIS data.\n"
        
        info = self.parse_whois(whois_data)
        
        report = f"# WHOIS Lookup Report for {domain}\n\n"
        report += "## Domain Information\n\n"
        report += f"**Domain**: {info['domain'] or domain}\n\n"
        report += f"**Registrar**: {info['registrar'] or 'Not found'}\n\n"
        report += f"**Creation Date**: {info['creation_date'] or 'Not found'}\n\n"
        report += f"**Expiration Date**: {info['expiration_date'] or 'Not found'}\n\n"
        report += f"**Last Updated**: {info['updated_date'] or 'Not found'}\n\n"
        
        if info['name_servers']:
            report += "## Name Servers\n\n"
            for ns in info['name_servers']:
                report += f"- {ns}\n"
            report += "\n"
        
        if info['status']:
            report += "## Domain Status\n\n"
            for status in info['status']:
                report += f"- {status}\n"
            report += "\n"
        
        report += "## Raw WHOIS Data\n\n"
        report += "```\n"
        report += whois_data
        report += "\n```\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python whois_lookup.py <domain>")
        print("Example: python whois_lookup.py example.com")
        sys.exit(1)
    
    domain = sys.argv[1]
    lookup = WhoisLookup()
    
    report = lookup.generate_report(domain)
    
    filename = f"whois_{domain.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] WHOIS lookup complete for {domain}")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()

