#!/usr/bin/env python3
"""
Certificate Transparency Scanner
Discovers subdomains from Certificate Transparency logs.
"""

import sys
import requests
import json
from typing import List, Set

class CertificateTransparency:
    def __init__(self):
        self.ct_apis = [
            'https://crt.sh/?q={}&output=json',
            'https://api.certspotter.com/v1/issuances?domain={}&include_subdomains=true&expand=dns_names'
        ]
        self.subdomains = set()
    
    def query_crt_sh(self, domain: str) -> Set[str]:
        """Query crt.sh for certificates"""
        print(f"[*] Querying crt.sh for {domain}...")
        subdomains = set()
        
        try:
            url = f"https://crt.sh/?q={domain}&output=json"
            response = requests.get(url, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                for entry in data:
                    name_value = entry.get('name_value', '')
                    # Parse multiple domains from name_value
                    for name in name_value.split('\n'):
                        name = name.strip().lower()
                        if name and domain in name:
                            subdomains.add(name)
        except Exception as e:
            print(f"[-] Error querying crt.sh: {e}")
        
        return subdomains
    
    def query_certspotter(self, domain: str) -> Set[str]:
        """Query CertSpotter API"""
        print(f"[*] Querying CertSpotter for {domain}...")
        subdomains = set()
        
        try:
            url = f"https://api.certspotter.com/v1/issuances?domain={domain}&include_subdomains=true&expand=dns_names"
            response = requests.get(url, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                for cert in data:
                    dns_names = cert.get('dns_names', [])
                    for name in dns_names:
                        name = name.strip().lower()
                        if name and domain in name:
                            subdomains.add(name)
        except Exception as e:
            print(f"[-] Error querying CertSpotter: {e}")
        
        return subdomains
    
    def scan_domain(self, domain: str) -> Set[str]:
        """Scan domain using all CT sources"""
        print(f"[*] Scanning Certificate Transparency logs for {domain}...\n")
        
        all_subdomains = set()
        
        # Query crt.sh
        subdomains = self.query_crt_sh(domain)
        all_subdomains.update(subdomains)
        print(f"[+] Found {len(subdomains)} subdomains from crt.sh")
        
        # Query CertSpotter
        subdomains = self.query_certspotter(domain)
        all_subdomains.update(subdomains)
        print(f"[+] Found {len(subdomains)} subdomains from CertSpotter")
        
        self.subdomains = all_subdomains
        return all_subdomains
    
    def generate_report(self, domain: str) -> str:
        """Generate CT scan report"""
        subdomains = sorted(self.subdomains)
        
        report = f"# Certificate Transparency Scan Report for {domain}\n\n"
        report += "## Summary\n\n"
        report += f"Total Subdomains Found: {len(subdomains)}\n\n"
        
        if subdomains:
            report += "## Discovered Subdomains\n\n"
            for i, subdomain in enumerate(subdomains, 1):
                report += f"{i}. {subdomain}\n"
            report += "\n"
        else:
            report += "No subdomains found in Certificate Transparency logs.\n\n"
        
        report += "## Sources\n\n"
        report += "- crt.sh (Certificate Transparency Log Search)\n"
        report += "- CertSpotter API\n\n"
        
        report += "## Notes\n\n"
        report += "Certificate Transparency logs contain all publicly-trusted SSL/TLS certificates.\n"
        report += "This can reveal subdomains that may not be publicly advertised.\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python certificate_transparency.py <domain>")
        print("Example: python certificate_transparency.py example.com")
        sys.exit(1)
    
    domain = sys.argv[1]
    ct = CertificateTransparency()
    
    ct.scan_domain(domain)
    
    report = ct.generate_report(domain)
    
    filename = f"ct_scan_{domain.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"\n[+] Scan complete. Found {len(ct.subdomains)} subdomains")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()

