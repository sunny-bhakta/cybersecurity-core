#!/usr/bin/env python3
"""
Service Version Detection Tool
Detects versions of services running on target systems.
"""

import sys
import socket
import requests
from typing import Dict, List

class ServiceVersionDetection:
    def __init__(self, target: str, port: int):
        self.target = target
        self.port = port
        self.versions = {}
    
    def detect_http_version(self) -> Dict:
        """Detect HTTP server version"""
        print(f"[*] Detecting HTTP version on {self.target}:{self.port}...")
        
        version_info = {
            'server': 'Unknown',
            'version': 'Unknown',
            'powered_by': 'Unknown'
        }
        
        try:
            protocol = 'https' if self.port == 443 else 'http'
            url = f"{protocol}://{self.target}:{self.port}"
            
            response = requests.get(url, timeout=10, verify=False)
            
            # Get Server header
            server = response.headers.get('Server', 'Unknown')
            version_info['server'] = server
            
            # Extract version from Server header
            if server and server != 'Unknown':
                parts = server.split('/')
                if len(parts) > 1:
                    version_info['version'] = parts[1]
            
            # Get X-Powered-By header
            powered_by = response.headers.get('X-Powered-By', 'Unknown')
            version_info['powered_by'] = powered_by
            
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return version_info
    
    def detect_ssh_version(self) -> str:
        """Detect SSH version"""
        print(f"[*] Detecting SSH version on {self.target}:{self.port}...")
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, self.port))
            
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            
            return banner
        except Exception as e:
            print(f"[-] Error: {e}")
            return None
    
    def detect_ftp_version(self) -> str:
        """Detect FTP version"""
        print(f"[*] Detecting FTP version on {self.target}:{self.port}...")
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, self.port))
            
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            
            return banner
        except Exception as e:
            print(f"[-] Error: {e}")
            return None
    
    def detect_smtp_version(self) -> str:
        """Detect SMTP version"""
        print(f"[*] Detecting SMTP version on {self.target}:{self.port}...")
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target, self.port))
            
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            
            return banner
        except Exception as e:
            print(f"[-] Error: {e}")
            return None
    
    def detect_all(self) -> Dict:
        """Detect versions for common services"""
        print(f"[*] Starting version detection for {self.target}:{self.port}\n")
        
        results = {}
        
        # HTTP/HTTPS
        if self.port in [80, 443, 8080, 8443]:
            results['http'] = self.detect_http_version()
        
        # SSH
        elif self.port == 22:
            results['ssh'] = self.detect_ssh_version()
        
        # FTP
        elif self.port == 21:
            results['ftp'] = self.detect_ftp_version()
        
        # SMTP
        elif self.port == 25:
            results['smtp'] = self.detect_smtp_version()
        
        # Generic banner grab
        else:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(5)
                sock.connect((self.target, self.port))
                banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
                sock.close()
                results['banner'] = banner
            except:
                pass
        
        return results
    
    def generate_report(self) -> str:
        """Generate version detection report"""
        results = self.detect_all()
        
        report = f"# Service Version Detection Report\n\n"
        report += f"**Target**: {self.target}:{self.port}\n\n"
        
        if results:
            report += "## Detected Versions\n\n"
            
            if 'http' in results:
                http_info = results['http']
                report += "### HTTP Service\n\n"
                report += f"**Server**: {http_info.get('server', 'Unknown')}\n\n"
                report += f"**Version**: {http_info.get('version', 'Unknown')}\n\n"
                report += f"**X-Powered-By**: {http_info.get('powered_by', 'Unknown')}\n\n"
            
            if 'ssh' in results:
                report += "### SSH Service\n\n"
                report += f"**Banner**: {results['ssh']}\n\n"
            
            if 'ftp' in results:
                report += "### FTP Service\n\n"
                report += f"**Banner**: {results['ftp']}\n\n"
            
            if 'smtp' in results:
                report += "### SMTP Service\n\n"
                report += f"**Banner**: {results['smtp']}\n\n"
            
            if 'banner' in results:
                report += "### Service Banner\n\n"
                report += f"```\n{results['banner']}\n```\n\n"
        else:
            report += "[-] Could not detect service version.\n\n"
        
        report += "## Security Implications\n\n"
        report += "1. **Outdated Versions**: May have known vulnerabilities\n"
        report += "2. **Version Disclosure**: Reveals technology stack\n"
        report += "3. **Targeted Attacks**: Attackers can target specific versions\n"
        report += "4. **Patch Management**: Helps identify systems needing updates\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Keep services updated to latest versions\n"
        report += "2. Consider hiding version information\n"
        report += "3. Use security headers to limit information disclosure\n"
        report += "4. Regularly scan for outdated software\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python service_version_detection.py <target> <port>")
        print("Example: python service_version_detection.py 192.168.1.100 80")
        sys.exit(1)
    
    target = sys.argv[1]
    port = int(sys.argv[2])
    
    detector = ServiceVersionDetection(target, port)
    
    report = detector.generate_report()
    
    filename = f"version_detection_{target.replace('.', '_')}_{port}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Version detection complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only scan systems you own or have permission to test!")

if __name__ == '__main__':
    main()

