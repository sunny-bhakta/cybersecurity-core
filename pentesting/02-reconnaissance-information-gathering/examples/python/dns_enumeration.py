#!/usr/bin/env python3
"""
DNS Enumeration Tool
Performs comprehensive DNS enumeration including record types, subdomain discovery, and zone transfers.
"""

import dns.resolver
import dns.zone
import dns.query
import socket
import sys
from typing import List, Dict, Optional

class DNSEnumerator:
    def __init__(self, domain: str):
        self.domain = domain
        self.results = {
            'a_records': [],
            'aaaa_records': [],
            'mx_records': [],
            'ns_records': [],
            'txt_records': [],
            'cname_records': [],
            'subdomains': []
        }
    
    def get_a_records(self) -> List[str]:
        """Get A records (IPv4 addresses)"""
        try:
            answers = dns.resolver.resolve(self.domain, 'A')
            for rdata in answers:
                self.results['a_records'].append(str(rdata))
            return self.results['a_records']
        except Exception as e:
            print(f"[-] Error getting A records: {e}")
            return []
    
    def get_aaaa_records(self) -> List[str]:
        """Get AAAA records (IPv6 addresses)"""
        try:
            answers = dns.resolver.resolve(self.domain, 'AAAA')
            for rdata in answers:
                self.results['aaaa_records'].append(str(rdata))
            return self.results['aaaa_records']
        except Exception as e:
            print(f"[-] Error getting AAAA records: {e}")
            return []
    
    def get_mx_records(self) -> List[Dict]:
        """Get MX records (mail servers)"""
        try:
            answers = dns.resolver.resolve(self.domain, 'MX')
            mx_list = []
            for rdata in answers:
                mx_list.append({
                    'priority': rdata.preference,
                    'host': str(rdata.exchange)
                })
                self.results['mx_records'].append(f"{rdata.preference} {rdata.exchange}")
            return mx_list
        except Exception as e:
            print(f"[-] Error getting MX records: {e}")
            return []
    
    def get_ns_records(self) -> List[str]:
        """Get NS records (name servers)"""
        try:
            answers = dns.resolver.resolve(self.domain, 'NS')
            ns_list = []
            for rdata in answers:
                ns_list.append(str(rdata))
                self.results['ns_records'].append(str(rdata))
            return ns_list
        except Exception as e:
            print(f"[-] Error getting NS records: {e}")
            return []
    
    def get_txt_records(self) -> List[str]:
        """Get TXT records"""
        try:
            answers = dns.resolver.resolve(self.domain, 'TXT')
            txt_list = []
            for rdata in answers:
                txt_list.append(str(rdata))
                self.results['txt_records'].append(str(rdata))
            return txt_list
        except Exception as e:
            print(f"[-] Error getting TXT records: {e}")
            return []
    
    def get_cname_records(self, subdomain: str = None) -> List[str]:
        """Get CNAME records"""
        target = subdomain if subdomain else self.domain
        try:
            answers = dns.resolver.resolve(target, 'CNAME')
            cname_list = []
            for rdata in answers:
                cname_list.append(str(rdata))
                self.results['cname_records'].append(str(rdata))
            return cname_list
        except Exception as e:
            return []
    
    def attempt_zone_transfer(self, nameserver: str = None) -> bool:
        """Attempt DNS zone transfer (AXFR)"""
        if not nameserver:
            ns_records = self.get_ns_records()
            if not ns_records:
                print("[-] No nameservers found")
                return False
            nameserver = ns_records[0]
        
        try:
            zone = dns.zone.from_xfr(dns.query.xfr(nameserver, self.domain))
            print(f"[+] Zone transfer successful from {nameserver}")
            for name, node in zone.nodes.items():
                rdatasets = node.rdatasets
                for rdataset in rdatasets:
                    print(f"    {name} {rdataset}")
            return True
        except Exception as e:
            print(f"[-] Zone transfer failed: {e}")
            return False
    
    def brute_force_subdomains(self, wordlist: List[str]) -> List[str]:
        """Brute force subdomains using wordlist"""
        found_subdomains = []
        
        print(f"[*] Brute forcing {len(wordlist)} subdomains...")
        for subdomain in wordlist:
            target = f"{subdomain}.{self.domain}"
            try:
                answers = dns.resolver.resolve(target, 'A')
                for rdata in answers:
                    found_subdomains.append(target)
                    self.results['subdomains'].append({
                        'subdomain': target,
                        'ip': str(rdata)
                    })
                    print(f"[+] Found: {target} -> {rdata}")
            except:
                pass
        
        return found_subdomains
    
    def enumerate_all(self) -> Dict:
        """Perform complete DNS enumeration"""
        print(f"[*] Enumerating DNS records for {self.domain}\n")
        
        print("[*] A Records:")
        a_records = self.get_a_records()
        for record in a_records:
            print(f"    {record}")
        
        print("\n[*] AAAA Records:")
        aaaa_records = self.get_aaaa_records()
        for record in aaaa_records:
            print(f"    {record}")
        
        print("\n[*] MX Records:")
        mx_records = self.get_mx_records()
        for record in mx_records:
            print(f"    {record['priority']} {record['host']}")
        
        print("\n[*] NS Records:")
        ns_records = self.get_ns_records()
        for record in ns_records:
            print(f"    {record}")
        
        print("\n[*] TXT Records:")
        txt_records = self.get_txt_records()
        for record in txt_records:
            print(f"    {record}")
        
        print("\n[*] Attempting zone transfer...")
        self.attempt_zone_transfer()
        
        return self.results
    
    def generate_report(self) -> str:
        """Generate enumeration report"""
        report = f"# DNS Enumeration Report for {self.domain}\n\n"
        report += f"## A Records\n"
        for record in self.results['a_records']:
            report += f"- {record}\n"
        
        report += f"\n## MX Records\n"
        for record in self.results['mx_records']:
            report += f"- {record}\n"
        
        report += f"\n## NS Records\n"
        for record in self.results['ns_records']:
            report += f"- {record}\n"
        
        report += f"\n## TXT Records\n"
        for record in self.results['txt_records']:
            report += f"- {record}\n"
        
        report += f"\n## Subdomains\n"
        for subdomain in self.results['subdomains']:
            report += f"- {subdomain['subdomain']} -> {subdomain['ip']}\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python dns_enumeration.py <domain> [wordlist_file]")
        sys.exit(1)
    
    domain = sys.argv[1]
    enumerator = DNSEnumerator(domain)
    
    # Perform enumeration
    results = enumerator.enumerate_all()
    
    # If wordlist provided, brute force subdomains
    if len(sys.argv) > 2:
        wordlist_file = sys.argv[2]
        try:
            with open(wordlist_file, 'r') as f:
                wordlist = [line.strip() for line in f if line.strip()]
            enumerator.brute_force_subdomains(wordlist)
        except FileNotFoundError:
            print(f"[-] Wordlist file not found: {wordlist_file}")
    
    # Generate report
    report = enumerator.generate_report()
    with open(f'dns_enum_{domain}.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Report saved to dns_enum_{domain}.md")

if __name__ == '__main__':
    main()

