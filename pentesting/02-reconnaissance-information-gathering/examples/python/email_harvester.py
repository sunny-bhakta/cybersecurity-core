#!/usr/bin/env python3
"""
Email Harvester Tool
Harvests email addresses from various sources.
"""

import sys
import re
import requests
from typing import List, Set

class EmailHarvester:
    def __init__(self, domain: str):
        self.domain = domain
        self.emails: Set[str] = set()
        self.sources = []
    
    def extract_emails_from_text(self, text: str) -> List[str]:
        """Extract email addresses from text"""
        pattern = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
        emails = re.findall(pattern, text)
        # Filter for domain
        domain_emails = [e for e in emails if self.domain.lower() in e.lower()]
        return domain_emails
    
    def harvest_from_website(self, url: str) -> List[str]:
        """Harvest emails from a website"""
        print(f"[*] Harvesting from: {url}")
        try:
            response = requests.get(url, timeout=10, headers={'User-Agent': 'Mozilla/5.0'})
            emails = self.extract_emails_from_text(response.text)
            if emails:
                self.sources.append(f"Website: {url}")
            return emails
        except Exception as e:
            print(f"[-] Error: {e}")
            return []
    
    def harvest_from_github(self) -> List[str]:
        """Harvest emails from GitHub (public repos)"""
        print(f"[*] Searching GitHub for {self.domain}...")
        emails = []
        # In real implementation, would use GitHub API
        # This is a simplified example
        return emails
    
    def harvest_from_whois(self) -> List[str]:
        """Harvest emails from WHOIS data"""
        print(f"[*] Checking WHOIS for {self.domain}...")
        emails = []
        try:
            import whois
            w = whois.whois(self.domain)
            if w.emails:
                emails.extend(w.emails if isinstance(w.emails, list) else [w.emails])
        except:
            pass
        return emails
    
    def harvest_all(self) -> Set[str]:
        """Harvest emails from all sources"""
        print(f"[*] Starting email harvest for domain: {self.domain}")
        
        # Try main website
        main_url = f"https://{self.domain}"
        emails = self.harvest_from_website(main_url)
        self.emails.update(emails)
        
        # Try contact/about pages
        contact_urls = [
            f"https://{self.domain}/contact",
            f"https://{self.domain}/about",
            f"https://{self.domain}/team"
        ]
        
        for url in contact_urls:
            emails = self.harvest_from_website(url)
            self.emails.update(emails)
        
        # WHOIS
        emails = self.harvest_from_whois()
        self.emails.update(emails)
        
        return self.emails
    
    def generate_report(self) -> str:
        """Generate email harvest report"""
        report = f"# Email Harvest Report for {self.domain}\n\n"
        report += f"**Total Emails Found**: {len(self.emails)}\n\n"
        
        if self.emails:
            report += "## Emails Found\n\n"
            for email in sorted(self.emails):
                report += f"- {email}\n"
            report += "\n"
        else:
            report += "[-] No emails found.\n\n"
        
        if self.sources:
            report += "## Sources\n\n"
            for source in self.sources:
                report += f"- {source}\n"
            report += "\n"
        
        report += "## Usage Notes\n\n"
        report += "⚠️ **WARNING**: Only harvest emails from sources you have permission to access.\n"
        report += "⚠️ Respect privacy and applicable laws (GDPR, CAN-SPAM, etc.).\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python email_harvester.py <domain>")
        print("Example: python email_harvester.py example.com")
        sys.exit(1)
    
    domain = sys.argv[1]
    
    harvester = EmailHarvester(domain)
    harvester.harvest_all()
    
    report = harvester.generate_report()
    
    filename = f"email_harvest_{domain.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Email harvest complete")
    print(f"[+] Found {len(harvester.emails)} emails")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only use on domains you own or have permission to test!")

if __name__ == '__main__':
    main()

