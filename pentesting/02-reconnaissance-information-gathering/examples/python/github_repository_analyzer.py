#!/usr/bin/env python3
"""
GitHub Repository Analyzer
Analyzes GitHub repositories for security issues and exposed information.
"""

import sys
import requests
from typing import Dict, List

class GitHubRepositoryAnalyzer:
    def __init__(self, owner: str, repo: str = None):
        self.owner = owner
        self.repo = repo
        self.findings = []
        self.api_base = "https://api.github.com"
    
    def analyze_repository(self) -> Dict:
        """Analyze a specific repository"""
        if not self.repo:
            return {}
        
        print(f"[*] Analyzing repository: {self.owner}/{self.repo}")
        
        findings = {
            'secrets': [],
            'exposed_files': [],
            'vulnerabilities': [],
            'sensitive_info': []
        }
        
        # Check for common sensitive files
        sensitive_files = [
            '.env', '.gitignore', 'config.json', 'secrets.json',
            'credentials.txt', 'passwords.txt', 'private_key.pem'
        ]
        
        for file in sensitive_files:
            url = f"{self.api_base}/repos/{self.owner}/{self.repo}/contents/{file}"
            try:
                response = requests.get(url, timeout=10)
                if response.status_code == 200:
                    findings['exposed_files'].append(file)
                    print(f"[!] Found exposed file: {file}")
            except:
                pass
        
        # Check for secrets in code
        # In real implementation, would search code for patterns
        findings['secrets'] = self.search_for_secrets()
        
        return findings
    
    def search_for_secrets(self) -> List[str]:
        """Search for potential secrets in repository"""
        secrets = []
        
        # Common secret patterns
        patterns = [
            r'api[_-]?key\s*[:=]\s*["\']([^"\']+)["\']',
            r'password\s*[:=]\s*["\']([^"\']+)["\']',
            r'secret\s*[:=]\s*["\']([^"\']+)["\']',
            r'aws[_-]?access[_-]?key[_-]?id\s*[:=]\s*["\']([^"\']+)["\']'
        ]
        
        # In real implementation, would search through repository files
        # This is a simplified example
        
        return secrets
    
    def list_repositories(self) -> List[Dict]:
        """List all repositories for a user/organization"""
        print(f"[*] Listing repositories for: {self.owner}")
        
        repos = []
        url = f"{self.api_base}/users/{self.owner}/repos"
        
        try:
            response = requests.get(url, timeout=10)
            if response.status_code == 200:
                repos = response.json()
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return repos
    
    def generate_report(self) -> str:
        """Generate analysis report"""
        report = f"# GitHub Repository Analysis Report\n\n"
        report += f"**Target**: {self.owner}"
        if self.repo:
            report += f" / {self.repo}"
        report += "\n\n"
        
        if self.repo:
            findings = self.analyze_repository()
            
            if findings['exposed_files']:
                report += "## Exposed Files Found\n\n"
                for file in findings['exposed_files']:
                    report += f"- ⚠️ {file}\n"
                report += "\n"
            
            if findings['secrets']:
                report += "## Potential Secrets Found\n\n"
                for secret in findings['secrets']:
                    report += f"- ⚠️ {secret}\n"
                report += "\n"
        else:
            repos = self.list_repositories()
            report += f"## Repositories Found: {len(repos)}\n\n"
            for repo in repos[:10]:  # Limit to first 10
                report += f"- {repo['name']} ({repo.get('visibility', 'public')})\n"
            report += "\n"
        
        report += "## Recommendations\n\n"
        report += "1. Review exposed files and remove sensitive information\n"
        report += "2. Use environment variables for secrets\n"
        report += "3. Add sensitive files to .gitignore\n"
        report += "4. Rotate any exposed credentials\n"
        report += "5. Enable secret scanning in GitHub\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python github_repository_analyzer.py <owner> [repo]")
        print("Example: python github_repository_analyzer.py octocat")
        print("Example: python github_repository_analyzer.py octocat Hello-World")
        sys.exit(1)
    
    owner = sys.argv[1]
    repo = sys.argv[2] if len(sys.argv) > 2 else None
    
    analyzer = GitHubRepositoryAnalyzer(owner, repo)
    
    report = analyzer.generate_report()
    
    filename = f"github_analysis_{owner}"
    if repo:
        filename += f"_{repo}"
    filename += ".md"
    
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] GitHub analysis complete")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()

