#!/usr/bin/env python3
"""
Subdomain Discovery Tool
Discovers subdomains using multiple techniques: DNS brute forcing, certificate transparency, and search engines.
"""

import requests
import dns.resolver
import json
from typing import List, Set, Optional
from concurrent.futures import ThreadPoolExecutor, as_completed

class SubdomainDiscoverer:
    def __init__(self, domain: str):
        self.domain = domain
        self.found_subdomains: Set[str] = set()
    
    def dns_brute_force(self, wordlist: List[str], threads: int = 50) -> Set[str]:
        """Brute force subdomains using DNS"""
        print(f"[*] DNS brute forcing {len(wordlist)} subdomains...")
        
        def check_subdomain(subdomain: str) -> Optional[str]:
            target = f"{subdomain}.{self.domain}"
            try:
                answers = dns.resolver.resolve(target, 'A')
                return target
            except:
                return None
        
        found = set()
        with ThreadPoolExecutor(max_workers=threads) as executor:
            futures = {executor.submit(check_subdomain, word): word for word in wordlist}
            for future in as_completed(futures):
                result = future.result()
                if result:
                    found.add(result)
                    print(f"[+] Found: {result}")
        
        self.found_subdomains.update(found)
        return found
    
    def certificate_transparency(self) -> Set[str]:
        """Discover subdomains from certificate transparency logs"""
        print("[*] Checking certificate transparency logs...")
        found = set()
        
        try:
            # Using crt.sh API
            url = f"https://crt.sh/?q=%.{self.domain}&output=json"
            response = requests.get(url, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                for entry in data:
                    name = entry.get('name_value', '')
                    # Extract subdomains
                    if self.domain in name:
                        subdomain = name.split('\n')[0].strip()
                        if subdomain.startswith('*.'):
                            subdomain = subdomain[2:]
                        if '.' + self.domain in subdomain or subdomain == self.domain:
                            found.add(subdomain)
            
            self.found_subdomains.update(found)
            print(f"[+] Found {len(found)} subdomains from certificate transparency")
        except Exception as e:
            print(f"[-] Error checking certificate transparency: {e}")
        
        return found
    
    def security_trails(self, api_key: str = None) -> Set[str]:
        """Query SecurityTrails API for subdomains (requires API key)"""
        if not api_key:
            print("[-] SecurityTrails API key required")
            return set()
        
        print("[*] Querying SecurityTrails...")
        found = set()
        
        try:
            headers = {'APIKEY': api_key}
            url = f"https://api.securitytrails.com/v1/domain/{self.domain}/subdomains"
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                for subdomain in data.get('subdomains', []):
                    full_subdomain = f"{subdomain}.{self.domain}"
                    found.add(full_subdomain)
            
            self.found_subdomains.update(found)
            print(f"[+] Found {len(found)} subdomains from SecurityTrails")
        except Exception as e:
            print(f"[-] Error querying SecurityTrails: {e}")
        
        return found
    
    def virustotal(self, api_key: str = None) -> Set[str]:
        """Query VirusTotal API for subdomains (requires API key)"""
        if not api_key:
            print("[-] VirusTotal API key required")
            return set()
        
        print("[*] Querying VirusTotal...")
        found = set()
        
        try:
            headers = {'x-apikey': api_key}
            url = f"https://www.virustotal.com/vtapi/v2/domain/report"
            params = {'domain': self.domain, 'apikey': api_key}
            response = requests.get(url, headers=headers, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                for subdomain in data.get('subdomains', []):
                    found.add(subdomain)
            
            self.found_subdomains.update(found)
            print(f"[+] Found {len(found)} subdomains from VirusTotal")
        except Exception as e:
            print(f"[-] Error querying VirusTotal: {e}")
        
        return found
    
    def discover_all(self, wordlist: List[str] = None, threads: int = 50) -> Set[str]:
        """Run all discovery methods"""
        print(f"[*] Starting subdomain discovery for {self.domain}\n")
        
        # Certificate transparency (no API key needed)
        self.certificate_transparency()
        
        # DNS brute force if wordlist provided
        if wordlist:
            self.dns_brute_force(wordlist, threads)
        
        print(f"\n[+] Total unique subdomains found: {len(self.found_subdomains)}")
        return self.found_subdomains
    
    def save_results(self, filename: str = None):
        """Save discovered subdomains to file"""
        if not filename:
            filename = f"subdomains_{self.domain}.txt"
        
        with open(filename, 'w') as f:
            for subdomain in sorted(self.found_subdomains):
                f.write(f"{subdomain}\n")
        
        print(f"[+] Results saved to {filename}")

def main():
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: python subdomain_discovery.py <domain> [wordlist_file]")
        sys.exit(1)
    
    domain = sys.argv[1]
    discoverer = SubdomainDiscoverer(domain)
    
    wordlist = None
    if len(sys.argv) > 2:
        wordlist_file = sys.argv[2]
        try:
            with open(wordlist_file, 'r') as f:
                wordlist = [line.strip() for line in f if line.strip()]
        except FileNotFoundError:
            print(f"[-] Wordlist file not found: {wordlist_file}")
    
    # Discover subdomains
    subdomains = discoverer.discover_all(wordlist)
    
    # Print results
    print("\n[+] Discovered Subdomains:")
    for subdomain in sorted(subdomains):
        print(f"    {subdomain}")
    
    # Save results
    discoverer.save_results()

if __name__ == '__main__':
    main()

