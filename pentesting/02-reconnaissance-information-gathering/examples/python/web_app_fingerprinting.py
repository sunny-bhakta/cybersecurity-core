#!/usr/bin/env python3
"""
Web Application Fingerprinting Tool
Identifies web applications and their versions.
"""

import sys
import requests
from typing import Dict, List
import re

class WebAppFingerprinting:
    def __init__(self, url: str):
        self.url = url.rstrip('/')
        self.fingerprints = {}
        self.matches = []
    
    def check_headers(self) -> Dict:
        """Check HTTP headers for application fingerprints"""
        print("[*] Checking HTTP headers...")
        
        headers_info = {}
        
        try:
            response = requests.get(self.url, timeout=10, verify=False)
            
            # Server header
            server = response.headers.get('Server', '')
            if server:
                headers_info['server'] = server
            
            # X-Powered-By header
            powered_by = response.headers.get('X-Powered-By', '')
            if powered_by:
                headers_info['powered_by'] = powered_by
            
            # X-Generator header (common in CMS)
            generator = response.headers.get('X-Generator', '')
            if generator:
                headers_info['generator'] = generator
            
            # Set-Cookie headers
            set_cookie = response.headers.get('Set-Cookie', '')
            if set_cookie:
                headers_info['cookie'] = set_cookie
            
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return headers_info
    
    def check_html_content(self) -> Dict:
        """Check HTML content for application fingerprints"""
        print("[*] Checking HTML content...")
        
        content_info = {}
        
        try:
            response = requests.get(self.url, timeout=10, verify=False)
            html = response.text.lower()
            
            # Common CMS patterns
            cms_patterns = {
                'WordPress': [r'wp-content', r'wp-includes', r'/wp-admin/', r'wordpress'],
                'Joomla': [r'/joomla/', r'joomla', r'option=com_'],
                'Drupal': [r'/sites/', r'drupal', r'/modules/', r'/themes/'],
                'Magento': [r'magento', r'/skin/', r'/js/mage/'],
                'Laravel': [r'laravel_session', r'/vendor/laravel/'],
                'Django': [r'csrfmiddlewaretoken', r'/static/admin/'],
                'React': [r'react', r'__react', r'/static/js/'],
                'Vue.js': [r'vue', r'__vue', r'/dist/'],
                'Angular': [r'angular', r'ng-', r'/node_modules/']
            }
            
            for cms, patterns in cms_patterns.items():
                for pattern in patterns:
                    if re.search(pattern, html):
                        content_info[cms] = True
                        self.matches.append(f"{cms} detected via HTML content")
                        break
            
            # Check for meta generator tags
            generator_match = re.search(r'<meta\s+name=["\']generator["\']\s+content=["\']([^"\']+)["\']', html)
            if generator_match:
                content_info['meta_generator'] = generator_match.group(1)
                self.matches.append(f"Generator: {generator_match.group(1)}")
            
            # Check for common paths
            common_paths = [
                '/wp-admin/', '/wp-content/', '/wp-includes/',
                '/administrator/', '/admin/', '/cpanel/',
                '/phpmyadmin/', '/.git/', '/.env'
            ]
            
            for path in common_paths:
                try:
                    test_url = f"{self.url}{path}"
                    test_response = requests.get(test_url, timeout=5, verify=False)
                    if test_response.status_code in [200, 301, 302, 403]:
                        content_info[f'path_{path.replace("/", "_")}'] = True
                        self.matches.append(f"Path found: {path}")
                except:
                    pass
            
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return content_info
    
    def check_robots_txt(self) -> Dict:
        """Check robots.txt for application hints"""
        print("[*] Checking robots.txt...")
        
        robots_info = {}
        
        try:
            robots_url = f"{self.url}/robots.txt"
            response = requests.get(robots_url, timeout=5, verify=False)
            
            if response.status_code == 200:
                robots_content = response.text.lower()
                
                # Look for CMS-specific paths
                if 'wp-admin' in robots_content:
                    robots_info['wordpress'] = True
                    self.matches.append("WordPress detected via robots.txt")
                
                if 'administrator' in robots_content:
                    robots_info['joomla'] = True
                    self.matches.append("Joomla detected via robots.txt")
        
        except:
            pass
        
        return robots_info
    
    def fingerprint(self) -> Dict:
        """Perform complete fingerprinting"""
        print(f"[*] Starting web application fingerprinting for {self.url}\n")
        
        results = {
            'headers': self.check_headers(),
            'content': self.check_html_content(),
            'robots': self.check_robots_txt()
        }
        
        return results
    
    def generate_report(self) -> str:
        """Generate fingerprinting report"""
        results = self.fingerprint()
        
        report = f"# Web Application Fingerprinting Report\n\n"
        report += f"**Target**: {self.url}\n\n"
        
        # Headers
        if results['headers']:
            report += "## HTTP Headers\n\n"
            for key, value in results['headers'].items():
                report += f"**{key}**: {value}\n"
            report += "\n"
        
        # Content analysis
        if results['content']:
            report += "## Content Analysis\n\n"
            detected_apps = [k for k, v in results['content'].items() if v is True and not k.startswith('path_')]
            if detected_apps:
                report += "### Detected Applications\n\n"
                for app in detected_apps:
                    report += f"- {app}\n"
                report += "\n"
            
            if 'meta_generator' in results['content']:
                report += f"**Meta Generator**: {results['content']['meta_generator']}\n\n"
        
        # Matches
        if self.matches:
            report += "## Detection Matches\n\n"
            for match in self.matches:
                report += f"- {match}\n"
            report += "\n"
        
        # Robots.txt
        if results['robots']:
            report += "## Robots.txt Analysis\n\n"
            for key, value in results['robots'].items():
                if value:
                    report += f"- {key.capitalize()} detected\n"
            report += "\n"
        
        report += "## Security Implications\n\n"
        report += "1. **Technology Disclosure**: Reveals application stack\n"
        report += "2. **Version Information**: May reveal specific versions\n"
        report += "3. **Attack Surface**: Identifies potential attack vectors\n"
        report += "4. **Vulnerability Research**: Helps identify known vulnerabilities\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Hide or modify server headers\n"
        report += "2. Remove generator meta tags\n"
        report += "3. Restrict access to sensitive paths\n"
        report += "4. Use security headers\n"
        report += "5. Regularly update applications\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python web_app_fingerprinting.py <url>")
        print("Example: python web_app_fingerprinting.py http://example.com")
        sys.exit(1)
    
    url = sys.argv[1]
    
    fingerprinter = WebAppFingerprinting(url)
    
    report = fingerprinter.generate_report()
    
    filename = "web_app_fingerprint.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Web application fingerprinting complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

