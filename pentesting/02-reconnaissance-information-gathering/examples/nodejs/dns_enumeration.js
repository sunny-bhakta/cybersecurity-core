/**
 * DNS Enumeration Tool
 * Performs comprehensive DNS enumeration including record types, subdomain discovery, and zone transfers.
 */

const dns = require('dns').promises;
const { promisify } = require('util');
const fs = require('fs');

class DNSEnumerator {
    constructor(domain) {
        this.domain = domain;
        this.results = {
            a_records: [],
            aaaa_records: [],
            mx_records: [],
            ns_records: [],
            txt_records: [],
            cname_records: [],
            subdomains: []
        };
    }

    async getARecords() {
        try {
            const addresses = await dns.resolve4(this.domain);
            this.results.a_records = addresses;
            return addresses;
        } catch (error) {
            console.log(`[-] Error getting A records: ${error.message}`);
            return [];
        }
    }

    async getAAAARecords() {
        try {
            const addresses = await dns.resolve6(this.domain);
            this.results.aaaa_records = addresses;
            return addresses;
        } catch (error) {
            console.log(`[-] Error getting AAAA records: ${error.message}`);
            return [];
        }
    }

    async getMXRecords() {
        try {
            const mxRecords = await dns.resolveMx(this.domain);
            const mxList = mxRecords.map(record => ({
                priority: record.priority,
                host: record.exchange
            }));
            this.results.mx_records = mxList;
            return mxList;
        } catch (error) {
            console.log(`[-] Error getting MX records: ${error.message}`);
            return [];
        }
    }

    async getNSRecords() {
        try {
            const nsRecords = await dns.resolveNs(this.domain);
            this.results.ns_records = nsRecords;
            return nsRecords;
        } catch (error) {
            console.log(`[-] Error getting NS records: ${error.message}`);
            return [];
        }
    }

    async getTXTRecords() {
        try {
            const txtRecords = await dns.resolveTxt(this.domain);
            const flattened = txtRecords.flat();
            this.results.txt_records = flattened;
            return flattened;
        } catch (error) {
            console.log(`[-] Error getting TXT records: ${error.message}`);
            return [];
        }
    }

    async getCNAMERecords(subdomain = null) {
        const target = subdomain || this.domain;
        try {
            const cnameRecords = await dns.resolveCname(target);
            this.results.cname_records.push(...cnameRecords);
            return cnameRecords;
        } catch (error) {
            return [];
        }
    }

    async bruteForceSubdomains(wordlist) {
        const foundSubdomains = [];
        console.log(`[*] Brute forcing ${wordlist.length} subdomains...`);

        const promises = wordlist.map(async (subdomain) => {
            const target = `${subdomain}.${this.domain}`;
            try {
                const addresses = await dns.resolve4(target);
                foundSubdomains.push({
                    subdomain: target,
                    ip: addresses[0]
                });
                console.log(`[+] Found: ${target} -> ${addresses[0]}`);
            } catch (error) {
                // Subdomain doesn't exist or can't resolve
            }
        });

        await Promise.all(promises);
        this.results.subdomains = foundSubdomains;
        return foundSubdomains;
    }

    async enumerateAll() {
        console.log(`[*] Enumerating DNS records for ${this.domain}\n`);

        console.log('[*] A Records:');
        const aRecords = await this.getARecords();
        aRecords.forEach(record => console.log(`    ${record}`));

        console.log('\n[*] AAAA Records:');
        const aaaaRecords = await this.getAAAARecords();
        aaaaRecords.forEach(record => console.log(`    ${record}`));

        console.log('\n[*] MX Records:');
        const mxRecords = await this.getMXRecords();
        mxRecords.forEach(record => {
            console.log(`    ${record.priority} ${record.host}`);
        });

        console.log('\n[*] NS Records:');
        const nsRecords = await this.getNSRecords();
        nsRecords.forEach(record => console.log(`    ${record}`));

        console.log('\n[*] TXT Records:');
        const txtRecords = await this.getTXTRecords();
        txtRecords.forEach(record => console.log(`    ${record}`));

        return this.results;
    }

    generateReport() {
        let report = `# DNS Enumeration Report for ${this.domain}\n\n`;
        report += `## A Records\n`;
        this.results.a_records.forEach(record => {
            report += `- ${record}\n`;
        });

        report += `\n## MX Records\n`;
        this.results.mx_records.forEach(record => {
            report += `- ${record.priority} ${record.host}\n`;
        });

        report += `\n## NS Records\n`;
        this.results.ns_records.forEach(record => {
            report += `- ${record}\n`;
        });

        report += `\n## TXT Records\n`;
        this.results.txt_records.forEach(record => {
            report += `- ${record}\n`;
        });

        report += `\n## Subdomains\n`;
        this.results.subdomains.forEach(subdomain => {
            report += `- ${subdomain.subdomain} -> ${subdomain.ip}\n`;
        });

        return report;
    }
}

async function main() {
    const args = process.argv.slice(2);
    if (args.length < 1) {
        console.log('Usage: node dns_enumeration.js <domain> [wordlist_file]');
        process.exit(1);
    }

    const domain = args[0];
    const enumerator = new DNSEnumerator(domain);

    // Perform enumeration
    await enumerator.enumerateAll();

    // If wordlist provided, brute force subdomains
    if (args.length > 1) {
        const wordlistFile = args[1];
        try {
            const wordlist = fs.readFileSync(wordlistFile, 'utf8')
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            await enumerator.bruteForceSubdomains(wordlist);
        } catch (error) {
            console.log(`[-] Wordlist file not found: ${wordlistFile}`);
        }
    }

    // Generate report
    const report = enumerator.generateReport();
    const filename = `dns_enum_${domain}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    console.log(`\n[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = DNSEnumerator;

