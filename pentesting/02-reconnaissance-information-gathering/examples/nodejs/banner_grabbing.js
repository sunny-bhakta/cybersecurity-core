#!/usr/bin/env node
/**
 * Banner Grabbing Tool
 * Grabs service banners to identify versions and technologies.
 */

const net = require('net');
const http = require('http');
const https = require('https');
const fs = require('fs');

class BannerGrabber {
    constructor(target, port) {
        this.target = target;
        this.port = port;
        this.banner = null;
    }

    grabBanner(timeout = 5000) {
        return new Promise((resolve, reject) => {
            console.log(`[*] Grabbing banner from ${this.target}:${this.port}...`);
            
            const socket = new net.Socket();
            socket.setTimeout(timeout);
            
            socket.on('connect', () => {
                socket.on('data', (data) => {
                    this.banner = data.toString('utf8').trim();
                    socket.destroy();
                    resolve(this.banner);
                });
            });
            
            socket.on('timeout', () => {
                socket.destroy();
                reject(new Error('Connection timeout'));
            });
            
            socket.on('error', (err) => {
                reject(err);
            });
            
            socket.connect(this.port, this.target);
        });
    }

    async grabHttpBanner() {
        return new Promise((resolve, reject) => {
            const protocol = this.port === 443 ? https : http;
            const url = `${this.port === 443 ? 'https' : 'http'}://${this.target}:${this.port}`;
            
            protocol.get(url, { timeout: 5000 }, (res) => {
                const info = {
                    server: res.headers['server'] || 'Unknown',
                    poweredBy: res.headers['x-powered-by'] || 'Unknown',
                    version: this.extractVersion(res.headers['server'] || '')
                };
                resolve(info);
            }).on('error', (err) => {
                reject(err);
            });
        });
    }

    extractVersion(banner) {
        const versionMatch = banner.match(/(\d+\.\d+(?:\.\d+)?)/);
        return versionMatch ? versionMatch[1] : 'Unknown';
    }

    async generateReport() {
        let banner = null;
        let httpInfo = null;
        
        try {
            banner = await this.grabBanner();
        } catch (err) {
            console.log(`[-] Could not grab banner: ${err.message}`);
        }
        
        if (this.port === 80 || this.port === 443 || this.port === 8080 || this.port === 8443) {
            try {
                httpInfo = await this.grabHttpBanner();
            } catch (err) {
                console.log(`[-] Could not grab HTTP banner: ${err.message}`);
            }
        }
        
        let report = `# Banner Grabbing Report for ${this.target}:${this.port}\n\n`;
        
        if (banner) {
            report += `## Banner\n\n`;
            report += `\`\`\`\n${banner}\n\`\`\`\n\n`;
        }
        
        if (httpInfo) {
            report += `## HTTP Headers\n\n`;
            report += `**Server**: ${httpInfo.server}\n\n`;
            report += `**X-Powered-By**: ${httpInfo.poweredBy}\n\n`;
        }
        
        if (!banner && !httpInfo) {
            report += `[-] Could not grab banner.\n\n`;
        }
        
        report += `## Usage\n\n`;
        report += `Banner information can reveal:\n`;
        report += `- Service versions\n`;
        report += `- Technology stack\n`;
        report += `- Potential vulnerabilities\n\n`;
        
        return report;
    }
}

// Main execution
async function main() {
    if (process.argv.length < 4) {
        console.log('Usage: node banner_grabbing.js <target> <port>');
        console.log('Example: node banner_grabbing.js 192.168.1.100 22');
        process.exit(1);
    }
    
    const target = process.argv[2];
    const port = parseInt(process.argv[3]);
    
    const grabber = new BannerGrabber(target, port);
    
    const report = await grabber.generateReport();
    
    const filename = `banner_${target.replace(/\./g, '_')}_${port}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Banner grabbing complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = BannerGrabber;

