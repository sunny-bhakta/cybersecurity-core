#!/usr/bin/env node
/**
 * Subdomain Discovery Tool
 * Discovers subdomains for a given domain.
 */

const dns = require('dns').promises;
const { promisify } = require('util');
const fs = require('fs');

class SubdomainDiscovery {
    constructor(domain) {
        this.domain = domain;
        this.subdomains = [];
        this.commonSubdomains = [
            'www', 'mail', 'ftp', 'localhost', 'webmail', 'smtp', 'pop', 'ns1',
            'webdisk', 'ns2', 'cpanel', 'whm', 'autodiscover', 'autoconfig',
            'm', 'imap', 'test', 'ns', 'blog', 'pop3', 'dev', 'www2', 'admin',
            'forum', 'news', 'vpn', 'ns3', 'mail2', 'new', 'mysql', 'old',
            'lists', 'support', 'mobile', 'mx', 'static', 'docs', 'beta',
            'shop', 'sql', 'secure', 'demo', 'cp', 'calendar', 'wiki', 'web',
            'media', 'email', 'images', 'img', 'www1', 'intranet', 'portal',
            'video', 'sip', 'dns2', 'api', 'cdn', 'stats', 'dns1', 'ns4',
            'www3', 'dns', 'search', 'staging', 'server', 'mx1', 'chat',
            'wap', 'my', 'svn', 'mail1', 'sites', 'proxy', 'ads', 'host',
            'cms', 'backup', 'mx2', 'lyncdiscover', 'info', 'apps', 'download',
            'remote', 'db', 'forums', 'store', 'relay', 'files', 'news',
            'live', 'owa', 'en', 'start', 'sms', 'office', 'exchange',
            'ipv4'
        ];
    }

    async checkSubdomain(subdomain) {
        const hostname = `${subdomain}.${this.domain}`;
        try {
            await dns.resolve4(hostname);
            return { subdomain: hostname, found: true };
        } catch (err) {
            try {
                await dns.resolve6(hostname);
                return { subdomain: hostname, found: true };
            } catch (err2) {
                return { subdomain: hostname, found: false };
            }
        }
    }

    async discoverCommon() {
        console.log(`[*] Discovering common subdomains for ${this.domain}...`);
        
        const results = [];
        const promises = this.commonSubdomains.map(sub => this.checkSubdomain(sub));
        const checked = await Promise.all(promises);
        
        checked.forEach(result => {
            if (result.found) {
                results.push(result.subdomain);
                this.subdomains.push(result.subdomain);
                console.log(`[+] Found: ${result.subdomain}`);
            }
        });
        
        return results;
    }

    async discoverFromWordlist(wordlistFile) {
        if (!wordlistFile || !fs.existsSync(wordlistFile)) {
            return [];
        }
        
        console.log(`[*] Discovering from wordlist: ${wordlistFile}...`);
        
        const wordlist = fs.readFileSync(wordlistFile, 'utf8')
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);
        
        const results = [];
        const batchSize = 50;
        
        for (let i = 0; i < wordlist.length; i += batchSize) {
            const batch = wordlist.slice(i, i + batchSize);
            const promises = batch.map(word => this.checkSubdomain(word));
            const checked = await Promise.all(promises);
            
            checked.forEach(result => {
                if (result.found) {
                    results.push(result.subdomain);
                    this.subdomains.push(result.subdomain);
                    console.log(`[+] Found: ${result.subdomain}`);
                }
            });
        }
        
        return results;
    }

    generateReport() {
        let report = `# Subdomain Discovery Report for ${this.domain}\n\n`;
        report += `**Total Subdomains Found**: ${this.subdomains.length}\n\n`;
        
        if (this.subdomains.length > 0) {
            report += `## Discovered Subdomains\n\n`;
            this.subdomains.forEach(subdomain => {
                report += `- ${subdomain}\n`;
            });
            report += `\n`;
        } else {
            report += `[-] No subdomains found.\n\n`;
        }
        
        report += `## Usage Notes\n\n`;
        report += `1. This tool checks DNS resolution for subdomains\n`;
        report += `2. Results may vary based on DNS configuration\n`;
        report += `3. Some subdomains may require specific DNS records\n`;
        report += `4. Use wordlists for comprehensive discovery\n\n`;
        
        return report;
    }
}

// Main execution
async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node subdomain_discovery.js <domain> [wordlist_file]');
        console.log('Example: node subdomain_discovery.js example.com');
        console.log('Example: node subdomain_discovery.js example.com wordlist.txt');
        process.exit(1);
    }
    
    const domain = process.argv[2];
    const wordlistFile = process.argv[3];
    
    const discovery = new SubdomainDiscovery(domain);
    
    await discovery.discoverCommon();
    
    if (wordlistFile) {
        await discovery.discoverFromWordlist(wordlistFile);
    }
    
    const report = discovery.generateReport();
    
    const filename = `subdomain_discovery_${domain.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`\n[+] Subdomain discovery complete`);
    console.log(`[+] Found ${discovery.subdomains.length} subdomains`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = SubdomainDiscovery;

