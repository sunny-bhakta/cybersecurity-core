#!/usr/bin/env node
/**
 * Email Harvester Tool
 * Harvests email addresses from various sources.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class EmailHarvester {
    constructor(domain) {
        this.domain = domain;
        this.emails = new Set();
        this.sources = [];
    }

    extractEmailsFromText(text) {
        const pattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
        const emails = text.match(pattern) || [];
        const domainEmails = emails.filter(e => 
            e.toLowerCase().includes(this.domain.toLowerCase())
        );
        return domainEmails;
    }

    async harvestFromWebsite(url) {
        return new Promise((resolve, reject) => {
            console.log(`[*] Harvesting from: ${url}`);
            
            const protocol = url.startsWith('https') ? https : http;
            
            protocol.get(url, { timeout: 10000, headers: { 'User-Agent': 'Mozilla/5.0' } }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    const emails = this.extractEmailsFromText(data);
                    if (emails.length > 0) {
                        this.sources.push(`Website: ${url}`);
                    }
                    resolve(emails);
                });
            }).on('error', (err) => {
                console.log(`[-] Error: ${err.message}`);
                resolve([]);
            });
        });
    }

    async harvestAll() {
        console.log(`[*] Starting email harvest for domain: ${this.domain}`);

        const mainUrl = `https://${this.domain}`;
        const emails = await this.harvestFromWebsite(mainUrl);
        emails.forEach(e => this.emails.add(e));

        const contactUrls = [
            `https://${this.domain}/contact`,
            `https://${this.domain}/about`,
            `https://${this.domain}/team`
        ];

        for (const url of contactUrls) {
            const emails = await this.harvestFromWebsite(url);
            emails.forEach(e => this.emails.add(e));
        }

        return Array.from(this.emails);
    }

    generateReport() {
        let report = `# Email Harvest Report for ${this.domain}\n\n`;
        report += `**Total Emails Found**: ${this.emails.size}\n\n`;

        if (this.emails.size > 0) {
            report += `## Emails Found\n\n`;
            Array.from(this.emails).sort().forEach(email => {
                report += `- ${email}\n`;
            });
            report += `\n`;
        } else {
            report += `[-] No emails found.\n\n`;
        }

        if (this.sources.length > 0) {
            report += `## Sources\n\n`;
            this.sources.forEach(source => {
                report += `- ${source}\n`;
            });
            report += `\n`;
        }

        report += `## Usage Notes\n\n`;
        report += `⚠️ **WARNING**: Only harvest emails from sources you have permission to access.\n`;
        report += `⚠️ Respect privacy and applicable laws (GDPR, CAN-SPAM, etc.).\n\n`;

        return report;
    }
}

// Main execution
async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node email_harvester.js <domain>');
        console.log('Example: node email_harvester.js example.com');
        process.exit(1);
    }

    const domain = process.argv[2];

    const harvester = new EmailHarvester(domain);
    await harvester.harvestAll();

    const report = harvester.generateReport();

    const filename = `email_harvest_${domain.replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');

    console.log(`\n[+] Email harvest complete`);
    console.log(`[+] Found ${harvester.emails.size} emails`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only use on domains you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = EmailHarvester;

