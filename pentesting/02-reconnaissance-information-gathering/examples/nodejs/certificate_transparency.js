/**
 * Certificate Transparency Scanner
 * Discovers subdomains from Certificate Transparency logs.
 */

const https = require('https');
const fs = require('fs');

class CertificateTransparency {
    constructor() {
        this.subdomains = new Set();
    }

    queryCrtSh(domain) {
        return new Promise((resolve, reject) => {
            console.log(`[*] Querying crt.sh for ${domain}...`);
            const url = `https://crt.sh/?q=${domain}&output=json`;

            https.get(url, (res) => {
                let data = '';

                res.on('data', (chunk) => {
                    data += chunk;
                });

                res.on('end', () => {
                    try {
                        const entries = JSON.parse(data);
                        const subdomains = new Set();

                        entries.forEach(entry => {
                            const nameValue = entry.name_value || '';
                            nameValue.split('\n').forEach(name => {
                                const trimmed = name.trim().toLowerCase();
                                if (trimmed && trimmed.includes(domain)) {
                                    subdomains.add(trimmed);
                                }
                            });
                        });

                        resolve(subdomains);
                    } catch (error) {
                        reject(error);
                    }
                });
            }).on('error', reject);
        });
    }

    async scanDomain(domain) {
        console.log(`[*] Scanning Certificate Transparency logs for ${domain}...\n`);

        try {
            const subdomains = await this.queryCrtSh(domain);
            this.subdomains = subdomains;
            console.log(`[+] Found ${subdomains.size} subdomains from crt.sh`);
            return subdomains;
        } catch (error) {
            console.log(`[-] Error scanning CT logs: ${error.message}`);
            return new Set();
        }
    }

    generateReport(domain) {
        const subdomains = Array.from(this.subdomains).sort();

        let report = `# Certificate Transparency Scan Report for ${domain}\n\n`;
        report += `## Summary\n\n`;
        report += `Total Subdomains Found: ${subdomains.length}\n\n`;

        if (subdomains.length > 0) {
            report += `## Discovered Subdomains\n\n`;
            subdomains.forEach((subdomain, i) => {
                report += `${i + 1}. ${subdomain}\n`;
            });
            report += `\n`;
        } else {
            report += `No subdomains found in Certificate Transparency logs.\n\n`;
        }

        report += `## Sources\n\n`;
        report += `- crt.sh (Certificate Transparency Log Search)\n\n`;

        return report;
    }
}

async function main() {
    const args = process.argv.slice(2);
    if (args.length < 1) {
        console.log('Usage: node certificate_transparency.js <domain>');
        console.log('Example: node certificate_transparency.js example.com');
        process.exit(1);
    }

    const domain = args[0];
    const ct = new CertificateTransparency();

    await ct.scanDomain(domain);

    const report = ct.generateReport(domain);
    const filename = `ct_scan_${domain.replace(/\./g, '_')}.md`;

    fs.writeFileSync(filename, report, 'utf8');

    console.log(`\n[+] Scan complete. Found ${ct.subdomains.size} subdomains`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = CertificateTransparency;

