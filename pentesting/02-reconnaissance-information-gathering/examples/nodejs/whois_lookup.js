/**
 * WHOIS Lookup Tool
 * Performs WHOIS queries to gather domain registration information.
 */

const { exec } = require('child_process');
const { promisify } = require('util');
const fs = require('fs');
const net = require('net');

const execAsync = promisify(exec);

class WhoisLookup {
    constructor() {
        this.whoisServers = {
            'com': 'whois.verisign-grs.com',
            'net': 'whois.verisign-grs.com',
            'org': 'whois.pir.org',
            'edu': 'whois.educause.edu',
            'uk': 'whois.nic.uk'
        };
    }

    getTLD(domain) {
        const parts = domain.split('.');
        return parts.length >= 2 ? parts[parts.length - 1].toLowerCase() : 'com';
    }

    async queryWhois(domain) {
        try {
            const { stdout } = await execAsync(`whois ${domain}`, { timeout: 30000 });
            return stdout;
        } catch (error) {
            console.log(`[-] Error querying WHOIS: ${error.message}`);
            return null;
        }
    }

    parseWhois(whoisData) {
        const info = {
            domain: '',
            registrar: '',
            creation_date: '',
            expiration_date: '',
            updated_date: '',
            name_servers: [],
            status: []
        };

        if (!whoisData) return info;

        const lines = whoisData.split('\n');
        const nameServers = new Set();

        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('%') || trimmed.startsWith('#')) continue;

            if (trimmed.toLowerCase().includes('domain name:')) {
                info.domain = trimmed.split(':').slice(1).join(':').trim().toUpperCase();
            }
            if (trimmed.toLowerCase().includes('registrar:')) {
                info.registrar = trimmed.split(':').slice(1).join(':').trim();
            }
            if (trimmed.toLowerCase().includes('creation date:') || trimmed.toLowerCase().includes('created:')) {
                info.creation_date = trimmed.split(':').slice(1).join(':').trim();
            }
            if (trimmed.toLowerCase().includes('expiration date:') || trimmed.toLowerCase().includes('expires:')) {
                info.expiration_date = trimmed.split(':').slice(1).join(':').trim();
            }
            if (trimmed.toLowerCase().includes('name server:') || trimmed.toLowerCase().includes('nserver:')) {
                const ns = trimmed.split(':').slice(1).join(':').trim().toLowerCase();
                if (ns) nameServers.add(ns);
            }
        }

        info.name_servers = Array.from(nameServers);
        return info;
    }

    async generateReport(domain) {
        console.log(`[*] Querying WHOIS for ${domain}...`);
        const whoisData = await this.queryWhois(domain);

        if (!whoisData) {
            return `# WHOIS Lookup Report for ${domain}\n\n[-] Failed to retrieve WHOIS data.\n`;
        }

        const info = this.parseWhois(whoisData);

        let report = `# WHOIS Lookup Report for ${domain}\n\n`;
        report += `## Domain Information\n\n`;
        report += `**Domain**: ${info.domain || domain}\n\n`;
        report += `**Registrar**: ${info.registrar || 'Not found'}\n\n`;
        report += `**Creation Date**: ${info.creation_date || 'Not found'}\n\n`;
        report += `**Expiration Date**: ${info.expiration_date || 'Not found'}\n\n`;

        if (info.name_servers.length > 0) {
            report += `## Name Servers\n\n`;
            info.name_servers.forEach(ns => {
                report += `- ${ns}\n`;
            });
            report += `\n`;
        }

        report += `## Raw WHOIS Data\n\n`;
        report += `\`\`\`\n`;
        report += whoisData;
        report += `\n\`\`\`\n\n`;

        return report;
    }
}

async function main() {
    const args = process.argv.slice(2);
    if (args.length < 1) {
        console.log('Usage: node whois_lookup.js <domain>');
        console.log('Example: node whois_lookup.js example.com');
        process.exit(1);
    }

    const domain = args[0];
    const lookup = new WhoisLookup();

    const report = await lookup.generateReport(domain);
    const filename = `whois_${domain.replace(/\./g, '_')}.md`;

    fs.writeFileSync(filename, report, 'utf8');

    console.log(`[+] WHOIS lookup complete for ${domain}`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = WhoisLookup;

