#!/usr/bin/env node
/**
 * Risk Assessment Calculator
 * Calculates risk scores based on likelihood and impact.
 */

const fs = require('fs');

class RiskAssessmentCalculator {
    constructor() {
        this.cvssBaseScores = {
            'Critical': 9.0,
            'High': 7.0,
            'Medium': 4.0,
            'Low': 0.0
        };
        
        this.likelihoodMultipliers = {
            'Very High': 1.0,
            'High': 0.8,
            'Medium': 0.6,
            'Low': 0.4,
            'Very Low': 0.2
        };
        
        this.impactMultipliers = {
            'Critical': 1.0,
            'High': 0.8,
            'Medium': 0.6,
            'Low': 0.4,
            'Minimal': 0.2
        };
        
        this.riskLevels = {
            'Critical': { min: 9.0, color: 'ðŸ”´' },
            'High': { min: 7.0, color: 'ðŸŸ ' },
            'Medium': { min: 4.0, color: 'ðŸŸ¡' },
            'Low': { min: 1.0, color: 'ðŸŸ¢' },
            'Informational': { min: 0.0, color: 'âšª' }
        };
    }

    calculateRiskScore(cvssScore, likelihood, businessImpact) {
        const likelihoodMult = this.likelihoodMultipliers[likelihood] || 0.5;
        const impactMult = this.impactMultipliers[businessImpact] || 0.5;
        
        const adjustedScore = cvssScore * likelihoodMult * impactMult;
        
        return {
            cvssBaseScore: cvssScore,
            likelihood: likelihood,
            businessImpact: businessImpact,
            adjustedRiskScore: Math.round(adjustedScore * 100) / 100,
            riskLevel: this.getRiskLevel(adjustedScore),
            riskScoreNumeric: adjustedScore
        };
    }

    getRiskLevel(score) {
        if (score >= 9.0) {
            return 'Critical';
        } else if (score >= 7.0) {
            return 'High';
        } else if (score >= 4.0) {
            return 'Medium';
        } else if (score >= 1.0) {
            return 'Low';
        } else {
            return 'Informational';
        }
    }

    assessVulnerability(vulnerability) {
        const cvss = vulnerability.cvssScore || 0.0;
        const likelihood = vulnerability.likelihood || 'Medium';
        const impact = vulnerability.businessImpact || 'Medium';
        
        const assessment = this.calculateRiskScore(cvss, likelihood, impact);
        
        return {
            vulnerabilityName: vulnerability.name || 'Unknown',
            description: vulnerability.description || '',
            affectedSystems: vulnerability.affectedSystems || [],
            ...assessment
        };
    }

    prioritizeVulnerabilities(vulnerabilities) {
        const assessments = vulnerabilities.map(v => this.assessVulnerability(v));
        return assessments.sort((a, b) => b.riskScoreNumeric - a.riskScoreNumeric);
    }

    calculateOverallRisk(vulnerabilities) {
        const prioritized = this.prioritizeVulnerabilities(vulnerabilities);
        
        const critical = prioritized.filter(v => v.riskLevel === 'Critical').length;
        const high = prioritized.filter(v => v.riskLevel === 'High').length;
        const medium = prioritized.filter(v => v.riskLevel === 'Medium').length;
        const low = prioritized.filter(v => v.riskLevel === 'Low').length;
        const informational = prioritized.filter(v => v.riskLevel === 'Informational').length;
        
        const totalScore = prioritized.reduce((sum, v) => sum + v.riskScoreNumeric, 0);
        const averageScore = totalScore / prioritized.length;
        
        return {
            total: prioritized.length,
            critical: critical,
            high: high,
            medium: medium,
            low: low,
            informational: informational,
            averageScore: averageScore.toFixed(2),
            overallLevel: this.getRiskLevel(averageScore)
        };
    }

    generateRiskMatrix() {
        let matrix = `## Risk Matrix (Adjusted Risk Scores)\n\n`;
        matrix += `| Business Impact \\ Likelihood | Very Low | Low | Medium | High | Very High |\n`;
        matrix += `|------------------------------|----------|-----|--------|------|-----------|\n`;
        
        const impacts = ['Critical', 'High', 'Medium', 'Low', 'Minimal'];
        const cvssScores = { 'Critical': 9.0, 'High': 7.0, 'Medium': 4.0, 'Low': 2.0, 'Minimal': 1.0 };
        
        impacts.forEach(impact => {
            const row = [impact];
            const baseCvss = cvssScores[impact] || 4.0;
            
            ['Very Low', 'Low', 'Medium', 'High', 'Very High'].forEach(likelihood => {
                const result = this.calculateRiskScore(baseCvss, likelihood, impact);
                const level = result.riskLevel;
                const color = this.riskLevels[level].color;
                row.push(`${color} ${result.adjustedRiskScore.toFixed(2)}`);
            });
            matrix += `| ${row.join(' | ')} |\n`;
        });
        
        matrix += `\n`;
        return matrix;
    }

    generateReport(vulnerabilities, projectName = 'Security Assessment') {
        const date = new Date().toISOString().split('T')[0];
        
        let report = `# Risk Assessment Report\n\n`;
        report += `**Project**: ${projectName}\n`;
        report += `**Assessment Date**: ${date}\n\n`;
        report += `---\n\n`;
        
        // Overall Summary
        const overall = this.calculateOverallRisk(vulnerabilities);
        report += `## Executive Summary\n\n`;
        report += `**Total Vulnerabilities**: ${overall.total}\n\n`;
        report += `### Risk Distribution\n\n`;
        report += `| Risk Level | Count |\n`;
        report += `|------------|-------|\n`;
        report += `| ðŸ”´ Critical | ${overall.critical} |\n`;
        report += `| ðŸŸ  High | ${overall.high} |\n`;
        report += `| ðŸŸ¡ Medium | ${overall.medium} |\n`;
        report += `| ðŸŸ¢ Low | ${overall.low} |\n`;
        report += `| âšª Informational | ${overall.informational} |\n\n`;
        report += `**Average Risk Score**: ${overall.averageScore}\n\n`;
        report += `**Overall Risk Level**: ${overall.overallLevel}\n\n`;
        report += `---\n\n`;
        
        // Risk Matrix
        report += this.generateRiskMatrix();
        
        // Detailed Findings
        report += `## Detailed Findings\n\n`;
        
        const prioritized = this.prioritizeVulnerabilities(vulnerabilities);
        
        prioritized.forEach((vuln, index) => {
            const color = this.riskLevels[vuln.riskLevel].color;
            report += `### ${index + 1}. ${vuln.vulnerabilityName}\n\n`;
            report += `**Risk Level**: ${color} ${vuln.riskLevel}\n\n`;
            report += `**CVSS Base Score**: ${vuln.cvssBaseScore}\n\n`;
            report += `**Adjusted Risk Score**: ${vuln.adjustedRiskScore}\n\n`;
            report += `**Likelihood**: ${vuln.likelihood}\n\n`;
            report += `**Business Impact**: ${vuln.businessImpact}\n\n`;
            report += `**Description**: ${vuln.description}\n\n`;
            
            if (vuln.affectedSystems && vuln.affectedSystems.length > 0) {
                report += `**Affected Systems**:\n`;
                vuln.affectedSystems.forEach(system => {
                    report += `- ${system}\n`;
                });
                report += `\n`;
            }
            
            report += `---\n\n`;
        });
        
        // Recommendations
        report += `## Recommendations\n\n`;
        report += `1. **Immediate Action Required**: Address all Critical and High risk vulnerabilities\n`;
        report += `2. **Short-term**: Plan remediation for Medium risk vulnerabilities\n`;
        report += `3. **Long-term**: Implement security controls to prevent Low risk vulnerabilities\n`;
        report += `4. **Continuous Monitoring**: Regularly reassess risks as environment changes\n\n`;
        
        return report;
    }
}

// Main execution
function main() {
    console.log('Risk Assessment Calculator');
    console.log('='.repeat(50));
    
    const calculator = new RiskAssessmentCalculator();
    
    // Example vulnerabilities
    const exampleVulnerabilities = [
        {
            name: 'SQL Injection in Login Form',
            description: 'SQL injection vulnerability allows authentication bypass',
            cvssScore: 9.8,
            likelihood: 'Very High',
            businessImpact: 'Critical',
            affectedSystems: ['Web Application - Login Page']
        },
        {
            name: 'Weak Password Policy',
            description: 'Password policy allows weak passwords',
            cvssScore: 5.3,
            likelihood: 'High',
            businessImpact: 'Medium',
            affectedSystems: ['User Management System']
        },
        {
            name: 'Missing Security Headers',
            description: 'X-Frame-Options and CSP headers not configured',
            cvssScore: 3.1,
            likelihood: 'Medium',
            businessImpact: 'Low',
            affectedSystems: ['Web Application']
        },
        {
            name: 'Information Disclosure in Error Messages',
            description: 'Error messages reveal sensitive system information',
            cvssScore: 4.3,
            likelihood: 'Medium',
            businessImpact: 'Medium',
            affectedSystems: ['API Endpoints']
        }
    ];
    
    const report = calculator.generateReport(exampleVulnerabilities, 'Example Web Application');
    
    const filename = 'risk_assessment_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Risk assessment complete`);
    console.log(`[+] Report saved to ${filename}`);
    
    // Display summary
    const overall = calculator.calculateOverallRisk(exampleVulnerabilities);
    // Display summary
    const prioritized = calculator.prioritizeVulnerabilities(exampleVulnerabilities);
    console.log(`\n[+] Summary:`);
    console.log(`    Total Vulnerabilities: ${overall.total}`);
    console.log(`    Critical: ${overall.critical}, High: ${overall.high}, Medium: ${overall.medium}, Low: ${overall.low}, Informational: ${overall.informational}`);
    console.log(`    Overall Risk Level: ${overall.overallLevel}`);
    
    console.log(`\n[+] Top 3 Highest Risk Vulnerabilities:`);
    prioritized.slice(0, 3).forEach((vuln, index) => {
        console.log(`\n${index + 1}. ${vuln.vulnerabilityName}`);
        console.log(`   Risk Level: ${vuln.riskLevel}`);
        console.log(`   Risk Score: ${vuln.adjustedRiskScore}`);
    });
}

if (require.main === module) {
    main();
}

module.exports = RiskAssessmentCalculator;

