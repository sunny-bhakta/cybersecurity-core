/**
 * Rules of Engagement (ROE) Template Generator
 * Generates a customizable ROE document for penetration testing engagements.
 */

const fs = require('fs');
const path = require('path');

class ROETemplateGenerator {
    constructor() {
        this.template = {
            client_name: '',
            project_name: '',
            date: new Date().toISOString().split('T')[0],
            scope: [],
            out_of_scope: [],
            testing_windows: [],
            contacts: {},
            emergency_procedures: {},
            data_handling: {},
            reporting: {}
        };
    }

    generateROE(config) {
        let roeDoc = `# RULES OF ENGAGEMENT (ROE)
## Penetration Testing Engagement

**Client**: ${config.client_name || 'N/A'}
**Project**: ${config.project_name || 'N/A'}
**Date**: ${config.date || new Date().toISOString().split('T')[0]}
**Engagement Type**: ${config.engagement_type || 'N/A'}

---

## 1. SCOPE OF ENGAGEMENT

### In-Scope Systems
`;

        (config.scope || []).forEach(item => {
            roeDoc += `- ${item}\n`;
        });

        roeDoc += `\n### Out-of-Scope Systems\n`;
        (config.out_of_scope || []).forEach(item => {
            roeDoc += `- ${item}\n`;
        });

        roeDoc += `\n---\n\n## 2. TESTING WINDOWS\n\n`;
        (config.testing_windows || []).forEach(window => {
            roeDoc += `- **${window.name || 'Window'}**: ${window.time || 'N/A'}\n`;
        });

        roeDoc += `\n---\n\n## 3. CONTACT INFORMATION\n\n### Client Contacts
- **Primary Contact**: ${config.contacts?.primary || 'N/A'}
- **Technical Contact**: ${config.contacts?.technical || 'N/A'}
- **Emergency Contact**: ${config.contacts?.emergency || 'N/A'}

### Testing Team Contacts
- **Lead Tester**: ${config.contacts?.lead_tester || 'N/A'}
- **Project Manager**: ${config.contacts?.project_manager || 'N/A'}

---

## 4. AUTHORIZATION

This penetration test is authorized by:
- **Authorized By**: ${config.authorization?.authorized_by || 'N/A'}
- **Authorization Date**: ${config.authorization?.date || 'N/A'}
- **Authorization Reference**: ${config.authorization?.reference || 'N/A'}

---

## 5. TESTING METHODOLOGY

**Methodology**: ${config.methodology || 'PTES - Penetration Testing Execution Standard'}

**Testing Approach**: ${config.testing_approach || 'Gray Box'}

---

## 6. RESTRICTIONS AND LIMITATIONS

### Prohibited Activities
`;

        (config.prohibited_activities || []).forEach(activity => {
            roeDoc += `- ${activity}\n`;
        });

        roeDoc += `\n### Rate Limiting
- **Request Rate**: ${config.rate_limiting?.max_requests_per_second || 'N/A'} requests/second
- **Concurrent Connections**: ${config.rate_limiting?.max_concurrent || 'N/A'}

---

## 7. EMERGENCY PROCEDURES

### Incident Response
${config.emergency_procedures?.incident_response || 'Contact emergency contact immediately'}

### Service Disruption
${config.emergency_procedures?.service_disruption || 'Stop all testing activities immediately'}

### Emergency Contact
- **Phone**: ${config.emergency_procedures?.phone || 'N/A'}
- **Email**: ${config.emergency_procedures?.email || 'N/A'}

---

## 8. DATA HANDLING

### Data Collection
${config.data_handling?.collection || 'Only collect data necessary for testing'}

### Data Storage
${config.data_handling?.storage || 'Store data in encrypted format'}

### Data Retention
${config.data_handling?.retention || 'Retain data for 30 days after engagement completion'}

### Data Destruction
${config.data_handling?.destruction || 'Securely delete all collected data after retention period'}

---

## 9. REPORTING REQUIREMENTS

### Report Deliverables
`;

        (config.reporting?.deliverables || []).forEach(deliverable => {
            roeDoc += `- ${deliverable}\n`;
        });

        roeDoc += `\n### Report Timeline
- **Draft Report**: ${config.reporting?.draft_timeline || 'N/A'}
- **Final Report**: ${config.reporting?.final_timeline || 'N/A'}

---

## 10. LEGAL AND COMPLIANCE

### Compliance Requirements
`;

        (config.compliance || []).forEach(requirement => {
            roeDoc += `- ${requirement}\n`;
        });

        roeDoc += `\n---

## 11. SIGNATURES

**Client Signature**: _________________ Date: _______

**Testing Team Signature**: _________________ Date: _______

---

**Document Version**: 1.0
**Last Updated**: ${new Date().toISOString().split('T')[0]}

**IMPORTANT**: This document must be signed by authorized personnel before testing begins.
`;

        return roeDoc;
    }

    saveROE(config, filename = 'roe_document.md') {
        const roeContent = this.generateROE(config);
        fs.writeFileSync(filename, roeContent, 'utf8');
        console.log(`[+] ROE document saved to ${filename}`);
    }
}

// Example usage
function main() {
    const generator = new ROETemplateGenerator();

    const config = {
        client_name: 'Example Corporation',
        project_name: 'Web Application Security Assessment',
        engagement_type: 'Gray Box Penetration Test',
        scope: [
            'https://example.com',
            'https://api.example.com',
            'Internal network (192.168.1.0/24)'
        ],
        out_of_scope: [
            'Production database servers',
            'Third-party services',
            'Social engineering attacks'
        ],
        testing_windows: [
            { name: 'Weekdays', time: '09:00 - 17:00 EST' },
            { name: 'Weekends', time: 'No testing' }
        ],
        contacts: {
            primary: 'client@example.com',
            technical: 'tech@example.com',
            emergency: '+1-555-0123',
            lead_tester: 'tester@securityfirm.com',
            project_manager: 'pm@securityfirm.com'
        },
        authorization: {
            authorized_by: 'John Doe, CISO',
            date: '2024-01-15',
            reference: 'AUTH-2024-001'
        },
        methodology: 'PTES - Penetration Testing Execution Standard',
        testing_approach: 'Gray Box',
        prohibited_activities: [
            'Denial of Service (DoS) attacks',
            'Physical security testing',
            'Social engineering',
            'Data exfiltration beyond testing needs'
        ],
        rate_limiting: {
            max_requests_per_second: '10',
            max_concurrent: '5'
        },
        emergency_procedures: {
            incident_response: 'Contact emergency contact immediately',
            service_disruption: 'Stop all testing activities immediately',
            phone: '+1-555-0123',
            email: 'emergency@example.com'
        },
        data_handling: {
            collection: 'Only collect data necessary for testing',
            storage: 'Store data in encrypted format on secure servers',
            retention: '30 days after engagement completion',
            destruction: 'Securely delete using DoD 5220.22-M standard'
        },
        reporting: {
            deliverables: [
                'Executive Summary',
                'Technical Findings Report',
                'Remediation Recommendations',
                'Raw Data (upon request)'
            ],
            draft_timeline: '5 business days after testing completion',
            final_timeline: '10 business days after testing completion'
        },
        compliance: [
            'GDPR compliance required',
            'PCI DSS considerations',
            'Internal security policies'
        ]
    };

    generator.saveROE(config, 'roe_document.md');
    console.log('\n[+] ROE template generated successfully!');
    console.log('[!] Review and customize the generated document before use.');
}

if (require.main === module) {
    main();
}

module.exports = ROETemplateGenerator;

