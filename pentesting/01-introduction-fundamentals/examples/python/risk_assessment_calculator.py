#!/usr/bin/env python3
"""
Risk Assessment Calculator
Calculates risk scores based on CVSS, likelihood, and business impact.
"""

from typing import Dict, List
from enum import Enum

class RiskLevel(Enum):
    CRITICAL = "Critical"
    HIGH = "High"
    MEDIUM = "Medium"
    LOW = "Low"
    INFORMATIONAL = "Informational"

class RiskCalculator:
    def __init__(self):
        self.cvss_base_scores = {
            'Critical': 9.0,
            'High': 7.0,
            'Medium': 4.0,
            'Low': 0.0
        }
    
    def calculate_risk_score(self, cvss_score: float, likelihood: str, business_impact: str) -> Dict:
        """
        Calculate risk score based on CVSS, likelihood, and business impact
        
        Args:
            cvss_score: CVSS base score (0.0 - 10.0)
            likelihood: Likelihood of exploitation (Very High, High, Medium, Low, Very Low)
            business_impact: Business impact (Critical, High, Medium, Low, Minimal)
        
        Returns:
            Dictionary with risk score and level
        """
        # Likelihood multipliers
        likelihood_multipliers = {
            'Very High': 1.0,
            'High': 0.8,
            'Medium': 0.6,
            'Low': 0.4,
            'Very Low': 0.2
        }
        
        # Business impact multipliers
        impact_multipliers = {
            'Critical': 1.0,
            'High': 0.8,
            'Medium': 0.6,
            'Low': 0.4,
            'Minimal': 0.2
        }
        
        # Calculate adjusted score
        likelihood_mult = likelihood_multipliers.get(likelihood, 0.5)
        impact_mult = impact_multipliers.get(business_impact, 0.5)
        
        adjusted_score = cvss_score * likelihood_mult * impact_mult
        
        # Determine risk level
        if adjusted_score >= 9.0:
            risk_level = RiskLevel.CRITICAL
        elif adjusted_score >= 7.0:
            risk_level = RiskLevel.HIGH
        elif adjusted_score >= 4.0:
            risk_level = RiskLevel.MEDIUM
        elif adjusted_score >= 1.0:
            risk_level = RiskLevel.LOW
        else:
            risk_level = RiskLevel.INFORMATIONAL
        
        return {
            'cvss_base_score': cvss_score,
            'likelihood': likelihood,
            'business_impact': business_impact,
            'adjusted_risk_score': round(adjusted_score, 2),
            'risk_level': risk_level.value,
            'risk_score_numeric': adjusted_score
        }
    
    def assess_vulnerability(self, vulnerability: Dict) -> Dict:
        """Assess a single vulnerability"""
        cvss = vulnerability.get('cvss_score', 0.0)
        likelihood = vulnerability.get('likelihood', 'Medium')
        impact = vulnerability.get('business_impact', 'Medium')
        
        assessment = self.calculate_risk_score(cvss, likelihood, impact)
        assessment['vulnerability_name'] = vulnerability.get('name', 'Unknown')
        assessment['description'] = vulnerability.get('description', '')
        assessment['affected_systems'] = vulnerability.get('affected_systems', [])
        
        return assessment
    
    def prioritize_vulnerabilities(self, vulnerabilities: List[Dict]) -> List[Dict]:
        """Sort vulnerabilities by risk score (highest first)"""
        assessments = [self.assess_vulnerability(vuln) for vuln in vulnerabilities]
        return sorted(assessments, key=lambda x: x['risk_score_numeric'], reverse=True)
    
    def generate_risk_report(self, vulnerabilities: List[Dict]) -> str:
        """Generate a formatted risk assessment report"""
        prioritized = self.prioritize_vulnerabilities(vulnerabilities)
        
        report = "# Risk Assessment Report\n\n"
        report += "## Summary\n\n"
        report += f"Total Vulnerabilities: {len(prioritized)}\n\n"
        
        # Count by risk level
        risk_counts = {}
        for vuln in prioritized:
            level = vuln['risk_level']
            risk_counts[level] = risk_counts.get(level, 0) + 1
        
        report += "### Risk Distribution\n"
        for level in ['Critical', 'High', 'Medium', 'Low', 'Informational']:
            count = risk_counts.get(level, 0)
            report += f"- **{level}**: {count}\n"
        
        report += "\n## Detailed Findings\n\n"
        
        for i, vuln in enumerate(prioritized, 1):
            report += f"### {i}. {vuln['vulnerability_name']}\n\n"
            report += f"**Risk Level**: {vuln['risk_level']}\n\n"
            report += f"**CVSS Base Score**: {vuln['cvss_base_score']}\n\n"
            report += f"**Adjusted Risk Score**: {vuln['adjusted_risk_score']}\n\n"
            report += f"**Likelihood**: {vuln['likelihood']}\n\n"
            report += f"**Business Impact**: {vuln['business_impact']}\n\n"
            report += f"**Description**: {vuln['description']}\n\n"
            
            if vuln['affected_systems']:
                report += "**Affected Systems**:\n"
                for system in vuln['affected_systems']:
                    report += f"- {system}\n"
            
            report += "\n---\n\n"
        
        return report

def main():
    """Example usage"""
    calculator = RiskCalculator()
    
    # Example vulnerabilities
    vulnerabilities = [
        {
            'name': 'SQL Injection in Login Form',
            'description': 'SQL injection vulnerability allows authentication bypass',
            'cvss_score': 9.8,
            'likelihood': 'Very High',
            'business_impact': 'Critical',
            'affected_systems': ['Web Application - Login Page']
        },
        {
            'name': 'Weak Password Policy',
            'description': 'Password policy allows weak passwords',
            'cvss_score': 5.3,
            'likelihood': 'High',
            'business_impact': 'Medium',
            'affected_systems': ['User Management System']
        },
        {
            'name': 'Missing Security Headers',
            'description': 'X-Frame-Options and CSP headers not configured',
            'cvss_score': 3.1,
            'likelihood': 'Medium',
            'business_impact': 'Low',
            'affected_systems': ['Web Application']
        },
        {
            'name': 'Information Disclosure in Error Messages',
            'description': 'Error messages reveal sensitive system information',
            'cvss_score': 4.3,
            'likelihood': 'Medium',
            'business_impact': 'Medium',
            'affected_systems': ['API Endpoints']
        }
    ]
    
    # Generate report
    report = calculator.generate_risk_report(vulnerabilities)
    
    # Save to file
    with open('risk_assessment_report.md', 'w') as f:
        f.write(report)
    
    print("[+] Risk assessment report generated: risk_assessment_report.md")
    
    # Print summary
    prioritized = calculator.prioritize_vulnerabilities(vulnerabilities)
    print("\n[+] Top 3 Highest Risk Vulnerabilities:")
    for i, vuln in enumerate(prioritized[:3], 1):
        print(f"\n{i}. {vuln['vulnerability_name']}")
        print(f"   Risk Level: {vuln['risk_level']}")
        print(f"   Risk Score: {vuln['adjusted_risk_score']}")

if __name__ == '__main__':
    main()

