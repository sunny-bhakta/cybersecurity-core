#!/usr/bin/env python3
"""
Threat Modeling Tool
Helps identify and document security threats using STRIDE methodology.
"""

import sys
from datetime import datetime
from typing import Dict, List
from enum import Enum

class ThreatCategory(Enum):
    SPOOFING = "Spoofing"
    TAMPERING = "Tampering"
    REPUDIATION = "Repudiation"
    INFORMATION_DISCLOSURE = "Information Disclosure"
    DENIAL_OF_SERVICE = "Denial of Service"
    ELEVATION_OF_PRIVILEGE = "Elevation of Privilege"

class ThreatModelingTool:
    def __init__(self, system_name: str):
        self.system_name = system_name
        self.threats = []
        self.assets = []
        self.trust_boundaries = []
    
    def add_asset(self, asset_name: str, description: str, sensitivity: str = "Medium"):
        """Add a system asset"""
        self.assets.append({
            'name': asset_name,
            'description': description,
            'sensitivity': sensitivity
        })
    
    def add_trust_boundary(self, boundary_name: str, description: str):
        """Add a trust boundary"""
        self.trust_boundaries.append({
            'name': boundary_name,
            'description': description
        })
    
    def identify_threat(self, category: ThreatCategory, asset: str, description: str, 
                       severity: str = "Medium", mitigation: str = ""):
        """Identify a threat"""
        self.threats.append({
            'category': category.value,
            'asset': asset,
            'description': description,
            'severity': severity,
            'mitigation': mitigation
        })
    
    def generate_threat_model(self) -> str:
        """Generate threat model document"""
        doc = f"""# Threat Model: {self.system_name}

## System Overview

**System Name**: {self.system_name}
**Threat Model Date**: {datetime.now().strftime('%Y-%m-%d')}

---

## Assets

The following assets have been identified:

"""
        for i, asset in enumerate(self.assets, 1):
            doc += f"### {i}. {asset['name']}\n\n"
            doc += f"**Description**: {asset['description']}\n\n"
            doc += f"**Sensitivity**: {asset['sensitivity']}\n\n"
        
        doc += "\n---\n\n## Trust Boundaries\n\n"
        doc += "The following trust boundaries have been identified:\n\n"
        
        for i, boundary in enumerate(self.trust_boundaries, 1):
            doc += f"{i}. **{boundary['name']}**: {boundary['description']}\n"
        
        doc += "\n---\n\n## Threat Analysis (STRIDE)\n\n"
        doc += "### STRIDE Methodology\n\n"
        doc += "- **S**poofing: Impersonating something or someone\n"
        doc += "- **T**ampering: Modifying data or code\n"
        doc += "- **R**epudiation: Denying an action occurred\n"
        doc += "- **I**nformation Disclosure: Exposing information to unauthorized parties\n"
        doc += "- **D**enial of Service: Disrupting service availability\n"
        doc += "- **E**levation of Privilege: Gaining unauthorized access\n\n"
        
        doc += "### Identified Threats\n\n"
        
        # Group threats by category
        threats_by_category = {}
        for threat in self.threats:
            category = threat['category']
            if category not in threats_by_category:
                threats_by_category[category] = []
            threats_by_category[category].append(threat)
        
        for category in ThreatCategory:
            if category.value in threats_by_category:
                doc += f"#### {category.value}\n\n"
                for threat in threats_by_category[category.value]:
                    doc += f"**Asset**: {threat['asset']}\n\n"
                    doc += f"**Threat**: {threat['description']}\n\n"
                    doc += f"**Severity**: {threat['severity']}\n\n"
                    if threat['mitigation']:
                        doc += f"**Mitigation**: {threat['mitigation']}\n\n"
                    doc += "---\n\n"
        
        doc += "\n## Risk Summary\n\n"
        
        # Count threats by severity
        severity_count = {'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0}
        for threat in self.threats:
            severity = threat['severity']
            if severity in severity_count:
                severity_count[severity] += 1
        
        doc += "| Severity | Count |\n"
        doc += "|----------|-------|\n"
        for severity, count in severity_count.items():
            doc += f"| {severity} | {count} |\n"
        
        doc += "\n---\n\n## Recommendations\n\n"
        doc += "1. Prioritize mitigation of Critical and High severity threats\n"
        doc += "2. Implement security controls at trust boundaries\n"
        doc += "3. Regularly review and update threat model\n"
        doc += "4. Integrate threat modeling into SDLC\n\n"
        
        return doc
    
    def auto_identify_threats(self):
        """Automatically identify common threats based on assets"""
        for asset in self.assets:
            asset_name = asset['name'].lower()
            
            # Identify common threats based on asset type
            if 'database' in asset_name or 'db' in asset_name:
                self.identify_threat(
                    ThreatCategory.INFORMATION_DISCLOSURE,
                    asset['name'],
                    "Unauthorized access to database could expose sensitive data",
                    "High",
                    "Implement database encryption, access controls, and auditing"
                )
                self.identify_threat(
                    ThreatCategory.TAMPERING,
                    asset['name'],
                    "Unauthorized modification of database records",
                    "High",
                    "Implement database integrity checks and access controls"
                )
            
            if 'api' in asset_name or 'endpoint' in asset_name:
                self.identify_threat(
                    ThreatCategory.SPOOFING,
                    asset['name'],
                    "API authentication bypass or token spoofing",
                    "High",
                    "Implement strong authentication and authorization mechanisms"
                )
                self.identify_threat(
                    ThreatCategory.DENIAL_OF_SERVICE,
                    asset['name'],
                    "API endpoint could be overwhelmed with requests",
                    "Medium",
                    "Implement rate limiting and request throttling"
                )
            
            if 'web' in asset_name or 'application' in asset_name:
                self.identify_threat(
                    ThreatCategory.ELEVATION_OF_PRIVILEGE,
                    asset['name'],
                    "Privilege escalation through application vulnerabilities",
                    "High",
                    "Implement proper authorization checks and least privilege"
                )
                self.identify_threat(
                    ThreatCategory.INFORMATION_DISCLOSURE,
                    asset['name'],
                    "Sensitive information exposure through application",
                    "Medium",
                    "Implement proper input validation and output encoding"
                )

def main():
    print("Threat Modeling Tool")
    print("=" * 50)
    
    tool = ThreatModelingTool("Example Web Application")
    
    # Add assets
    tool.add_asset("Web Application", "Main web application server", "High")
    tool.add_asset("Database", "PostgreSQL database containing user data", "Critical")
    tool.add_asset("API Server", "RESTful API endpoints", "High")
    tool.add_asset("Authentication Service", "OAuth 2.0 authentication service", "Critical")
    
    # Add trust boundaries
    tool.add_trust_boundary("Internet to DMZ", "External users accessing web application")
    tool.add_trust_boundary("DMZ to Internal Network", "Web server accessing database")
    
    # Auto-identify threats
    tool.auto_identify_threats()
    
    # Add custom threats
    tool.identify_threat(
        ThreatCategory.REPUDIATION,
        "Authentication Service",
        "User could deny performing sensitive actions",
        "Medium",
        "Implement comprehensive audit logging"
    )
    
    # Generate threat model
    document = tool.generate_threat_model()
    
    # Save to file
    filename = "threat_model.md"
    with open(filename, 'w') as f:
        f.write(document)
    
    print(f"[+] Threat model generated")
    print(f"[+] Saved to: {filename}")
    print(f"[+] Identified {len(tool.threats)} threats")

if __name__ == '__main__':
    main()

