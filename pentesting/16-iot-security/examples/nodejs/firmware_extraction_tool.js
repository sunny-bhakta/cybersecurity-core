#!/usr/bin/env node
/**
 * Firmware Extraction Tool
 * Extracts and analyzes firmware from IoT devices.
 */

const fs = require('fs');
const path = require('path');

class FirmwareExtractionTool {
    constructor(firmwareFile) {
        this.firmwareFile = firmwareFile;
        this.extractedPath = null;
        this.findings = [];
    }

    extractFirmware(outputDir = 'firmware_extracted') {
        console.log(`[*] Extracting firmware: ${this.firmwareFile}...`);
        
        try {
            if (!fs.existsSync(outputDir)) {
                fs.mkdirSync(outputDir, { recursive: true });
            }
            
            console.log('[!] Note: Real implementation requires binwalk');
            console.log('[!] Install: npm install -g binwalk or use binwalk CLI');
            console.log('[!] Command: binwalk -e firmware.bin');
            
            this.extractedPath = outputDir;
            return true;
        } catch (err) {
            console.log(`[-] Error extracting firmware: ${err.message}`);
            return false;
        }
    }

    analyzeFilesystem(extractedPath) {
        console.log('[*] Analyzing extracted filesystem...');
        
        const findings = [];
        
        if (!fs.existsSync(extractedPath)) {
            return findings;
        }
        
        const sensitiveFiles = [
            'etc/passwd',
            'etc/shadow',
            'etc/hosts',
            '.ssh/id_rsa',
            'config.json',
            '.env'
        ];
        
        function walkDir(dir) {
            const files = fs.readdirSync(dir);
            
            files.forEach(file => {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                
                if (stat.isDirectory()) {
                    walkDir(filePath);
                } else {
                    const relPath = path.relative(extractedPath, filePath);
                    
                    sensitiveFiles.forEach(sensitive => {
                        if (relPath.includes(sensitive)) {
                            findings.push({
                                severity: 'High',
                                issue: `Sensitive File Found: ${relPath}`,
                                description: `Firmware contains sensitive file: ${relPath}`,
                                file: relPath
                            });
                        }
                    });
                    
                    // Check for hardcoded credentials
                    try {
                        const content = fs.readFileSync(filePath, 'utf8');
                        if (content.length < 10000 && (content.toLowerCase().includes('password') || content.toLowerCase().includes('secret'))) {
                            findings.push({
                                severity: 'High',
                                issue: `Potential Hardcoded Credentials: ${relPath}`,
                                description: 'File may contain hardcoded credentials',
                                file: relPath
                            });
                        }
                    } catch (err) {
                        // Ignore binary files
                    }
                }
            });
        }
        
        walkDir(extractedPath);
        return findings;
    }

    extractAll() {
        console.log(`[*] Extracting firmware: ${this.firmwareFile}\n`);
        
        if (this.extractFirmware()) {
            if (this.extractedPath) {
                this.findings = this.analyzeFilesystem(this.extractedPath);
            }
        }
        
        return {
            firmware: this.firmwareFile,
            extractedPath: this.extractedPath,
            findings: this.findings
        };
    }

    generateReport() {
        let report = `# Firmware Extraction Report\n\n`;
        report += `**Firmware File**: ${path.basename(this.firmwareFile)}\n\n`;
        
        if (this.extractedPath) {
            report += `**Extracted To**: ${this.extractedPath}\n\n`;
        }
        
        if (this.findings.length > 0) {
            report += `## Summary\n\n`;
            report += `Total Findings: ${this.findings.length}\n\n`;
            
            const high = this.findings.filter(f => f.severity === 'High');
            const medium = this.findings.filter(f => f.severity === 'Medium');
            
            report += `- **High**: ${high.length}\n`;
            report += `- **Medium**: ${medium.length}\n\n`;
            
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                if (finding.file) {
                    report += `**File**: \`${finding.file}\`\n\n`;
                }
                report += `---\n\n`;
            });
        } else {
            report += `âœ… No security issues found in extracted firmware.\n\n`;
        }
        
        report += `## Firmware Analysis Best Practices\n\n`;
        report += `1. Extract firmware in isolated environment\n`;
        report += `2. Analyze filesystem structure\n`;
        report += `3. Check for hardcoded credentials\n`;
        report += `4. Review configuration files\n`;
        report += `5. Check for debug information\n`;
        report += `6. Analyze binary files for vulnerabilities\n`;
        report += `7. Check for backdoors or malicious code\n\n`;
        
        return report;
    }
}

function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node firmware_extraction_tool.js <firmware_file>');
        console.log('Example: node firmware_extraction_tool.js firmware.bin');
        process.exit(1);
    }
    
    const firmwareFile = process.argv[2];
    
    const tool = new FirmwareExtractionTool(firmwareFile);
    tool.extractAll();
    
    const report = tool.generateReport();
    
    const filename = `firmware_extraction_${path.basename(firmwareFile).replace(/\./g, '_')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Firmware extraction complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main();
}

module.exports = FirmwareExtractionTool;

