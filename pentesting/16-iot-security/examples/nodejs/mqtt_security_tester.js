#!/usr/bin/env node
/**
 * MQTT Security Tester
 * Tests MQTT brokers and clients for security vulnerabilities.
 */

const net = require('net');
const fs = require('fs');

class MQTTSecurityTester {
    constructor(brokerHost, brokerPort = 1883) {
        this.brokerHost = brokerHost;
        this.brokerPort = brokerPort;
        this.findings = [];
    }

    testAuthentication() {
        console.log('[*] Testing MQTT authentication...');
        
        const findings = [];
        
        return new Promise((resolve) => {
            const sock = new net.Socket();
            sock.setTimeout(5000);
            
            sock.on('connect', () => {
                findings.push({
                    severity: 'High',
                    issue: 'No Authentication Required',
                    description: 'MQTT broker accepts connections without authentication',
                    broker: `${this.brokerHost}:${this.brokerPort}`
                });
                sock.destroy();
                resolve(findings);
            });
            
            sock.on('timeout', () => {
                sock.destroy();
                resolve(findings);
            });
            
            sock.on('error', () => {
                resolve(findings);
            });
            
            sock.connect(this.brokerPort, this.brokerHost);
        });
    }

    testTlsEncryption() {
        console.log('[*] Testing MQTT TLS encryption...');
        
        const findings = [];
        const tlsPort = 8883;
        
        return new Promise((resolve) => {
            const sock = new net.Socket();
            sock.setTimeout(5000);
            
            sock.on('connect', () => {
                sock.destroy();
                resolve(findings);
            });
            
            sock.on('timeout', () => {
                findings.push({
                    severity: 'High',
                    issue: 'TLS Not Available',
                    description: 'MQTT broker does not support TLS encryption',
                    broker: `${this.brokerHost}:${this.brokerPort}`
                });
                sock.destroy();
                resolve(findings);
            });
            
            sock.on('error', () => {
                findings.push({
                    severity: 'High',
                    issue: 'TLS Not Available',
                    description: 'MQTT broker does not support TLS encryption',
                    broker: `${this.brokerHost}:${this.brokerPort}`
                });
                resolve(findings);
            });
            
            sock.connect(tlsPort, this.brokerHost);
        });
    }

    async testAll() {
        console.log(`[*] Testing MQTT broker: ${this.brokerHost}:${this.brokerPort}\n`);
        
        this.findings.push(...await this.testAuthentication());
        this.findings.push(...await this.testTlsEncryption());
        
        console.log('[!] Note: Real implementation requires MQTT client library');
        console.log('[!] Would test: authorization, anonymous access, topic security');
        
        return {
            broker: `${this.brokerHost}:${this.brokerPort}`,
            findings: this.findings
        };
    }

    generateReport() {
        let report = `# MQTT Security Test Report\n\n`;
        report += `**Broker**: ${this.brokerHost}:${this.brokerPort}\n\n`;
        
        if (this.findings.length > 0) {
            report += `## Summary\n\n`;
            report += `Total Findings: ${this.findings.length}\n\n`;
            
            const critical = this.findings.filter(f => f.severity === 'Critical');
            const high = this.findings.filter(f => f.severity === 'High');
            const medium = this.findings.filter(f => f.severity === 'Medium');
            
            report += `- **Critical**: ${critical.length}\n`;
            report += `- **High**: ${high.length}\n`;
            report += `- **Medium**: ${medium.length}\n\n`;
            
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                if (finding.broker) {
                    report += `**Broker**: ${finding.broker}\n\n`;
                }
                report += `---\n\n`;
            });
        } else {
            report += `âœ… No security issues found.\n\n`;
        }
        
        report += `## MQTT Security Best Practices\n\n`;
        report += `1. Require authentication for all connections\n`;
        report += `2. Use TLS/SSL encryption\n`;
        report += `3. Implement topic access control\n`;
        report += `4. Use strong passwords\n`;
        report += `5. Disable anonymous access\n`;
        report += `6. Implement rate limiting\n`;
        report += `7. Monitor for suspicious activity\n`;
        report += `8. Keep MQTT broker updated\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node mqtt_security_tester.js <broker_host> [broker_port]');
        console.log('Example: node mqtt_security_tester.js 192.168.1.100 1883');
        process.exit(1);
    }
    
    const brokerHost = process.argv[2];
    const brokerPort = parseInt(process.argv[3]) || 1883;
    
    const tester = new MQTTSecurityTester(brokerHost, brokerPort);
    await tester.testAll();
    
    const report = tester.generateReport();
    
    const filename = `mqtt_security_test_${brokerHost.replace(/\./g, '_')}_${brokerPort}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] MQTT security testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test MQTT brokers you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = MQTTSecurityTester;

