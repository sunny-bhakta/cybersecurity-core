#!/usr/bin/env python3
"""
MQTT Security Tester
Tests MQTT brokers and clients for security vulnerabilities.
"""

import sys
import socket
from typing import Dict, List

class MQTTSecurityTester:
    def __init__(self, broker_host: str, broker_port: int = 1883):
        self.broker_host = broker_host
        self.broker_port = broker_port
        self.findings = []
    
    def test_authentication(self) -> List[Dict]:
        """Test MQTT authentication"""
        print("[*] Testing MQTT authentication...")
        
        findings = []
        
        try:
            # Try connecting without authentication
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            result = sock.connect_ex((self.broker_host, self.broker_port))
            sock.close()
            
            if result == 0:
                findings.append({
                    'severity': 'High',
                    'issue': 'No Authentication Required',
                    'description': 'MQTT broker accepts connections without authentication',
                    'broker': f'{self.broker_host}:{self.broker_port}'
                })
        except Exception as e:
            print(f"[-] Error testing authentication: {e}")
        
        return findings
    
    def test_authorization(self) -> List[Dict]:
        """Test MQTT authorization"""
        print("[*] Testing MQTT authorization...")
        
        findings = []
        
        # In real implementation, would use paho-mqtt or similar
        print("[!] Note: Real implementation requires paho-mqtt library")
        print("[!] Would test: topic access control, publish/subscribe permissions")
        
        return findings
    
    def test_tls_encryption(self) -> List[Dict]:
        """Test MQTT TLS encryption"""
        print("[*] Testing MQTT TLS encryption...")
        
        findings = []
        
        # Check if TLS port is available
        tls_port = 8883
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            result = sock.connect_ex((self.broker_host, tls_port))
            sock.close()
            
            if result != 0:
                findings.append({
                    'severity': 'High',
                    'issue': 'TLS Not Available',
                    'description': 'MQTT broker does not support TLS encryption',
                    'broker': f'{self.broker_host}:{self.broker_port}'
                })
        except:
            pass
        
        return findings
    
    def test_anonymous_access(self) -> List[Dict]:
        """Test for anonymous access"""
        print("[*] Testing for anonymous access...")
        
        findings = []
        
        # In real implementation, would attempt anonymous connection
        print("[!] Note: Real implementation requires MQTT client library")
        
        return findings
    
    def test_all(self) -> Dict:
        """Run all MQTT security tests"""
        print(f"[*] Testing MQTT broker: {self.broker_host}:{self.broker_port}\n")
        
        self.findings.extend(self.test_authentication())
        self.findings.extend(self.test_authorization())
        self.findings.extend(self.test_tls_encryption())
        self.findings.extend(self.test_anonymous_access())
        
        return {
            'broker': f'{self.broker_host}:{self.broker_port}',
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate MQTT security test report"""
        report = f"# MQTT Security Test Report\n\n"
        report += f"**Broker**: {self.broker_host}:{self.broker_port}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'broker' in finding:
                    report += f"**Broker**: {finding['broker']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## MQTT Security Best Practices\n\n"
        report += "1. Require authentication for all connections\n"
        report += "2. Use TLS/SSL encryption\n"
        report += "3. Implement topic access control\n"
        report += "4. Use strong passwords\n"
        report += "5. Disable anonymous access\n"
        report += "6. Implement rate limiting\n"
        report += "7. Monitor for suspicious activity\n"
        report += "8. Keep MQTT broker updated\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python mqtt_security_tester.py <broker_host> [broker_port]")
        print("Example: python mqtt_security_tester.py 192.168.1.100 1883")
        sys.exit(1)
    
    broker_host = sys.argv[1]
    broker_port = int(sys.argv[2]) if len(sys.argv) > 2 else 1883
    
    tester = MQTTSecurityTester(broker_host, broker_port)
    tester.test_all()
    
    report = tester.generate_report()
    
    filename = f"mqtt_security_test_{broker_host.replace('.', '_')}_{broker_port}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] MQTT security testing complete")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only test MQTT brokers you own or have permission to test!")

if __name__ == "__main__":
    main()

