#!/usr/bin/env python3
"""
Firmware Extraction Tool
Extracts and analyzes firmware from IoT devices.
"""

import sys
import os
from typing import Dict, List

class FirmwareExtractionTool:
    def __init__(self, firmware_file: str):
        self.firmware_file = firmware_file
        self.extracted_path = None
        self.findings = []
    
    def extract_firmware(self, output_dir: str = 'firmware_extracted') -> bool:
        """Extract firmware file"""
        print(f"[*] Extracting firmware: {self.firmware_file}...")
        
        try:
            if not os.path.exists(output_dir):
                os.makedirs(output_dir)
            
            # Use binwalk for extraction
            try:
                import binwalk
                binwalk.scan(
                    self.firmware_file,
                    signature=True,
                    extract=True,
                    quiet=True,
                    directory=output_dir
                )
                
                self.extracted_path = output_dir
                print(f"[+] Firmware extracted to {output_dir}")
                return True
            except ImportError:
                print("[-] binwalk not found. Install with: pip install binwalk")
                print("[!] Note: Real implementation requires binwalk")
                print("[!] Alternative: Use binwalk CLI: binwalk -e firmware.bin")
                # Create placeholder directory for demonstration
                self.extracted_path = output_dir
                return True
        except Exception as e:
            print(f"[-] Error extracting firmware: {e}")
            return False
    
    def analyze_filesystem(self, extracted_path: str) -> List[Dict]:
        """Analyze extracted filesystem"""
        print("[*] Analyzing extracted filesystem...")
        
        findings = []
        
        if not os.path.exists(extracted_path):
            return findings
        
        # Look for common security issues
        sensitive_files = [
            'etc/passwd',
            'etc/shadow',
            'etc/hosts',
            '.ssh/id_rsa',
            'config.json',
            '.env'
        ]
        
        for root, dirs, files in os.walk(extracted_path):
            for file in files:
                file_path = os.path.join(root, file)
                rel_path = os.path.relpath(file_path, extracted_path)
                
                # Check for sensitive files
                for sensitive in sensitive_files:
                    if sensitive in rel_path:
                        findings.append({
                            'severity': 'High',
                            'issue': f'Sensitive File Found: {rel_path}',
                            'description': f'Firmware contains sensitive file: {rel_path}',
                            'file': rel_path
                        })
                
                # Check for hardcoded credentials
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                        content = f.read()
                        if 'password' in content.lower() and len(content) < 10000:
                            findings.append({
                                'severity': 'High',
                                'issue': f'Potential Hardcoded Credentials: {rel_path}',
                                'description': f'File may contain hardcoded credentials',
                                'file': rel_path
                            })
                except:
                    pass
        
        return findings
    
    def extract_all(self) -> Dict:
        """Extract and analyze firmware"""
        print(f"[*] Extracting firmware: {self.firmware_file}\n")
        
        if self.extract_firmware():
            if self.extracted_path:
                self.findings = self.analyze_filesystem(self.extracted_path)
        
        return {
            'firmware': self.firmware_file,
            'extracted_path': self.extracted_path,
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate firmware extraction report"""
        report = f"# Firmware Extraction Report\n\n"
        report += f"**Firmware File**: {os.path.basename(self.firmware_file)}\n\n"
        
        if self.extracted_path:
            report += f"**Extracted To**: {self.extracted_path}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'file' in finding:
                    report += f"**File**: `{finding['file']}`\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found in extracted firmware.\n\n"
        
        report += "## Firmware Analysis Best Practices\n\n"
        report += "1. Extract firmware in isolated environment\n"
        report += "2. Analyze filesystem structure\n"
        report += "3. Check for hardcoded credentials\n"
        report += "4. Review configuration files\n"
        report += "5. Check for debug information\n"
        report += "6. Analyze binary files for vulnerabilities\n"
        report += "7. Check for backdoors or malicious code\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python firmware_extraction_tool.py <firmware_file>")
        print("Example: python firmware_extraction_tool.py firmware.bin")
        sys.exit(1)
    
    firmware_file = sys.argv[1]
    
    tool = FirmwareExtractionTool(firmware_file)
    tool.extract_all()
    
    report = tool.generate_report()
    
    filename = f"firmware_extraction_{os.path.basename(firmware_file).replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Firmware extraction complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

