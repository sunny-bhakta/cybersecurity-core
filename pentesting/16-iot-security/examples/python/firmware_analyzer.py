#!/usr/bin/env python3
"""
Firmware Analyzer
Analyzes IoT device firmware for security vulnerabilities.
"""

import os
import sys
import zipfile
import tarfile
from typing import List, Dict, Optional

class FirmwareAnalyzer:
    def __init__(self, firmware_path: str):
        self.firmware_path = firmware_path
        self.findings = []
        self.extracted_path = None
    
    def extract_firmware(self, extract_path: str = 'firmware_extracted') -> bool:
        """Extract firmware file"""
        print(f"[*] Extracting firmware...")
        
        try:
            if os.path.exists(extract_path):
                import shutil
                shutil.rmtree(extract_path)
            
            os.makedirs(extract_path, exist_ok=True)
            
            if self.firmware_path.endswith('.zip'):
                with zipfile.ZipFile(self.firmware_path, 'r') as zip_ref:
                    zip_ref.extractall(extract_path)
            elif self.firmware_path.endswith(('.tar', '.tar.gz', '.tgz')):
                with tarfile.open(self.firmware_path, 'r:*') as tar_ref:
                    tar_ref.extractall(extract_path)
            else:
                print("[-] Unsupported firmware format")
                return False
            
            self.extracted_path = extract_path
            print(f"[+] Firmware extracted to {extract_path}")
            return True
        except Exception as e:
            print(f"[-] Error extracting firmware: {e}")
            return False
    
    def find_binaries(self, extract_path: str = None) -> List[str]:
        """Find binary files in firmware"""
        if not extract_path:
            extract_path = self.extracted_path
        
        if not extract_path:
            return []
        
        print("[*] Searching for binary files...")
        
        binaries = []
        for root, dirs, files in os.walk(extract_path):
            for file in files:
                file_path = os.path.join(root, file)
                # Check if file is binary
                try:
                    with open(file_path, 'rb') as f:
                        chunk = f.read(512)
                        if b'\x00' in chunk or not chunk.isascii():
                            binaries.append(file_path)
                except:
                    pass
        
        print(f"[+] Found {len(binaries)} binary files")
        return binaries
    
    def check_default_credentials(self, extract_path: str = None) -> List[Dict]:
        """Check for default credentials in firmware"""
        if not extract_path:
            extract_path = self.extracted_path
        
        if not extract_path:
            return []
        
        print("[*] Checking for default credentials...")
        
        findings = []
        default_creds = [
            'admin:admin',
            'admin:password',
            'root:root',
            'root:12345',
            'user:user'
        ]
        
        for root, dirs, files in os.walk(extract_path):
            for file in files:
                if file.endswith(('.txt', '.conf', '.cfg', '.xml')):
                    file_path = os.path.join(root, file)
                    try:
                        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                            content = f.read().lower()
                            for cred in default_creds:
                                if cred in content:
                                    findings.append({
                                        'severity': 'Critical',
                                        'issue': 'Default Credentials Found',
                                        'description': f'Found default credentials in {file}',
                                        'file': file_path,
                                        'credentials': cred
                                    })
                    except:
                        pass
        
        self.findings.extend(findings)
        return findings
    
    def check_hardcoded_secrets(self, extract_path: str = None) -> List[Dict]:
        """Check for hardcoded secrets"""
        if not extract_path:
            extract_path = self.extracted_path
        
        if not extract_path:
            return []
        
        print("[*] Checking for hardcoded secrets...")
        
        findings = []
        secret_patterns = [
            'password',
            'secret',
            'api_key',
            'private_key',
            'token'
        ]
        
        for root, dirs, files in os.walk(extract_path):
            for file in files:
                if file.endswith(('.txt', '.conf', '.cfg', '.sh', '.py', '.c')):
                    file_path = os.path.join(root, file)
                    try:
                        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                            lines = f.readlines()
                            for i, line in enumerate(lines, 1):
                                line_lower = line.lower()
                                for pattern in secret_patterns:
                                    if pattern in line_lower and '=' in line:
                                        findings.append({
                                            'severity': 'High',
                                            'issue': 'Potential Hardcoded Secret',
                                            'description': f'Found potential secret in {file}:{i}',
                                            'file': file_path,
                                            'line': i
                                        })
                                        break
                    except:
                        pass
        
        self.findings.extend(findings)
        return findings
    
    def analyze_file_system(self, extract_path: str = None) -> Dict:
        """Analyze firmware file system structure"""
        if not extract_path:
            extract_path = self.extracted_path
        
        if not extract_path:
            return {}
        
        print("[*] Analyzing file system structure...")
        
        analysis = {
            'binaries': [],
            'config_files': [],
            'scripts': [],
            'total_files': 0
        }
        
        for root, dirs, files in os.walk(extract_path):
            for file in files:
                analysis['total_files'] += 1
                file_path = os.path.join(root, file)
                
                if file.endswith(('.bin', '.elf', '.so')):
                    analysis['binaries'].append(file_path)
                elif file.endswith(('.conf', '.cfg', '.ini')):
                    analysis['config_files'].append(file_path)
                elif file.endswith(('.sh', '.py', '.pl')):
                    analysis['scripts'].append(file_path)
        
        return analysis
    
    def analyze_all(self) -> Dict:
        """Perform complete firmware analysis"""
        print(f"[*] Analyzing firmware: {self.firmware_path}\n")
        
        if not os.path.exists(self.firmware_path):
            print(f"[-] Firmware file not found: {self.firmware_path}")
            return {}
        
        # Extract firmware
        extract_path = 'firmware_extracted'
        if not self.extract_firmware(extract_path):
            return {}
        
        # Analyze components
        binaries = self.find_binaries(extract_path)
        self.check_default_credentials(extract_path)
        self.check_hardcoded_secrets(extract_path)
        filesystem = self.analyze_file_system(extract_path)
        
        return {
            'binaries': binaries,
            'filesystem': filesystem,
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate firmware analysis report"""
        report = f"# Firmware Security Analysis Report\n\n"
        report += f"**Firmware File**: {os.path.basename(self.firmware_path)}\n\n"
        report += f"## Summary\n\n"
        report += f"Total Findings: {len(self.findings)}\n\n"
        
        critical = [f for f in self.findings if f['severity'] == 'Critical']
        high = [f for f in self.findings if f['severity'] == 'High']
        medium = [f for f in self.findings if f['severity'] == 'Medium']
        low = [f for f in self.findings if f['severity'] == 'Low']
        
        report += f"- **Critical**: {len(critical)}\n"
        report += f"- **High**: {len(high)}\n"
        report += f"- **Medium**: {len(medium)}\n"
        report += f"- **Low**: {len(low)}\n\n"
        
        report += "## Findings\n\n"
        for i, finding in enumerate(self.findings, 1):
            report += f"### {i}. {finding['issue']}\n\n"
            report += f"**Severity**: {finding['severity']}\n\n"
            report += f"**Description**: {finding['description']}\n\n"
            if 'file' in finding:
                report += f"**File**: {finding['file']}\n\n"
            report += "---\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python firmware_analyzer.py <firmware_file>")
        print("Example: python firmware_analyzer.py firmware.bin")
        sys.exit(1)
    
    firmware_path = sys.argv[1]
    analyzer = FirmwareAnalyzer(firmware_path)
    
    results = analyzer.analyze_all()
    
    # Generate report
    report = analyzer.generate_report()
    with open('firmware_analysis_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Analysis complete. Found {len(analyzer.findings)} security issues")
    print(f"[+] Report saved to firmware_analysis_report.md")
    print(f"[!] WARNING: Only analyze firmware you own or have permission to analyze!")

if __name__ == '__main__':
    main()

