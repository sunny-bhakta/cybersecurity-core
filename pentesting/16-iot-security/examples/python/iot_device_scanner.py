#!/usr/bin/env python3
"""
IoT Device Scanner
Scans IoT devices for security vulnerabilities and misconfigurations.
"""

import sys
import socket
import subprocess
from typing import Dict, List

class IoTDeviceScanner:
    def __init__(self, target_ip: str):
        self.target_ip = target_ip
        self.findings = []
    
    def scan_ports(self) -> List[Dict]:
        """Scan common IoT device ports"""
        print(f"[*] Scanning ports on {self.target_ip}...")
        
        findings = []
        common_ports = {
            22: 'SSH',
            23: 'Telnet',
            80: 'HTTP',
            443: 'HTTPS',
            1883: 'MQTT',
            8883: 'MQTT over TLS',
            5683: 'CoAP',
            5900: 'VNC',
            8080: 'HTTP Alt',
            8443: 'HTTPS Alt'
        }
        
        open_ports = []
        for port, service in common_ports.items():
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(1)
                result = sock.connect_ex((self.target_ip, port))
                sock.close()
                
                if result == 0:
                    open_ports.append((port, service))
                    
                    # Check for insecure services
                    if service == 'Telnet':
                        findings.append({
                            'severity': 'High',
                            'issue': f'Telnet Enabled (Port {port})',
                            'description': 'Telnet is unencrypted and insecure',
                            'port': port,
                            'service': service
                        })
            except:
                pass
        
        return findings
    
    def check_default_credentials(self) -> List[Dict]:
        """Check for default credentials"""
        print("[*] Checking for default credentials...")
        
        findings = []
        
        # Common default credentials
        default_creds = [
            ('admin', 'admin'),
            ('admin', 'password'),
            ('admin', '1234'),
            ('root', 'root'),
            ('root', 'password'),
            ('user', 'user')
        ]
        
        # In real implementation, would attempt authentication
        print("[!] Note: Real implementation requires service-specific authentication")
        print("[!] Would test: HTTP basic auth, SSH, Telnet, etc.")
        
        return findings
    
    def check_firmware_version(self) -> List[Dict]:
        """Check firmware version for known vulnerabilities"""
        print("[*] Checking firmware version...")
        
        findings = []
        
        # In real implementation, would query device for firmware version
        print("[!] Note: Real implementation requires device-specific queries")
        print("[!] Would check: HTTP headers, SNMP, device APIs")
        
        return findings
    
    def check_encryption(self) -> List[Dict]:
        """Check for encryption support"""
        print("[*] Checking encryption support...")
        
        findings = []
        
        # Check for HTTPS
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((self.target_ip, 443))
            sock.close()
            
            if result != 0:
                findings.append({
                    'severity': 'Medium',
                    'issue': 'HTTPS Not Available',
                    'description': 'Device does not support HTTPS encryption',
                    'port': 443
                })
        except:
            pass
        
        return findings
    
    def scan_all(self) -> Dict:
        """Perform complete IoT device scan"""
        print(f"[*] Scanning IoT device: {self.target_ip}\n")
        
        self.findings.extend(self.scan_ports())
        self.findings.extend(self.check_default_credentials())
        self.findings.extend(self.check_firmware_version())
        self.findings.extend(self.check_encryption())
        
        return {
            'target': self.target_ip,
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate IoT device scan report"""
        report = f"# IoT Device Security Scan Report\n\n"
        report += f"**Target Device**: {self.target_ip}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'port' in finding:
                    report += f"**Port**: {finding['port']}\n\n"
                if 'service' in finding:
                    report += f"**Service**: {finding['service']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## IoT Security Best Practices\n\n"
        report += "1. Change default credentials\n"
        report += "2. Disable unnecessary services\n"
        report += "3. Use encryption for all communications\n"
        report += "4. Keep firmware updated\n"
        report += "5. Implement network segmentation\n"
        report += "6. Use strong authentication\n"
        report += "7. Monitor device activity\n"
        report += "8. Disable remote access when not needed\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python iot_device_scanner.py <target_ip>")
        print("Example: python iot_device_scanner.py 192.168.1.100")
        sys.exit(1)
    
    target_ip = sys.argv[1]
    
    scanner = IoTDeviceScanner(target_ip)
    scanner.scan_all()
    
    report = scanner.generate_report()
    
    filename = f"iot_device_scan_{target_ip.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] IoT device scan complete")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only scan devices you own or have permission to test!")

if __name__ == "__main__":
    main()

