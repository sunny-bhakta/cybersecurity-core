#!/usr/bin/env python3
"""
Kubernetes Security Scanner
Scans Kubernetes clusters for security misconfigurations.
"""

import subprocess
import json
import sys
from typing import List, Dict

class KubernetesScanner:
    def __init__(self):
        self.findings = []
        self.namespaces = []
    
    def check_kubectl(self) -> bool:
        """Check if kubectl is available"""
        try:
            result = subprocess.run(
                ['kubectl', 'version', '--client'],
                capture_output=True,
                timeout=5
            )
            return result.returncode == 0
        except:
            return False
    
    def scan_namespaces(self) -> List[str]:
        """List all namespaces"""
        print("[*] Scanning namespaces...")
        
        try:
            result = subprocess.run(
                ['kubectl', 'get', 'namespaces', '-o', 'json'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                data = json.loads(result.stdout)
                namespaces = [ns['metadata']['name'] for ns in data.get('items', [])]
                self.namespaces = namespaces
                return namespaces
        except Exception as e:
            print(f"[-] Error scanning namespaces: {e}")
        
        return []
    
    def check_rbac(self, namespace: str = 'default') -> List[Dict]:
        """Check RBAC configurations"""
        print(f"[*] Checking RBAC in namespace: {namespace}...")
        
        findings = []
        
        try:
            # Check for overly permissive roles
            result = subprocess.run(
                ['kubectl', 'get', 'roles', '-n', namespace, '-o', 'json'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                data = json.loads(result.stdout)
                for role in data.get('items', []):
                    rules = role.get('rules', [])
                    for rule in rules:
                        # Check for wildcard permissions
                        if '*' in rule.get('verbs', []) or '*' in rule.get('resources', []):
                            findings.append({
                                'severity': 'High',
                                'issue': f'Overly Permissive Role: {role["metadata"]["name"]}',
                                'description': 'Role has wildcard permissions',
                                'namespace': namespace
                            })
        except Exception as e:
            print(f"[-] Error checking RBAC: {e}")
        
        self.findings.extend(findings)
        return findings
    
    def check_secrets(self, namespace: str = 'default') -> List[Dict]:
        """Check for exposed secrets"""
        print(f"[*] Checking secrets in namespace: {namespace}...")
        
        findings = []
        
        try:
            result = subprocess.run(
                ['kubectl', 'get', 'secrets', '-n', namespace, '-o', 'json'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                data = json.loads(result.stdout)
                for secret in data.get('items', []):
                    secret_type = secret.get('type', '')
                    if secret_type == 'Opaque':
                        # Check if secret is mounted in pods
                        findings.append({
                            'severity': 'Medium',
                            'issue': f'Secret Found: {secret["metadata"]["name"]}',
                            'description': 'Opaque secret in cluster',
                            'namespace': namespace
                        })
        except Exception as e:
            print(f"[-] Error checking secrets: {e}")
        
        self.findings.extend(findings)
        return findings
    
    def check_pod_security(self, namespace: str = 'default') -> List[Dict]:
        """Check pod security configurations"""
        print(f"[*] Checking pod security in namespace: {namespace}...")
        
        findings = []
        
        try:
            result = subprocess.run(
                ['kubectl', 'get', 'pods', '-n', namespace, '-o', 'json'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                data = json.loads(result.stdout)
                for pod in data.get('items', []):
                    spec = pod.get('spec', {})
                    
                    # Check if running as root
                    security_context = spec.get('securityContext', {})
                    run_as_user = security_context.get('runAsUser')
                    if run_as_user == 0 or run_as_user is None:
                        findings.append({
                            'severity': 'High',
                            'issue': f'Pod Running as Root: {pod["metadata"]["name"]}',
                            'description': 'Pod is running as root user',
                            'namespace': namespace
                        })
                    
                    # Check for privileged containers
                    containers = spec.get('containers', [])
                    for container in containers:
                        container_security = container.get('securityContext', {})
                        if container_security.get('privileged'):
                            findings.append({
                                'severity': 'Critical',
                                'issue': f'Privileged Container: {container["name"]}',
                                'description': 'Container is running in privileged mode',
                                'namespace': namespace
                            })
        except Exception as e:
            print(f"[-] Error checking pod security: {e}")
        
        self.findings.extend(findings)
        return findings
    
    def scan_all(self) -> Dict:
        """Perform complete Kubernetes security scan"""
        print("[*] Starting Kubernetes security scan...\n")
        
        if not self.check_kubectl():
            print("[-] kubectl not found. Install kubectl to use this tool.")
            return {}
        
        # Scan all namespaces
        namespaces = self.scan_namespaces()
        if not namespaces:
            namespaces = ['default']
        
        for namespace in namespaces:
            print(f"\n[*] Scanning namespace: {namespace}")
            self.check_rbac(namespace)
            self.check_secrets(namespace)
            self.check_pod_security(namespace)
        
        return {
            'namespaces_scanned': len(namespaces),
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate security scan report"""
        report = "# Kubernetes Security Scan Report\n\n"
        report += "## Summary\n\n"
        report += f"Namespaces Scanned: {len(self.namespaces)}\n"
        report += f"Total Findings: {len(self.findings)}\n\n"
        
        critical = [f for f in self.findings if f['severity'] == 'Critical']
        high = [f for f in self.findings if f['severity'] == 'High']
        medium = [f for f in self.findings if f['severity'] == 'Medium']
        low = [f for f in self.findings if f['severity'] == 'Low']
        
        report += f"- **Critical**: {len(critical)}\n"
        report += f"- **High**: {len(high)}\n"
        report += f"- **Medium**: {len(medium)}\n"
        report += f"- **Low**: {len(low)}\n\n"
        
        report += "## Findings\n\n"
        for i, finding in enumerate(self.findings, 1):
            report += f"### {i}. {finding['issue']}\n\n"
            report += f"**Severity**: {finding['severity']}\n\n"
            report += f"**Namespace**: {finding.get('namespace', 'N/A')}\n\n"
            report += f"**Description**: {finding['description']}\n\n"
            report += "---\n\n"
        
        return report

def main():
    scanner = KubernetesScanner()
    
    if len(sys.argv) > 1:
        namespace = sys.argv[1]
        print(f"[*] Scanning namespace: {namespace}")
        scanner.check_rbac(namespace)
        scanner.check_secrets(namespace)
        scanner.check_pod_security(namespace)
    else:
        scanner.scan_all()
    
    # Generate report
    report = scanner.generate_report()
    with open('kubernetes_security_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Scan complete. Found {len(scanner.findings)} security issues")
    print(f"[+] Report saved to kubernetes_security_report.md")
    print(f"[!] WARNING: Only scan clusters you own or have permission to scan!")

if __name__ == '__main__':
    main()

