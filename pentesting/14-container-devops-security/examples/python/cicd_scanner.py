#!/usr/bin/env python3
"""
CI/CD Pipeline Security Scanner
Scans CI/CD configuration files for security issues.
"""

import sys
import os
import yaml
import json
from typing import List, Dict

class CICDScanner:
    def __init__(self, project_path: str = '.'):
        self.project_path = project_path
        self.findings = []
        self.config_files = []
    
    def find_cicd_files(self) -> List[str]:
        """Find CI/CD configuration files"""
        print("[*] Searching for CI/CD configuration files...")
        
        files = []
        cicd_patterns = [
            '.github/workflows/*.yml',
            '.github/workflows/*.yaml',
            '.gitlab-ci.yml',
            '.gitlab-ci.yaml',
            '.circleci/config.yml',
            'Jenkinsfile',
            '.travis.yml',
            'azure-pipelines.yml',
            '.drone.yml'
        ]
        
        for pattern in cicd_patterns:
            # Simplified - would use glob in real implementation
            if os.path.exists(os.path.join(self.project_path, pattern.split('/')[-1])):
                files.append(pattern.split('/')[-1])
        
        self.config_files = files
        return files
    
    def scan_github_actions(self, file_path: str) -> List[Dict]:
        """Scan GitHub Actions workflow file"""
        findings = []
        
        try:
            with open(file_path, 'r') as f:
                workflow = yaml.safe_load(f)
            
            if not workflow:
                return findings
            
            # Check for hardcoded secrets
            workflow_str = str(workflow)
            secret_indicators = ['password', 'secret', 'token', 'key', 'api_key']
            for indicator in secret_indicators:
                if indicator in workflow_str.lower():
                    findings.append({
                        'severity': 'High',
                        'issue': f'Potential hardcoded secret: {indicator}',
                        'file': file_path
                    })
            
            # Check for unsafe permissions
            if 'permissions' in workflow:
                perms = workflow['permissions']
                if perms.get('contents') == 'write' or perms.get('actions') == 'write':
                    findings.append({
                        'severity': 'Medium',
                        'issue': 'Workflow has write permissions',
                        'file': file_path
                    })
        
        except Exception as e:
            print(f"[-] Error scanning {file_path}: {e}")
        
        return findings
    
    def scan_all(self) -> Dict:
        """Scan all CI/CD files"""
        print(f"[*] Scanning CI/CD configurations in {self.project_path}...\n")
        
        files = self.find_cicd_files()
        
        for file in files:
            file_path = os.path.join(self.project_path, file)
            if os.path.exists(file_path):
                if 'github' in file.lower() or 'workflow' in file.lower():
                    findings = self.scan_github_actions(file_path)
                    self.findings.extend(findings)
        
        return {
            'files_scanned': len(files),
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate CI/CD scan report"""
        report = f"# CI/CD Pipeline Security Scan Report\n\n"
        report += f"**Project**: {self.project_path}\n\n"
        report += f"## Summary\n\n"
        report += f"Files Scanned: {len(self.config_files)}\n"
        report += f"Security Issues Found: {len(self.findings)}\n\n"
        
        if self.findings:
            report += "## Security Issues\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**File**: {finding['file']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues detected.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use secrets management (GitHub Secrets, etc.)\n"
        report += "2. Implement least privilege for workflows\n"
        report += "3. Review and restrict workflow permissions\n"
        report += "4. Use dependency scanning in CI/CD\n"
        report += "5. Implement code signing for artifacts\n\n"
        
        return report

def main():
    project_path = sys.argv[1] if len(sys.argv) > 1 else '.'
    
    scanner = CICDScanner(project_path)
    scanner.scan_all()
    
    report = scanner.generate_report()
    
    filename = "cicd_scan_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] CI/CD scan complete. Found {len(scanner.findings)} issues")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()

