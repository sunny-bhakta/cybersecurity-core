#!/usr/bin/env python3
"""
IaC Security Scanner
Scans Infrastructure as Code (IaC) files for security misconfigurations.
"""

import sys
import os
import json
import yaml
from typing import Dict, List

class IaCSecurityScanner:
    def __init__(self, target_path: str):
        self.target_path = target_path
        self.findings = []
    
    def scan_terraform(self, tf_file: str) -> List[Dict]:
        """Scan Terraform files for security issues"""
        print(f"[*] Scanning Terraform file: {tf_file}...")
        
        findings = []
        
        try:
            with open(tf_file, 'r') as f:
                content = f.read()
            
            # Check for hardcoded secrets
            if 'password' in content.lower() or 'secret' in content.lower():
                findings.append({
                    'severity': 'High',
                    'issue': 'Potential Hardcoded Secrets',
                    'description': 'Terraform file may contain hardcoded secrets',
                    'file': tf_file
                })
            
            # Check for public access
            if 'public_access' in content.lower() or 'publicly_accessible' in content.lower():
                if 'true' in content.lower():
                    findings.append({
                        'severity': 'High',
                        'issue': 'Public Access Enabled',
                        'description': 'Resource may be publicly accessible',
                        'file': tf_file
                    })
            
            # Check for unencrypted storage
            if 'encryption' in content.lower() and 'false' in content.lower():
                findings.append({
                    'severity': 'Medium',
                    'issue': 'Encryption Disabled',
                    'description': 'Resource has encryption disabled',
                    'file': tf_file
                })
            
            # Check for open security groups
            if 'security_group' in content.lower():
                if '0.0.0.0/0' in content or '::/0' in content:
                    findings.append({
                        'severity': 'Critical',
                        'issue': 'Open Security Group',
                        'description': 'Security group allows access from anywhere (0.0.0.0/0)',
                        'file': tf_file
                    })
        except Exception as e:
            print(f"[-] Error scanning {tf_file}: {e}")
        
        return findings
    
    def scan_cloudformation(self, cf_file: str) -> List[Dict]:
        """Scan CloudFormation templates for security issues"""
        print(f"[*] Scanning CloudFormation template: {cf_file}...")
        
        findings = []
        
        try:
            with open(cf_file, 'r') as f:
                if cf_file.endswith('.json'):
                    template = json.load(f)
                else:
                    template = yaml.safe_load(f)
            
            resources = template.get('Resources', {})
            
            for resource_name, resource in resources.items():
                resource_type = resource.get('Type', '')
                properties = resource.get('Properties', {})
                
                # Check S3 buckets
                if 'S3::Bucket' in resource_type:
                    if properties.get('PublicAccessBlockConfiguration') is None:
                        findings.append({
                            'severity': 'High',
                            'issue': f'S3 Bucket Without Public Access Block: {resource_name}',
                            'description': 'S3 bucket may be publicly accessible',
                            'file': cf_file
                        })
                
                # Check security groups
                if 'EC2::SecurityGroup' in resource_type:
                    ingress_rules = properties.get('SecurityGroupIngress', [])
                    for rule in ingress_rules:
                        cidr = rule.get('CidrIp', '')
                        if cidr == '0.0.0.0/0':
                            findings.append({
                                'severity': 'Critical',
                                'issue': f'Open Security Group Rule: {resource_name}',
                                'description': 'Security group allows access from anywhere',
                                'file': cf_file
                            })
                
                # Check RDS instances
                if 'RDS::DBInstance' in resource_type:
                    if properties.get('PubliclyAccessible') == True:
                        findings.append({
                            'severity': 'High',
                            'issue': f'Public RDS Instance: {resource_name}',
                            'description': 'RDS instance is publicly accessible',
                            'file': cf_file
                        })
        except Exception as e:
            print(f"[-] Error scanning {cf_file}: {e}")
        
        return findings
    
    def scan_ansible(self, playbook: str) -> List[Dict]:
        """Scan Ansible playbooks for security issues"""
        print(f"[*] Scanning Ansible playbook: {playbook}...")
        
        findings = []
        
        try:
            with open(playbook, 'r') as f:
                content = f.read()
            
            # Check for hardcoded passwords
            if 'password:' in content.lower() or 'ansible_password:' in content.lower():
                findings.append({
                    'severity': 'High',
                    'issue': 'Hardcoded Password',
                    'description': 'Playbook may contain hardcoded passwords',
                    'file': playbook
                })
            
            # Check for become without password
            if 'become: yes' in content.lower() and 'become_pass' not in content.lower():
                findings.append({
                    'severity': 'Medium',
                    'issue': 'Become Without Password',
                    'description': 'Playbook uses become without password requirement',
                    'file': playbook
                })
        except Exception as e:
            print(f"[-] Error scanning {playbook}: {e}")
        
        return findings
    
    def scan_kubernetes(self, k8s_file: str) -> List[Dict]:
        """Scan Kubernetes manifests for security issues"""
        print(f"[*] Scanning Kubernetes manifest: {k8s_file}...")
        
        findings = []
        
        try:
            with open(k8s_file, 'r') as f:
                if k8s_file.endswith('.json'):
                    manifest = json.load(f)
                else:
                    manifest = yaml.safe_load(f)
            
            # Check for default service account
            if manifest.get('kind') == 'ServiceAccount':
                if manifest.get('metadata', {}).get('name') == 'default':
                    findings.append({
                        'severity': 'Medium',
                        'issue': 'Default Service Account',
                        'description': 'Using default service account',
                        'file': k8s_file
                    })
            
            # Check for privileged containers
            if manifest.get('kind') in ['Pod', 'Deployment', 'StatefulSet']:
                containers = manifest.get('spec', {}).get('containers', [])
                for container in containers:
                    security_context = container.get('securityContext', {})
                    if security_context.get('privileged') == True:
                        findings.append({
                            'severity': 'High',
                            'issue': 'Privileged Container',
                            'description': f'Container {container.get("name")} runs in privileged mode',
                            'file': k8s_file
                        })
            
            # Check for host network
            if manifest.get('spec', {}).get('hostNetwork') == True:
                findings.append({
                    'severity': 'High',
                    'issue': 'Host Network Access',
                    'description': 'Pod uses host network',
                    'file': k8s_file
                })
        except Exception as e:
            print(f"[-] Error scanning {k8s_file}: {e}")
        
        return findings
    
    def scan_directory(self, directory: str) -> List[Dict]:
        """Scan directory for IaC files"""
        print(f"[*] Scanning directory: {directory}...")
        
        findings = []
        
        for root, dirs, files in os.walk(directory):
            # Exclude certain directories
            dirs[:] = [d for d in dirs if d not in ['.git', 'node_modules', '.terraform']]
            
            for file in files:
                file_path = os.path.join(root, file)
                
                if file.endswith('.tf') or file.endswith('.tfvars'):
                    findings.extend(self.scan_terraform(file_path))
                elif file.endswith('.yaml') or file.endswith('.yml'):
                    if 'cloudformation' in file.lower() or 'cf' in file.lower():
                        findings.extend(self.scan_cloudformation(file_path))
                    elif 'playbook' in file.lower() or 'ansible' in file.lower():
                        findings.extend(self.scan_ansible(file_path))
                    elif 'k8s' in file.lower() or 'kubernetes' in file.lower() or root.endswith('k8s'):
                        findings.extend(self.scan_kubernetes(file_path))
                elif file.endswith('.json'):
                    if 'cloudformation' in file.lower() or 'cf' in file.lower():
                        findings.extend(self.scan_cloudformation(file_path))
                    elif 'k8s' in file.lower() or 'kubernetes' in file.lower():
                        findings.extend(self.scan_kubernetes(file_path))
        
        return findings
    
    def scan(self) -> Dict:
        """Perform IaC security scan"""
        if os.path.isfile(self.target_path):
            if self.target_path.endswith('.tf'):
                self.findings = self.scan_terraform(self.target_path)
            elif 'cloudformation' in self.target_path.lower():
                self.findings = self.scan_cloudformation(self.target_path)
            elif 'ansible' in self.target_path.lower() or 'playbook' in self.target_path.lower():
                self.findings = self.scan_ansible(self.target_path)
            elif 'k8s' in self.target_path.lower() or 'kubernetes' in self.target_path.lower():
                self.findings = self.scan_kubernetes(self.target_path)
        elif os.path.isdir(self.target_path):
            self.findings = self.scan_directory(self.target_path)
        else:
            print(f"[-] Path not found: {self.target_path}")
            return {}
        
        return {
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate IaC security scan report"""
        report = f"# IaC Security Scan Report\n\n"
        report += f"**Target**: {self.target_path}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                report += f"**File**: `{finding['file']}`\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## Best Practices\n\n"
        report += "1. Use secrets management (AWS Secrets Manager, HashiCorp Vault)\n"
        report += "2. Implement least privilege access\n"
        report += "3. Enable encryption at rest and in transit\n"
        report += "4. Restrict network access (security groups, firewalls)\n"
        report += "5. Use private subnets for sensitive resources\n"
        report += "6. Enable logging and monitoring\n"
        report += "7. Review and validate IaC before deployment\n"
        report += "8. Use static analysis tools (Checkov, Terrascan, tfsec)\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python iac_security_scanner.py <file_or_directory>")
        print("Example: python iac_security_scanner.py terraform/")
        print("Example: python iac_security_scanner.py template.yaml")
        sys.exit(1)
    
    target_path = sys.argv[1]
    
    scanner = IaCSecurityScanner(target_path)
    scanner.scan()
    
    report = scanner.generate_report()
    
    filename = "iac_security_scan.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] IaC security scan complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

