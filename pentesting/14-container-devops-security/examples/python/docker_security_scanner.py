#!/usr/bin/env python3
"""
Docker Security Scanner
Scans Docker images and containers for security vulnerabilities.
"""

import subprocess
import json
import sys
import os
from typing import List, Dict, Optional

class DockerSecurityScanner:
    def __init__(self):
        self.vulnerabilities = []
        self.images = []
        self.containers = []
    
    def scan_image(self, image_name: str) -> Dict:
        """Scan Docker image for vulnerabilities"""
        print(f"[*] Scanning Docker image: {image_name}...")
        
        vulnerabilities = {
            'image': image_name,
            'vulnerabilities': [],
            'high_severity': 0,
            'medium_severity': 0,
            'low_severity': 0
        }
        
        try:
            # Use trivy or similar tool if available
            # For demo, we'll check image configuration
            result = subprocess.run(
                ['docker', 'inspect', image_name],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                image_data = json.loads(result.stdout)[0]
                
                # Check for security issues
                config = image_data.get('Config', {})
                
                # Check if running as root
                user = config.get('User', '')
                if not user or user == 'root' or user == '0':
                    vulnerabilities['vulnerabilities'].append({
                        'severity': 'High',
                        'issue': 'Running as root',
                        'description': 'Container runs as root user'
                    })
                    vulnerabilities['high_severity'] += 1
                
                # Check exposed ports
                exposed_ports = config.get('ExposedPorts', {})
                if exposed_ports:
                    vulnerabilities['vulnerabilities'].append({
                        'severity': 'Medium',
                        'issue': 'Exposed Ports',
                        'description': f'Ports exposed: {list(exposed_ports.keys())}'
                    })
                    vulnerabilities['medium_severity'] += 1
                
                # Check environment variables
                env_vars = config.get('Env', [])
                sensitive_vars = ['PASSWORD', 'SECRET', 'KEY', 'TOKEN', 'API_KEY']
                for env_var in env_vars:
                    if any(sensitive in env_var.upper() for sensitive in sensitive_vars):
                        vulnerabilities['vulnerabilities'].append({
                            'severity': 'High',
                            'issue': 'Sensitive Environment Variable',
                            'description': f'Potential sensitive data in env: {env_var.split("=")[0]}'
                        })
                        vulnerabilities['high_severity'] += 1
                
                # Check for healthcheck
                if 'Healthcheck' not in config:
                    vulnerabilities['vulnerabilities'].append({
                        'severity': 'Low',
                        'issue': 'No Healthcheck',
                        'description': 'Container does not have healthcheck configured'
                    })
                    vulnerabilities['low_severity'] += 1
        except FileNotFoundError:
            print("[-] Docker not found. Install Docker to use this tool.")
        except subprocess.TimeoutExpired:
            print("[-] Docker command timed out")
        except Exception as e:
            print(f"[-] Error scanning image: {e}")
        
        self.vulnerabilities.extend(vulnerabilities['vulnerabilities'])
        return vulnerabilities
    
    def scan_container(self, container_id: str) -> Dict:
        """Scan running container for security issues"""
        print(f"[*] Scanning container: {container_id}...")
        
        vulnerabilities = {
            'container': container_id,
            'vulnerabilities': []
        }
        
        try:
            # Inspect container
            result = subprocess.run(
                ['docker', 'inspect', container_id],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                container_data = json.loads(result.stdout)[0]
                
                # Check security options
                security_opts = container_data.get('HostConfig', {}).get('SecurityOpt', [])
                if not security_opts:
                    vulnerabilities['vulnerabilities'].append({
                        'severity': 'Medium',
                        'issue': 'No Security Options',
                        'description': 'Container lacks security options'
                    })
                
                # Check if privileged
                privileged = container_data.get('HostConfig', {}).get('Privileged', False)
                if privileged:
                    vulnerabilities['vulnerabilities'].append({
                        'severity': 'Critical',
                        'issue': 'Privileged Container',
                        'description': 'Container is running in privileged mode'
                    })
                
                # Check resource limits
                memory_limit = container_data.get('HostConfig', {}).get('Memory', 0)
                if memory_limit == 0:
                    vulnerabilities['vulnerabilities'].append({
                        'severity': 'Medium',
                        'issue': 'No Memory Limit',
                        'description': 'Container has no memory limit'
                    })
        except Exception as e:
            print(f"[-] Error scanning container: {e}")
        
        self.vulnerabilities.extend(vulnerabilities['vulnerabilities'])
        return vulnerabilities
    
    def list_images(self) -> List[str]:
        """List all Docker images"""
        try:
            result = subprocess.run(
                ['docker', 'images', '--format', '{{.Repository}}:{{.Tag}}'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                images = [img for img in result.stdout.strip().split('\n') if img]
                self.images = images
                return images
        except Exception as e:
            print(f"[-] Error listing images: {e}")
        
        return []
    
    def list_containers(self, all_containers: bool = True) -> List[str]:
        """List all Docker containers"""
        try:
            cmd = ['docker', 'ps', '--format', '{{.ID}}']
            if all_containers:
                cmd.append('-a')
            
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                containers = [c for c in result.stdout.strip().split('\n') if c]
                self.containers = containers
                return containers
        except Exception as e:
            print(f"[-] Error listing containers: {e}")
        
        return []
    
    def scan_all_images(self) -> List[Dict]:
        """Scan all Docker images"""
        images = self.list_images()
        results = []
        
        for image in images:
            result = self.scan_image(image)
            results.append(result)
        
        return results
    
    def generate_report(self) -> str:
        """Generate security scan report"""
        report = "# Docker Security Scan Report\n\n"
        report += "## Summary\n\n"
        report += f"Total Vulnerabilities Found: {len(self.vulnerabilities)}\n\n"
        
        critical = [v for v in self.vulnerabilities if v['severity'] == 'Critical']
        high = [v for v in self.vulnerabilities if v['severity'] == 'High']
        medium = [v for v in self.vulnerabilities if v['severity'] == 'Medium']
        low = [v for v in self.vulnerabilities if v['severity'] == 'Low']
        
        report += f"- **Critical**: {len(critical)}\n"
        report += f"- **High**: {len(high)}\n"
        report += f"- **Medium**: {len(medium)}\n"
        report += f"- **Low**: {len(low)}\n\n"
        
        report += "## Vulnerabilities\n\n"
        for i, vuln in enumerate(self.vulnerabilities, 1):
            report += f"### {i}. {vuln['issue']}\n\n"
            report += f"**Severity**: {vuln['severity']}\n\n"
            report += f"**Description**: {vuln['description']}\n\n"
            report += "---\n\n"
        
        return report

def main():
    scanner = DockerSecurityScanner()
    
    if len(sys.argv) < 2:
        print("Usage:")
        print("  python docker_security_scanner.py image <image_name>")
        print("  python docker_security_scanner.py container <container_id>")
        print("  python docker_security_scanner.py all")
        print("\nExample:")
        print("  python docker_security_scanner.py image nginx:latest")
        print("  python docker_security_scanner.py all")
        sys.exit(1)
    
    action = sys.argv[1]
    
    if action == 'image':
        if len(sys.argv) < 3:
            print("Usage: python docker_security_scanner.py image <image_name>")
            sys.exit(1)
        image_name = sys.argv[2]
        scanner.scan_image(image_name)
    
    elif action == 'container':
        if len(sys.argv) < 3:
            print("Usage: python docker_security_scanner.py container <container_id>")
            sys.exit(1)
        container_id = sys.argv[2]
        scanner.scan_container(container_id)
    
    elif action == 'all':
        print("[*] Scanning all images...")
        scanner.scan_all_images()
    
    # Generate report
    report = scanner.generate_report()
    with open('docker_security_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Scan complete. Found {len(scanner.vulnerabilities)} vulnerabilities")
    print(f"[+] Report saved to docker_security_report.md")
    print(f"[!] WARNING: Only scan images/containers you own or have permission to scan!")

if __name__ == '__main__':
    main()

