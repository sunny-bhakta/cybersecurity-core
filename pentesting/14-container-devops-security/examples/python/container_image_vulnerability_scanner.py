#!/usr/bin/env python3
"""
Container Image Vulnerability Scanner
Scans container images for known vulnerabilities.
"""

import sys
import subprocess
import json
from typing import Dict, List

class ContainerImageVulnerabilityScanner:
    def __init__(self, image_name: str):
        self.image_name = image_name
        self.findings = []
    
    def scan_with_trivy(self) -> Dict:
        """Scan container image using Trivy"""
        print(f"[*] Scanning image {self.image_name} with Trivy...")
        
        try:
            result = subprocess.run(
                ['trivy', 'image', '--format', 'json', self.image_name],
                capture_output=True,
                text=True,
                timeout=300
            )
            
            if result.returncode == 0:
                scan_results = json.loads(result.stdout)
                return self.parse_trivy_results(scan_results)
            else:
                print(f"[-] Trivy scan failed: {result.stderr}")
                return {}
        except FileNotFoundError:
            print("[-] Trivy not found. Install from: https://github.com/aquasecurity/trivy")
            return {}
        except subprocess.TimeoutExpired:
            print("[-] Trivy scan timed out")
            return {}
        except Exception as e:
            print(f"[-] Error running Trivy: {e}")
            return {}
    
    def parse_trivy_results(self, results: Dict) -> Dict:
        """Parse Trivy scan results"""
        findings = []
        
        if 'Results' in results:
            for result in results['Results']:
                target = result.get('Target', 'Unknown')
                vulnerabilities = result.get('Vulnerabilities', [])
                
                for vuln in vulnerabilities:
                    severity = vuln.get('Severity', 'Unknown')
                    pkg_name = vuln.get('PkgName', 'Unknown')
                    vuln_id = vuln.get('VulnerabilityID', 'Unknown')
                    title = vuln.get('Title', '')
                    description = vuln.get('Description', '')
                    
                    findings.append({
                        'severity': severity,
                        'package': pkg_name,
                        'vulnerability_id': vuln_id,
                        'title': title,
                        'description': description,
                        'target': target
                    })
        
        self.findings = findings
        return {
            'findings': findings,
            'total_vulnerabilities': len(findings)
        }
    
    def scan_with_docker_scan(self) -> Dict:
        """Scan container image using Docker scan"""
        print(f"[*] Scanning image {self.image_name} with Docker scan...")
        
        try:
            result = subprocess.run(
                ['docker', 'scan', '--json', self.image_name],
                capture_output=True,
                text=True,
                timeout=300
            )
            
            if result.returncode == 0:
                scan_results = json.loads(result.stdout)
                return self.parse_docker_scan_results(scan_results)
            else:
                print(f"[-] Docker scan failed: {result.stderr}")
                return {}
        except FileNotFoundError:
            print("[-] Docker not found or scan plugin not installed")
            return {}
        except Exception as e:
            print(f"[-] Error running Docker scan: {e}")
            return {}
    
    def parse_docker_scan_results(self, results: Dict) -> Dict:
        """Parse Docker scan results"""
        findings = []
        
        vulnerabilities = results.get('vulnerabilities', [])
        
        for vuln in vulnerabilities:
            findings.append({
                'severity': vuln.get('severity', 'Unknown'),
                'package': vuln.get('package', 'Unknown'),
                'vulnerability_id': vuln.get('id', 'Unknown'),
                'title': vuln.get('title', ''),
                'description': vuln.get('description', ''),
                'target': self.image_name
            })
        
        self.findings = findings
        return {
            'findings': findings,
            'total_vulnerabilities': len(findings)
        }
    
    def scan(self, tool: str = 'trivy') -> Dict:
        """Perform container image vulnerability scan"""
        if tool == 'trivy':
            return self.scan_with_trivy()
        elif tool == 'docker':
            return self.scan_with_docker_scan()
        else:
            print(f"[-] Unknown tool: {tool}")
            return {}
    
    def generate_report(self) -> str:
        """Generate vulnerability scan report"""
        report = f"# Container Image Vulnerability Scan Report\n\n"
        report += f"**Image**: {self.image_name}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Vulnerabilities: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'CRITICAL']
            high = [f for f in self.findings if f['severity'] == 'HIGH']
            medium = [f for f in self.findings if f['severity'] == 'MEDIUM']
            low = [f for f in self.findings if f['severity'] == 'LOW']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n"
            report += f"- **Low**: {len(low)}\n\n"
            
            # Group by severity
            for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']:
                severity_findings = [f for f in self.findings if f['severity'] == severity]
                if severity_findings:
                    report += f"## {severity} Vulnerabilities ({len(severity_findings)})\n\n"
                    for i, finding in enumerate(severity_findings[:20], 1):  # Limit to 20 per severity
                        report += f"### {i}. {finding['vulnerability_id']}\n\n"
                        report += f"**Package**: {finding['package']}\n\n"
                        report += f"**Title**: {finding['title']}\n\n"
                        if finding['description']:
                            report += f"**Description**: {finding['description'][:200]}...\n\n"
                        report += "---\n\n"
                    
                    if len(severity_findings) > 20:
                        report += f"*... and {len(severity_findings) - 20} more {severity} vulnerabilities*\n\n"
        else:
            report += "âœ… No vulnerabilities found.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Update base images regularly\n"
        report += "2. Use minimal base images (Alpine, Distroless)\n"
        report += "3. Keep packages up to date\n"
        report += "4. Scan images before deployment\n"
        report += "5. Use image signing and verification\n"
        report += "6. Implement image scanning in CI/CD\n"
        report += "7. Monitor for new vulnerabilities\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python container_image_vulnerability_scanner.py <image_name> [tool]")
        print("Example: python container_image_vulnerability_scanner.py nginx:latest")
        print("Example: python container_image_vulnerability_scanner.py nginx:latest trivy")
        print("\nTools: trivy (default), docker")
        sys.exit(1)
    
    image_name = sys.argv[1]
    tool = sys.argv[2] if len(sys.argv) > 2 else 'trivy'
    
    scanner = ContainerImageVulnerabilityScanner(image_name)
    scanner.scan(tool)
    
    report = scanner.generate_report()
    
    filename = f"container_vulnerability_scan_{image_name.replace(':', '_').replace('/', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Container image vulnerability scan complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] Found {len(scanner.findings)} vulnerabilities")

if __name__ == "__main__":
    main()

