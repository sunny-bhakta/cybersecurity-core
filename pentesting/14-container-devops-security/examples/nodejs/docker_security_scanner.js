/**
 * Docker Security Scanner
 * Scans Docker images and containers for security vulnerabilities.
 */

const { exec } = require('child_process');
const { promisify } = require('util');
const fs = require('fs');

const execAsync = promisify(exec);

class DockerSecurityScanner {
    constructor() {
        this.vulnerabilities = [];
        this.images = [];
        this.containers = [];
    }

    async scanImage(imageName) {
        console.log(`[*] Scanning Docker image: ${imageName}...`);

        const vulnerabilities = {
            image: imageName,
            vulnerabilities: [],
            high_severity: 0,
            medium_severity: 0,
            low_severity: 0
        };

        try {
            const { stdout } = await execAsync(`docker inspect ${imageName}`, { timeout: 30000 });
            const imageData = JSON.parse(stdout)[0];
            const config = imageData.Config || {};

            // Check if running as root
            const user = config.User || '';
            if (!user || user === 'root' || user === '0') {
                vulnerabilities.vulnerabilities.push({
                    severity: 'High',
                    issue: 'Running as root',
                    description: 'Container runs as root user'
                });
                vulnerabilities.high_severity++;
            }

            // Check exposed ports
            const exposedPorts = config.ExposedPorts || {};
            if (Object.keys(exposedPorts).length > 0) {
                vulnerabilities.vulnerabilities.push({
                    severity: 'Medium',
                    issue: 'Exposed Ports',
                    description: `Ports exposed: ${Object.keys(exposedPorts).join(', ')}`
                });
                vulnerabilities.medium_severity++;
            }

            // Check environment variables
            const envVars = config.Env || [];
            const sensitiveVars = ['PASSWORD', 'SECRET', 'KEY', 'TOKEN', 'API_KEY'];
            envVars.forEach(envVar => {
                if (sensitiveVars.some(sensitive => envVar.toUpperCase().includes(sensitive))) {
                    vulnerabilities.vulnerabilities.push({
                        severity: 'High',
                        issue: 'Sensitive Environment Variable',
                        description: `Potential sensitive data in env: ${envVar.split('=')[0]}`
                    });
                    vulnerabilities.high_severity++;
                }
            });

            // Check for healthcheck
            if (!config.Healthcheck) {
                vulnerabilities.vulnerabilities.push({
                    severity: 'Low',
                    issue: 'No Healthcheck',
                    description: 'Container does not have healthcheck configured'
                });
                vulnerabilities.low_severity++;
            }
        } catch (error) {
            if (error.message.includes('docker')) {
                console.log('[-] Docker not found. Install Docker to use this tool.');
            } else {
                console.log(`[-] Error scanning image: ${error.message}`);
            }
        }

        this.vulnerabilities.push(...vulnerabilities.vulnerabilities);
        return vulnerabilities;
    }

    async listImages() {
        try {
            const { stdout } = await execAsync('docker images --format "{{.Repository}}:{{.Tag}}"', { timeout: 30000 });
            const images = stdout.trim().split('\n').filter(img => img);
            this.images = images;
            return images;
        } catch (error) {
            console.log(`[-] Error listing images: ${error.message}`);
            return [];
        }
    }

    async scanAllImages() {
        const images = await this.listImages();
        const results = [];

        for (const image of images) {
            const result = await this.scanImage(image);
            results.push(result);
        }

        return results;
    }

    generateReport() {
        let report = `# Docker Security Scan Report\n\n`;
        report += `## Summary\n\n`;
        report += `Total Vulnerabilities Found: ${this.vulnerabilities.length}\n\n`;

        const critical = this.vulnerabilities.filter(v => v.severity === 'Critical');
        const high = this.vulnerabilities.filter(v => v.severity === 'High');
        const medium = this.vulnerabilities.filter(v => v.severity === 'Medium');
        const low = this.vulnerabilities.filter(v => v.severity === 'Low');

        report += `- **Critical**: ${critical.length}\n`;
        report += `- **High**: ${high.length}\n`;
        report += `- **Medium**: ${medium.length}\n`;
        report += `- **Low**: ${low.length}\n\n`;

        report += `## Vulnerabilities\n\n`;
        this.vulnerabilities.forEach((vuln, i) => {
            report += `### ${i + 1}. ${vuln.issue}\n\n`;
            report += `**Severity**: ${vuln.severity}\n\n`;
            report += `**Description**: ${vuln.description}\n\n`;
            report += `---\n\n`;
        });

        return report;
    }
}

async function main() {
    const args = process.argv.slice(2);
    const scanner = new DockerSecurityScanner();

    if (args.length < 1) {
        console.log('Usage:');
        console.log('  node docker_security_scanner.js image <image_name>');
        console.log('  node docker_security_scanner.js all');
        console.log('\nExample:');
        console.log('  node docker_security_scanner.js image nginx:latest');
        console.log('  node docker_security_scanner.js all');
        process.exit(1);
    }

    const action = args[0];

    if (action === 'image') {
        if (args.length < 2) {
            console.log('Usage: node docker_security_scanner.js image <image_name>');
            process.exit(1);
        }
        await scanner.scanImage(args[1]);
    } else if (action === 'all') {
        console.log('[*] Scanning all images...');
        await scanner.scanAllImages();
    }

    const report = scanner.generateReport();
    fs.writeFileSync('docker_security_report.md', report, 'utf8');

    console.log(`\n[+] Scan complete. Found ${scanner.vulnerabilities.length} vulnerabilities`);
    console.log(`[+] Report saved to docker_security_report.md`);
    console.log(`[!] WARNING: Only scan images/containers you own or have permission to scan!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = DockerSecurityScanner;

