#!/usr/bin/env node
/**
 * Mass Assignment Vulnerability Tester
 * Tests for mass assignment vulnerabilities in web applications.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class MassAssignmentTester {
    constructor(baseUrl) {
        this.baseUrl = baseUrl;
        this.vulnerabilities = [];
    }

    makePostRequest(url, data) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            const urlObj = new URL(url);
            
            const dataStr = JSON.stringify(data);
            
            const options = {
                hostname: urlObj.hostname,
                port: urlObj.port || (protocol === https ? 443 : 80),
                path: urlObj.pathname + urlObj.search,
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(dataStr)
                },
                timeout: 10000
            };
            
            const req = protocol.request(options, (res) => {
                let responseData = '';
                res.on('data', (chunk) => {
                    responseData += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: responseData });
                });
            });
            
            req.on('error', reject);
            req.write(dataStr);
            req.end();
        });
    }

    async testMassAssignment(endpoint, baseData) {
        console.log(`[*] Testing mass assignment on ${endpoint}...`);
        
        const protectedFields = [
            'is_admin', 'admin', 'role', 'permissions',
            'is_active', 'is_verified', 'balance', 'credit'
        ];
        
        for (const field of protectedFields) {
            const testData = { ...baseData };
            testData[field] = true;
            
            try {
                const response = await this.makePostRequest(`${this.baseUrl}${endpoint}`, testData);
                if (response.statusCode === 200) {
                    console.log(`[!] Potential mass assignment: Field '${field}' may be assignable`);
                    this.vulnerabilities.push(`Mass assignment: Field '${field}' may be assignable`);
                }
            } catch (err) {
                // Ignore errors
            }
        }
        
        return this.vulnerabilities.length > 0;
    }

    generateReport() {
        let report = `# Mass Assignment Vulnerability Test Report for ${this.baseUrl}\n\n`;
        
        if (this.vulnerabilities.length > 0) {
            report += `⚠️ **VULNERABLE**: Mass assignment vulnerabilities detected!\n\n`;
            report += `## Vulnerabilities Found\n\n`;
            this.vulnerabilities.forEach(vuln => {
                report += `- ${vuln}\n`;
            });
            report += `\n`;
        } else {
            report += `✅ No mass assignment vulnerabilities detected.\n\n`;
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Use whitelist for allowed fields\n`;
        report += `2. Use blacklist for protected fields\n`;
        report += `3. Validate all input fields\n`;
        report += `4. Use DTOs (Data Transfer Objects)\n`;
        report += `5. Implement proper access controls\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node mass_assignment_tester.js <base_url>');
        console.log('Example: node mass_assignment_tester.js http://example.com');
        process.exit(1);
    }
    
    const baseUrl = process.argv[2];
    const tester = new MassAssignmentTester(baseUrl);
    
    const report = tester.generateReport();
    
    const filename = 'mass_assignment_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Mass assignment testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = MassAssignmentTester;

