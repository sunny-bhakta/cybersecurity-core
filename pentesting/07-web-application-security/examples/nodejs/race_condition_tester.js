#!/usr/bin/env node
/**
 * Race Condition Tester
 * Tests for race condition vulnerabilities (TOCTOU).
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class RaceConditionTester {
    constructor(url) {
        this.url = url;
        this.successCount = 0;
        this.totalRequests = 0;
    }

    makePostRequest(url, data) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            const urlObj = new URL(url);
            
            const dataStr = JSON.stringify(data);
            
            const options = {
                hostname: urlObj.hostname,
                port: urlObj.port || (protocol === https ? 443 : 80),
                path: urlObj.pathname + urlObj.search,
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(dataStr)
                },
                timeout: 10000
            };
            
            const req = protocol.request(options, (res) => {
                this.totalRequests++;
                if (res.statusCode === 200) {
                    this.successCount++;
                }
                resolve();
            });
            
            req.on('error', () => {
                this.totalRequests++;
                resolve();
            });
            
            req.write(dataStr);
            req.end();
        });
    }

    async testRaceCondition(data, numRequests = 10) {
        console.log(`[*] Testing race condition with ${numRequests} concurrent requests...`);
        
        this.successCount = 0;
        this.totalRequests = 0;
        
        const promises = [];
        for (let i = 0; i < numRequests; i++) {
            promises.push(this.makePostRequest(this.url, data));
        }
        
        await Promise.all(promises);
        
        console.log(`[+] Sent ${this.totalRequests} requests, ${this.successCount} succeeded`);
        
        if (this.successCount > 1) {
            console.log('[+] Potential race condition detected!');
            return true;
        }
        
        return false;
    }

    generateReport() {
        let report = `# Race Condition Test Report for ${this.url}\n\n`;
        report += `## Test Results\n\n`;
        report += `Total Requests: ${this.totalRequests}\n`;
        report += `Successful Requests: ${this.successCount}\n\n`;
        
        if (this.successCount > 1) {
            report += `⚠️ **WARNING**: Potential race condition vulnerability detected!\n`;
            report += `Multiple concurrent requests succeeded, indicating possible TOCTOU issue.\n\n`;
        } else {
            report += `✅ No race condition detected in this test.\n\n`;
        }
        
        report += `## Common Race Condition Scenarios\n\n`;
        report += `1. **Double Spending**: Multiple transactions processed\n`;
        report += `2. **Account Creation**: Multiple accounts with same email\n`;
        report += `3. **Inventory Management**: Overselling products\n`;
        report += `4. **Vote Manipulation**: Multiple votes counted\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Use database transactions with proper locking\n`;
        report += `2. Implement atomic operations\n`;
        report += `3. Use optimistic/pessimistic locking\n`;
        report += `4. Add rate limiting\n`;
        report += `5. Implement idempotency keys\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node race_condition_tester.js <url>');
        console.log('Example: node race_condition_tester.js http://example.com/api/transfer');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const tester = new RaceConditionTester(url);
    
    const testData = { amount: 100, account: 'test' };
    await tester.testRaceCondition(testData);
    
    const report = tester.generateReport();
    
    const filename = 'race_condition_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Race condition testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = RaceConditionTester;

