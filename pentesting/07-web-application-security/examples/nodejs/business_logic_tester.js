#!/usr/bin/env node
/**
 * Business Logic Vulnerability Tester
 * Tests for business logic flaws in web applications.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class BusinessLogicTester {
    constructor(baseUrl) {
        this.baseUrl = baseUrl;
        this.vulnerabilities = [];
    }

    makePostRequest(url, data) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            const urlObj = new URL(url);
            
            const dataStr = JSON.stringify(data);
            
            const options = {
                hostname: urlObj.hostname,
                port: urlObj.port || (protocol === https ? 443 : 80),
                path: urlObj.pathname + urlObj.search,
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(dataStr)
                },
                timeout: 10000
            };
            
            const req = protocol.request(options, (res) => {
                let responseData = '';
                res.on('data', (chunk) => {
                    responseData += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: responseData });
                });
            });
            
            req.on('error', reject);
            req.write(dataStr);
            req.end();
        });
    }

    async testPriceManipulation(endpoint, params) {
        console.log(`[*] Testing price manipulation on ${endpoint}...`);
        
        const testParams = { ...params };
        testParams.price = -1;
        
        try {
            const response = await this.makePostRequest(`${this.baseUrl}${endpoint}`, testParams);
            if (response.statusCode === 200) {
                console.log('[!] Application accepts negative prices!');
                this.vulnerabilities.push('Price manipulation: Negative prices accepted');
                return true;
            }
        } catch (err) {
            // Ignore errors
        }
        
        return false;
    }

    generateReport() {
        let report = `# Business Logic Vulnerability Test Report for ${this.baseUrl}\n\n`;
        
        if (this.vulnerabilities.length > 0) {
            report += `⚠️ **VULNERABLE**: Business logic vulnerabilities detected!\n\n`;
            report += `## Vulnerabilities Found\n\n`;
            this.vulnerabilities.forEach(vuln => {
                report += `- ${vuln}\n`;
            });
            report += `\n`;
        } else {
            report += `✅ No business logic vulnerabilities detected.\n\n`;
        }
        
        report += `## Common Business Logic Vulnerabilities\n\n`;
        report += `1. **Price Manipulation**: Negative or zero prices\n`;
        report += `2. **Quantity Manipulation**: Negative or excessive quantities\n`;
        report += `3. **Workflow Bypass**: Skipping required steps\n`;
        report += `4. **Time-based Attacks**: Race conditions\n`;
        report += `5. **Privilege Escalation**: Gaining unauthorized access\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Validate all business rules server-side\n`;
        report += `2. Implement proper authorization checks\n`;
        report += `3. Use atomic transactions\n`;
        report += `4. Implement rate limiting\n`;
        report += `5. Regular security audits\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node business_logic_tester.js <base_url>');
        console.log('Example: node business_logic_tester.js http://example.com');
        process.exit(1);
    }
    
    const baseUrl = process.argv[2];
    const tester = new BusinessLogicTester(baseUrl);
    
    const report = tester.generateReport();
    
    const filename = 'business_logic_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] Business logic testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = BusinessLogicTester;

