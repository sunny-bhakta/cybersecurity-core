#!/usr/bin/env node
/**
 * JWT Vulnerability Tester
 * Tests for JWT (JSON Web Token) vulnerabilities.
 */

const fs = require('fs');
const crypto = require('crypto');

class JWTVulnerabilityTester {
    constructor() {
        this.vulnerabilities = [];
    }

    decodeJWT(token) {
        const parts = token.split('.');
        if (parts.length !== 3) {
            return null;
        }
        
        try {
            const header = JSON.parse(Buffer.from(parts[0], 'base64url').toString());
            const payload = JSON.parse(Buffer.from(parts[1], 'base64url').toString());
            return { header, payload, signature: parts[2] };
        } catch (err) {
            return null;
        }
    }

    testNoneAlgorithm(token) {
        console.log('[*] Testing for "none" algorithm vulnerability...');
        
        const decoded = this.decodeJWT(token);
        if (!decoded) return false;
        
        if (decoded.header.alg === 'none' || decoded.header.alg === 'None') {
            console.log('[+] "none" algorithm vulnerability found!');
            this.vulnerabilities.push('None algorithm accepted');
            return true;
        }
        
        return false;
    }

    testWeakSecret(token) {
        console.log('[*] Testing for weak secret...');
        
        const commonSecrets = ['secret', 'password', '123456', 'admin', 'test'];
        // In real implementation, would try to crack JWT
        return false;
    }

    testAlgorithmConfusion(token) {
        console.log('[*] Testing for algorithm confusion...');
        
        const decoded = this.decodeJWT(token);
        if (!decoded) return false;
        
        // Try changing algorithm from RS256 to HS256
        if (decoded.header.alg === 'RS256') {
            console.log('[!] Potential algorithm confusion: RS256 -> HS256');
            this.vulnerabilities.push('Algorithm confusion possible');
            return true;
        }
        
        return false;
    }

    generateReport() {
        let report = `# JWT Vulnerability Test Report\n\n`;
        
        if (this.vulnerabilities.length > 0) {
            report += `⚠️ **VULNERABLE**: JWT vulnerabilities detected!\n\n`;
            report += `## Vulnerabilities Found\n\n`;
            this.vulnerabilities.forEach(vuln => {
                report += `- ${vuln}\n`;
            });
            report += `\n`;
        } else {
            report += `✅ No JWT vulnerabilities detected.\n\n`;
        }
        
        report += `## Common JWT Vulnerabilities\n\n`;
        report += `1. **None Algorithm**: Accepting "none" algorithm\n`;
        report += `2. **Weak Secrets**: Using weak or default secrets\n`;
        report += `3. **Algorithm Confusion**: RS256 to HS256 confusion\n`;
        report += `4. **Missing Signature Verification**: Not verifying signatures\n`;
        report += `5. **Expired Tokens**: Not checking expiration\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Always verify JWT signatures\n`;
        report += `2. Use strong secrets/keys\n`;
        report += `3. Whitelist allowed algorithms\n`;
        report += `4. Check token expiration\n`;
        report += `5. Validate token claims\n\n`;
        
        return report;
    }
}

function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node jwt_vulnerability_tester.js <jwt_token>');
        console.log('Example: node jwt_vulnerability_tester.js eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...');
        process.exit(1);
    }
    
    const token = process.argv[2];
    const tester = new JWTVulnerabilityTester();
    
    tester.testNoneAlgorithm(token);
    tester.testWeakSecret(token);
    tester.testAlgorithmConfusion(token);
    
    const report = tester.generateReport();
    
    const filename = 'jwt_vulnerability_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] JWT vulnerability testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main();
}

module.exports = JWTVulnerabilityTester;

