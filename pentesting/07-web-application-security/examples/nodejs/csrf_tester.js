#!/usr/bin/env node
/**
 * CSRF (Cross-Site Request Forgery) Tester
 * Tests for CSRF vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class CSRFTester {
    constructor(url) {
        this.url = url;
        this.vulnerable = false;
        this.csrfTokens = [];
    }

    makeRequest(url, options = {}) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            protocol.get(url, { timeout: 10000, ...options }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    resolve({ 
                        statusCode: res.statusCode, 
                        text: data,
                        headers: res.headers,
                        cookies: res.headers['set-cookie'] || []
                    });
                });
            }).on('error', (err) => {
                reject(err);
            });
        });
    }

    async checkCsrfProtection() {
        console.log(`[*] Checking CSRF protection for ${this.url}...`);
        
        const protection = {
            csrfToken: false,
            sameSiteCookie: false,
            refererCheck: false,
            customHeader: false
        };
        
        try {
            const response = await this.makeRequest(this.url);
            
            if (response.text.toLowerCase().includes('csrf') || 
                response.text.toLowerCase().includes('token')) {
                protection.csrfToken = true;
            }
            
            if (response.cookies) {
                for (const cookie of response.cookies) {
                    if (cookie.includes('SameSite')) {
                        protection.sameSiteCookie = true;
                    }
                }
            }
            
            if (response.headers['x-csrf-token'] || 
                response.headers['x-requested-with']) {
                protection.customHeader = true;
            }
        } catch (err) {
            console.log(`[-] Error: ${err.message}`);
        }
        
        return protection;
    }

    generateReport() {
        return this.checkCsrfProtection().then(protection => {
            let report = `# CSRF Test Report for ${this.url}\n\n`;
            report += `## CSRF Protection Status\n\n`;
            
            report += `- **CSRF Token**: ${protection.csrfToken ? '✅ Found' : '❌ Not found'}\n`;
            report += `- **SameSite Cookie**: ${protection.sameSiteCookie ? '✅ Found' : '❌ Not found'}\n`;
            report += `- **Custom Header**: ${protection.customHeader ? '✅ Found' : '❌ Not found'}\n\n`;
            
            if (!protection.csrfToken && !protection.sameSiteCookie && !protection.customHeader) {
                report += `⚠️ **WARNING**: Application may be vulnerable to CSRF attacks!\n\n`;
            }
            
            report += `## Recommendations\n\n`;
            report += `1. Implement CSRF tokens\n`;
            report += `2. Use SameSite cookie attribute\n`;
            report += `3. Verify Referer header\n`;
            report += `4. Use custom headers (X-Requested-With)\n\n`;
            
            return report;
        });
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node csrf_tester.js <url>');
        console.log('Example: node csrf_tester.js http://example.com');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const tester = new CSRFTester(url);
    const report = await tester.generateReport();
    
    const filename = 'csrf_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] CSRF testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = CSRFTester;

