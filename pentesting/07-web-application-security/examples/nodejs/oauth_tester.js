#!/usr/bin/env node
/**
 * OAuth Vulnerability Tester
 * Tests for OAuth 2.0 and OpenID Connect vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class OAuthTester {
    constructor(baseUrl) {
        this.baseUrl = baseUrl;
        this.vulnerabilities = [];
    }

    makeRequest(url) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            protocol.get(url, { timeout: 10000 }, (res) => {
                resolve({ 
                    statusCode: res.statusCode, 
                    headers: res.headers,
                    location: res.headers.location || ''
                });
            }).on('error', reject);
        });
    }

    async testRedirectUriValidation(authEndpoint, clientId) {
        console.log(`[*] Testing redirect URI validation on ${authEndpoint}...`);
        
        const testRedirects = [
            'http://evil.com',
            'https://evil.com',
            'http://localhost',
            'http://127.0.0.1',
            'javascript:alert(1)'
        ];
        
        for (const redirectUri of testRedirects) {
            const urlObj = new URL(authEndpoint);
            urlObj.searchParams.set('response_type', 'code');
            urlObj.searchParams.set('client_id', clientId);
            urlObj.searchParams.set('redirect_uri', redirectUri);
            urlObj.searchParams.set('scope', 'openid profile');
            urlObj.searchParams.set('state', 'test');
            
            try {
                const response = await this.makeRequest(urlObj.toString());
                if ([302, 301, 307, 308].includes(response.statusCode)) {
                    if (response.location.includes(redirectUri) || response.location.includes('evil.com')) {
                        console.log(`[!] Redirect URI validation bypass: ${redirectUri} accepted!`);
                        this.vulnerabilities.push(`Redirect URI validation: ${redirectUri} accepted`);
                    }
                }
            } catch (err) {
                // Ignore errors
            }
        }
        
        return this.vulnerabilities.length > 0;
    }

    generateReport() {
        let report = `# OAuth Vulnerability Test Report for ${this.baseUrl}\n\n`;
        
        if (this.vulnerabilities.length > 0) {
            report += `⚠️ **VULNERABLE**: OAuth vulnerabilities detected!\n\n`;
            report += `## Vulnerabilities Found\n\n`;
            this.vulnerabilities.forEach(vuln => {
                report += `- ${vuln}\n`;
            });
            report += `\n`;
        } else {
            report += `✅ No OAuth vulnerabilities detected.\n\n`;
        }
        
        report += `## Common OAuth Vulnerabilities\n\n`;
        report += `1. **Redirect URI Validation**: Weak or missing validation\n`;
        report += `2. **Client Secret Exposure**: Secrets in client-side code\n`;
        report += `3. **Missing State Parameter**: CSRF vulnerabilities\n`;
        report += `4. **Token Leakage**: Tokens in URLs or logs\n`;
        report += `5. **Scope Abuse**: Excessive permissions\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Strictly validate redirect URIs\n`;
        report += `2. Use PKCE for public clients\n`;
        report += `3. Always use state parameter\n`;
        report += `4. Implement token expiration\n`;
        report += `5. Use least privilege scopes\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 4) {
        console.log('Usage: node oauth_tester.js <base_url> <auth_endpoint> <client_id>');
        console.log('Example: node oauth_tester.js http://example.com /oauth/authorize client123');
        process.exit(1);
    }
    
    const baseUrl = process.argv[2];
    const authEndpoint = process.argv[3];
    const clientId = process.argv[4];
    
    const tester = new OAuthTester(baseUrl);
    await tester.testRedirectUriValidation(`${baseUrl}${authEndpoint}`, clientId);
    
    const report = tester.generateReport();
    
    const filename = 'oauth_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] OAuth testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = OAuthTester;

