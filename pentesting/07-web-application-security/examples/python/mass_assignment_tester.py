#!/usr/bin/env python3
"""
Mass Assignment Vulnerability Tester
Tests for mass assignment vulnerabilities in web applications.
"""

import sys
import requests
from typing import Dict, List

class MassAssignmentTester:
    def __init__(self, base_url: str):
        self.base_url = base_url
        self.vulnerabilities = []
    
    def test_mass_assignment(self, endpoint: str, base_data: Dict) -> bool:
        """Test for mass assignment vulnerability"""
        print(f"[*] Testing mass assignment on {endpoint}...")
        
        # Common fields that should be protected
        protected_fields = [
            'is_admin', 'admin', 'role', 'permissions', 'privileges',
            'is_active', 'is_verified', 'email_verified',
            'balance', 'credit', 'points', 'discount',
            'created_at', 'updated_at', 'id', 'user_id'
        ]
        
        vulnerable = False
        
        for field in protected_fields:
            test_data = base_data.copy()
            test_data[field] = True  # or appropriate test value
            
            try:
                response = requests.post(
                    f"{self.base_url}{endpoint}",
                    json=test_data,
                    timeout=10
                )
                
                # Check if field was accepted
                if response.status_code == 200:
                    # Try to verify if field was set
                    # In real implementation, would check response or make follow-up request
                    print(f"[!] Potential mass assignment: Field '{field}' may be assignable")
                    self.vulnerabilities.append(f"Mass assignment: Field '{field}' may be assignable")
                    vulnerable = True
            except Exception as e:
                print(f"[-] Error testing {field}: {e}")
        
        return vulnerable
    
    def test_nested_assignment(self, endpoint: str, base_data: Dict) -> bool:
        """Test for nested object mass assignment"""
        print(f"[*] Testing nested mass assignment on {endpoint}...")
        
        # Try nested object assignment
        test_data = base_data.copy()
        test_data['user'] = {
            'is_admin': True,
            'role': 'administrator',
            'permissions': ['all']
        }
        
        try:
            response = requests.post(
                f"{self.base_url}{endpoint}",
                json=test_data,
                timeout=10
            )
            
            if response.status_code == 200:
                print("[!] Nested mass assignment may be possible!")
                self.vulnerabilities.append("Nested mass assignment: Nested objects may be assignable")
                return True
        except:
            pass
        
        return False
    
    def test_array_assignment(self, endpoint: str, base_data: Dict) -> bool:
        """Test for array mass assignment"""
        print(f"[*] Testing array mass assignment on {endpoint}...")
        
        test_data = base_data.copy()
        test_data['roles'] = ['user', 'admin', 'super_admin']
        test_data['permissions'] = ['read', 'write', 'delete', 'admin']
        
        try:
            response = requests.post(
                f"{self.base_url}{endpoint}",
                json=test_data,
                timeout=10
            )
            
            if response.status_code == 200:
                print("[!] Array mass assignment may be possible!")
                self.vulnerabilities.append("Array mass assignment: Arrays may be assignable")
                return True
        except:
            pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate mass assignment test report"""
        report = f"# Mass Assignment Vulnerability Test Report\n\n"
        report += f"**Target**: {self.base_url}\n\n"
        
        if self.vulnerabilities:
            report += "## Vulnerabilities Found\n\n"
            report += "⚠️ **WARNING**: Mass assignment vulnerabilities detected!\n\n"
            for i, vuln in enumerate(self.vulnerabilities, 1):
                report += f"{i}. {vuln}\n"
            report += "\n"
        else:
            report += "✅ No obvious mass assignment vulnerabilities detected.\n\n"
        
        report += "## Common Mass Assignment Vulnerabilities\n\n"
        report += "1. **Direct Field Assignment**: Assigning protected fields directly\n"
        report += "2. **Nested Object Assignment**: Assigning nested objects with protected fields\n"
        report += "3. **Array Assignment**: Assigning arrays that modify permissions/roles\n"
        report += "4. **Hidden Field Assignment**: Assigning fields not in the form\n\n"
        
        report += "## Examples of Vulnerable Code\n\n"
        report += "```python\n"
        report += "# Vulnerable - accepts all fields\n"
        report += "user = User(**request.json)\n\n"
        report += "# Safe - whitelist approach\n"
        report += "allowed = ['name', 'email', 'password']\n"
        report += "user_data = {k: v for k, v in request.json.items() if k in allowed}\n"
        report += "user = User(**user_data)\n"
        report += "```\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use whitelist approach for allowed fields\n"
        report += "2. Explicitly define which fields can be assigned\n"
        report += "3. Use DTOs (Data Transfer Objects) with validation\n"
        report += "4. Implement field-level access controls\n"
        report += "5. Log all mass assignment attempts\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python mass_assignment_tester.py <base_url>")
        print("Example: python mass_assignment_tester.py http://example.com")
        sys.exit(1)
    
    base_url = sys.argv[1]
    
    tester = MassAssignmentTester(base_url)
    
    # Example test case
    # tester.test_mass_assignment("/api/users", {"name": "test", "email": "test@example.com"})
    
    report = tester.generate_report()
    
    filename = "mass_assignment_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Mass assignment testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

