#!/usr/bin/env python3
"""
IDOR (Insecure Direct Object Reference) / BOLA Tester
Tests for broken object level authorization vulnerabilities.
"""

import requests
import sys
from typing import List, Dict, Optional

class IDORTester:
    def __init__(self, base_url: str):
        self.base_url = base_url
        self.session = requests.Session()
        self.vulnerabilities = []
    
    def test_sequential_ids(self, endpoint: str, param_name: str, start_id: int = 1, 
                           end_id: int = 100, auth_token: str = None) -> List[Dict]:
        """Test sequential ID enumeration"""
        print(f"[*] Testing sequential ID enumeration on {endpoint}")
        print(f"[*] Testing IDs from {start_id} to {end_id}")
        
        vulnerable_ids = []
        headers = {}
        if auth_token:
            headers['Authorization'] = f'Bearer {auth_token}'
        
        for test_id in range(start_id, end_id + 1):
            try:
                # Test with different ID
                test_url = endpoint.replace(param_name, str(test_id))
                response = self.session.get(test_url, headers=headers, timeout=5)
                
                # Check if we got valid data (not 404, not access denied)
                if response.status_code == 200:
                    # Check if response contains actual data
                    if len(response.text) > 100:  # Arbitrary threshold
                        print(f"[+] Found accessible resource with ID: {test_id}")
                        vulnerable_ids.append({
                            'id': test_id,
                            'url': test_url,
                            'status_code': response.status_code,
                            'response_length': len(response.text)
                        })
            except Exception as e:
                pass
        
        return vulnerable_ids
    
    def test_uuid_enumeration(self, endpoint: str, param_name: str, 
                              uuid_list: List[str], auth_token: str = None) -> List[Dict]:
        """Test UUID/GUID enumeration"""
        print(f"[*] Testing UUID enumeration on {endpoint}")
        
        vulnerable_uuids = []
        headers = {}
        if auth_token:
            headers['Authorization'] = f'Bearer {auth_token}'
        
        for uuid in uuid_list:
            try:
                test_url = endpoint.replace(param_name, uuid)
                response = self.session.get(test_url, headers=headers, timeout=5)
                
                if response.status_code == 200:
                    print(f"[+] Found accessible resource with UUID: {uuid}")
                    vulnerable_uuids.append({
                        'uuid': uuid,
                        'url': test_url,
                        'status_code': response.status_code
                    })
            except:
                pass
        
        return vulnerable_uuids
    
    def test_horizontal_privilege_escalation(self, endpoint: str, param_name: str,
                                            user1_id: str, user2_id: str,
                                            user1_token: str) -> bool:
        """Test horizontal privilege escalation (accessing another user's data)"""
        print(f"[*] Testing horizontal privilege escalation")
        
        headers = {'Authorization': f'Bearer {user1_token}'}
        
        # Try to access user2's resource with user1's token
        test_url = endpoint.replace(param_name, user2_id)
        try:
            response = self.session.get(test_url, headers=headers, timeout=5)
            
            if response.status_code == 200:
                print(f"[+] VULNERABLE: Can access user {user2_id}'s data with user {user1_id}'s token")
                return True
            elif response.status_code == 403:
                print(f"[-] Protected: Cannot access user {user2_id}'s data (403 Forbidden)")
                return False
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return False
    
    def test_vertical_privilege_escalation(self, endpoint: str, param_name: str,
                                         admin_id: str, user_token: str) -> bool:
        """Test vertical privilege escalation (user accessing admin functions)"""
        print(f"[*] Testing vertical privilege escalation")
        
        headers = {'Authorization': f'Bearer {user_token}'}
        
        # Try to access admin resource with user token
        test_url = endpoint.replace(param_name, admin_id)
        try:
            response = self.session.get(test_url, headers=headers, timeout=5)
            
            if response.status_code == 200:
                print(f"[+] VULNERABLE: User can access admin resource {admin_id}")
                return True
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return False
    
    def test_parameter_tampering(self, endpoint: str, params: Dict, 
                                auth_token: str = None) -> bool:
        """Test parameter tampering"""
        print(f"[*] Testing parameter tampering")
        
        headers = {}
        if auth_token:
            headers['Authorization'] = f'Bearer {auth_token}'
        
        # Try modifying parameters
        modified_params = params.copy()
        for key, value in params.items():
            # Try different values
            test_values = [
                value + 1 if isinstance(value, int) else value,
                value - 1 if isinstance(value, int) else value,
                'admin',
                '1',
                '0'
            ]
            
            for test_value in test_values:
                modified_params[key] = test_value
                try:
                    response = self.session.get(endpoint, params=modified_params, 
                                               headers=headers, timeout=5)
                    if response.status_code == 200 and len(response.text) > 100:
                        print(f"[+] Parameter tampering successful: {key} = {test_value}")
                        return True
                except:
                    pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate IDOR test report"""
        report = "# IDOR / BOLA Test Report\n\n"
        report += f"**Target**: {self.base_url}\n\n"
        report += "## Summary\n\n"
        report += f"Total Vulnerabilities Found: {len(self.vulnerabilities)}\n\n"
        
        report += "## Vulnerabilities\n\n"
        for vuln in self.vulnerabilities:
            report += f"### {vuln.get('type', 'Unknown')}\n\n"
            report += f"- **Endpoint**: {vuln.get('endpoint', 'N/A')}\n"
            report += f"- **Parameter**: {vuln.get('parameter', 'N/A')}\n"
            report += f"- **Description**: {vuln.get('description', 'N/A')}\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python idor_tester.py <base_url>")
        print("Example: python idor_tester.py http://example.com/api/users")
        sys.exit(1)
    
    base_url = sys.argv[1]
    tester = IDORTester(base_url)
    
    # Example: Test sequential ID enumeration
    endpoint = f"{base_url}/{{id}}"
    results = tester.test_sequential_ids(endpoint, "{id}", 1, 10)
    
    if results:
        print(f"\n[+] Found {len(results)} accessible resources")
        for result in results:
            print(f"    ID {result['id']}: {result['url']}")
    
    # Generate report
    report = tester.generate_report()
    with open('idor_test_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Report saved to idor_test_report.md")
    print(f"[!] WARNING: Only test on systems you own or have permission to test!")

if __name__ == '__main__':
    main()

