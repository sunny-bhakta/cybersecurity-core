#!/usr/bin/env python3
"""
CSRF (Cross-Site Request Forgery) Tester
Tests for CSRF vulnerabilities.
"""

import sys
import requests
from typing import Dict

class CSRFTester:
    def __init__(self, url: str):
        self.url = url
        self.vulnerable = False
        self.csrf_tokens = []
    
    def check_csrf_protection(self) -> Dict:
        """Check for CSRF protection mechanisms"""
        print(f"[*] Checking CSRF protection for {self.url}...")
        
        protection = {
            'csrf_token': False,
            'same_site_cookie': False,
            'referer_check': False,
            'custom_header': False
        }
        
        try:
            response = requests.get(self.url, timeout=10)
            
            # Check for CSRF token in form
            if 'csrf' in response.text.lower() or 'token' in response.text.lower():
                protection['csrf_token'] = True
            
            # Check cookies
            for cookie in response.cookies:
                if 'SameSite' in str(cookie):
                    protection['same_site_cookie'] = True
            
            # Check for custom headers
            if 'X-CSRF-Token' in response.headers or 'X-Requested-With' in response.headers:
                protection['custom_header'] = True
            
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return protection
    
    def test_csrf(self, action_url: str, params: Dict) -> bool:
        """Test for CSRF vulnerability"""
        print(f"[*] Testing CSRF on {action_url}...")
        
        try:
            # Attempt request without CSRF token
            response = requests.post(action_url, data=params, timeout=10)
            
            # If request succeeds, might be vulnerable
            if response.status_code == 200:
                print("[+] Potential CSRF vulnerability - request succeeded without token")
                self.vulnerable = True
                return True
        except:
            pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate CSRF test report"""
        protection = self.check_csrf_protection()
        
        report = f"# CSRF Test Report for {self.url}\n\n"
        report += "## CSRF Protection Status\n\n"
        
        report += f"- **CSRF Token**: {'✅ Found' if protection['csrf_token'] else '❌ Not found'}\n"
        report += f"- **SameSite Cookie**: {'✅ Found' if protection['same_site_cookie'] else '❌ Not found'}\n"
        report += f"- **Custom Header**: {'✅ Found' if protection['custom_header'] else '❌ Not found'}\n\n"
        
        if self.vulnerable or not any(protection.values()):
            report += "⚠️ **WARNING**: Application may be vulnerable to CSRF attacks!\n\n"
        else:
            report += "✅ CSRF protection mechanisms detected.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Implement CSRF tokens for state-changing operations\n"
        report += "2. Use SameSite cookie attribute\n"
        report += "3. Verify Origin/Referer headers\n"
        report += "4. Use custom headers (X-Requested-With)\n"
        report += "5. Implement double-submit cookie pattern\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python csrf_tester.py <url>")
        print("Example: python csrf_tester.py http://example.com/change-password")
        sys.exit(1)
    
    url = sys.argv[1]
    tester = CSRFTester(url)
    
    tester.check_csrf_protection()
    
    report = tester.generate_report()
    
    filename = "csrf_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] CSRF testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

