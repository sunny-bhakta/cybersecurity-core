#!/usr/bin/env python3
"""
JWT (JSON Web Token) Vulnerability Tester
Tests for JWT security vulnerabilities.
"""

import sys
import base64
import json
from typing import Dict

class JWTTester:
    def __init__(self, token: str):
        self.token = token
        self.vulnerabilities = []
    
    def decode_token(self) -> Dict:
        """Decode JWT token"""
        try:
            parts = self.token.split('.')
            if len(parts) != 3:
                return {}
            
            header = json.loads(base64.urlsafe_b64decode(parts[0] + '=='))
            payload = json.loads(base64.urlsafe_b64decode(parts[1] + '=='))
            
            return {
                'header': header,
                'payload': payload,
                'signature': parts[2]
            }
        except:
            return {}
    
    def check_algorithm_confusion(self) -> bool:
        """Check for algorithm confusion (none algorithm)"""
        decoded = self.decode_token()
        
        if decoded and decoded['header'].get('alg') == 'none':
            print("[+] Algorithm confusion vulnerability: 'none' algorithm detected!")
            self.vulnerabilities.append('Algorithm confusion (none)')
            return True
        
        return False
    
    def check_weak_secret(self) -> bool:
        """Check for weak secrets"""
        common_secrets = ['secret', 'password', '123456', 'admin', 'key']
        
        # In real implementation, would try to verify with common secrets
        # This is simplified
        return False
    
    def check_expiration(self) -> bool:
        """Check if token has expiration"""
        decoded = self.decode_token()
        
        if decoded and 'exp' not in decoded['payload']:
            print("[+] Token has no expiration!")
            self.vulnerabilities.append('No expiration')
            return True
        
        return False
    
    def test_algorithm_none(self) -> str:
        """Create token with 'none' algorithm"""
        decoded = self.decode_token()
        
        if decoded:
            # Modify header to use 'none'
            header = {'alg': 'none', 'typ': 'JWT'}
            payload = decoded['payload']
            
            # Encode
            header_b64 = base64.urlsafe_b64encode(json.dumps(header).encode()).decode().rstrip('=')
            payload_b64 = base64.urlsafe_b64encode(json.dumps(payload).encode()).decode().rstrip('=')
            
            # Token with none algorithm (no signature)
            return f"{header_b64}.{payload_b64}."
        
        return None
    
    def generate_report(self) -> str:
        """Generate JWT test report"""
        decoded = self.decode_token()
        
        report = "# JWT Vulnerability Test Report\n\n"
        
        if decoded:
            report += "## Token Information\n\n"
            report += "### Header\n\n"
            report += f"```json\n{json.dumps(decoded['header'], indent=2)}\n```\n\n"
            report += "### Payload\n\n"
            report += f"```json\n{json.dumps(decoded['payload'], indent=2)}\n```\n\n"
        
        # Run checks
        self.check_algorithm_confusion()
        self.check_expiration()
        
        if self.vulnerabilities:
            report += "## Vulnerabilities Found\n\n"
            for vuln in self.vulnerabilities:
                report += f"⚠️ {vuln}\n"
            report += "\n"
        else:
            report += "✅ No obvious vulnerabilities detected.\n\n"
        
        report += "## Common JWT Vulnerabilities\n\n"
        report += "1. **Algorithm Confusion**: Using 'none' algorithm\n"
        report += "2. **Weak Secrets**: Predictable signing keys\n"
        report += "3. **No Expiration**: Tokens that never expire\n"
        report += "4. **Sensitive Data**: Storing sensitive info in payload\n"
        report += "5. **Key Confusion**: HS256 vs RS256 confusion\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use strong, random secrets\n"
        report += "2. Always set expiration (exp claim)\n"
        report += "3. Don't store sensitive data in payload\n"
        report += "4. Validate algorithm in header\n"
        report += "5. Use RS256 for asymmetric signing\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python jwt_tester.py <jwt_token>")
        print("Example: python jwt_tester.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...")
        sys.exit(1)
    
    token = sys.argv[1]
    
    tester = JWTTester(token)
    
    report = tester.generate_report()
    
    filename = "jwt_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] JWT testing complete")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()


