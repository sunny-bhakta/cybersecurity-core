#!/usr/bin/env python3
"""
Race Condition Tester
Tests for race condition vulnerabilities (TOCTOU).
"""

import sys
import requests
import threading
from typing import List

class RaceConditionTester:
    def __init__(self, url: str):
        self.url = url
        self.success_count = 0
        self.total_requests = 0
    
    def send_request(self, data: dict, num_requests: int = 10):
        """Send multiple concurrent requests"""
        def make_request():
            try:
                response = requests.post(self.url, data=data, timeout=10)
                self.total_requests += 1
                if response.status_code == 200:
                    self.success_count += 1
            except:
                self.total_requests += 1
        
        threads = []
        for _ in range(num_requests):
            thread = threading.Thread(target=make_request)
            threads.append(thread)
            thread.start()
        
        for thread in threads:
            thread.join()
    
    def test_race_condition(self, data: dict, num_requests: int = 10) -> bool:
        """Test for race condition vulnerability"""
        print(f"[*] Testing race condition with {num_requests} concurrent requests...")
        
        self.success_count = 0
        self.total_requests = 0
        
        self.send_request(data, num_requests)
        
        print(f"[+] Sent {self.total_requests} requests, {self.success_count} succeeded")
        
        # If multiple requests succeeded, might indicate race condition
        if self.success_count > 1:
            print(f"[+] Potential race condition detected!")
            return True
        
        return False
    
    def generate_report(self) -> str:
        """Generate race condition test report"""
        report = f"# Race Condition Test Report for {self.url}\n\n"
        report += "## Test Results\n\n"
        report += f"Total Requests: {self.total_requests}\n"
        report += f"Successful Requests: {self.success_count}\n\n"
        
        if self.success_count > 1:
            report += "⚠️ **WARNING**: Potential race condition vulnerability detected!\n"
            report += "Multiple concurrent requests succeeded, indicating possible TOCTOU issue.\n\n"
        else:
            report += "✅ No race condition detected in this test.\n\n"
        
        report += "## Common Race Condition Scenarios\n\n"
        report += "1. **Double Spending**: Multiple transactions processed\n"
        report += "2. **Account Creation**: Multiple accounts with same email\n"
        report += "3. **Inventory Management**: Overselling products\n"
        report += "4. **Vote Manipulation**: Multiple votes counted\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use database transactions with proper locking\n"
        report += "2. Implement atomic operations\n"
        report += "3. Use optimistic/pessimistic locking\n"
        report += "4. Add rate limiting\n"
        report += "5. Implement idempotency keys\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python race_condition_tester.py <url> [num_requests]")
        print("Example: python race_condition_tester.py http://example.com/api/purchase 20")
        sys.exit(1)
    
    url = sys.argv[1]
    num_requests = int(sys.argv[2]) if len(sys.argv) > 2 else 10
    
    tester = RaceConditionTester(url)
    
    # Example data - should be customized per application
    test_data = {'action': 'purchase', 'item_id': '123'}
    
    tester.test_race_condition(test_data, num_requests)
    
    report = tester.generate_report()
    
    filename = "race_condition_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Race condition testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

