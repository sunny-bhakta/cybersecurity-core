#!/usr/bin/env python3
"""
iOS IPA Analyzer
Analyzes iOS IPA files for security vulnerabilities.
"""

import sys
import zipfile
import json
import os
from typing import Dict, List

class iOSIPAAnalyzer:
    def __init__(self, ipa_path: str):
        self.ipa_path = ipa_path
        self.findings = []
    
    def extract_ipa(self, extract_path: str = 'ipa_extracted') -> bool:
        """Extract IPA file contents"""
        try:
            if os.path.exists(extract_path):
                import shutil
                shutil.rmtree(extract_path)
            
            os.makedirs(extract_path, exist_ok=True)
            
            with zipfile.ZipFile(self.ipa_path, 'r') as zip_ref:
                zip_ref.extractall(extract_path)
            
            print(f"[+] IPA extracted to {extract_path}")
            return True
        except Exception as e:
            print(f"[-] Error extracting IPA: {e}")
            return False
    
    def analyze_info_plist(self, extract_path: str = 'ipa_extracted') -> Dict:
        """Analyze Info.plist for security issues"""
        print("[*] Analyzing Info.plist...")
        
        # Find Info.plist in Payload
        payload_path = os.path.join(extract_path, 'Payload')
        if not os.path.exists(payload_path):
            print("[-] Payload directory not found")
            return {}
        
        app_dirs = [d for d in os.listdir(payload_path) if d.endswith('.app')]
        if not app_dirs:
            print("[-] App directory not found")
            return {}
        
        app_path = os.path.join(payload_path, app_dirs[0])
        plist_path = os.path.join(app_path, 'Info.plist')
        
        if not os.path.exists(plist_path):
            print("[-] Info.plist not found")
            return {}
        
        findings = {
            'permissions': [],
            'security_issues': []
        }
        
        try:
            # In real implementation, would use plistlib or biplist
            # This is a simplified example
            with open(plist_path, 'rb') as f:
                content = f.read()
            
            # Check for common security issues
            if b'NSAllowsArbitraryLoads' in content or b'NSAppTransportSecurity' in content:
                findings['security_issues'].append('App Transport Security may be disabled')
                self.findings.append({
                    'severity': 'High',
                    'issue': 'App Transport Security',
                    'description': 'App may allow insecure network connections'
                })
        except Exception as e:
            print(f"[-] Error analyzing Info.plist: {e}")
        
        return findings
    
    def check_keychain_access(self, extract_path: str = 'ipa_extracted') -> List[str]:
        """Check for keychain access patterns"""
        print("[*] Checking keychain access...")
        
        issues = []
        
        # In real implementation, would analyze binary for keychain API calls
        print("[!] Note: Real implementation requires binary analysis")
        
        return issues
    
    def analyze_all(self) -> Dict:
        """Perform complete IPA analysis"""
        print(f"[*] Analyzing IPA: {self.ipa_path}\n")
        
        if not os.path.exists(self.ipa_path):
            print(f"[-] IPA file not found: {self.ipa_path}")
            return {}
        
        extract_path = 'ipa_extracted'
        if not self.extract_ipa(extract_path):
            return {}
        
        self.analyze_info_plist(extract_path)
        self.check_keychain_access(extract_path)
        
        return {
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate IPA analysis report"""
        report = f"# iOS IPA Security Analysis Report\n\n"
        report += f"**IPA File**: {os.path.basename(self.ipa_path)}\n\n"
        report += f"## Summary\n\n"
        report += f"Total Findings: {len(self.findings)}\n\n"
        
        if self.findings:
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                report += "---\n\n"
        else:
            report += "No security issues found.\n\n"
        
        report += "## iOS Security Best Practices\n\n"
        report += "1. Enable App Transport Security\n"
        report += "2. Use secure keychain storage\n"
        report += "3. Implement certificate pinning\n"
        report += "4. Disable debug builds in production\n"
        report += "5. Use code obfuscation\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python ios_ipa_analyzer.py <ipa_file>")
        print("Example: python ios_ipa_analyzer.py app.ipa")
        sys.exit(1)
    
    ipa_path = sys.argv[1]
    
    analyzer = iOSIPAAnalyzer(ipa_path)
    analyzer.analyze_all()
    
    report = analyzer.generate_report()
    
    filename = f"ipa_analysis_{os.path.basename(ipa_path).replace('.ipa', '')}.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] IPA analysis complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

