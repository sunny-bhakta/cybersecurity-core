#!/usr/bin/env node
/**
 * iOS IPA Analyzer
 * Analyzes iOS IPA files for security vulnerabilities.
 */

const fs = require('fs');
const AdmZip = require('adm-zip');
const path = require('path');

class iOSIPAAnalyzer {
    constructor(ipaPath) {
        this.ipaPath = ipaPath;
        this.findings = [];
    }

    extractIPA(extractPath = 'ipa_extracted') {
        try {
            if (fs.existsSync(extractPath)) {
                fs.rmSync(extractPath, { recursive: true, force: true });
            }
            
            fs.mkdirSync(extractPath, { recursive: true });
            
            const zip = new AdmZip(this.ipaPath);
            zip.extractAllTo(extractPath, true);
            
            console.log(`[+] IPA extracted to ${extractPath}`);
            return true;
        } catch (err) {
            console.log(`[-] Error extracting IPA: ${err.message}`);
            return false;
        }
    }

    analyzeInfoPlist(extractPath = 'ipa_extracted') {
        console.log('[*] Analyzing Info.plist...');
        
        const payloadPath = path.join(extractPath, 'Payload');
        if (!fs.existsSync(payloadPath)) {
            console.log('[-] Payload directory not found');
            return {};
        }
        
        const appDirs = fs.readdirSync(payloadPath).filter(d => d.endsWith('.app'));
        if (appDirs.length === 0) {
            console.log('[-] App directory not found');
            return {};
        }
        
        const appPath = path.join(payloadPath, appDirs[0]);
        const plistPath = path.join(appPath, 'Info.plist');
        
        if (!fs.existsSync(plistPath)) {
            console.log('[-] Info.plist not found');
            return {};
        }
        
        const findings = {
            permissions: [],
            securityIssues: []
        };
        
        try {
            const content = fs.readFileSync(plistPath);
            
            if (content.includes('NSAllowsArbitraryLoads') || content.includes('NSAppTransportSecurity')) {
                findings.securityIssues.push('App Transport Security may be disabled');
                this.findings.push({
                    severity: 'High',
                    issue: 'App Transport Security',
                    description: 'App may allow insecure network connections'
                });
            }
        } catch (err) {
            console.log(`[-] Error analyzing Info.plist: ${err.message}`);
        }
        
        return findings;
    }

    analyzeAll() {
        console.log(`[*] Analyzing IPA: ${this.ipaPath}\n`);
        
        if (!fs.existsSync(this.ipaPath)) {
            console.log(`[-] IPA file not found: ${this.ipaPath}`);
            return {};
        }
        
        const extractPath = 'ipa_extracted';
        if (!this.extractIPA(extractPath)) {
            return {};
        }
        
        this.analyzeInfoPlist(extractPath);
        
        return {
            findings: this.findings
        };
    }

    generateReport() {
        let report = `# iOS IPA Security Analysis Report\n\n`;
        report += `**IPA File**: ${path.basename(this.ipaPath)}\n\n`;
        report += `## Summary\n\n`;
        report += `Total Findings: ${this.findings.length}\n\n`;
        
        if (this.findings.length > 0) {
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                report += `---\n\n`;
            });
        } else {
            report += `No security issues found.\n\n`;
        }
        
        report += `## iOS Security Best Practices\n\n`;
        report += `1. Enable App Transport Security\n`;
        report += `2. Use secure keychain storage\n`;
        report += `3. Implement certificate pinning\n`;
        report += `4. Disable debug builds in production\n`;
        report += `5. Use code obfuscation\n\n`;
        
        return report;
    }
}

function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node ios_ipa_analyzer.js <ipa_file>');
        console.log('Example: node ios_ipa_analyzer.js app.ipa');
        process.exit(1);
    }
    
    const ipaPath = process.argv[2];
    
    const analyzer = new iOSIPAAnalyzer(ipaPath);
    analyzer.analyzeAll();
    
    const report = analyzer.generateReport();
    
    const filename = `ipa_analysis_${path.basename(ipaPath).replace('.ipa', '')}.md`;
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] IPA analysis complete`);
    console.log(`[+] Report saved to ${filename}`);
}

if (require.main === module) {
    main();
}

module.exports = iOSIPAAnalyzer;

