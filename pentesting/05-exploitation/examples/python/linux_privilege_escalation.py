#!/usr/bin/env python3
"""
Linux Privilege Escalation Checker
Checks for common Linux privilege escalation vectors.
"""

import sys
import os
import subprocess
from typing import List, Dict

class LinuxPrivEsc:
    def __init__(self):
        self.findings = []
    
    def check_suid_binaries(self) -> List[str]:
        """Check for SUID binaries"""
        print("[*] Checking for SUID binaries...")
        suid_binaries = []
        
        try:
            result = subprocess.run(
                ['find', '/usr', '/bin', '-perm', '-4000', '2>/dev/null'],
                shell=True,
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                binaries = result.stdout.strip().split('\n')
                suid_binaries = [b for b in binaries if b]
        except:
            pass
        
        return suid_binaries
    
    def check_sudo_permissions(self) -> Dict:
        """Check sudo permissions"""
        print("[*] Checking sudo permissions...")
        
        sudo_info = {
            'can_sudo': False,
            'commands': []
        }
        
        try:
            result = subprocess.run(
                ['sudo', '-l'],
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode == 0:
                sudo_info['can_sudo'] = True
                sudo_info['commands'] = result.stdout.split('\n')
        except:
            pass
        
        return sudo_info
    
    def check_writable_files(self) -> List[str]:
        """Check for writable files in sensitive locations"""
        print("[*] Checking for writable files...")
        writable = []
        
        sensitive_paths = [
            '/etc/passwd',
            '/etc/shadow',
            '/etc/crontab',
            '/etc/cron.d/',
            '/var/spool/cron/'
        ]
        
        for path in sensitive_paths:
            if os.path.exists(path):
                if os.access(path, os.W_OK):
                    writable.append(path)
        
        return writable
    
    def check_cron_jobs(self) -> List[Dict]:
        """Check for cron jobs"""
        print("[*] Checking cron jobs...")
        cron_jobs = []
        
        cron_files = [
            '/etc/crontab',
            '/etc/cron.d/',
            '/var/spool/cron/crontabs/'
        ]
        
        for cron_file in cron_files:
            if os.path.exists(cron_file):
                try:
                    with open(cron_file, 'r') as f:
                        content = f.read()
                        cron_jobs.append({
                            'file': cron_file,
                            'content': content
                        })
                except:
                    pass
        
        return cron_jobs
    
    def check_capabilities(self) -> List[str]:
        """Check Linux capabilities"""
        print("[*] Checking Linux capabilities...")
        capabilities = []
        
        try:
            result = subprocess.run(
                ['getcap', '-r', '/'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                capabilities = result.stdout.strip().split('\n')
        except:
            pass
        
        return capabilities
    
    def generate_report(self) -> str:
        """Generate privilege escalation report"""
        report = "# Linux Privilege Escalation Check Report\n\n"
        
        # Check SUID binaries
        suid = self.check_suid_binaries()
        if suid:
            report += "## SUID Binaries Found\n\n"
            for binary in suid[:10]:  # Limit to first 10
                report += f"- {binary}\n"
            report += "\n"
        
        # Check sudo
        sudo = self.check_sudo_permissions()
        if sudo['can_sudo']:
            report += "## Sudo Permissions\n\n"
            report += "⚠️ User can use sudo!\n\n"
            if sudo['commands']:
                report += "**Allowed commands**:\n"
                for cmd in sudo['commands'][:5]:
                    report += f"- {cmd}\n"
                report += "\n"
        
        # Check writable files
        writable = self.check_writable_files()
        if writable:
            report += "## Writable Sensitive Files\n\n"
            report += "⚠️ **WARNING**: Writable sensitive files found!\n\n"
            for file in writable:
                report += f"- {file}\n"
            report += "\n"
        
        # Check cron jobs
        cron = self.check_cron_jobs()
        if cron:
            report += "## Cron Jobs Found\n\n"
            for job in cron:
                report += f"**File**: {job['file']}\n\n"
            report += "\n"
        
        # Check capabilities
        caps = self.check_capabilities()
        if caps:
            report += "## Linux Capabilities\n\n"
            for cap in caps[:5]:
                report += f"- {cap}\n"
            report += "\n"
        
        report += "## Common Privilege Escalation Techniques\n\n"
        report += "1. **SUID Binaries**: Exploit misconfigured SUID binaries\n"
        report += "2. **Sudo Misconfigurations**: Abuse sudo permissions\n"
        report += "3. **Cron Jobs**: Exploit writable cron jobs\n"
        report += "4. **Kernel Exploits**: Use kernel vulnerabilities\n"
        report += "5. **PATH Hijacking**: Manipulate PATH variable\n\n"
        
        return report

def main():
    print("Linux Privilege Escalation Checker")
    print("⚠️ WARNING: Only run on systems you own or have permission to test!")
    
    checker = LinuxPrivEsc()
    
    report = checker.generate_report()
    
    filename = "linux_privesc_check.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Privilege escalation check complete")
    print(f"[+] Report saved to {filename}")

if __name__ == '__main__':
    main()


