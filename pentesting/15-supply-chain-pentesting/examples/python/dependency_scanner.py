#!/usr/bin/env python3
"""
Dependency Scanner
Scans project dependencies for known vulnerabilities.
"""

import json
import sys
import os
import subprocess
from typing import List, Dict, Optional
from pathlib import Path

class DependencyScanner:
    def __init__(self, project_path: str = '.'):
        self.project_path = project_path
        self.dependencies = []
        self.vulnerabilities = []
    
    def scan_package_json(self) -> List[Dict]:
        """Scan package.json for dependencies"""
        print("[*] Scanning package.json...")
        
        package_json_path = os.path.join(self.project_path, 'package.json')
        if not os.path.exists(package_json_path):
            return []
        
        try:
            with open(package_json_path, 'r') as f:
                data = json.load(f)
            
            dependencies = []
            
            # Get all dependencies
            deps = data.get('dependencies', {})
            dev_deps = data.get('devDependencies', {})
            
            for name, version in {**deps, **dev_deps}.items():
                dependencies.append({
                    'name': name,
                    'version': version,
                    'type': 'npm',
                    'file': 'package.json'
                })
            
            self.dependencies.extend(dependencies)
            return dependencies
        except Exception as e:
            print(f"[-] Error scanning package.json: {e}")
            return []
    
    def scan_requirements_txt(self) -> List[Dict]:
        """Scan requirements.txt for dependencies"""
        print("[*] Scanning requirements.txt...")
        
        requirements_path = os.path.join(self.project_path, 'requirements.txt')
        if not os.path.exists(requirements_path):
            return []
        
        try:
            dependencies = []
            with open(requirements_path, 'r') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        # Parse package==version
                        if '==' in line:
                            name, version = line.split('==', 1)
                        elif '>=' in line:
                            name, version = line.split('>=', 1)
                        else:
                            name = line
                            version = 'unknown'
                        
                        dependencies.append({
                            'name': name.strip(),
                            'version': version.strip(),
                            'type': 'pip',
                            'file': 'requirements.txt'
                        })
            
            self.dependencies.extend(dependencies)
            return dependencies
        except Exception as e:
            print(f"[-] Error scanning requirements.txt: {e}")
            return []
    
    def scan_pom_xml(self) -> List[Dict]:
        """Scan pom.xml for dependencies"""
        print("[*] Scanning pom.xml...")
        
        pom_path = os.path.join(self.project_path, 'pom.xml')
        if not os.path.exists(pom_path):
            return []
        
        try:
            import xml.etree.ElementTree as ET
            tree = ET.parse(pom_path)
            root = tree.getroot()
            
            dependencies = []
            # Parse Maven dependencies (simplified)
            for dep in root.findall('.//{http://maven.apache.org/POM/4.0.0}dependency'):
                group_id = dep.find('{http://maven.apache.org/POM/4.0.0}groupId')
                artifact_id = dep.find('{http://maven.apache.org/POM/4.0.0}artifactId')
                version = dep.find('{http://maven.apache.org/POM/4.0.0}version')
                
                if group_id is not None and artifact_id is not None:
                    name = f"{group_id.text}:{artifact_id.text}"
                    ver = version.text if version is not None else 'unknown'
                    
                    dependencies.append({
                        'name': name,
                        'version': ver,
                        'type': 'maven',
                        'file': 'pom.xml'
                    })
            
            self.dependencies.extend(dependencies)
            return dependencies
        except Exception as e:
            print(f"[-] Error scanning pom.xml: {e}")
            return []
    
    def check_vulnerabilities(self, dependency: Dict) -> List[Dict]:
        """Check dependency for known vulnerabilities"""
        # In real scenario, query vulnerability databases
        # This is a simplified example
        
        vulnerabilities = []
        
        # Simulate vulnerability check
        known_vulnerable_packages = {
            'lodash': ['4.17.20', '4.17.21'],
            'express': ['4.17.0'],
            'request': ['2.88.0']
        }
        
        name = dependency['name'].split(':')[0] if ':' in dependency['name'] else dependency['name']
        version = dependency['version']
        
        if name.lower() in known_vulnerable_packages:
            vulnerable_versions = known_vulnerable_packages[name.lower()]
            if version in vulnerable_versions:
                vulnerabilities.append({
                    'dependency': dependency['name'],
                    'version': version,
                    'severity': 'High',
                    'issue': 'Known Vulnerability',
                    'description': f'{name} version {version} has known vulnerabilities'
                })
        
        return vulnerabilities
    
    def scan_all(self) -> Dict:
        """Scan all dependency files"""
        print(f"[*] Scanning project: {self.project_path}\n")
        
        self.scan_package_json()
        self.scan_requirements_txt()
        self.scan_pom_xml()
        
        # Check vulnerabilities
        print(f"\n[*] Checking {len(self.dependencies)} dependencies for vulnerabilities...")
        for dep in self.dependencies:
            vulns = self.check_vulnerabilities(dep)
            self.vulnerabilities.extend(vulns)
        
        return {
            'dependencies': self.dependencies,
            'vulnerabilities': self.vulnerabilities
        }
    
    def generate_sbom(self) -> Dict:
        """Generate Software Bill of Materials (SBOM)"""
        sbom = {
            'format': 'SPDX-2.3',
            'name': os.path.basename(self.project_path),
            'packages': []
        }
        
        for dep in self.dependencies:
            sbom['packages'].append({
                'name': dep['name'],
                'version': dep['version'],
                'type': dep['type'],
                'source': dep['file']
            })
        
        return sbom
    
    def generate_report(self) -> str:
        """Generate dependency scan report"""
        report = f"# Dependency Security Scan Report\n\n"
        report += f"**Project**: {self.project_path}\n\n"
        report += f"## Summary\n\n"
        report += f"Total Dependencies: {len(self.dependencies)}\n"
        report += f"Vulnerabilities Found: {len(self.vulnerabilities)}\n\n"
        
        if self.vulnerabilities:
            report += "## Vulnerabilities\n\n"
            for i, vuln in enumerate(self.vulnerabilities, 1):
                report += f"### {i}. {vuln['dependency']}\n\n"
                report += f"**Version**: {vuln['version']}\n\n"
                report += f"**Severity**: {vuln['severity']}\n\n"
                report += f"**Description**: {vuln['description']}\n\n"
                report += "---\n\n"
        else:
            report += "## Vulnerabilities\n\n"
            report += "No known vulnerabilities found.\n\n"
        
        report += "## Dependencies\n\n"
        for dep in self.dependencies:
            report += f"- **{dep['name']}** ({dep['version']}) - {dep['type']} - {dep['file']}\n"
        
        return report

def main():
    project_path = sys.argv[1] if len(sys.argv) > 1 else '.'
    
    scanner = DependencyScanner(project_path)
    results = scanner.scan_all()
    
    # Generate SBOM
    sbom = scanner.generate_sbom()
    with open('sbom.json', 'w') as f:
        json.dump(sbom, f, indent=2)
    print(f"[+] SBOM saved to sbom.json")
    
    # Generate report
    report = scanner.generate_report()
    with open('dependency_scan_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Scan complete. Found {len(scanner.vulnerabilities)} vulnerabilities")
    print(f"[+] Report saved to dependency_scan_report.md")
    print(f"[!] WARNING: Only scan projects you own or have permission to scan!")

if __name__ == '__main__':
    main()

