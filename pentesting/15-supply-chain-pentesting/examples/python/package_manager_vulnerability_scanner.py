#!/usr/bin/env python3
"""
Package Manager Vulnerability Scanner
Scans package manager files for known vulnerabilities.
"""

import sys
import os
import json
import subprocess
from typing import Dict, List

class PackageManagerVulnerabilityScanner:
    def __init__(self, project_path: str = '.'):
        self.project_path = project_path
        self.findings = []
    
    def scan_npm(self) -> Dict:
        """Scan npm package.json for vulnerabilities"""
        print("[*] Scanning npm packages...")
        
        package_json = os.path.join(self.project_path, 'package.json')
        if not os.path.exists(package_json):
            return {}
        
        try:
            # Use npm audit
            result = subprocess.run(
                ['npm', 'audit', '--json'],
                cwd=self.project_path,
                capture_output=True,
                text=True,
                timeout=300
            )
            
            if result.returncode == 0:
                audit_data = json.loads(result.stdout)
                return self.parse_npm_audit(audit_data)
        except FileNotFoundError:
            print("[-] npm not found")
        except Exception as e:
            print(f"[-] Error running npm audit: {e}")
        
        return {}
    
    def parse_npm_audit(self, audit_data: Dict) -> Dict:
        """Parse npm audit results"""
        findings = []
        
        vulnerabilities = audit_data.get('vulnerabilities', {})
        
        for package_name, vuln_data in vulnerabilities.items():
            if isinstance(vuln_data, dict):
                severity = vuln_data.get('severity', 'Unknown')
                via = vuln_data.get('via', [])
                
                for vuln in via:
                    if isinstance(vuln, dict):
                        findings.append({
                            'severity': severity.upper(),
                            'package': package_name,
                            'vulnerability_id': vuln.get('source', 'Unknown'),
                            'title': vuln.get('title', ''),
                            'description': vuln.get('description', ''),
                            'package_manager': 'npm'
                        })
        
        self.findings.extend(findings)
        return {
            'findings': findings,
            'total_vulnerabilities': len(findings)
        }
    
    def scan_pip(self) -> Dict:
        """Scan pip requirements for vulnerabilities"""
        print("[*] Scanning pip packages...")
        
        requirements_files = [
            os.path.join(self.project_path, 'requirements.txt'),
            os.path.join(self.project_path, 'requirements-dev.txt'),
            os.path.join(self.project_path, 'Pipfile'),
            os.path.join(self.project_path, 'pyproject.toml')
        ]
        
        findings = []
        
        for req_file in requirements_files:
            if os.path.exists(req_file):
                try:
                    # Use safety check (if available)
                    result = subprocess.run(
                        ['safety', 'check', '--json', '--file', req_file],
                        capture_output=True,
                        text=True,
                        timeout=300
                    )
                    
                    if result.returncode == 0:
                        safety_data = json.loads(result.stdout)
                        for vuln in safety_data:
                            findings.append({
                                'severity': vuln.get('severity', 'Unknown').upper(),
                                'package': vuln.get('package', 'Unknown'),
                                'vulnerability_id': vuln.get('vulnerability_id', 'Unknown'),
                                'title': vuln.get('advisory', ''),
                                'description': vuln.get('advisory', ''),
                                'package_manager': 'pip'
                            })
                except FileNotFoundError:
                    print("[-] safety not found. Install with: pip install safety")
                except Exception as e:
                    print(f"[-] Error running safety: {e}")
        
        self.findings.extend(findings)
        return {
            'findings': findings,
            'total_vulnerabilities': len(findings)
        }
    
    def scan_maven(self) -> Dict:
        """Scan Maven pom.xml for vulnerabilities"""
        print("[*] Scanning Maven packages...")
        
        pom_xml = os.path.join(self.project_path, 'pom.xml')
        if not os.path.exists(pom_xml):
            return {}
        
        try:
            # Use OWASP Dependency-Check (if available)
            result = subprocess.run(
                ['dependency-check', '--scan', self.project_path, '--format', 'JSON', '--out', '/tmp'],
                capture_output=True,
                text=True,
                timeout=600
            )
            
            # In real implementation, would parse dependency-check results
            print("[!] Note: Real implementation requires OWASP Dependency-Check")
        except FileNotFoundError:
            print("[-] dependency-check not found")
        except Exception as e:
            print(f"[-] Error: {e}")
        
        return {}
    
    def scan_all(self) -> Dict:
        """Scan all package managers"""
        print(f"[*] Scanning package managers in: {self.project_path}\n")
        
        self.scan_npm()
        self.scan_pip()
        self.scan_maven()
        
        return {
            'findings': self.findings,
            'total_vulnerabilities': len(self.findings)
        }
    
    def generate_report(self) -> str:
        """Generate vulnerability scan report"""
        report = f"# Package Manager Vulnerability Scan Report\n\n"
        report += f"**Project Path**: {self.project_path}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Vulnerabilities: {len(self.findings)}\n\n"
            
            # Group by package manager
            by_manager = {}
            for finding in self.findings:
                manager = finding.get('package_manager', 'Unknown')
                if manager not in by_manager:
                    by_manager[manager] = []
                by_manager[manager].append(finding)
            
            for manager, findings in by_manager.items():
                report += f"### {manager.upper()}: {len(findings)} vulnerabilities\n\n"
            
            # Group by severity
            critical = [f for f in self.findings if f['severity'] == 'CRITICAL']
            high = [f for f in self.findings if f['severity'] == 'HIGH']
            medium = [f for f in self.findings if f['severity'] == 'MEDIUM']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings[:50], 1):  # Limit to 50
                report += f"### {i}. {finding['package']} - {finding['vulnerability_id']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Package Manager**: {finding['package_manager']}\n\n"
                report += f"**Title**: {finding['title']}\n\n"
                if finding['description']:
                    report += f"**Description**: {finding['description'][:200]}...\n\n"
                report += "---\n\n"
            
            if len(self.findings) > 50:
                report += f"\n*... and {len(self.findings) - 50} more vulnerabilities*\n\n"
        else:
            report += "âœ… No vulnerabilities found.\n\n"
        
        report += "## Recommendations\n\n"
        report += "1. Update vulnerable packages to patched versions\n"
        report += "2. Use automated dependency scanning in CI/CD\n"
        report += "3. Enable Dependabot or similar tools\n"
        report += "4. Review and test updates before deploying\n"
        report += "5. Use lock files (package-lock.json, Pipfile.lock)\n"
        report += "6. Monitor for new vulnerabilities\n"
        report += "7. Use security advisories from package maintainers\n\n"
        
        return report

def main():
    project_path = sys.argv[1] if len(sys.argv) > 1 else '.'
    
    scanner = PackageManagerVulnerabilityScanner(project_path)
    scanner.scan_all()
    
    report = scanner.generate_report()
    
    filename = "package_manager_vulnerability_scan.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Package manager vulnerability scan complete")
    print(f"[+] Report saved to {filename}")
    print(f"[!] Found {len(scanner.findings)} vulnerabilities")

if __name__ == "__main__":
    main()

