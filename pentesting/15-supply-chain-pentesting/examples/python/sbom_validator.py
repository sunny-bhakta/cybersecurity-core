#!/usr/bin/env python3
"""
SBOM Validator
Validates Software Bill of Materials (SBOM) files.
"""

import sys
import json
import os
from typing import Dict, List

class SBOMValidator:
    def __init__(self, sbom_file: str):
        self.sbom_file = sbom_file
        self.findings = []
    
    def validate_spdx(self, sbom_data: Dict) -> List[Dict]:
        """Validate SPDX format SBOM"""
        print("[*] Validating SPDX format...")
        
        findings = []
        
        # Check required fields
        required_fields = ['spdxVersion', 'dataLicense', 'SPDXID', 'name', 'documentNamespace']
        for field in required_fields:
            if field not in sbom_data:
                findings.append({
                    'severity': 'High',
                    'issue': f'Missing Required Field: {field}',
                    'description': f'SPDX SBOM missing required field: {field}',
                    'format': 'SPDX'
                })
        
        # Check packages
        packages = sbom_data.get('packages', [])
        if not packages:
            findings.append({
                'severity': 'Medium',
                'issue': 'No Packages Listed',
                'description': 'SBOM does not contain any packages',
                'format': 'SPDX'
            })
        
        # Validate package structure
        for i, package in enumerate(packages):
            if 'name' not in package:
                findings.append({
                    'severity': 'High',
                    'issue': f'Package {i+1} Missing Name',
                    'description': 'Package missing required name field',
                    'format': 'SPDX'
                })
            
            if 'versionInfo' not in package:
                findings.append({
                    'severity': 'Medium',
                    'issue': f'Package {i+1} Missing Version',
                    'description': 'Package missing version information',
                    'format': 'SPDX'
                })
        
        return findings
    
    def validate_cyclonedx(self, sbom_data: Dict) -> List[Dict]:
        """Validate CycloneDX format SBOM"""
        print("[*] Validating CycloneDX format...")
        
        findings = []
        
        # Check required fields
        if 'bomFormat' not in sbom_data:
            findings.append({
                'severity': 'High',
                'issue': 'Missing bomFormat',
                'description': 'CycloneDX SBOM missing bomFormat field',
                'format': 'CycloneDX'
            })
        
        if 'specVersion' not in sbom_data:
            findings.append({
                'severity': 'High',
                'issue': 'Missing specVersion',
                'description': 'CycloneDX SBOM missing specVersion field',
                'format': 'CycloneDX'
            })
        
        # Check components
        components = sbom_data.get('components', [])
        if not components:
            findings.append({
                'severity': 'Medium',
                'issue': 'No Components Listed',
                'description': 'SBOM does not contain any components',
                'format': 'CycloneDX'
            })
        
        # Validate component structure
        for i, component in enumerate(components):
            if 'name' not in component:
                findings.append({
                    'severity': 'High',
                    'issue': f'Component {i+1} Missing Name',
                    'description': 'Component missing required name field',
                    'format': 'CycloneDX'
                })
            
            if 'version' not in component:
                findings.append({
                    'severity': 'Medium',
                    'issue': f'Component {i+1} Missing Version',
                    'description': 'Component missing version information',
                    'format': 'CycloneDX'
                })
        
        return findings
    
    def validate(self) -> Dict:
        """Validate SBOM file"""
        print(f"[*] Validating SBOM: {self.sbom_file}\n")
        
        if not os.path.exists(self.sbom_file):
            print(f"[-] SBOM file not found: {self.sbom_file}")
            return {}
        
        try:
            with open(self.sbom_file, 'r') as f:
                sbom_data = json.load(f)
            
            # Detect format
            if 'spdxVersion' in sbom_data:
                self.findings = self.validate_spdx(sbom_data)
                format_type = 'SPDX'
            elif 'bomFormat' in sbom_data:
                self.findings = self.validate_cyclonedx(sbom_data)
                format_type = 'CycloneDX'
            else:
                self.findings.append({
                    'severity': 'High',
                    'issue': 'Unknown SBOM Format',
                    'description': 'SBOM format could not be determined',
                    'format': 'Unknown'
                })
                format_type = 'Unknown'
            
            return {
                'format': format_type,
                'findings': self.findings,
                'valid': len([f for f in self.findings if f['severity'] == 'High']) == 0
            }
        except json.JSONDecodeError as e:
            print(f"[-] Error parsing SBOM JSON: {e}")
            return {}
        except Exception as e:
            print(f"[-] Error validating SBOM: {e}")
            return {}
    
    def generate_report(self) -> str:
        """Generate SBOM validation report"""
        report = f"# SBOM Validation Report\n\n"
        report += f"**SBOM File**: {os.path.basename(self.sbom_file)}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            low = [f for f in self.findings if f['severity'] == 'Low']
            
            if len(high) == 0:
                report += "✅ **SBOM is valid** (no critical issues)\n\n"
            else:
                report += "❌ **SBOM has validation errors**\n\n"
            
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n"
            report += f"- **Low**: {len(low)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                if 'format' in finding:
                    report += f"**Format**: {finding['format']}\n\n"
                report += "---\n\n"
        else:
            report += "✅ SBOM is valid.\n\n"
        
        report += "## SBOM Best Practices\n\n"
        report += "1. Include all dependencies (direct and transitive)\n"
        report += "2. Use standard formats (SPDX, CycloneDX)\n"
        report += "3. Include version information for all components\n"
        report += "4. Include license information\n"
        report += "5. Sign SBOM files for authenticity\n"
        report += "6. Keep SBOMs up to date\n"
        report += "7. Validate SBOMs before distribution\n\n"
        
        return report

def main():
    if len(sys.argv) < 2:
        print("Usage: python sbom_validator.py <sbom_file>")
        print("Example: python sbom_validator.py sbom.json")
        sys.exit(1)
    
    sbom_file = sys.argv[1]
    
    validator = SBOMValidator(sbom_file)
    validator.validate()
    
    report = validator.generate_report()
    
    filename = "sbom_validation_report.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] SBOM validation complete")
    print(f"[+] Report saved to {filename}")
    if validator.findings:
        print(f"[!] Found {len(validator.findings)} validation issues")

if __name__ == "__main__":
    main()

