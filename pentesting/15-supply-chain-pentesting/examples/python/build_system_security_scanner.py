#!/usr/bin/env python3
"""
Build System Security Scanner
Scans build system configurations for security issues.
"""

import sys
import os
import json
import yaml
from typing import Dict, List

class BuildSystemSecurityScanner:
    def __init__(self, project_path: str = '.'):
        self.project_path = project_path
        self.findings = []
    
    def scan_maven(self) -> List[Dict]:
        """Scan Maven build configuration"""
        print("[*] Scanning Maven build configuration...")
        
        findings = []
        pom_xml = os.path.join(self.project_path, 'pom.xml')
        
        if not os.path.exists(pom_xml):
            return findings
        
        try:
            # In real implementation, would parse XML
            with open(pom_xml, 'r') as f:
                content = f.read()
            
            # Check for insecure repositories
            if 'http://' in content and 'repository' in content.lower():
                findings.append({
                    'severity': 'Medium',
                    'issue': 'Insecure Maven Repository',
                    'description': 'Maven uses HTTP instead of HTTPS for repositories',
                    'file': pom_xml
                })
            
            # Check for external repositories
            if 'repository' in content.lower() and 'maven-central' not in content.lower():
                findings.append({
                    'severity': 'Low',
                    'issue': 'External Maven Repository',
                    'description': 'Maven uses external repositories (potential supply chain risk)',
                    'file': pom_xml
                })
        except Exception as e:
            print(f"[-] Error scanning Maven: {e}")
        
        return findings
    
    def scan_gradle(self) -> List[Dict]:
        """Scan Gradle build configuration"""
        print("[*] Scanning Gradle build configuration...")
        
        findings = []
        build_gradle = os.path.join(self.project_path, 'build.gradle')
        build_gradle_kts = os.path.join(self.project_path, 'build.gradle.kts')
        
        gradle_files = [f for f in [build_gradle, build_gradle_kts] if os.path.exists(f)]
        
        for gradle_file in gradle_files:
            try:
                with open(gradle_file, 'r') as f:
                    content = f.read()
                
                # Check for insecure repositories
                if 'http://' in content and 'repositories' in content:
                    findings.append({
                        'severity': 'Medium',
                        'issue': 'Insecure Gradle Repository',
                        'description': 'Gradle uses HTTP instead of HTTPS for repositories',
                        'file': gradle_file
                    })
                
                # Check for allowInsecureProtocol
                if 'allowInsecureProtocol' in content:
                    findings.append({
                        'severity': 'High',
                        'issue': 'Insecure Protocol Allowed',
                        'description': 'Gradle allows insecure protocols',
                        'file': gradle_file
                    })
            except Exception as e:
                print(f"[-] Error scanning Gradle: {e}")
        
        return findings
    
    def scan_dockerfile(self) -> List[Dict]:
        """Scan Dockerfile for build security issues"""
        print("[*] Scanning Dockerfile...")
        
        findings = []
        dockerfile = os.path.join(self.project_path, 'Dockerfile')
        
        if not os.path.exists(dockerfile):
            return findings
        
        try:
            with open(dockerfile, 'r') as f:
                lines = f.readlines()
            
            for i, line in enumerate(lines, 1):
                # Check for root user
                if line.strip().startswith('USER root') or 'USER 0' in line:
                    findings.append({
                        'severity': 'Medium',
                        'issue': 'Running as Root',
                        'description': 'Container runs as root user',
                        'file': dockerfile,
                        'line': i
                    })
                
                # Check for secrets in build
                if 'RUN' in line and ('password' in line.lower() or 'secret' in line.lower()):
                    findings.append({
                        'severity': 'High',
                        'issue': 'Potential Secret in Build',
                        'description': 'Potential secret exposed in Dockerfile',
                        'file': dockerfile,
                        'line': i
                    })
                
                # Check for latest tag
                if 'FROM' in line and ':latest' in line:
                    findings.append({
                        'severity': 'Low',
                        'issue': 'Using Latest Tag',
                        'description': 'Dockerfile uses :latest tag (unpredictable builds)',
                        'file': dockerfile,
                        'line': i
                    })
        except Exception as e:
            print(f"[-] Error scanning Dockerfile: {e}")
        
        return findings
    
    def scan_makefile(self) -> List[Dict]:
        """Scan Makefile for security issues"""
        print("[*] Scanning Makefile...")
        
        findings = []
        makefile = os.path.join(self.project_path, 'Makefile')
        
        if not os.path.exists(makefile):
            return findings
        
        try:
            with open(makefile, 'r') as f:
                content = f.read()
            
            # Check for hardcoded credentials
            if 'password' in content.lower() or 'secret' in content.lower():
                findings.append({
                    'severity': 'High',
                    'issue': 'Potential Hardcoded Credentials',
                    'description': 'Makefile may contain hardcoded credentials',
                    'file': makefile
                })
            
            # Check for unsafe commands
            unsafe_commands = ['rm -rf', 'chmod 777', 'curl | sh', 'wget | sh']
            for cmd in unsafe_commands:
                if cmd in content:
                    findings.append({
                        'severity': 'Medium',
                        'issue': f'Unsafe Command: {cmd}',
                        'description': f'Makefile contains potentially unsafe command: {cmd}',
                        'file': makefile
                    })
        except Exception as e:
            print(f"[-] Error scanning Makefile: {e}")
        
        return findings
    
    def scan_all(self) -> Dict:
        """Scan all build systems"""
        print(f"[*] Scanning build systems in: {self.project_path}\n")
        
        self.findings.extend(self.scan_maven())
        self.findings.extend(self.scan_gradle())
        self.findings.extend(self.scan_dockerfile())
        self.findings.extend(self.scan_makefile())
        
        return {
            'findings': self.findings
        }
    
    def generate_report(self) -> str:
        """Generate build system security scan report"""
        report = f"# Build System Security Scan Report\n\n"
        report += f"**Project Path**: {self.project_path}\n\n"
        
        if self.findings:
            report += f"## Summary\n\n"
            report += f"Total Findings: {len(self.findings)}\n\n"
            
            critical = [f for f in self.findings if f['severity'] == 'Critical']
            high = [f for f in self.findings if f['severity'] == 'High']
            medium = [f for f in self.findings if f['severity'] == 'Medium']
            low = [f for f in self.findings if f['severity'] == 'Low']
            
            report += f"- **Critical**: {len(critical)}\n"
            report += f"- **High**: {len(high)}\n"
            report += f"- **Medium**: {len(medium)}\n"
            report += f"- **Low**: {len(low)}\n\n"
            
            report += "## Findings\n\n"
            for i, finding in enumerate(self.findings, 1):
                report += f"### {i}. {finding['issue']}\n\n"
                report += f"**Severity**: {finding['severity']}\n\n"
                report += f"**Description**: {finding['description']}\n\n"
                report += f"**File**: `{finding['file']}`\n\n"
                if 'line' in finding:
                    report += f"**Line**: {finding['line']}\n\n"
                report += "---\n\n"
        else:
            report += "âœ… No security issues found.\n\n"
        
        report += "## Best Practices\n\n"
        report += "1. Use HTTPS for all repository URLs\n"
        report += "2. Pin dependency versions (avoid latest)\n"
        report += "3. Use signed artifacts and verify signatures\n"
        report += "4. Run builds as non-root user\n"
        report += "5. Don't hardcode secrets in build files\n"
        report += "6. Use build secrets management\n"
        report += "7. Scan dependencies before building\n"
        report += "8. Use reproducible builds\n\n"
        
        return report

def main():
    project_path = sys.argv[1] if len(sys.argv) > 1 else '.'
    
    scanner = BuildSystemSecurityScanner(project_path)
    scanner.scan_all()
    
    report = scanner.generate_report()
    
    filename = "build_system_security_scan.md"
    with open(filename, 'w') as f:
        f.write(report)
    
    print(f"[+] Build system security scan complete")
    print(f"[+] Report saved to {filename}")

if __name__ == "__main__":
    main()

