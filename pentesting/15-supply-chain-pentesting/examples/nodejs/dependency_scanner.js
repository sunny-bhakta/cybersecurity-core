/**
 * Dependency Scanner
 * Scans project dependencies for known vulnerabilities.
 */

const fs = require('fs');
const path = require('path');

class DependencyScanner {
    constructor(projectPath = '.') {
        this.projectPath = projectPath;
        this.dependencies = [];
        this.vulnerabilities = [];
    }

    scanPackageJson() {
        console.log('[*] Scanning package.json...');

        const packageJsonPath = path.join(this.projectPath, 'package.json');
        if (!fs.existsSync(packageJsonPath)) {
            return [];
        }

        try {
            const data = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
            const dependencies = [];

            const deps = data.dependencies || {};
            const devDeps = data.devDependencies || {};

            for (const [name, version] of Object.entries({ ...deps, ...devDeps })) {
                dependencies.push({
                    name: name,
                    version: version,
                    type: 'npm',
                    file: 'package.json'
                });
            }

            this.dependencies.push(...dependencies);
            return dependencies;
        } catch (error) {
            console.log(`[-] Error scanning package.json: ${error.message}`);
            return [];
        }
    }

    scanRequirementsTxt() {
        console.log('[*] Scanning requirements.txt...');

        const requirementsPath = path.join(this.projectPath, 'requirements.txt');
        if (!fs.existsSync(requirementsPath)) {
            return [];
        }

        try {
            const dependencies = [];
            const content = fs.readFileSync(requirementsPath, 'utf8');
            const lines = content.split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('#')) {
                    let name, version;
                    if (trimmed.includes('==')) {
                        [name, version] = trimmed.split('==');
                    } else if (trimmed.includes('>=')) {
                        [name, version] = trimmed.split('>=');
                    } else {
                        name = trimmed;
                        version = 'unknown';
                    }

                    dependencies.push({
                        name: name.trim(),
                        version: version.trim(),
                        type: 'pip',
                        file: 'requirements.txt'
                    });
                }
            }

            this.dependencies.push(...dependencies);
            return dependencies;
        } catch (error) {
            console.log(`[-] Error scanning requirements.txt: ${error.message}`);
            return [];
        }
    }

    checkVulnerabilities(dependency) {
        const vulnerabilities = [];

        const knownVulnerablePackages = {
            'lodash': ['4.17.20', '4.17.21'],
            'express': ['4.17.0'],
            'request': ['2.88.0']
        };

        const name = dependency.name.includes(':') ? dependency.name.split(':')[0] : dependency.name;
        const version = dependency.version;

        if (knownVulnerablePackages[name.toLowerCase()]) {
            const vulnerableVersions = knownVulnerablePackages[name.toLowerCase()];
            if (vulnerableVersions.includes(version)) {
                vulnerabilities.push({
                    dependency: dependency.name,
                    version: version,
                    severity: 'High',
                    issue: 'Known Vulnerability',
                    description: `${name} version ${version} has known vulnerabilities`
                });
            }
        }

        return vulnerabilities;
    }

    scanAll() {
        console.log(`[*] Scanning project: ${this.projectPath}\n`);

        this.scanPackageJson();
        this.scanRequirementsTxt();

        console.log(`\n[*] Checking ${this.dependencies.length} dependencies for vulnerabilities...`);
        for (const dep of this.dependencies) {
            const vulns = this.checkVulnerabilities(dep);
            this.vulnerabilities.push(...vulns);
        }

        return {
            dependencies: this.dependencies,
            vulnerabilities: this.vulnerabilities
        };
    }

    generateSBOM() {
        const sbom = {
            format: 'SPDX-2.3',
            name: path.basename(this.projectPath),
            packages: []
        };

        for (const dep of this.dependencies) {
            sbom.packages.push({
                name: dep.name,
                version: dep.version,
                type: dep.type,
                source: dep.file
            });
        }

        return sbom;
    }

    generateReport() {
        let report = `# Dependency Security Scan Report\n\n`;
        report += `**Project**: ${this.projectPath}\n\n`;
        report += `## Summary\n\n`;
        report += `Total Dependencies: ${this.dependencies.length}\n`;
        report += `Vulnerabilities Found: ${this.vulnerabilities.length}\n\n`;

        if (this.vulnerabilities.length > 0) {
            report += `## Vulnerabilities\n\n`;
            this.vulnerabilities.forEach((vuln, i) => {
                report += `### ${i + 1}. ${vuln.dependency}\n\n`;
                report += `**Version**: ${vuln.version}\n\n`;
                report += `**Severity**: ${vuln.severity}\n\n`;
                report += `**Description**: ${vuln.description}\n\n`;
                report += `---\n\n`;
            });
        } else {
            report += `## Vulnerabilities\n\n`;
            report += `No known vulnerabilities found.\n\n`;
        }

        report += `## Dependencies\n\n`;
        this.dependencies.forEach(dep => {
            report += `- **${dep.name}** (${dep.version}) - ${dep.type} - ${dep.file}\n`;
        });

        return report;
    }
}

function main() {
    const args = process.argv.slice(2);
    const projectPath = args[0] || '.';

    const scanner = new DependencyScanner(projectPath);
    scanner.scanAll();

    const sbom = scanner.generateSBOM();
    fs.writeFileSync('sbom.json', JSON.stringify(sbom, null, 2), 'utf8');
    console.log(`[+] SBOM saved to sbom.json`);

    const report = scanner.generateReport();
    fs.writeFileSync('dependency_scan_report.md', report, 'utf8');

    console.log(`\n[+] Scan complete. Found ${scanner.vulnerabilities.length} vulnerabilities`);
    console.log(`[+] Report saved to dependency_scan_report.md`);
    console.log(`[!] WARNING: Only scan projects you own or have permission to scan!`);
}

if (require.main === module) {
    main();
}

module.exports = DependencyScanner;

