#!/usr/bin/env node
/**
 * SBOM Validator
 * Validates Software Bill of Materials (SBOM) files.
 */

const fs = require('fs');

class SBOMValidator {
    constructor(sbomFile) {
        this.sbomFile = sbomFile;
        this.findings = [];
    }

    validateSpdx(sbomData) {
        console.log('[*] Validating SPDX format...');
        
        const findings = [];
        
        const requiredFields = ['spdxVersion', 'dataLicense', 'SPDXID', 'name', 'documentNamespace'];
        requiredFields.forEach(field => {
            if (!sbomData[field]) {
                findings.push({
                    severity: 'High',
                    issue: `Missing Required Field: ${field}`,
                    description: `SPDX SBOM missing required field: ${field}`,
                    format: 'SPDX'
                });
            }
        });
        
        const packages = sbomData.packages || [];
        if (packages.length === 0) {
            findings.push({
                severity: 'Medium',
                issue: 'No Packages Listed',
                description: 'SBOM does not contain any packages',
                format: 'SPDX'
            });
        }
        
        packages.forEach((package, i) => {
            if (!package.name) {
                findings.push({
                    severity: 'High',
                    issue: `Package ${i + 1} Missing Name`,
                    description: 'Package missing required name field',
                    format: 'SPDX'
                });
            }
            
            if (!package.versionInfo) {
                findings.push({
                    severity: 'Medium',
                    issue: `Package ${i + 1} Missing Version`,
                    description: 'Package missing version information',
                    format: 'SPDX'
                });
            }
        });
        
        return findings;
    }

    validateCycloneDx(sbomData) {
        console.log('[*] Validating CycloneDX format...');
        
        const findings = [];
        
        if (!sbomData.bomFormat) {
            findings.push({
                severity: 'High',
                issue: 'Missing bomFormat',
                description: 'CycloneDX SBOM missing bomFormat field',
                format: 'CycloneDX'
            });
        }
        
        if (!sbomData.specVersion) {
            findings.push({
                severity: 'High',
                issue: 'Missing specVersion',
                description: 'CycloneDX SBOM missing specVersion field',
                format: 'CycloneDX'
            });
        }
        
        const components = sbomData.components || [];
        if (components.length === 0) {
            findings.push({
                severity: 'Medium',
                issue: 'No Components Listed',
                description: 'SBOM does not contain any components',
                format: 'CycloneDX'
            });
        }
        
        components.forEach((component, i) => {
            if (!component.name) {
                findings.push({
                    severity: 'High',
                    issue: `Component ${i + 1} Missing Name`,
                    description: 'Component missing required name field',
                    format: 'CycloneDX'
                });
            }
            
            if (!component.version) {
                findings.push({
                    severity: 'Medium',
                    issue: `Component ${i + 1} Missing Version`,
                    description: 'Component missing version information',
                    format: 'CycloneDX'
                });
            }
        });
        
        return findings;
    }

    validate() {
        console.log(`[*] Validating SBOM: ${this.sbomFile}\n`);
        
        if (!fs.existsSync(this.sbomFile)) {
            console.log(`[-] SBOM file not found: ${this.sbomFile}`);
            return {};
        }
        
        try {
            const sbomData = JSON.parse(fs.readFileSync(this.sbomFile, 'utf8'));
            
            let formatType;
            if (sbomData.spdxVersion) {
                this.findings = this.validateSpdx(sbomData);
                formatType = 'SPDX';
            } else if (sbomData.bomFormat) {
                this.findings = this.validateCycloneDx(sbomData);
                formatType = 'CycloneDX';
            } else {
                this.findings.push({
                    severity: 'High',
                    issue: 'Unknown SBOM Format',
                    description: 'SBOM format could not be determined',
                    format: 'Unknown'
                });
                formatType = 'Unknown';
            }
            
            return {
                format: formatType,
                findings: this.findings,
                valid: this.findings.filter(f => f.severity === 'High').length === 0
            };
        } catch (err) {
            if (err instanceof SyntaxError) {
                console.log(`[-] Error parsing SBOM JSON: ${err.message}`);
            } else {
                console.log(`[-] Error validating SBOM: ${err.message}`);
            }
            return {};
        }
    }

    generateReport() {
        let report = `# SBOM Validation Report\n\n`;
        report += `**SBOM File**: ${require('path').basename(this.sbomFile)}\n\n`;
        
        if (this.findings.length > 0) {
            report += `## Summary\n\n`;
            
            const high = this.findings.filter(f => f.severity === 'High');
            const medium = this.findings.filter(f => f.severity === 'Medium');
            const low = this.findings.filter(f => f.severity === 'Low');
            
            if (high.length === 0) {
                report += `✅ **SBOM is valid** (no critical issues)\n\n`;
            } else {
                report += `❌ **SBOM has validation errors**\n\n`;
            }
            
            report += `- **High**: ${high.length}\n`;
            report += `- **Medium**: ${medium.length}\n`;
            report += `- **Low**: ${low.length}\n\n`;
            
            report += `## Findings\n\n`;
            this.findings.forEach((finding, i) => {
                report += `### ${i + 1}. ${finding.issue}\n\n`;
                report += `**Severity**: ${finding.severity}\n\n`;
                report += `**Description**: ${finding.description}\n\n`;
                if (finding.format) {
                    report += `**Format**: ${finding.format}\n\n`;
                }
                report += `---\n\n`;
            });
        } else {
            report += `✅ SBOM is valid.\n\n`;
        }
        
        report += `## SBOM Best Practices\n\n`;
        report += `1. Include all dependencies (direct and transitive)\n`;
        report += `2. Use standard formats (SPDX, CycloneDX)\n`;
        report += `3. Include version information for all components\n`;
        report += `4. Include license information\n`;
        report += `5. Sign SBOM files for authenticity\n`;
        report += `6. Keep SBOMs up to date\n`;
        report += `7. Validate SBOMs before distribution\n\n`;
        
        return report;
    }
}

function main() {
    if (process.argv.length < 3) {
        console.log('Usage: node sbom_validator.js <sbom_file>');
        console.log('Example: node sbom_validator.js sbom.json');
        process.exit(1);
    }
    
    const sbomFile = process.argv[2];
    
    const validator = new SBOMValidator(sbomFile);
    validator.validate();
    
    const report = validator.generateReport();
    
    const filename = 'sbom_validation_report.md';
    fs.writeFileSync(filename, report, 'utf8');
    
    console.log(`[+] SBOM validation complete`);
    console.log(`[+] Report saved to ${filename}`);
    if (validator.findings.length > 0) {
        console.log(`[!] Found ${validator.findings.length} validation issues`);
    }
}

if (require.main === module) {
    main();
}

module.exports = SBOMValidator;

