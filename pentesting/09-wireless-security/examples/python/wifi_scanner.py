#!/usr/bin/env python3
"""
WiFi Scanner
Scans for wireless networks and analyzes WiFi security.
Note: Requires appropriate permissions and may need root/admin access.
"""

import subprocess
import sys
import re
from typing import List, Dict

class WiFiScanner:
    def __init__(self):
        self.networks = []
        self.interface = None
    
    def get_wifi_interfaces(self) -> List[str]:
        """Get available WiFi interfaces"""
        interfaces = []
        
        try:
            if sys.platform == 'win32':
                # Windows - use netsh
                result = subprocess.run(['netsh', 'wlan', 'show', 'interfaces'],
                                      capture_output=True, text=True)
                for line in result.stdout.split('\n'):
                    if 'Name' in line:
                        interface = line.split(':')[1].strip()
                        interfaces.append(interface)
            else:
                # Linux - use iwconfig or ip
                result = subprocess.run(['iwconfig'], capture_output=True, text=True)
                for line in result.stdout.split('\n'):
                    if 'IEEE 802.11' in line:
                        interface = line.split()[0]
                        interfaces.append(interface)
        except Exception as e:
            print(f"[-] Error getting interfaces: {e}")
        
        return interfaces
    
    def scan_networks(self, interface: str = None) -> List[Dict]:
        """Scan for WiFi networks"""
        print("[*] Scanning for WiFi networks...")
        
        if not interface:
            interfaces = self.get_wifi_interfaces()
            if interfaces:
                interface = interfaces[0]
            else:
                print("[-] No WiFi interface found")
                return []
        
        self.interface = interface
        networks = []
        
        try:
            if sys.platform == 'win32':
                # Windows - use netsh
                result = subprocess.run(['netsh', 'wlan', 'show', 'networks', 'mode=Bssid'],
                                      capture_output=True, text=True)
                networks = self.parse_windows_scan(result.stdout)
            else:
                # Linux - use iwlist or nmcli
                try:
                    result = subprocess.run(['iwlist', interface, 'scan'],
                                          capture_output=True, text=True, timeout=30)
                    networks = self.parse_linux_scan(result.stdout)
                except:
                    # Try nmcli as fallback
                    result = subprocess.run(['nmcli', '-t', '-f', 'SSID,SECURITY,SIGNAL', 'device', 'wifi', 'list'],
                                          capture_output=True, text=True)
                    networks = self.parse_nmcli_scan(result.stdout)
        except Exception as e:
            print(f"[-] Error scanning networks: {e}")
        
        self.networks = networks
        return networks
    
    def parse_windows_scan(self, output: str) -> List[Dict]:
        """Parse Windows netsh scan output"""
        networks = []
        current_network = {}
        
        for line in output.split('\n'):
            line = line.strip()
            if 'SSID' in line and ':' in line:
                if current_network:
                    networks.append(current_network)
                current_network = {'ssid': line.split(':', 1)[1].strip()}
            elif 'Authentication' in line and ':' in line:
                current_network['auth'] = line.split(':', 1)[1].strip()
            elif 'Encryption' in line and ':' in line:
                current_network['encryption'] = line.split(':', 1)[1].strip()
            elif 'Signal' in line and ':' in line:
                current_network['signal'] = line.split(':', 1)[1].strip()
        
        if current_network:
            networks.append(current_network)
        
        return networks
    
    def parse_linux_scan(self, output: str) -> List[Dict]:
        """Parse Linux iwlist scan output"""
        networks = []
        current_network = {}
        
        for line in output.split('\n'):
            line = line.strip()
            if 'ESSID:' in line:
                if current_network:
                    networks.append(current_network)
                ssid = line.split('ESSID:')[1].strip().strip('"')
                current_network = {'ssid': ssid}
            elif 'Encryption key:' in line:
                current_network['encrypted'] = 'on' in line.lower()
            elif 'IE: IEEE 802.11i/WPA2' in line:
                current_network['security'] = 'WPA2'
            elif 'WPA' in line:
                current_network['security'] = 'WPA'
            elif 'Quality=' in line:
                signal_match = re.search(r'Quality=(\d+)/(\d+)', line)
                if signal_match:
                    quality = int(signal_match.group(1))
                    max_quality = int(signal_match.group(2))
                    current_network['signal'] = f"{(quality/max_quality)*100:.0f}%"
        
        if current_network:
            networks.append(current_network)
        
        return networks
    
    def parse_nmcli_scan(self, output: str) -> List[Dict]:
        """Parse nmcli scan output"""
        networks = []
        for line in output.split('\n'):
            if line.strip():
                parts = line.split(':')
                if len(parts) >= 3:
                    networks.append({
                        'ssid': parts[0],
                        'security': parts[1] if parts[1] else 'Open',
                        'signal': parts[2] + '%'
                    })
        return networks
    
    def analyze_security(self, network: Dict) -> Dict:
        """Analyze WiFi network security"""
        analysis = {
            'ssid': network.get('ssid', 'Unknown'),
            'security_level': 'Low',
            'vulnerabilities': [],
            'recommendations': []
        }
        
        auth = network.get('auth', network.get('security', 'Open')).lower()
        encryption = network.get('encryption', '').lower()
        
        if 'wep' in auth or 'wep' in encryption:
            analysis['security_level'] = 'Critical'
            analysis['vulnerabilities'].append('WEP encryption (easily crackable)')
            analysis['recommendations'].append('Upgrade to WPA2 or WPA3')
        elif 'wpa' in auth and 'wpa2' not in auth:
            analysis['security_level'] = 'High'
            analysis['vulnerabilities'].append('WPA encryption (vulnerable to attacks)')
            analysis['recommendations'].append('Upgrade to WPA2 or WPA3')
        elif 'wpa2' in auth.lower():
            analysis['security_level'] = 'Medium'
            analysis['vulnerabilities'].append('WPA2 (vulnerable to KRACK attacks)')
            analysis['recommendations'].append('Consider WPA3 if supported')
        elif 'wpa3' in auth.lower():
            analysis['security_level'] = 'Low'
            analysis['recommendations'].append('WPA3 is secure')
        else:
            analysis['security_level'] = 'Critical'
            analysis['vulnerabilities'].append('Open network (no encryption)')
            analysis['recommendations'].append('Enable WPA2 or WPA3 encryption')
        
        return analysis
    
    def generate_report(self) -> str:
        """Generate WiFi scan report"""
        report = "# WiFi Security Scan Report\n\n"
        report += f"**Interface**: {self.interface or 'N/A'}\n\n"
        report += f"## Networks Found ({len(self.networks)})\n\n"
        
        for network in self.networks:
            analysis = self.analyze_security(network)
            report += f"### {analysis['ssid']}\n\n"
            report += f"- **Security Level**: {analysis['security_level']}\n"
            report += f"- **Authentication**: {network.get('auth', network.get('security', 'Unknown'))}\n"
            report += f"- **Signal**: {network.get('signal', 'N/A')}\n"
            
            if analysis['vulnerabilities']:
                report += f"\n**Vulnerabilities**:\n"
                for vuln in analysis['vulnerabilities']:
                    report += f"- {vuln}\n"
            
            if analysis['recommendations']:
                report += f"\n**Recommendations**:\n"
                for rec in analysis['recommendations']:
                    report += f"- {rec}\n"
            
            report += "\n"
        
        return report

def main():
    scanner = WiFiScanner()
    
    print("[*] WiFi Scanner\n")
    
    # Get interfaces
    interfaces = scanner.get_wifi_interfaces()
    if interfaces:
        print(f"[+] Found {len(interfaces)} WiFi interface(s)")
        for iface in interfaces:
            print(f"    - {iface}")
    else:
        print("[-] No WiFi interfaces found")
        print("[!] Note: This tool may require root/admin privileges")
        sys.exit(1)
    
    # Scan networks
    networks = scanner.scan_networks()
    
    if networks:
        print(f"\n[+] Found {len(networks)} networks")
        for network in networks:
            print(f"    - {network.get('ssid', 'Unknown')}: {network.get('auth', network.get('security', 'Open'))}")
    else:
        print("[-] No networks found or scan failed")
        print("[!] Try running with elevated privileges")
    
    # Generate report
    report = scanner.generate_report()
    with open('wifi_scan_report.md', 'w') as f:
        f.write(report)
    
    print(f"\n[+] Report saved to wifi_scan_report.md")
    print(f"[!] WARNING: Only scan networks you own or have permission to scan!")

if __name__ == '__main__':
    main()

